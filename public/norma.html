<script>
    document.addEventListener('DOMContentLoaded', () => {
        const shortNameSpan = document.getElementById('normaShortName');
        const analyzeButton = document.getElementById('analyzeButton');
        const analysisResultDiv = document.getElementById('analysisResult');
        const loaderDiv = document.getElementById('loader');
        const pageLoaderOverlay = document.getElementById('pageLoaderOverlay'); // Select the overlay
        const userPromptInput = document.getElementById('userPrompt');

        // Get the document ID from the URL (you can change this if you pass it differently)
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get('documentId');

        // Assuming the document ID is passed as a query parameter
        // Example: norma.html?documentId=BOE-A-2025-2144

        // Fetch the document details (only the short_name for this example)
        fetch(`/api/norma-details?documentId=${documentId}`) // New endpoint in app.js
            .then(response => response.json())
            .then(data => {
                shortNameSpan.textContent = data.short_name;
                pageLoaderOverlay.style.display = 'none';// Hide the overlay after loading shortname
            })
            .catch(error => {
                console.error('Error fetching norma details:', error);
                analysisResultDiv.textContent = 'Error fetching norma details.'; // show error if there's a problem
                pageLoaderOverlay.style.display = 'none';// Hide the overlay even if there's an error
            });

          analyzeButton.addEventListener('click', () => {
            analysisResultDiv.textContent = ''; // Clear previous results
            //loaderDiv.style.display = 'block'; // Show the loader
            analyzeButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analizando...'; // Show loading icon
            analyzeButton.style.backgroundColor = 'transparent';

            const userPrompt = userPromptInput.value;

            fetch('/api/analyze-norma', { // New endpoint in app.js
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ documentId: documentId, userPrompt: userPrompt })
            })
            .then(response => response.text()) // Expecting plain text
            .then(data => {
                     const htmlContent = data.replace(/^```html\s*|\s*```|^<\!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<\!DOCTYPE html>/g, '');
                    analyzeButton.innerHTML = 'Impacto Analizado'; // Change button text
                    analyzeButton.style.backgroundColor = '#83a300';
                    analysisResultDiv.innerHTML = htmlContent; // Set as HTML
            })
            .catch(error => {
                console.error('Error analyzing norma:', error);
                analyzeButton.innerHTML = 'Analisis Impacto'; // Revert button text
                  analyzeButton.style.backgroundColor = '#092534';
                analysisResultDiv.textContent = 'Error analyzing norma.';
            });
        });
    });
</script>