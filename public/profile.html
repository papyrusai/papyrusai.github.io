<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Profile</title>
  <link rel="icon" href="assets/reversa_logo.png" type="image/png"> 

  <!-- Font Awesome + Chart.js + Basic CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>

  <!-- Your existing CSS files -->
  <link rel="stylesheet" type="text/css" href="styles/styles.css" />
  <link rel="stylesheet" type="text/css" href="styles/menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
  <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
  <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/mobile.css" />
  <link rel="stylesheet" type="text/css" href="styles/sidebar_styles.css" />
  <link rel="stylesheet" type="text/css" href="styles/tuslistas.css" />
  <link rel="stylesheet" type="text/css" href="styles/profile.css" />

  <!-- Text Editor JavaScript -->
  <script src="/views/tuslistas/textEditor.js"></script>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "r7ltvtr85q");
</script>

</head>
<body>
  <!-- Loader overlay -->
  <div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

  <!-- Navbar -->
   <!--
  <nav class="navbar">
    <div class="logo">
      <a href="https://reversa.ai/" target="_blank">
        <img src="assets/papyrus_app.png" alt="Rev Logo">
      </a>
    </div>
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <ul class="menu">
      <li><a href="https://reversa.ai/">WEB</a></li>
      <li><a href="/profile">PANEL DE CONTROL</a></li>
      <li> <a href="#" id="editSuscription">CUENTA</a></li> 
      <li><a href="https://reversa.ai/pages/contact-1">AYUDA</a></li>
    </ul>
  </nav>
-->
  

  <!-- NUEVO CONTENEDOR PRINCIPAL -->
  <div class="profile-container">
    <!-- NUEVO MENÚ LATERAL -->
    <div id="sidebar">
      <div class="logo-reversa">
        <a href="https://reversa.ai/" target="_blank">
          <img src="assets/reversa_white.png" alt="Reversa Logo">
        </a>
      </div>
      <div class="border-menu"></div>
      <!-- Dropdown para cambiar entre Novedades Regulatorias y Consultas Públicas -->
      <div class="content-type-dropdown">
        <button class="content-type-dropbtn" id="contentTypeDropdown">
          <span id="selectedContentType">Novedades Normativas</span> 
          <i class="fa fa-caret-down"></i>
        </button>
        <div id="contentTypeDropdownContent" class="content-type-dropdown-content">
          <a href="#" data-content="novedades">Novedades Normativas</a>
          <a href="#" data-content="consultas">Consultas Públicas</a>
        </div>
      </div>
      
      <!-- Sidebar items para Novedades Normativas -->
      <div id="sidebar-novedades" class="sidebar-content">
        <a href="#" class="sidebar-item active" data-target="content-agentes">
          <i class="fas fa-users"></i> Agentes
        </a>
        <a href="#" class="sidebar-item" data-target="content-boletin">
          <i class="fas fa-newspaper"></i> Boletín Diario
        </a>
        <a href="#" class="sidebar-item" data-target="content-busqueda">
          <i class="fas fa-search"></i> Búsqueda y Estadísticas
        </a>
        <a href="#" class="sidebar-item" data-target="content-listas">
          <i class="fas fa-list"></i> Tus listas
        </a>
        <a href="#" class="sidebar-item" data-target="content-configuracion">
          <i class="fas fa-cog"></i> Configuración
        </a>
        <a href="#" class="sidebar-item" id="editSuscription">
          <i class="fas fa-user-circle"></i> Cuenta
        </a>
      </div>
      
      <!-- Sidebar items para Consultas Públicas -->
      <div id="sidebar-consultas" class="sidebar-content" style="display: none;">
        <a href="#" class="sidebar-item active" data-target="content-radar-consultas">
          <i class="fas fa-satellite-dish"></i> Radar de Consultas
        </a>
        <a href="#" class="sidebar-item" data-target="content-configuracion">
          <i class="fas fa-cog"></i> Configuración
        </a>
        <a href="#" class="sidebar-item" data-target="content-listas">
          <i class="fas fa-list"></i> Tus listas
        </a>
        <a href="#" class="sidebar-item" id="editSuscriptionConsultas">
          <i class="fas fa-user-circle"></i> Cuenta
        </a>
      </div>
    </div>

    <!-- NUEVA ÁREA DE CONTENIDO PRINCIPAL -->
    <div id="main-content">

      <!-- Sección Agentes (El contenido se cargará dinámicamente desde tracker.html) -->
      <div id="content-agentes" class="vision-section active">
        <!-- El contenido del tracker se cargará aquí dinámicamente -->
      </div> 
     

      <!-- Sección Boletín Diario -->
      <div id="content-boletin" class="vision-section">
        <!-- El contenido del boletín diario se cargará aquí dinámicamente -->
      </div>

      <!-- Sección Búsqueda y Estadísticas (Contenido de marcador de posición) -->
       <!-- Placeholder dinámico para Búsqueda y Estadísticas -->
       <div id="content-busqueda" class="vision-section" style="display:none;"></div>


      <!-- La sección Tus Listas se cargará dinámicamente -->
      <div id="content-listas" class="vision-section" style="display: none;">
          <!-- El contenido de tuslistas.html se cargará aquí -->
      </div>

      <!-- Sección Configuración -->
      <div id="content-configuracion" class="vision-section">
        <div id="configuracion-iframe-container" style="width: 100%; height: 100vh; border: none;">
          <!-- The configuration content will be loaded here -->
        </div>
      </div>

      <!-- Sección Cuenta (Contenido de marcador de posición) -->
      <div id="content-cuenta" class="vision-section">
        <h2>Cuenta</h2>
        <p>Estamos trabajando en desarrollar el producto para que próximamente tenga esta nueva funcionalidad.</p>
      </div>

      <!-- Sección Radar de Consultas -->
      <div id="content-radar-consultas" class="vision-section" style="display: none;">
        <div id="consultas-publicas-container" style="width: 100%; height: 100vh; border: none;">
          <!-- El contenido de consultas públicas se cargará aquí dinámicamente -->
        </div>
      </div>

    </div> <!-- Fin de #main-content -->
  </div> <!-- Fin de .profile-container -->


  <!-- Additional JSON data for the chart and plan, etc. (mantenemos solo los necesarios para profile.html) -->
  <script id="userPlan" type="application/json">{{subscription_plan}}</script>
  <script id="userAcceptedEmail" type="application/json">{{#if accepted_email}}{{accepted_email}}{{else}}null{{/if}}</script>
  <script id="userEmail" type="application/json">"{{email}}"</script>
  <script id="userBoletines" type="application/json">{{user_boletines_json}}</script>
  <script id="allRangosData" type="application/json">{{all_rangos_json}}</script>
  
  <!-- Scripts JSON necesarios para el tracker (serán accesibles globalmente) -->
  <script id="monthsData" type="application/json">{{months_json}}</script>
  <script id="countsData" type="application/json">{{counts_json}}</script>
  <script id="startDateInput" type="application/json">{{start_date}}</script>
  <script id="endDateInput" type="application/json">{{end_date}}</script>
  <script id="userRangos" type="application/json">{{user_rangos_json}}</script>
  <script id="industryTags" type="application/json">{{industry_tags_json}}</script>
  <script id="userSubIndustriaMap" type="application/json">{{subindustria_map_json}}</script>
  <script id="ramaJuridicas" type="application/json">{{rama_juridicas_json}}</script>
  <script id="userSubRamaMap" type="application/json">{{subrama_juridicas_json}}</script>
  <script id="userEtiquetasPersonalizadas" type="application/json">{{etiquetas_personalizadas_json}}</script>

  <!-- Modal para validación de documentos -->
  <div id="modal-no-documentos" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Selecciona documentos</h3>
      <p>Selecciona al menos un documento para generar contenido</p>
      <button class="modal-ok-btn" onclick="closeNoDocumentosModal()">OK</button>
    </div>
  </div>

  <!--<script src="editarSuscripcion.js"></script> -->
  <script src="editarsuscripcion2.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // --------------------- NAV / HAMBURGER ---------------------
    function toggleMenu() {
      const menu = document.querySelector('.menu');
      menu.classList.toggle('active');
    }
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.menu');
      const hamburger = document.querySelector('.hamburger');
      if (event.target && menu && hamburger && !menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    // --------------------- LOADER / CHART ON LOAD ---------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Dejamos visible el overlay de carga inicial; se ocultará cuando la visión activa
      // (tracker o boletín) termine su inicialización para evitar parpadeos.

      // Utilidad global para ocultar el overlay de página una vez la vista activa esté lista
      window.hidePageLoaderOverlay = function() {
        const overlay = document.getElementById('pageLoaderOverlay');
        if (overlay) overlay.style.display = 'none';
      };

      // Get user plan early to use throughout the code - make it global
      window.userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');

      // Cargar las listas del usuario al inicio de la página
      loadUserListsFromBackend();

      // Handle plan-specific UI in agentes view
      const userEtiquetasPersonalizadas = JSON.parse(document.getElementById('userEtiquetasPersonalizadas').textContent || '{}');
      const hasEtiquetasPersonalizadas = userEtiquetasPersonalizadas && Object.keys(userEtiquetasPersonalizadas).length > 0;
      
      // Expose globally for later checks
      window.hasEtiquetasPersonalizadas = hasEtiquetasPersonalizadas;
      // Apply visibility rules for agentes view (plan2/3 with no tags)
      if (typeof applyAgentesAdvancedVisibility === 'function') {
        applyAgentesAdvancedVisibility();
      }
      
      // Show radar banner for plan1 users OR plan2/plan3 users without etiquetas_personalizadas
      if (window.userPlan === 'plan1' || ((window.userPlan === 'plan2' || window.userPlan === 'plan3') && !hasEtiquetasPersonalizadas)) {
        const radarBanner = document.getElementById('radar-normativo-banner');
        const betaBanner = document.querySelector('.beta-banner');
        const bannerTitle = document.getElementById('radar-banner-title');
        const bannerDescription = document.getElementById('radar-banner-description');
        const bannerButton = document.getElementById('radar-banner-button');
        
        if (radarBanner) radarBanner.style.display = 'block';
        if (betaBanner) betaBanner.style.display = 'none';
        
        // Update banner content based on plan
        if (window.userPlan === 'plan2' || window.userPlan === 'plan3') {
          // Change content for plan2/plan3 users
          if (bannerTitle) bannerTitle.textContent = 'Configura tu cuenta';
          if (bannerDescription) bannerDescription.textContent = 'Configura tu cuenta para poder filtrar y analizar de manera automática la normativa que te afecta a través de nuestros agentes';
          if (bannerButton) {
            bannerButton.textContent = 'Configura tu cuenta';
            bannerButton.onclick = function(e) {
              e.preventDefault();
              showConfiguracionSection();
              return false;
            };
          }
        } else {
          // Keep original content for plan1 users
          if (bannerButton) {
            bannerButton.onclick = function(e) {
              e.preventDefault();
              // Original plan1 behavior - you can add the subscription upgrade logic here
              window.location.href = 'https://reversa.ai/prices';
              return false;
            };
          }
        }
        
        // Modify the handleBuscar function for plan1 users
        if (window.userPlan === 'plan1') {
          const originalHandleBuscar = window.handleBuscar;
          window.handleBuscar = function() {
            if (window.userPlan === 'plan1') {
              // Show upgrade message instead of search results
              document.querySelector('.collectionDocs').innerHTML = `
                <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <h3 style="color: #0b2431;">¡Mejora tu plan para acceder a esta funcionalidad!</h3>
                  <p style="color: #455862;">Nuestros planes de pago te permiten realizar búsquedas avanzadas y filtrar normativa según tus necesidades específicas.</p>
                  <button onclick="window.location.href='https://reversa.ai/prices'" style="background-color: #04db8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Ver planes</button>
                </div>
              `;
              
              // Hide the analytics sections
              document.querySelectorAll('.analytics-label').forEach(label => {
                if (!label.classList.contains('busqueda')) {
                  label.style.display = 'none';
                }
              });
              const chartContainer = document.getElementById('chartContainer');
              if (chartContainer) {
                chartContainer.style.display = 'none';
              }
              
              // Hide loading indicators
              document.getElementById('loading-icon').style.display = 'none';
              document.getElementById('loading-icon-chart').style.display = 'none';
              
              return; // Stop execution here for plan1 users
            }
            
            // Call the original function for non-plan1 users
            if (typeof originalHandleBuscar === 'function') {
              originalHandleBuscar();
            }
          };
        }
      }

      // Fill default date from server
      const startDateInput = JSON.parse(document.getElementById("startDateInput").textContent || '"2024-01-01T00:00:00.000Z"');
      const formattedDate = new Date(startDateInput).toISOString().split('T')[0];
      const startDate = document.getElementById("startDate");
      if (formattedDate && startDate) {
        startDate.value = formattedDate;
      }

      // El gráfico inicial lo carga tracker.js después de que el contenido esté listo
      // para evitar doble renderizado y parpadeos.

      // Check if we should show the newsletter banner
      checkAndShowNewsletterBanner();

       /* 1. Toggle al pulsar en cualquier .dropbtn ------------------ */
       document.querySelectorAll('.dropbtn').forEach(btn => {
         btn.addEventListener('click', e => {
           e.stopPropagation();                     // evita que el click burbujee
           const dropdown = btn.closest('.dropdown');
           const menu     = dropdown?.querySelector('.dropdown-content');
           if (!menu) return;
     
           // Cierra otros menús que pudieran estar abiertos
           document.querySelectorAll('.dropdown-content.show')
                   .forEach(el => { if (el !== menu) el.classList.remove('show'); });
     
           menu.classList.toggle('show');
         });
       });
     
       /* 2. Cerrar cuando se hace click FUERA de cualquier .dropdown -- */
       window.addEventListener('click', e => {
         // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
         const clickedInsideDropdown = e && e.target && typeof e.target.closest === 'function' && !!e.target.closest('.dropdown');
         if (clickedInsideDropdown) return;         // no cerramos nada
     
         // Click fuera  →  cerrar todos los menús abiertos
         document.querySelectorAll('.dropdown-content.show')
                 .forEach(el => el.classList.remove('show'));
       });
     
       // NOTA: Las funciones del tracker se inicializan desde tracker.js, no aquí
       // para evitar doble inicialización y parpadeo
       
       // Check URL parameters to determine which section to show
       const urlParams = new URLSearchParams(window.location.search);
       const viewParam = urlParams.get('view');
       
       // Get user plan
       const userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
       
       // Show Boletín Diario by default for plan1 users or if view=boletin is specified
       if (viewParam === 'boletin' || (userPlan === 'plan1' && !viewParam)) {
         // Hide Agentes section, remove active class
         const agentesSection = document.getElementById('content-agentes');
         const agentesMenuItem = document.querySelector('.sidebar-item[data-target="content-agentes"]');
         if (agentesSection) {
           agentesSection.classList.remove('active');
           agentesSection.style.display = 'none';
         }
         if (agentesMenuItem) {
           agentesMenuItem.classList.remove('active');
         }
         
         // Show Boletín Diario section, add active class
         const boletinSection = document.getElementById('content-boletin');
         const boletinMenuItem = document.querySelector('.sidebar-item[data-target="content-boletin"]');
         if (boletinSection) {
           boletinSection.classList.add('active');
           boletinSection.style.display = 'block';
         }
         if (boletinMenuItem) {
           boletinMenuItem.classList.add('active');
         }
         
         // Load boletin content
         loadBoletinDiarioContent();
       } else if (viewParam === 'configuracion') {
         // Show configuration section by default
         showConfiguracionSection();
       } else {
         // *** EXISTENTE: Lógica para mostrar la sección por defecto (Agentes) ***
         // Asegurarse de que solo la sección activa sea visible al cargar
         document.querySelectorAll('.vision-section').forEach(section => {
           if (!section.classList.contains('active')) {
             section.style.display = 'none';
           } else {
             section.style.display = 'block';
           }
         });
         
         // Cargar el contenido del tracker si la sección de agentes está activa por defecto
         const agentesSection = document.getElementById('content-agentes');
         if (agentesSection && agentesSection.classList.contains('active')) {
           loadTrackerContent();
         }
       }
    });
    
    // ==================== CHART FUNCTION (GLOBAL) ====================
    // Chart function needed by tracker
    window.loadChart = function(months, counts) {
      const ctx = document.getElementById('documentsChart');
      if (!ctx) return;
      
      // Destroy existing chart if any
      if (window.trackerChart) {
        window.trackerChart.destroy();
      }
      
      window.trackerChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Documentos por mes',
            data: counts,
            fill: false,
            borderColor: '#04db8d',
            backgroundColor: '#04db8d',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    };
    
    // ==================== FUNCION PARA LOAD TRACKER (AGENTES) ====================
    let trackerContentLoaded = false;
    function loadTrackerContent(callback) {
        console.log('[loadTrackerContent] Function called.');
        const container = document.getElementById('content-agentes');
        
        if (!container) {
            console.error('[loadTrackerContent] Error: Container with ID "content-agentes" not found.');
            return;
        }

        if (trackerContentLoaded) {
            console.log('[loadTrackerContent] Content already loaded. Running callback if it exists.');
            if (typeof window.initializeTracker === 'function') {
                window.initializeTracker();
            }
            if (callback) callback();
            return;
        }

        console.log('[loadTrackerContent] Starting fetch for tracker.html');
        fetch('views/tracker/tracker.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`[loadTrackerContent] Network response was not ok: ${response.statusText}`);
                }
                console.log('[loadTrackerContent] Successfully fetched tracker.html.');
                return response.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Append styles
                doc.querySelectorAll('style').forEach(style => {
                    document.head.appendChild(style);
                    console.log('[loadTrackerContent] Appended a <style> block to <head>.');
                });

                // Append HTML content to the container
                container.innerHTML = doc.body.innerHTML;
                console.log('[loadTrackerContent] Injected HTML content into #content-agentes.');
                
                // Execute scripts
                const scripts = Array.from(doc.querySelectorAll('script'));
                console.log(`[loadTrackerContent] Found ${scripts.length} script(s) to execute.`);
                const loadScript = (index) => {
                    if (index >= scripts.length) {
                        trackerContentLoaded = true;
                        console.log('[loadTrackerContent] All scripts loaded. trackerContentLoaded set to true.');
                        
                        // Inicializar el tracker después de cargar los scripts
                        setTimeout(() => {
                            if (typeof window.initializeTracker === 'function') {
                                console.log('[loadTrackerContent] Calling initializeTracker() to initialize the view.');
                                window.initializeTracker();
                            } else {
                                console.warn('[loadTrackerContent] initializeTracker function not found after loading scripts.');
                            }
                        }, 100);
                        
                        if (callback) callback();
                        return;
                    }
                    const script = scripts[index];
                    const newScript = document.createElement('script');
                    console.log(`[loadTrackerContent] Loading script ${index + 1}/${scripts.length}...`);
                    if (script.src) {
                        // Use the raw src attribute to decide how to resolve the path
                        const rawSrc = script.getAttribute('src');
                        let resolvedSrc = rawSrc;
                        // If the path is relative (does not start with http or /), prefix it with the tracker folder path
                        if (rawSrc && !rawSrc.startsWith('http') && !rawSrc.startsWith('/')) {
                            resolvedSrc = '/views/tracker/' + rawSrc;
                        }
                        newScript.src = resolvedSrc;
                        newScript.onload = () => loadScript(index + 1);
                        newScript.onerror = () => {
                            console.error(`[loadTrackerContent] Failed to load script: ${newScript.src}`);
                            loadScript(index + 1); // Continue to next script even if one fails
                        };
                        document.body.appendChild(newScript);
                    } else {
                        newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                        loadScript(index + 1);
                    }
                    script.remove();
                };
                loadScript(0);
            })
            .catch(error => {
                console.error('[loadTrackerContent] Fetch error:', error);
                if (container) container.innerHTML = `<p style="color:red;">Error al cargar la sección de Agentes.</p>`;
            });
    }

    // ==================== FUNCION PARA LOAD TUS LISTAS ====================
    let tusListasLoaded = false;
    function loadTusListasContent(callback) {
        console.log('[loadTusListasContent] Function called.');
        const container = document.getElementById('content-listas');
        
        if (!container) {
            console.error('[loadTusListasContent] Error: Container with ID "content-listas" not found.');
            return;
        }

        if (tusListasLoaded) {
            console.log('[loadTusListasContent] Content already loaded. Running callback if it exists.');
            if (typeof loadDetailedUserLists === 'function') {
                loadDetailedUserLists();
            }
            if (callback) callback();
            return;
        }

        console.log('[loadTusListasContent] Starting fetch for tuslistas.html');
        fetch('views/tuslistas/tuslistas.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`[loadTusListasContent] Network response was not ok: ${response.statusText}`);
                }
                console.log('[loadTusListasContent] Successfully fetched tuslistas.html.');
                return response.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Append styles
                doc.querySelectorAll('style').forEach(style => {
                    document.head.appendChild(style);
                    console.log('[loadTusListasContent] Appended a <style> block to <head>.');
                });

                // Append HTML content to the container
                container.innerHTML = doc.body.innerHTML;
                console.log('[loadTusListasContent] Injected HTML content into #content-listas.');
                
                // Execute scripts
                const scripts = Array.from(doc.querySelectorAll('script'));
                console.log(`[loadTusListasContent] Found ${scripts.length} script(s) to execute.`);
                const loadScript = (index) => {
                    if (index >= scripts.length) {
                        tusListasLoaded = true;
                        console.log('[loadTusListasContent] All scripts loaded. tusListasLoaded set to true.');
                        if (typeof loadDetailedUserLists === 'function') {
                            console.log('[loadTusListasContent] Calling loadDetailedUserLists() to initialize the view.');
                            loadDetailedUserLists();
                        } else {
                            console.warn('[loadTusListasContent] loadDetailedUserLists function not found after loading scripts.');
                        }
                        
                        // Ocultar overlay principal después de cargar las listas
                        if (typeof window.hidePageLoaderOverlay === 'function') {
                            window.hidePageLoaderOverlay();
                        }
                        if (callback) callback();
                        return;
                    }
                    const script = scripts[index];
                    const newScript = document.createElement('script');
                    console.log(`[loadTusListasContent] Loading script ${index + 1}/${scripts.length}...`);
                    if (script.src) {
                        // Use the raw src attribute to decide how to resolve the path
                        const rawSrc = script.getAttribute('src');
                        let resolvedSrc = rawSrc;
                        // If the path is relative (does not start with http or /), prefix it with the tuslistas folder path
                        if (rawSrc && !rawSrc.startsWith('http') && !rawSrc.startsWith('/')) {
                            resolvedSrc = '/views/tuslistas/' + rawSrc;
                        }
                        newScript.src = resolvedSrc;
                        newScript.onload = () => loadScript(index + 1);
                        newScript.onerror = () => {
                            console.error(`[loadTusListasContent] Failed to load script: ${newScript.src}`);
                            loadScript(index + 1); // Continue to next script even if one fails
                        };
                        document.body.appendChild(newScript);
                    } else {
                        newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                        loadScript(index + 1);
                    }
                    script.remove();
                };
                loadScript(0);
            })
            .catch(error => {
                console.error('[loadTusListasContent] Fetch error:', error);
                if (container) container.innerHTML = `<p style="color:red;">Error al cargar la sección de Tus Listas.</p>`;
            });
    }

    // ==================== FUNCION PARA LOAD BUSQUEDA / ESTADISTICAS ====================
    let busquedaContentLoaded = false;
    function loadBusquedaContent(callback) {
        console.log('[loadBusquedaContent] Function called.');
        const container = document.getElementById('content-busqueda');
        if (!container) {
            console.error('[loadBusquedaContent] Error: Container with ID "content-busqueda" not found.');
            return;
        }
        if (busquedaContentLoaded) {
            console.log('[loadBusquedaContent] Content already loaded.');
            if (callback) callback();
            return;
        }
        fetch('views/busqueda_estadisticas/busqueda_estadisticas.html')
            .then(resp => {
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                container.innerHTML = doc.body.innerHTML;
                // Copiar estilos embebidos o links
                doc.head.querySelectorAll('style, link[rel="stylesheet"]').forEach(el => {
                    document.head.appendChild(el.cloneNode(true));
                });
                busquedaContentLoaded = true;
                
                // Ocultar overlay principal después de cargar búsqueda
                if (typeof window.hidePageLoaderOverlay === 'function') {
                    window.hidePageLoaderOverlay();
                }
                
                if (callback) callback();
            })
            .catch(error => {
                console.error('[loadBusquedaContent] Fetch error:', error);
                container.innerHTML = '<p style="color:red;text-align:center;">Error al cargar la sección.</p>';
            });
    }

    // --------------------- CONTENT TYPE DROPDOWN FUNCTIONALITY ---------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Variable global para mantener el contexto actual
      window.currentContentType = 'novedades';
      
      // Manejar el dropdown de tipo de contenido
      const contentTypeDropdown = document.getElementById('contentTypeDropdown');
      const contentTypeDropdownContent = document.getElementById('contentTypeDropdownContent');
      const selectedContentType = document.getElementById('selectedContentType');
      
      // Toggle dropdown
      contentTypeDropdown.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('.content-type-dropdown').classList.toggle('show');
      });
      
      // Cerrar dropdown cuando se hace clic fuera
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.content-type-dropdown')) {
          document.querySelector('.content-type-dropdown').classList.remove('show');
        }
      });
      
      // Manejar selección de opciones
      contentTypeDropdownContent.addEventListener('click', function(e) {
        e.preventDefault();
        const target = e.target.closest('a');
        if (!target) return;
        
        const contentType = target.getAttribute('data-content');
        const contentText = target.textContent;
        
        // Actualizar texto del dropdown
        selectedContentType.textContent = contentText;
        
        // Cerrar dropdown
        document.querySelector('.content-type-dropdown').classList.remove('show');
        
        // Cambiar el contexto global
        window.currentContentType = contentType;
        
        if (contentType === 'consultas') {
          // Mostrar contexto de consultas públicas
          showConsultasContext();
        } else {
          // Mostrar contexto de novedades normativas
          showNovedadesContext();
        }
      });
      
      // Función para mostrar contexto de consultas públicas
      function showConsultasContext() {
        // Cambiar sidebar
        document.getElementById('sidebar-novedades').style.display = 'none';
        document.getElementById('sidebar-consultas').style.display = 'block';
        
        // Ocultar todas las secciones del contenido principal
        document.querySelectorAll('.vision-section').forEach(section => {
          section.style.display = 'none';
          section.classList.remove('active');
        });
        
        // Mostrar la sección de radar de consultas por defecto
        const radarConsultasSection = document.getElementById('content-radar-consultas');
        if (radarConsultasSection) {
          radarConsultasSection.style.display = 'block';
          radarConsultasSection.classList.add('active');
        }
        
        // Marcar como activo el primer elemento del sidebar de consultas
        document.querySelectorAll('#sidebar-consultas .sidebar-item').forEach(item => {
          item.classList.remove('active');
        });
        const firstConsultasItem = document.querySelector('#sidebar-consultas .sidebar-item[data-target="content-radar-consultas"]');
        if (firstConsultasItem) {
          firstConsultasItem.classList.add('active');
        }
        
        // Cargar el contenido de consultas públicas
        window.loadConsultasPublicasContent();
        
        // Reconfigurar listeners del sidebar
        if (typeof setupSidebarListeners === 'function') {
          setupSidebarListeners();
        }
      }
      
      // Función para mostrar contexto de novedades normativas
      function showNovedadesContext() {
        // Cambiar sidebar
        document.getElementById('sidebar-consultas').style.display = 'none';
        document.getElementById('sidebar-novedades').style.display = 'block';
        
        // Ocultar todas las secciones del contenido principal
        document.querySelectorAll('.vision-section').forEach(section => {
          if (section.id !== 'content-radar-consultas') {
            section.style.display = 'none';
            section.classList.remove('active');
          }
        });
        
        // Ocultar sección de radar de consultas
        const radarConsultasSection = document.getElementById('content-radar-consultas');
        if (radarConsultasSection) {
          radarConsultasSection.style.display = 'none';
          radarConsultasSection.classList.remove('active');
        }
        
        // Mostrar la sección de agentes por defecto
        const agentesSection = document.getElementById('content-agentes');
        if (agentesSection) {
          agentesSection.style.display = 'block';
          agentesSection.classList.add('active');
        }
        
        // Marcar como activo el primer elemento del sidebar de novedades
        document.querySelectorAll('#sidebar-novedades .sidebar-item').forEach(item => {
          item.classList.remove('active');
        });
        const firstNovedadesItem = document.querySelector('#sidebar-novedades .sidebar-item[data-target="content-agentes"]');
        if (firstNovedadesItem) {
          firstNovedadesItem.classList.add('active');
        }
        
        // Reconfigurar listeners del sidebar
        if (typeof setupSidebarListeners === 'function') {
          setupSidebarListeners();
        }
      }
    });

    // --------------------- plan logic => disabling bulletins if plan1 ---------------------
    // Remove the userPlan variable since we're using window.userPlan now
    document.addEventListener("DOMContentLoaded", () => {
      // We already define userPlan in the main DOMContentLoaded event, don't redefine it here
      // userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
    });

    // --------------------- CHART FUNCTIONS (Movidas a tracker.js) ---------------------
    // Las funciones de gráficos y visibilidad de agentes han sido movidas a tracker.js

    // --------------------- DROPDOWN FUNCTIONS ---------------------
    function toggleIndustryDropdown() {
      document.getElementById("myDropdown").classList.toggle("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleRamaDropdown() {
      document.getElementById("ramaDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleBoletinDropdown() {
      document.getElementById("boletinDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }
    
    function toggleEtiquetasDropdown() {
      document.getElementById("etiquetasDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleRangoDropdown() {
      document.getElementById("rangoDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
    }


/*----- Boletin diario ---------------*/

// ==================== FUNCION PARA LOAD BOLETIN DIARIO ====================
let boletinDiarioContentLoaded = false;

function loadBoletinDiarioContent(callback) {
    console.log('[loadBoletinDiarioContent] Function called.');
    const container = document.getElementById('content-boletin');
    
    if (!container) {
        console.error('[loadBoletinDiarioContent] Error: Container with ID "content-boletin" not found.');
        return;
    }

    if (boletinDiarioContentLoaded) {
        console.log('[loadBoletinDiarioContent] Content already loaded. Running callback if it exists.');
        // Ejecutar fetchBoletinDiario si está disponible
        if (typeof window.fetchBoletinDiario === 'function') {
            window.fetchBoletinDiario();
        }
        if (callback) callback();
        return;
    }

    console.log('[loadBoletinDiarioContent] Starting fetch for boletindiario.html');
    fetch('views/boletindiario/boletindiario.html')
        .then(response => {
            if (!response.ok) {
                throw new Error(`[loadBoletinDiarioContent] Network response was not ok: ${response.statusText}`);
            }
            console.log('[loadBoletinDiarioContent] Successfully fetched boletindiario.html.');
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Append styles
            doc.querySelectorAll('style').forEach(style => {
                document.head.appendChild(style);
                console.log('[loadBoletinDiarioContent] Appended a <style> block to <head>.');
            });

            // Append HTML content to the container
            container.innerHTML = doc.body.innerHTML;
            console.log('[loadBoletinDiarioContent] Injected HTML content into #content-boletin.');
            
            // Execute scripts
            const scripts = Array.from(doc.querySelectorAll('script'));
            console.log(`[loadBoletinDiarioContent] Found ${scripts.length} script(s) to execute.`);
            const loadScript = (index) => {
                if (index >= scripts.length) {
                    boletinDiarioContentLoaded = true;
                    console.log('[loadBoletinDiarioContent] All scripts loaded. boletinDiarioContentLoaded set to true.');
                    
                    // Inicializar datos del boletín después de cargar los scripts
                    setTimeout(() => {
                                                if (typeof window.fetchBoletinDiario === 'function') {
                            console.log('[loadBoletinDiarioContent] Calling fetchBoletinDiario() to initialize the view.');
                            
                            // Poblar filtros iniciales antes de la primera carga de datos
                            try {
                                const userBoletines = JSON.parse(document.getElementById('userBoletines')?.textContent || '[]');
                                const allRangos = JSON.parse(document.getElementById('allRangosData')?.textContent || '[]');
                                if (typeof window.populateBoletinDiarioFilters === 'function') {
                                    window.populateBoletinDiarioFilters(userBoletines, allRangos).catch(console.error);
                                }
                            } catch (err) {
                                console.warn('No initial boletín/rango data available, populating defaults.', err);
                                if (typeof window.populateBoletinDiarioFilters === 'function') {
                                    window.populateBoletinDiarioFilters([], []).catch(console.error);
                                }
                            }
                            
                             window.fetchBoletinDiario();
                             if (typeof window.setBoletinDiarioLoaded === 'function') {
                                 window.setBoletinDiarioLoaded(true);
                             }
                             
                             // Ocultar overlay principal después de cargar el boletín
                             if (typeof window.hidePageLoaderOverlay === 'function') {
                                 window.hidePageLoaderOverlay();
                             }
                        } else {
                            console.warn('[loadBoletinDiarioContent] fetchBoletinDiario function not found after loading scripts.');
                        }
                    }, 100);
                    
                    if (callback) callback();
                    return;
                }
                const script = scripts[index];
                const newScript = document.createElement('script');
                console.log(`[loadBoletinDiarioContent] Loading script ${index + 1}/${scripts.length}...`);
                if (script.src) {
                    // Use the raw src attribute to decide how to resolve the path
                    const rawSrc = script.getAttribute('src');
                    let resolvedSrc = rawSrc;
                    // If the path is relative (does not start with http or /), prefix it with the boletindiario folder path
                    if (rawSrc && !rawSrc.startsWith('http') && !rawSrc.startsWith('/')) {
                        resolvedSrc = '/views/boletindiario/' + rawSrc;
                    }
                    newScript.src = resolvedSrc;
                    newScript.onload = () => loadScript(index + 1);
                    newScript.onerror = () => {
                        console.error(`[loadBoletinDiarioContent] Failed to load script: ${newScript.src}`);
                        loadScript(index + 1); // Continue to next script even if one fails
                    };
                    document.body.appendChild(newScript);
                } else {
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript);
                    loadScript(index + 1);
                }
                script.remove();
            };
            loadScript(0);
        })
        .catch(error => {
            console.error('[loadBoletinDiarioContent] Fetch error:', error);
            if (container) container.innerHTML = `<p style="color:red;">Error al cargar la sección de Boletín Diario.</p>`;
        });
}






/*--------------Visiones--------------*/
 // *** NUEVO: Lógica de Navegación del Menú Lateral ***

 
 document.addEventListener('DOMContentLoaded', function() {

  
    // Función dinámica para obtener los elementos del sidebar según el contexto
    function getCurrentSidebarItems() {
        const currentContext = window.currentContentType || 'novedades';
        if (currentContext === 'consultas') {
            return document.querySelectorAll('#sidebar-consultas .sidebar-item');
        } else {
            return document.querySelectorAll('#sidebar-novedades .sidebar-item');
        }
    }

    const contentSections = document.querySelectorAll('.vision-section');

    // Función para manejar el cambio de sección
    function handleSectionChange(targetId) {
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
            // Ocultar todas las secciones excepto las específicas del contexto de consultas
            const currentContext = window.currentContentType || 'novedades';
            
            contentSections.forEach(section => {
                if (currentContext === 'consultas' && section.id === 'content-radar-consultas') {
                    // No ocultar la sección de radar de consultas si estamos en contexto de consultas
                    return;
                } else if (currentContext === 'novedades' && section.id === 'content-radar-consultas') {
                    // Ocultar la sección de radar de consultas si estamos en contexto de novedades
                    section.style.display = 'none';
                    return;
                }
                section.style.display = 'none';
            });
            
            targetSection.style.display = 'block';

            // *** NUEVO/MODIFICADO: Cargar contenido del boletín si es la sección correcta ***
            if (targetId === 'content-boletin') {
                loadBoletinDiarioContent();
            }
            
            // *** NUEVO: Cargar listas detalladas si es la sección de listas ***
            if (targetId === 'content-listas') {
                loadTusListasContent();
            }
            
            // *** NUEVO: Cargar contenido del tracker si es la sección Agentes ***
            if (targetId === 'content-agentes') {
                loadTrackerContent();
            }
            
            // Cargar Búsqueda y Estadísticas
            if (targetId === 'content-busqueda') {
                 loadBusquedaContent();
            }
            
            // *** NUEVO: Cargar contenido de radar de consultas ***
            if (targetId === 'content-radar-consultas') {
                window.loadConsultasPublicasContent();
            }
            
            // *** NUEVO: Cargar configuración si es la sección de configuración ***
            if (targetId === 'content-configuracion') {
                loadConfiguracionContent();
            }
            
            // Update URL with view parameter for navigation history
            if (targetId === 'content-boletin') {
                // If this is the boletín view, update URL to include view=boletin
                if (history.pushState) {
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('view', 'boletin');
                    window.history.pushState({path: newUrl.href}, '', newUrl.href);
                }
            } else if (targetId === 'content-agentes') {
                // If this is the agentes view, remove view parameter from URL
                if (history.pushState) {
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('view');
                    window.history.pushState({path: newUrl.href}, '', newUrl.href);
                }
            }
        }
    }

    // Función global para cargar el contenido de consultas públicas
    window.loadConsultasPublicasContent = function() {
        const container = document.getElementById('consultas-publicas-container');
        if (!container) {
            console.error('Elemento consultas-publicas-container no encontrado');
            return;
        }
        
        // Check if content is already loaded
        if (container.innerHTML.trim() !== '<!-- El contenido de consultas públicas se cargará aquí dinámicamente -->') {
            console.log('Contenido de consultas públicas ya está cargado');
            return;
        }
        
        console.log('Cargando contenido de consultas públicas...');
        
        // Load the configuration content
        fetch('consultas_publicas.html')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.text();
          })
          .then(html => {
            // Extract the body content from the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const bodyContent = doc.body.innerHTML;
            
            container.innerHTML = bodyContent;
            
            // Append styles from the loaded document head to the main document head
            const headStyles = doc.head.querySelectorAll('style, link[rel="stylesheet"]');
            headStyles.forEach(styleEl => {
              document.head.appendChild(styleEl.cloneNode(true));
            });
            
            // Re-execute any scripts in the loaded content
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
              const newScript = document.createElement('script');
              if (script.src) {
                newScript.src = script.src;
              } else {
                newScript.textContent = script.textContent;
              }
              document.head.appendChild(newScript);
              script.remove();
            });
            
            console.log('Contenido de consultas públicas cargado exitosamente');
            
            // Ocultar overlay principal después de cargar consultas públicas
            if (typeof window.hidePageLoaderOverlay === 'function') {
              window.hidePageLoaderOverlay();
            }
          })
          .catch(error => {
            console.error('Error loading consultas públicas content:', error);
            container.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #666;">
                <h3>Error al cargar las consultas públicas</h3>
                <p>Por favor, inténtalo de nuevo más tarde.</p>
              </div>
            `;
            
            // Ocultar overlay principal incluso en caso de error
            if (typeof window.hidePageLoaderOverlay === 'function') {
              window.hidePageLoaderOverlay();
            }
          });
    }

    // Función para configurar los listeners de los elementos del sidebar
    function setupSidebarListeners() {
        // Remover listeners existentes
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.replaceWith(item.cloneNode(true));
        });

        // Añadir nuevos listeners a todos los elementos del sidebar
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                
                // Remover clase active de todos los elementos del sidebar activo
                const currentSidebarItems = getCurrentSidebarItems();
                currentSidebarItems.forEach(i => i.classList.remove('active'));
                
                // Añadir clase active al elemento clickeado
                this.classList.add('active');
                
                const targetId = this.getAttribute('data-target');
                handleSectionChange(targetId);
            });
        });
    }

    // Configurar listeners iniciales
    setupSidebarListeners();

    // Mostrar la sección activa inicial y cargarla si es el Boletín
    const initialActiveItem = document.querySelector('.sidebar-item.active');
    if (initialActiveItem) {
        const initialTargetId = initialActiveItem.getAttribute('data-target');
        handleSectionChange(initialTargetId);
    } else {
        // Si no hay ninguno activo por defecto, activar 'Agentes' y mostrarlo
        const defaultItem = document.querySelector('.sidebar-item[data-target="content-agentes"]');
        const defaultSection = document.getElementById('content-agentes');
        if (defaultItem && defaultSection) {
            defaultItem.classList.add('active');
            defaultSection.style.display = 'block';
        }
    }

    // Cerrar dropdowns al hacer clic fuera (código existente adaptado)
    window.addEventListener('click', e => {
        // Check if the dropdown elements exist before accessing them
        const dropdownContents = document.querySelectorAll('.dropdown-content.show');
        if (dropdownContents.length > 0) {
            // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
            const clickedInsideDropdown = e.target.closest && e.target.closest('.dropdown');
            if (clickedInsideDropdown) return;         // no cerramos nada
            
            // Click fuera  →  cerrar todos los menús abiertos
            dropdownContents.forEach(el => el.classList.remove('show'));
        }
    });

    // Set up event listener for editSuscription buttons - both in the sidebar and content area
    document.querySelectorAll('#editSuscription, #editSuscription2, #editSuscription3, #editSuscriptionConsultas').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        // Show subscription container instead of redirecting
        if (typeof showSubscriptionModal === 'function') {
          showSubscriptionModal();
        } else {
          // Fallback if the function isn't available
          const modal = document.getElementById('subscription-container');
          if (modal) {
            modal.style.display = 'block';
          } else {
            console.error('Subscription container not found');
            alert('La funcionalidad de editar suscripción estará disponible próximamente.');
          }
        }
      });
    });

    /* === Intercept "Analizar documento" para usuarios plan1 === */
    document.body.addEventListener('click', function(e) {
      const impactoLink = e.target && e.target.closest && e.target.closest('.button-impacto');
      if (!impactoLink) return; // Click no proveniente del enlace

      if (window.userPlan === 'plan1') {
        e.preventDefault();
        showUpgradePlanBanner();
      }
    });

    /* === Banner de mejora de plan === */
    function showUpgradePlanBanner() {
      // Evitar duplicados
      let overlay = document.getElementById('upgrade-plan-overlay');
      let banner  = document.getElementById('upgrade-plan-banner');

      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'upgrade-plan-overlay';
        Object.assign(overlay.style, {
          position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
          background: 'rgba(0,0,0,0.4)', zIndex: 9998
        });
        document.body.appendChild(overlay);
        // Cerrar al hacer clic en overlay
        overlay.addEventListener('click', () => { hideBanner(); });
      }

      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'upgrade-plan-banner';
        Object.assign(banner.style, {
          position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
          background: '#fff', padding: '25px 30px', borderRadius: '10px',
          boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 9999, maxWidth: '400px', width: '90%'
        });

        banner.innerHTML = `
          <button id="close-upgrade-banner" style="position:absolute; top:8px; right:10px; background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
          <h3 style="margin:0 0 15px 0; color:#0b2431; font-size:20px;">Mejora tu plan para poder analizar cualquier norma con IA</h3>
          <div style="text-align:center;">
            <button id="upgrade-plan-btn" style="background:#04db8d; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:500;">Mejora tu plan</button>
          </div>
          <div id="upgrade-loader" style="display:none; text-align:center; margin-top:15px;">
            <div style="display:inline-block; width:30px; height:30px; border:3px solid rgba(4,219,141,0.3); border-radius:50%; border-top-color:#04db8d; animation:spin 1s linear infinite;"></div>
          </div>
        `;
        document.body.appendChild(banner);

        // Añadir keyframes para la animación del loader si no existen ya
        if (!document.getElementById('loader-keyframes')) {
          const style = document.createElement('style');
          style.id = 'loader-keyframes';
          style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
          document.head.appendChild(style);
        }

        // Listeners de los botones
        banner.querySelector('#close-upgrade-banner').addEventListener('click', hideBanner);
        banner.querySelector('#upgrade-plan-btn').addEventListener('click', () => {
          // Mostrar loader
          banner.querySelector('#upgrade-plan-btn').style.display = 'none';
          banner.querySelector('#upgrade-loader').style.display = 'block';

          // Esperar brevemente para asegurar que se muestra el loader
          setTimeout(() => {
            hideBanner();
            if (typeof showSubscriptionModal === 'function') {
              showSubscriptionModal();
            } else {
              const modal = document.getElementById('subscription-container');
              if (modal) modal.style.display = 'block';
            }
          }, 300);
        });
      }

      overlay.style.display = 'block';
      banner.style.display   = 'block';

      // Helper para ocultar
      function hideBanner() {
        if (overlay) overlay.style.display = 'none';
        if (banner)  banner.style.display  = 'none';
      }
    }
 });
  </script>
  <script>
    /* ===========  DROPDOWNS GENÉRICOS  ===================
       – Cualquier .dropbtn abre / cierra su propio menú
       – Sólo se puede abrir un menú a la vez
       – Si se hace click FUERA de .dropdown   ⇒  se cierran todos
       – Si se hace click dentro del menú      ⇒  NO se cierra          */
    document.addEventListener('DOMContentLoaded', () => {
    
      /* 1. Toggle al pulsar en cualquier .dropbtn ------------------ */
      document.querySelectorAll('.dropbtn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();                     // evita que el click burbujee
          const dropdown = btn.closest('.dropdown');
          const menu     = dropdown?.querySelector('.dropdown-content');
          if (!menu) return;
    
          // Cierra otros menús que pudieran estar abiertos
          document.querySelectorAll('.dropdown-content.show')
                  .forEach(el => { if (el !== menu) el.classList.remove('show'); });
    
          menu.classList.toggle('show');
        });
      });
    
      /* 2. Cerrar cuando se hace click FUERA de cualquier .dropdown -- */
      window.addEventListener('click', e => {
        // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
        const clickedInsideDropdown = e && e.target && typeof e.target.closest === 'function' && !!e.target.closest('.dropdown');
        if (clickedInsideDropdown) return;         // no cerramos nada
    
        // Click fuera  →  cerrar todos los menús abiertos
        document.querySelectorAll('.dropdown-content.show')
                .forEach(el => el.classList.remove('show'));
      });
    });
    
    // Newsletter Subscription Banner Logic
    function checkAndShowNewsletterBanner() {
      try {
        // Using window.userPlan instead of local userPlan
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        
        try {
          // Get accepted_email value, default to null if there are any issues
          const acceptedEmailElement = document.getElementById('userAcceptedEmail');
          let acceptedEmail = null;
          if (acceptedEmailElement) {
            const rawVal = acceptedEmailElement.textContent && acceptedEmailElement.textContent.trim();
            try {
              acceptedEmail = rawVal ? JSON.parse(rawVal) : null;
            } catch (e) {
              acceptedEmail = null;
            }
          }
          
          // Check if this is a plan1 user who hasn't set email preference and is in the appropriate view
          if (window.userPlan === 'plan1') {
            // Show radar normativo banner in agentes section
            const agentesSectionActive = document.getElementById('content-agentes')?.classList.contains('active');
            
            // Get the radar banner element
            const radarBanner = document.getElementById('radar-normativo-banner');
            
            if (radarBanner && agentesSectionActive) {
              // Show radar normativo banner
              radarBanner.style.display = 'block';
              
              // Hide no results message if it exists
              const noResultsElement = document.querySelector('.no-results');
              if (noResultsElement) {
                noResultsElement.style.display = 'none';
              }
              
              // Hide beta banner for plan1 users
              const betaBanner = document.querySelector('.beta-banner');
              if (betaBanner) {
                betaBanner.style.display = 'none';
              }
            }
            
            // Show newsletter banner if user hasn't set email preference and is viewing boletín
            const newsletterBanner = document.getElementById('newsletter-banner');
            const boletinSectionActive = document.getElementById('content-boletin')?.classList.contains('active');
            
            if (newsletterBanner && acceptedEmail === null && boletinSectionActive) {
              newsletterBanner.style.display = 'block';
              
              // Get the accept and reject buttons
              const acceptBtn = document.getElementById('accept-newsletter');
              const rejectBtn = document.getElementById('reject-newsletter');
              
              // Remove any existing event listeners by cloning the buttons
              if (acceptBtn) {
                const newAcceptBtn = acceptBtn.cloneNode(true);
                acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
                newAcceptBtn.addEventListener('click', function() {
                  saveEmailPreference(true);
                });
              }
              
              if (rejectBtn) {
                const newRejectBtn = rejectBtn.cloneNode(true);
                rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                newRejectBtn.addEventListener('click', function() {
                  saveEmailPreference(false);
                });
              }
            }
          }
        } catch (error) {
          console.error('Error processing email preferences:', error);
        }
      } catch (error) {
        console.error('Error in checkAndShowNewsletterBanner:', error);
      }
    }
    
    // Function to save the user's email preference (make it global for boletindiario.js)
    window.saveEmailPreference = function(preference) {
      // Create loading overlay
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.position = 'fixed';
      loadingOverlay.style.top = '0';
      loadingOverlay.style.left = '0';
      loadingOverlay.style.width = '100%';
      loadingOverlay.style.height = '100%';
      loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      loadingOverlay.style.display = 'flex';
      loadingOverlay.style.justifyContent = 'center';
      loadingOverlay.style.alignItems = 'center';
      loadingOverlay.style.zIndex = '9999';
      
      const spinner = document.createElement('div');
      spinner.className = 'loader';
      spinner.style.border = '5px solid #f3f3f3';
      spinner.style.borderTop = '5px solid #04db8d';
      spinner.style.borderRadius = '50%';
      spinner.style.width = '50px';
      spinner.style.height = '50px';
      spinner.style.animation = 'spin 2s linear infinite';
      
      // Add animation keyframes
      const style = document.createElement('style');
      style.innerHTML = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
      document.head.appendChild(style);
      
      loadingOverlay.appendChild(spinner);
      document.body.appendChild(loadingOverlay);
      
      // Convert boolean preference to string value that the server expects
      const accepted_email = preference === true ? 'yes' : 'no';
      
      // Make API call to update preferences
      fetch('/api/update-user-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          accepted_email: accepted_email
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Hide newsletter banner
        const banner = document.getElementById('newsletter-banner');
        if (banner) {
          banner.style.display = 'none';
        }
        
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.style.padding = '10px';
        successMessage.style.backgroundColor = '#d4edda';
        successMessage.style.color = '#155724';
        successMessage.style.borderRadius = '4px';
        successMessage.style.marginBottom = '20px';
        successMessage.style.textAlign = 'center';
        successMessage.innerHTML = preference ? 
          'Gracias por suscribirte a nuestras actualizaciones.' : 
          'Tus preferencias han sido actualizadas.';
        
        // Find a good place to add the message
        const contentBoletin = document.getElementById('content-boletin');
        if (contentBoletin) {
          contentBoletin.insertBefore(successMessage, contentBoletin.firstChild);
          
          // Remove message after 5 seconds
          setTimeout(() => {
            successMessage.remove();
          }, 5000);
        }
      })
      .catch(error => {
        console.error('Error updating preferences:', error);
        alert('Error al guardar tus preferencias. Por favor, inténtalo de nuevo.');
      })
      .finally(() => {
        // Remove loading overlay
        loadingOverlay.remove();
      });
    }
    </script>
    
    <script>
    // ==================== FUNCIONES PARA MANEJO DE LISTAS ====================
    
    // Variables globales para almacenar las listas del usuario
    let userLists = [];
    let userListsData = {};
    
    // Función para añadir una nueva lista al storage
    function addListToStorage(newList) {
      userLists.push(newList);
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para limpiar el cache de listas (útil para forzar recarga desde servidor)
    function clearListsCache() {
      sessionStorage.removeItem('userLists');
      sessionStorage.removeItem('userListsData');
      sessionStorage.removeItem('userListsTimestamp');
      userLists = [];
      userListsData = {};
      console.log('Cache de listas limpiado');
    }
    
    // Función para verificar si el cache es válido (opcional: añadir timestamp)
    function isCacheValid() {
      const cacheTimestamp = sessionStorage.getItem('userListsTimestamp');
      if (!cacheTimestamp) return false;
      
      const now = Date.now();
      const cacheTime = parseInt(cacheTimestamp);
      const maxAge = 30 * 60 * 1000; // 30 minutos
      
      return (now - cacheTime) < maxAge;
    }
    
    // Función mejorada para cargar las listas con validación de cache
    async function loadUserListsFromBackend(forceRefresh = false) {
      try {
        console.log(`[loadUserListsFromBackend] Iniciando carga con forceRefresh: ${forceRefresh}`);
        
        // Si se fuerza la recarga, limpiar cache
        if (forceRefresh) {
          console.log('[loadUserListsFromBackend] Forzando refresh - limpiando cache');
          clearListsCache();
        }
        
        // Intentar cargar desde sessionStorage primero si el cache es válido
        const cachedLists = sessionStorage.getItem('userLists');
        const cachedListsData = sessionStorage.getItem('userListsData');
        if (cachedLists && cachedListsData && !forceRefresh && isCacheValid()) {
          userLists = JSON.parse(cachedLists);
          userListsData = JSON.parse(cachedListsData);
          console.log('[loadUserListsFromBackend] Listas cargadas desde sessionStorage:', userLists);
          return;
        }
        
        // Si no hay datos en cache o no es válido, cargar desde el servidor
        console.log('[loadUserListsFromBackend] Cargando listas desde el servidor...');
        const response = await fetch('/api/get-user-lists', {
          credentials: 'same-origin'
        });
        if (response.ok) {
          const data = await response.json();
          userLists = data.lists || [];
          userListsData = data; // Almacenar los datos completos incluyendo 'guardados'
          
          // Guardar en sessionStorage con timestamp para futuras cargas
          sessionStorage.setItem('userLists', JSON.stringify(userLists));
          sessionStorage.setItem('userListsData', JSON.stringify(userListsData));
          sessionStorage.setItem('userListsTimestamp', Date.now().toString());
          console.log('[loadUserListsFromBackend] Listas cargadas desde servidor y guardadas en sessionStorage:', userLists);
          console.log('[loadUserListsFromBackend] Datos guardados completos:', userListsData);
        } else {
          console.error('[loadUserListsFromBackend] Error loading user lists:', response.statusText);
          userLists = [];
          userListsData = {};
        }
      } catch (error) {
        console.error('[loadUserListsFromBackend] Error loading user lists:', error);
        userLists = [];
        userListsData = {};
      }
    }
    
    // Función para actualizar las listas en sessionStorage
    function updateUserListsInStorage(newLists) {
      userLists = newLists;
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para añadir una nueva lista al storage
    function addListToStorage(newList) {
      userLists.push(newList);
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para extraer información del documento desde el DOM
    function extractDocumentData(dataItem) {
      const documentData = {};
      
      try {
        // Extraer información básica
        documentData.short_name = dataItem.querySelector('.id-values')?.textContent?.trim() || null;
        documentData.resumen = dataItem.querySelector('.resumen-content')?.textContent?.trim() || null;
        
        // Extraer fecha
        const dateElement = dataItem.querySelector('.date em');
        if (dateElement) {
          const dateText = dateElement.textContent.trim();
          const dateParts = dateText.split('/');
          if (dateParts.length === 3) {
            documentData.dia = parseInt(dateParts[0]) || null;
            documentData.mes = parseInt(dateParts[1]) || null;
            documentData.anio = parseInt(dateParts[2]) || null;
          }
        }
        
        // Extraer rango_titulo - buscar en diferentes posibles ubicaciones
        let rangoTitulo = null;
        
        // Buscar en el elemento con estilo de color gris
        const rangoElement = dataItem.querySelector('div[style*="color: gray"], div[style*="color:gray"]');
        if (rangoElement) {
          const rangoText = rangoElement.textContent.trim();
          const rangoParts = rangoText.split('|');
          if (rangoParts.length > 0) {
            rangoTitulo = rangoParts[0].trim();
          }
        }
        
        // Si no se encontró, buscar en otros elementos posibles
        if (!rangoTitulo) {
          const possibleRangoElements = dataItem.querySelectorAll('div');
          for (const element of possibleRangoElements) {
            const text = element.textContent.trim();
            if (text.includes('|') && (text.includes('BOE') || text.includes('DOUE') || text.includes('BOCG'))) {
              const parts = text.split('|');
              if (parts.length > 0) {
                rangoTitulo = parts[0].trim();
                break;
              }
            }
          }
        }
        
        documentData.rango_titulo = rangoTitulo;
        
        // Extraer URL del PDF
        const pdfLink = dataItem.querySelector('.leer-mas, a[href*=".pdf"], a[target="_blank"]');
        if (pdfLink) {
          documentData.url_pdf = pdfLink.getAttribute('href');
        }
        
        // Extraer etiquetas personalizadas de múltiples fuentes
        const etiquetas = [];
        
        // 1. Obtener etiquetas de ramas jurídicas
        const ramaTags = dataItem.querySelectorAll('.tag-rama');
        ramaTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText) etiquetas.push(tagText);
        });
        
        // 2. Obtener etiquetas de divisiones
        const divisionTags = dataItem.querySelectorAll('.tag-division');
        divisionTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText) etiquetas.push(tagText);
        });
        
        // 3. Buscar en elementos con clases de etiquetas
        const etiquetaTags = dataItem.querySelectorAll('.etiqueta-personalizada-value, .tag, [class*="tag-"], [class*="etiqueta"]');
        etiquetaTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText && !etiquetas.includes(tagText)) {
            etiquetas.push(tagText);
          }
        });
        
        // 4. Buscar en spans con estilos específicos (como los que tienen colores de etiquetas)
        const styledSpans = dataItem.querySelectorAll('span[style*="background"], span[class*="badge"], span[class*="chip"]');
        styledSpans.forEach(span => {
          const spanText = span.textContent.trim();
          if (spanText && !etiquetas.includes(spanText)) {
            etiquetas.push(spanText);
          }
        });
        
        documentData.etiquetas_personalizadas = etiquetas;
        
        console.log('Datos extraídos del documento:', documentData);
        
      } catch (error) {
        console.error('Error extracting document data:', error);
      }
      
      return documentData;
    }
    
    // Función para mostrar/ocultar el desplegable de listas
    async function toggleListsDropdown(buttonElement, documentId, collectionName) {
      // Cerrar otros desplegables abiertos
      document.querySelectorAll('.lists-dropdown.show').forEach(dropdown => {
        if (dropdown !== buttonElement.nextElementSibling) {
          dropdown.classList.remove('show');
        }
      });
      
      const dropdown = buttonElement.nextElementSibling;
      const isShowing = dropdown.classList.contains('show');
      
      if (!isShowing) {
        // Mostrar loader en el botón mientras carga
        const originalButtonContent = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
        buttonElement.disabled = true;
        
        try {
          // CRÍTICO: Forzar refresh de datos para asegurar estado actual
          console.log(`[toggleListsDropdown] Abriendo dropdown para documento ${documentId}`);
          await loadUserListsFromBackend(true);
          
          // Cargar las listas del usuario antes de mostrar
          loadUserLists(dropdown);
          
          // Ocultar el botón OK permanentemente (ya no se usa)
          const saveButton = dropdown.querySelector('.save-ok-btn');
          saveButton.style.display = 'none';
          
          // No desmarcar checkboxes - ahora se marcan automáticamente según el estado real
          
          dropdown.classList.add('show');
        } finally {
          // Restaurar botón original
          buttonElement.innerHTML = originalButtonContent;
          buttonElement.disabled = false;
        }
      } else {
        dropdown.classList.remove('show');
      }
      
      // Prevenir que el evento se propague
      event.stopPropagation();
    }
    
    // Función para cargar las listas del usuario en el desplegable
    function loadUserLists(dropdown) {
      const listsContainer = dropdown.querySelector('.lists-container');
      
      if (userLists.length === 0) {
        listsContainer.innerHTML = '<div class="no-lists-message">No tienes listas creadas</div>';
      } else {
        // Obtener información del documento actual
        const saveButton = dropdown.closest('.guardar-button');
        const mainButton = saveButton.querySelector('.save-btn');
        const onclickAttr = mainButton.getAttribute('onclick');
        const matches = onclickAttr.match(/toggleListsDropdown\(this, '([^']+)', '([^']+)'\)/);
        const documentId = matches ? matches[1] : null;
        
        console.log(`[loadUserLists] Cargando listas para documento ${documentId}`);
        console.log(`[loadUserLists] Datos de userListsData:`, userListsData);
        
        listsContainer.innerHTML = userLists.map(list => {
          // Verificar si el documento ya está guardado en esta lista
          const isDocumentSaved = checkIfDocumentSaved(list.name, documentId);
          const checkedAttribute = isDocumentSaved ? 'checked' : '';
          
          console.log(`[loadUserLists] Lista "${list.name}" (${list.id}): documento ${isDocumentSaved ? 'SÍ' : 'NO'} guardado`);
          
          return `<div class="list-item">
            <div class="checkbox-container">
              <input type="checkbox" id="list_${list.id}" value="${list.id}" ${checkedAttribute} onchange="handleListCheckboxChange(this, '${documentId}')">
              <div class="checkbox-loader" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
            </div>
            <label for="list_${list.id}" class="list-label">
              <span class="list-name">${list.name}</span>
            </label>
          </div>`;
        }).join('');
      }
    }
    
    // Función para verificar si un documento está guardado en una lista específica
    function checkIfDocumentSaved(listName, documentId) {
      if (!documentId || !userListsData || !userListsData.guardados) {
        console.log(`[checkIfDocumentSaved] Missing data - documentId: ${documentId}, userListsData: ${!!userListsData}, guardados: ${!!userListsData?.guardados}`);
        return false;
      }
      
      const listData = userListsData.guardados[listName];
      if (!listData) {
        console.log(`[checkIfDocumentSaved] Lista "${listName}" no encontrada`);
        return false;
      }
      
      // Verificar si el documento existe en esta lista
      const isDocumentInList = listData.hasOwnProperty(documentId);
      console.log(`[checkIfDocumentSaved] Documento ${documentId} en lista "${listName}": ${isDocumentInList}`);
      return isDocumentInList;
    }
    
    // Función para manejar el cambio de checkbox de lista (acción directa)
    async function handleListCheckboxChange(checkbox, documentId) {
      const dropdown = checkbox.closest('.lists-dropdown');
      const saveButton = dropdown.closest('.guardar-button');
      const dataItem = saveButton.closest('.data-item');
      const listId = checkbox.value;
      
      // Obtener información del documento y lista
      const mainButton = saveButton.querySelector('.save-btn');
      const onclickAttr = mainButton.getAttribute('onclick');
      const matches = onclickAttr.match(/toggleListsDropdown\(this, '([^']+)', '([^']+)'\)/);
      const collectionName = matches ? matches[2] : null;
      
      if (!collectionName) {
        alert('Error: No se pudo obtener la información del documento');
        checkbox.checked = !checkbox.checked; // Revertir cambio
        return;
      }
      
      const listName = userLists.find(list => list.id === listId)?.name;
      if (!listName) {
        alert('Error: No se pudo encontrar la lista');
        checkbox.checked = !checkbox.checked; // Revertir cambio
        return;
      }
      
      // Aplicar feedback visual inmediato - sustituir checkbox por loader
      const checkboxContainer = checkbox.closest('.checkbox-container');
      const loader = checkboxContainer.querySelector('.checkbox-loader');
      
      // Ocultar checkbox y mostrar loader en su lugar
      checkbox.style.display = 'none';
      loader.style.display = 'inline-block';
      
      if (checkbox.checked) {
        // Agregar a la lista
        const documentData = extractDocumentData(dataItem);
        await saveDocumentToList(documentId, collectionName, listId, documentData, checkbox, loader);
      } else {
        // Quitar de la lista
        await removeDocumentFromList(documentId, listId, listName, checkbox, loader);
      }
    }
    
    // Función para actualizar la visibilidad del botón OK (mantenida para compatibilidad)
    function updateSaveButton(checkbox) {
      // Esta función ya no se usa con el nuevo comportamiento directo
      // Mantenida solo para compatibilidad con código existente
    }
    
    // Función para guardar un documento en una lista específica
    async function saveDocumentToList(documentId, collectionName, listId, documentData, checkbox, loader) {
      try {
        const response = await fetch('/api/save-document-to-lists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            documentId: documentId,
            collectionName: collectionName,
            listIds: [listId],
            documentData: documentData
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Documento guardado exitosamente:', result);
          
          // CRÍTICO: Forzar refresh del cache desde el servidor
          await loadUserListsFromBackend(true);
          
          // Actualizar cache local inmediatamente para reflejar el cambio
          const listName = userLists.find(list => list.id === listId)?.name;
          if (listName && userListsData.guardados) {
            if (!userListsData.guardados[listName]) {
              userListsData.guardados[listName] = {};
            }
            userListsData.guardados[listName][documentId] = {
              documentId: documentId,
              collectionName: collectionName,
              savedAt: new Date(),
              ...documentData
            };
            
            // Actualizar sessionStorage con los nuevos datos
            sessionStorage.setItem('userListsData', JSON.stringify(userListsData));
          }
          
          // Estado final exitoso: mostrar checkbox marcado y ocultar loader
          checkbox.checked = true;
          checkbox.style.accentColor = '#04db8d';
          checkbox.style.display = 'inline-block';
          loader.style.display = 'none';
        } else {
          const error = await response.json();
          alert('Error al guardar el documento: ' + (error.message || 'Error desconocido'));
          // Revertir estado en caso de error
          checkbox.checked = false;
          checkbox.style.accentColor = '';
          checkbox.style.display = 'inline-block';
          loader.style.display = 'none';
        }
      } catch (error) {
        console.error('Error saving document:', error);
        alert('Error al guardar el documento. Por favor, inténtalo de nuevo.');
        // Revertir estado en caso de error
        checkbox.checked = false;
        checkbox.style.accentColor = '';
        checkbox.style.display = 'inline-block';
        loader.style.display = 'none';
      }
    }
    
    // Función para quitar un documento de una lista específica
    async function removeDocumentFromList(documentId, listId, listName, checkbox, loader) {
      try {
        const response = await fetch('/api/remove-document-from-list', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            documentId: documentId,
            listId: listId,
            listName: listName
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Documento removido exitosamente:', result);
          
          // CRÍTICO: Forzar refresh del cache desde el servidor
          await loadUserListsFromBackend(true);
          
          // Actualizar cache local inmediatamente para reflejar el cambio
          if (listName && userListsData.guardados && userListsData.guardados[listName]) {
            delete userListsData.guardados[listName][documentId];
            
            // Actualizar sessionStorage con los nuevos datos
            sessionStorage.setItem('userListsData', JSON.stringify(userListsData));
          }
          
          // Estado final exitoso: mostrar checkbox desmarcado y ocultar loader
          checkbox.checked = false;
          checkbox.style.accentColor = '';
          checkbox.style.display = 'inline-block';
          loader.style.display = 'none';
        } else {
          const error = await response.json();
          alert('Error al eliminar el documento: ' + (error.message || 'Error desconocido'));
          // Revertir estado en caso de error
          checkbox.checked = true;
          checkbox.style.accentColor = '#04db8d';
          checkbox.style.display = 'inline-block';
          loader.style.display = 'none';
        }
      } catch (error) {
        console.error('Error removing document:', error);
        alert('Error al eliminar el documento. Por favor, inténtalo de nuevo.');
        // Revertir estado en caso de error
        checkbox.checked = true;
        checkbox.style.accentColor = '#04db8d';
        checkbox.style.display = 'inline-block';
        loader.style.display = 'none';
      }
    }
    
    // Función para mostrar feedback visual (DEPRECATED - eliminada)
    // Esta función ya no se usa con el nuevo sistema de feedback visual inmediato
    
    // Función para guardar en las listas seleccionadas (mantenida para compatibilidad)
    async function saveToSelectedLists(okButton) {
      const dropdown = okButton.closest('.lists-dropdown');
      const checkedBoxes = dropdown.querySelectorAll('.lists-container input[type="checkbox"]:checked');
      
      if (checkedBoxes.length === 0) {
        alert('Por favor, selecciona al menos una lista');
        return;
      }
      
      // Obtener información del documento
      const saveButton = dropdown.closest('.guardar-button');
      const dataItem = saveButton.closest('.data-item');
      
      // Obtener el documentId y collectionName desde el botón
      const mainButton = saveButton.querySelector('.save-btn');
      const onclickAttr = mainButton.getAttribute('onclick');
      const matches = onclickAttr.match(/toggleListsDropdown\(this, '([^']+)', '([^']+)'\)/);
      const documentId = matches ? matches[1] : null;
      const collectionName = matches ? matches[2] : null;
      
      if (!documentId || !collectionName) {
        alert('Error: No se pudo obtener la información del documento');
        return;
      }
      
      // Extraer información completa del documento
      const documentData = extractDocumentData(dataItem);
      
      // Obtener las listas seleccionadas
      const selectedListIds = Array.from(checkedBoxes).map(cb => cb.value);
      
      try {
        // Guardar el documento en las listas seleccionadas
        const response = await fetch('/api/save-document-to-lists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin', // Incluir cookies de autenticación
          body: JSON.stringify({
            documentId: documentId,
            collectionName: collectionName,
            listIds: selectedListIds,
            documentData: documentData
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Documento guardado exitosamente:', result);
          
          // Mostrar feedback visual en el botón principal
          const mainSaveBtn = saveButton.querySelector('.save-btn');
          const originalText = mainSaveBtn.innerHTML;
          mainSaveBtn.innerHTML = '<i class="fas fa-check"></i> Guardado';
          mainSaveBtn.style.backgroundColor = '#04db8d';
          mainSaveBtn.style.color = 'white';
          
          // Cerrar el desplegable inmediatamente
          dropdown.classList.remove('show');
          
          // Resetear checkboxes y botón OK
          checkedBoxes.forEach(cb => cb.checked = false);
          okButton.classList.remove('show');
          
          setTimeout(() => {
            mainSaveBtn.innerHTML = originalText;
            mainSaveBtn.style.backgroundColor = '';
            mainSaveBtn.style.color = '';
          }, 2000);
        } else {
          const error = await response.json();
          alert('Error al guardar el documento: ' + (error.message || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error saving document:', error);
        alert('Error al guardar el documento. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Función para guardar un documento en una lista existente (DEPRECATED - mantenida por compatibilidad)
    function saveToList(listId, listName, element) {
      // Esta función ya no se usa con la nueva lógica de checkboxes
      console.log('saveToList is deprecated, use saveToSelectedLists instead');
    }
    
    // Función para mostrar el formulario de nueva lista
    function showNewListForm(element) {
      const dropdown = element.closest('.lists-dropdown');
      const newListForm = dropdown.querySelector('.new-list-form');
      const addNewButton = dropdown.querySelector('.add-new-list');
      
      addNewButton.style.display = 'none';
      newListForm.classList.add('show');
      
      // Enfocar el input
      const input = newListForm.querySelector('.new-list-input');
      input.focus();
      input.value = '';
    }
    
    // Función para ocultar el formulario de nueva lista
    function hideNewListForm(element) {
      const dropdown = element.closest('.lists-dropdown');
      const newListForm = dropdown.querySelector('.new-list-form');
      const addNewButton = dropdown.querySelector('.add-new-list');
      
      newListForm.classList.remove('show');
      addNewButton.style.display = 'flex';
    }
    
    // Función para crear una nueva lista
    async function createNewList(element, documentId, collectionName) {
      const dropdown = element.closest('.lists-dropdown');
      const input = dropdown.querySelector('.new-list-input');
      const listName = input.value.trim();
      
      if (!listName) {
        alert('Por favor, introduce un nombre para la lista');
        input.focus();
        return;
      }
      
      // Verificar que no existe una lista con el mismo nombre
      if (userLists.some(list => list.name.toLowerCase() === listName.toLowerCase())) {
        alert('Ya existe una lista con ese nombre');
        input.focus();
        return;
      }
      
      try {
        // Debug: Imprimir datos que se van a enviar
        console.log('Enviando datos a la API:', { listName: listName });
        console.log('Longitud del nombre de lista:', listName.length);
        console.log('Tipo de dato:', typeof listName);
        
        // Verificar autenticación primero
        console.log('Verificando autenticación...');
        const testResponse = await fetch('/api/get-user-lists', {
          credentials: 'same-origin'
        });
        console.log('Test de autenticación:', testResponse.status, testResponse.statusText);
        
        // Crear nueva lista en el backend
        const response = await fetch('/api/create-user-list', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin', // Incluir cookies de autenticación
          body: JSON.stringify({
            listName: listName
          })
        });
        
        console.log('Respuesta de la API:', response.status, response.statusText);
        
        if (response.ok) {
          const result = await response.json();
          console.log('Lista creada exitosamente:', result);
          
          // Añadir la nueva lista al array local y sessionStorage
          const newList = {
            id: result.listId,
            name: listName
          };
          addListToStorage(newList);
          
          // Recargar las listas en el desplegable
          loadUserLists(dropdown);
          
          // Seleccionar automáticamente la nueva lista
          const newCheckbox = dropdown.querySelector(`input[value="${newList.id}"]`);
          if (newCheckbox) {
            newCheckbox.checked = true;
            updateSaveButton(newCheckbox);
          }
          
          // Ocultar el formulario
          hideNewListForm(element);
        } else {
          let errorMessage = `Error ${response.status}: ${response.statusText}`;
          try {
            const error = await response.json();
            console.log('Error detallado de la API:', error);
            errorMessage = error.error || error.message || errorMessage;
          } catch (e) {
            console.log('No se pudo parsear el error JSON');
          }
          alert('Error al crear la lista: ' + errorMessage);
          console.error('Error completo:', { status: response.status, statusText: response.statusText });
        }
      } catch (error) {
        console.error('Error creating list:', error);
        alert('Error al crear la lista. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Cerrar desplegables al hacer clic fuera
    document.addEventListener('click', function(event) {
      if (event.target && !event.target.closest('.guardar-button')) {
        document.querySelectorAll('.lists-dropdown.show').forEach(dropdown => {
          dropdown.classList.remove('show');
        });
      }
    });
    
    // Manejar Enter en el input de nueva lista
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' && event.target.classList.contains('new-list-input')) {
        const saveButton = event.target.closest('.new-list-form').querySelector('.new-list-btn.save');
        saveButton.click();
      }
    });
    
      </script>


    <script>
      // ==================== FUNCIONES PARA MOSTRAR CONFIGURACION DE CUENTA ====================
    // Function to show the configuration section
    function showConfiguracionSection() {
      // Remove active class from all sidebar items
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      
      // Add active class to configuration sidebar item
      const configItem = document.querySelector('.sidebar-item[data-target="content-configuracion"]');
      if (configItem) {
        configItem.classList.add('active');
      }
      
      // Hide all content sections
      document.querySelectorAll('.vision-section').forEach(section => section.style.display = 'none');
      
      // Show configuration section
      const configSection = document.getElementById('content-configuracion');
      if (configSection) {
        configSection.style.display = 'block';
        loadConfiguracionContent();
      }
    }
    
    // Function to load configuration content
    function loadConfiguracionContent() {
      const container = document.getElementById('configuracion-iframe-container');
      if (!container) return;
      
      // Check if content is already loaded
      if (container.innerHTML.trim() !== '<!-- The configuration content will be loaded here -->') {
        // Content already loaded, just initialize the menu
        if (window.initializeConfigurationMenu) {
          window.initializeConfigurationMenu();
        }
        return;
      }
      
      // Load the configuration content
      fetch('views/configuracion/configuracion_cuenta.html')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(html => {
          // Extract the body content from the HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const bodyContent = doc.body.innerHTML;
          
          container.innerHTML = bodyContent;
          
          // Append styles from the loaded document head to the main document head
          const headStyles = doc.head.querySelectorAll('style, link[rel="stylesheet"]');
          headStyles.forEach(styleEl => {
            document.head.appendChild(styleEl.cloneNode(true));
          });
          
          // Re-execute any scripts in the loaded content
          const scripts = container.querySelectorAll('script');
          scripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.head.appendChild(newScript);
            script.remove();
          });
          
          // Initialize the configuration menu after a short delay to ensure DOM is ready
          setTimeout(() => {
            if (window.initializeConfigurationMenu) {
              window.initializeConfigurationMenu();
            }
            
            // Ocultar overlay principal después de cargar configuración
            if (typeof window.hidePageLoaderOverlay === 'function') {
              window.hidePageLoaderOverlay();
            }
          }, 200);
        })
        .catch(error => {
          console.error('Error loading configuration content:', error);
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <h3>Error al cargar la configuración</h3>
              <p>Por favor, inténtalo de nuevo más tarde.</p>
            </div>
          `;
        });
    }
    
    </script>
</body>

<script>
// ------------------ TRASH ICON + DELETE DOC FUNCTIONALITY ------------------
(function() {
  const userEmailElement = document.getElementById('userEmail');
  if (!userEmailElement) return;
  let userEmail = '';
  try { userEmail = JSON.parse(userEmailElement.textContent || '""'); } catch(e){ userEmail=''; }
  if (!userEmail.endsWith('@reversademo.com')) return; //reversademo.com

  // Utility to add icons whenever documents list changes
  function addTrashIcons() {
    document.querySelectorAll('.data-item').forEach(item => {
      // Skip if already has icon
      if (item.querySelector('.delete-doc-btn')) return;
      // Parse document id & collection from analyze link
      const analyzeLink = item.querySelector('a.button-impacto');
      if (!analyzeLink) return;
      try {
        const url = new URL(analyzeLink.getAttribute('href'), window.location.origin);
        const docId = url.searchParams.get('documentId');
        const collectionName = url.searchParams.get('collectionName');
        if (!docId || !collectionName) return;
        // Ensure parent is relative
        if (getComputedStyle(item).position === 'static') {
          item.style.position = 'relative';
        }
        const icon = document.createElement('i');
        icon.className = 'fas fa-trash delete-doc-btn';
        icon.dataset.docId = docId;
        icon.dataset.collection = collectionName;
        Object.assign(icon.style, {
          position: 'absolute',
          bottom: '10px',
          right: '10px',
          color: '#999',
          cursor: 'pointer'
        });
        item.appendChild(icon);
      } catch(err){ console.error(err); }
    });
  }

  // Modal helper
  function showDeleteModal(targetItem, docId, collectionName) {
    const overlay = document.createElement('div');
    Object.assign(overlay.style, {
      position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
      background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10000
    });

    const modal = document.createElement('div');
    Object.assign(modal.style, {
      background: '#fff', padding: '30px 25px', borderRadius: '8px', maxWidth: '420px', textAlign: 'center', width: '90%'
    });
    modal.innerHTML = '<p style="font-size:16px;margin-bottom:25px;">¿Seguro que quieres eliminar este documento de tu tracker normativo?</p>';

    const yesBtn = document.createElement('button');
    yesBtn.textContent = 'Sí';
    Object.assign(yesBtn.style, { background:'#04db8d', color:'#fff', border:'none', padding:'8px 22px', marginRight:'12px', borderRadius:'4px', cursor:'pointer' });

    const noBtn = document.createElement('button');
    noBtn.textContent = 'No';
    Object.assign(noBtn.style, { background:'transparent', color:'#04db8d', border:'1px solid #04db8d', padding:'8px 22px', borderRadius:'4px', cursor:'pointer' });

    modal.appendChild(yesBtn); modal.appendChild(noBtn); overlay.appendChild(modal); document.body.appendChild(overlay);

    noBtn.addEventListener('click', () => overlay.remove());
    yesBtn.addEventListener('click', () => {
      fetch('/delete-document', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ collectionName, documentId: docId })
      }).then(resp => {
        if(!resp.ok) throw new Error('Error');
        targetItem.remove();
      }).catch(err => { alert('No se pudo eliminar el documento'); console.error(err); })
      .finally(()=> overlay.remove());
    });
  }

  // Delegated click handler
  document.body.addEventListener('click', e => {
    if (e.target.classList.contains('delete-doc-btn')) {
      e.stopPropagation();
      const icon = e.target;
      const docId = icon.dataset.docId;
      const collectionName = icon.dataset.collection;
      const item = icon.closest('.data-item');
      showDeleteModal(item, docId, collectionName);
    }
  });

  // Observe changes on collectionDocs container
  const docsContainer = document.querySelector('.collectionDocs');
  if (docsContainer) {
    const observer = new MutationObserver(() => addTrashIcons());
    observer.observe(docsContainer, { childList: true, subtree: true });
  }
  // Initial run
  addTrashIcons();
})();
</script>
</body>

</html>
