<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Profile</title>
    <link rel="icon" href="assets\reversa_logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="styles/styles.css" />
    <link rel="stylesheet" type="text/css" href="styles/menu.css" />
    <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
    <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
    <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
    <link rel="stylesheet" type="text/css" href="styles/mobile.css" />
    <style>

      :root {
        --primary-color: #04db8d;
        --secondary-color: #455862;
        --border-color: #e0e0e0;
        --text-color: #0b2431;
        --placeholder-color: #999;
        --active-color: #04db8d;
        --error-color: #d32f2f;
        --background-color: #ffffff;

        /*tab background color: #f8f8f8*/
      }
        #analysisResult {
            margin-top: 20px;
            padding: 20px 30px;
            border: 1px solid #ccc;
            border-radius: 20px;
            text-align: left;
            display: none;
            background-color: #ffffff;
        }

        body {
          font-family: 'Satoshi', sans-serif;
          background: radial-gradient(circle at 50% 0, rgba(4, 219, 141, 0.25) 0%, #ffffff 70%);
          margin: 0;
          padding: 0;
          min-height: 100vh;
        }

        #loader {
            display: none; /* Hidden by default */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .analisis-impacto {
            background: transparent;
            color: var(--text-color);
            padding: 8px 16px;
            border: 1px solid #999;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 2%;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .analisis-impacto .icon {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .analisis-impacto:hover {
            background-color: var(--text-color);
            border: none;
            color: white;
           /* transform: translateY(-1px);*/
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .analisis-impacto:hover .icon {
            color: white;
        }
        
        /* Styling for active analysis buttons */
        .analisis-impacto.active {
            background-color: var(--text-color);
            color: white;
            border: 1px solid var(--text-color);
        }
        
        .analisis-impacto.active .icon {
            color: white;
        }
          .container-norma {
            max-width: 1100px; 
            margin: 40px auto; 
            padding: 30px;     
            border-radius: 12px; 
            text-align: center;
          }
          /* Style the input field */
          .user-prompt {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: 'Heebo', sans-serif;
            text-align: left;
            resize: vertical; /* This enables vertical resizing */
            overflow: auto;
            min-height: 100px;
            /* height: auto;
            white-space: pre-wrap; /* Allows line breaks within the text area */
            word-break: break-word;/*Break on new word, not letter*/
             spellcheck: false; /* Disable spellcheck */
             padding-right: 45px; /* Add space for the button */
        }


        /* Add focus style */
        .user-prompt:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 5px rgba(131, 163, 0, 0.5);
        }

        /* Style the container for the input and button */
        .input-button-container {
          display: flex;
          flex-direction: column;
          align-items: center; /* Aligns items to the start (left) */
          width: 100%;
          margin-bottom: 20px;
          position: relative;
        }
        
        /* Wrapper for textarea to contain the button */
        .textarea-wrapper {
          position: relative;
          width: 100%;
        }
        .input-button-container > * {
            margin-bottom: 10px; /* Adds spacing between elements */
        }
        
        /* Style for the custom prompt submit button */
        #sendCustomPrompt {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background-color: var(--text-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 15;
        }
        
        #sendCustomPrompt:hover {
            background-color: #03c57f;
        }
        
        /* When textarea is focused, ensure the button is visible */
        .user-prompt:focus + #sendCustomPrompt {
            opacity: 1;
        }
        
        /* Table styling for checklist */
        #analysisResult table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        #analysisResult th, #analysisResult td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }
        
        #analysisResult th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        
        #analysisResult tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /*feedback*/

                #feedbackSection {
          margin-top: 20px;
          border: 1px solid #ccc;
          border-radius: 20px;
          overflow: hidden;
        }

        #feedbackToggle {
          display: flex;
          justify-content: space-between;
          padding: 10px 15px;
          background-color: #ffffff;
          cursor: pointer;
        }

        #feedbackContent {
          padding: 15px;
        }

        #feedbackText {
          width: 95%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 20px;
          margin-bottom: 10px;
          resize: vertical;
          min-height: 80px;
        }

        #sendFeedbackBtn {
          margin-top: 10px;
        }

        .feedback-success {
          color: var(--primary-color);
          margin-top: 10px;
          font-weight: bold;
        }

        /* Dropdown para selección de agentes */
        .analysis-dropdown {
            display: none;
            position: relative;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .dropdown-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            text-align: left;
        }

        .etiquetas-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .etiqueta-btn {
            background: #f2f2f2;
            border: 1px solid #dcdcdc;
            color: #455862;
            padding: 8px 14px;
            border-radius: 14px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .etiqueta-btn:hover {
            background: #e6e6e6;
        }

        .etiqueta-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .start-analysis-btn {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .start-analysis-btn:hover {
            background: var(--text-color);
            color: white;
        }

        .start-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Hidden class for original etiquetas selector */
        #etiquetasSelectorContainer {
            display: none;
        }

        /* ---------- STATUS WORKFLOW ---------- */
        #analysisStatus {
            margin-top: 15px;
            display: none;
            font-size: 15px;
            color: var(--text-color);
            font-weight: 500;
            align-items: center;
            gap: 8px;
            justify-content: flex-start; /* left align */
            position: relative;
            width: 100%;
        }

        #analysisStatus .spinner {
            font-size: 16px;
            animation: spin 2s linear infinite;
        }

        /* shimmer effect - PRECISE TEXT ONLY */
        .shimmer-text {
            position: relative;
            display: inline-block;
            color: var(--text-color);
            overflow: hidden; /* This ensures shimmer doesn't go beyond text */
        }

        .shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: -50px; /* Start from left edge */
            width: 50px; /* Fixed width shimmer bar */
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
            animation: shimmer-slide 3s infinite;
        }

        @keyframes shimmer-slide {
          0% { 
            left: -50px; 
          }
          100% { 
            left: 100%; 
          }
        }

        /* slide-in subtle animation */
        .slide {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(-8px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* Analysis result render animation */
        .analysis-render {
            animation: renderFromTop 0.8s ease-out;
        }

        @keyframes renderFromTop {
            0% { 
                opacity: 0; 
                transform: translateY(-20px);
                max-height: 0;
            }
            100% { 
                opacity: 1; 
                transform: translateY(0);
                max-height: none;
            }
        }

        /* Completed status animation */
        .status-completed {
            animation: statusComplete 0.5s ease-out;
        }

        @keyframes statusComplete {
            0% { opacity: 1; }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-10px); }
        }

    </style>
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "r7ltvtr85q");
  </script>
</head>
<body>

     <!-- Loader overlay -->
<div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

    <nav class="navbar">
      <div class="logo">
          <a href="https://reversa.ai/" target="_blank">
            <img src="assets/reversa_blue.png" alt="Reversa Logo">
          </a>
        </div>
      <button class="hamburger" onclick="toggleMenu()">☰</button> 
      
        <ul class="menu">
          <li><a href="https://reversa.ai/">WEB</a></li>
          <li><a href="https://app.reversa.ai/profile">PANEL DE CONTROL</a></li> <!--cambiar-->
          <li><a href="http://app.reversa.ai/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
          <li><a href="https://reversa.ai/pages/contact-1">AYUDA</a></li>
        </ul>
    </nav>

    <div class="container-norma">
      <h2 > <span id="normaShortName"></span></h2>
      <div id="normaExtraDetails" style="font-size: large; color: #757575; margin-top: 4px; margin-bottom: 15px; line-height: 1.4;"></div>

    <div id="normaDetails">
        <!-- This will be populated with data from MongoDB -->
        <h2>  </h2>
           <!-- <label for="userPrompt">Custom Prompt:</label> --> </div>
             <div class="input-button-container">

<div class="textarea-wrapper">
<textarea class="user-prompt" id="userPrompt" name="userPrompt" placeholder="Escribe aquí para analizar la norma..." spellcheck="false"></textarea>
<button id="sendCustomPrompt" title="Enviar consulta personalizada">↑</button>
</div>
<div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
    <button id="analyzeButton" class="analisis-impacto">
        <i class="fa fa-file-text-o icon"></i>
        <span>Realizar resumen</span>
    </button>
    <button id="checklistButton" class="analisis-impacto">
        <span class="icon">☐</span>
        <span>Cuadro de obligaciones</span>
    </button>
    <button id="risksButton" class="analisis-impacto">
        <span class="icon">⚠</span>
        <span>Riesgos y oportunidades</span>
    </button>
</div>

<!-- Dropdown para selección de agentes -->
<div id="analysisDropdown" class="analysis-dropdown">
    <div class="dropdown-title">Selecciona agentes</div>
    <div id="etiquetasList" class="etiquetas-list">
        <!-- Las etiquetas se llenarán dinámicamente -->
    </div>
    <button id="startAnalysisBtn" class="start-analysis-btn">Empezar análisis</button>
</div>

</div>
    <div id="analysisResult"></div>

    <!-- Status workflow indicator -->
    <div id="analysisStatus"><i class="fa fa-spinner spinner"></i> <span class="shimmer-text"></span></div>

<!-- Sección de Feedback -->
<div id="feedbackSection" style="display: none;">
  <div id="feedbackToggle">
    <span style="font-weight: 700;">Feedback</span>
    <i class="fa fa-chevron-down"></i>
  </div>
  <div id="feedbackContent" style="display: none;">
    <textarea id="feedbackText" placeholder="Indícanos tu opinión para que podamos seguir mejorando"></textarea>
    <button id="sendFeedbackBtn" class="analisis-impacto">Enviar feedback</button>
  </div>
</div>

</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const shortNameSpan = document.getElementById('normaShortName');
        const analyzeButton = document.getElementById('analyzeButton');
        const checklistButton = document.getElementById('checklistButton');
        const risksButton = document.getElementById('risksButton');
        const sendCustomPromptButton = document.getElementById('sendCustomPrompt');
        const analysisResultDiv = document.getElementById('analysisResult');
        const loaderDiv = document.getElementById('loader');
        const pageLoaderOverlay = document.getElementById('pageLoaderOverlay'); // Select the overlay
        const userPromptInput = document.getElementById('userPrompt');
        const analysisStatusDiv = document.getElementById('analysisStatus');
        const statusTextSpan = analysisStatusDiv.querySelector('.shimmer-text');
        const analysisDropdown = document.getElementById('analysisDropdown');
        const etiquetasList = document.getElementById('etiquetasList');
        const startAnalysisBtn = document.getElementById('startAnalysisBtn');
        let statusTimeouts = [];
        let currentAnalysisType = null;
        let activeAnalysisButton = null;

        // Get the document ID from the URL (you can change this if you pass it differently)
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get('documentId');
        const collectionName = urlParams.get('collectionName'); // Get the collection from URL

        // Función para mostrar la sección de feedback
        function showFeedbackSection() {
          const feedbackSection = document.getElementById('feedbackSection');
          feedbackSection.style.display = 'block';
        }

        // Add event listener for custom prompt button
        sendCustomPromptButton.addEventListener('click', () => {
            handleCustomPrompt();
        });

        // Also allow pressing Enter in the textarea to submit
        userPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleCustomPrompt();
            }
        });

        // Function to handle custom prompt submissions
        function handleCustomPrompt() {
            const userInput = userPromptInput.value.trim();
            if (!userInput) {
                alert('Por favor, escribe una consulta antes de enviar.');
                return;
            }
            
            const customPrompt = `${userInput}

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML solo puede incluir <h2>, <p>, <ul>, <li>, <b>. Nada más.  
• Sin saltos de línea innecesarios ni Markdown.`;
            
            performCustomAnalysis(customPrompt, sendCustomPromptButton);
        }

        // Function for custom prompt analysis
        function performCustomAnalysis(customPrompt, buttonElement) {
            analysisResultDiv.textContent = ''; // Clear previous results
            analysisResultDiv.classList.remove('analysis-render'); // Remove previous animation
            
            // Disable all buttons during analysis
            setAnalysisButtonsState(true);
            
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i>'; // Show loading icon
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Start status workflow for custom analysis
            if (typeof startStatusWorkflow === 'function') startStatusWorkflow();
            
            fetch('/api/analyze-norma', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/html; charset=utf-8'
                },
                body: JSON.stringify({ documentId: documentId, userPrompt: customPrompt, collectionName: collectionName })
            })
            .then(response => {
                // Ensure we're properly handling the UTF-8 encoding
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('charset=utf-8')) {
                    return response.text();
                }
                // Explicitly decode as UTF-8 if charset not specified
                return response.arrayBuffer().then(buffer => {
                    const decoder = new TextDecoder('utf-8');
                    return decoder.decode(buffer);
                });
            })
            .then(data => {
                // Process the response
                const htmlContent = data.replace(/^```html\s*|\s*```|^<\!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<\!DOCTYPE html>/g, '');
                
                // Complete the status workflow with success animation
                completeStatusWorkflow();
                
                // After status animation completes, show results with animation
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText; // Restore original button text
                    
                    // Enable all buttons again
                    setAnalysisButtonsState(false);
                    
                    // Set content and show with animation
                    analysisResultDiv.innerHTML = htmlContent; // Set as HTML
                    analysisResultDiv.classList.add('analysis-render'); // Add render animation
                    analysisResultDiv.style.display = 'block'; // Show the analysis result div
                    
                    showFeedbackSection();
                }, 1300); // Wait for status completion animation
            })
            .catch(error => {
                console.error('Error analyzing norma:', error);
                
                // Complete the status workflow first, then show error
                clearStatusWorkflow();
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText; // Restore original button text
                    
                    // Enable all buttons again
                    setAnalysisButtonsState(false);
                    
                    analysisResultDiv.textContent = 'Error al analizar la norma. Por favor, inténtalo de nuevo.';
                    analysisResultDiv.classList.add('analysis-render'); // Add render animation
                    analysisResultDiv.style.display = 'block'; // Show the analysis result div
                }, 1300); // Wait for status completion animation
            });
        }

        // Function to disable/enable analysis buttons
        function setAnalysisButtonsState(disabled) {
            const buttons = [analyzeButton, checklistButton, risksButton, sendCustomPromptButton];
            buttons.forEach(btn => {
                btn.disabled = disabled;
                if (disabled) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        // Function to show analysis dropdown with agent selection
        function showAnalysisDropdown(analysisType, buttonElement) {
            currentAnalysisType = analysisType;
            activeAnalysisButton = buttonElement;
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set this button as active
            buttonElement.classList.add('active');
            
            // Populate etiquetas list
            const etiquetasData = window.getEtiquetasData ? window.getEtiquetasData() : {};
            etiquetasList.innerHTML = '';
            
            if (etiquetasData && Object.keys(etiquetasData).length > 0) {
                Object.keys(etiquetasData).forEach(etiqueta => {
                    const btn = document.createElement('button');
                    btn.className = 'etiqueta-btn';
                    btn.textContent = etiqueta;
                                        btn.addEventListener('click', () => {
                        const isAlreadySelected = btn.classList.contains('selected');
                        
                        // Toggle selection
                        etiquetasList.querySelectorAll('.etiqueta-btn').forEach(b => b.classList.remove('selected'));
                        
                        const startBtn = document.getElementById('startAnalysisBtn');
                        const analysisTypeText = {
                            'summary': 'resumen',
                            'checklist': 'cuadro de obligaciones', 
                            'risks': 'riesgos y oportunidades'
                        };
                        
                        if (isAlreadySelected) {
                            // Deselect - reset to generic
                            if (window.setSelectedEtiqueta) {
                                window.setSelectedEtiqueta(null, null);
                            }
                            if (startBtn) {
                                startBtn.textContent = `Generar ${analysisTypeText[currentAnalysisType] || 'análisis'} genérico`;
                            }
                        } else {
                            // Select this etiqueta
                            btn.classList.add('selected');
                            
                            // Update global selection
                            if (window.setSelectedEtiqueta) {
                                window.setSelectedEtiqueta(etiqueta, etiquetasData[etiqueta]);
                            }
                            
                            // Update start button text to show personalized
                            if (startBtn) {
                                startBtn.textContent = `Generar ${analysisTypeText[currentAnalysisType] || 'análisis'} personalizado`;
                            }
                        }
                    });
                    etiquetasList.appendChild(btn);
                });
            } else {
                const noEtiquetasMsg = document.createElement('div');
                noEtiquetasMsg.style.color = '#999';
                noEtiquetasMsg.style.fontStyle = 'italic';
                noEtiquetasMsg.textContent = 'No hay agentes disponibles para este documento';
                etiquetasList.appendChild(noEtiquetasMsg);
            }
            
            // Reset start button text - initially shows "genérico"
            const analysisTypeText = {
                'summary': 'resumen',
                'checklist': 'cuadro de obligaciones', 
                'risks': 'riesgos y oportunidades'
            };
            startAnalysisBtn.textContent = `Generar ${analysisTypeText[analysisType] || 'análisis'} genérico`;
            
            // Show dropdown
            analysisDropdown.style.display = 'block';
        }

        // Function to hide analysis dropdown
        function hideAnalysisDropdown() {
            analysisDropdown.style.display = 'none';
            // Reset active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            currentAnalysisType = null;
            activeAnalysisButton = null;
        }

        // Function to handle all analysis requests
        function performAnalysis(promptType, buttonElement) {
            // Validate buttonElement
            if (!buttonElement || typeof buttonElement.innerHTML === 'undefined') {
                console.error('Error: buttonElement is null or invalid in performAnalysis');
                alert('Error: Elemento de botón no válido. Por favor, inténtalo de nuevo.');
                return;
            }
            
            analysisResultDiv.textContent = ''; // Clear previous results
            analysisResultDiv.classList.remove('analysis-render'); // Remove previous animation
            
            // Disable all buttons during analysis
            setAnalysisButtonsState(true);
            
            if (typeof startStatusWorkflow === 'function') startStatusWorkflow();
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analizando...'; // Show loading icon
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set this button as active
            buttonElement.classList.add('active');
            
            let userPrompt;
            
            // Obtener contexto de etiqueta seleccionada, si existe
            const etiquetaContext = window.getSelectedEtiquetaContext ? window.getSelectedEtiquetaContext() : null;
            let contextoEtiquetaTexto = '';
            if (etiquetaContext) {
                const { name, data } = etiquetaContext;
                let definicion = '';
                let nivelImpacto = '';
                if (typeof data === 'string') {
                    definicion = data;
                } else if (data && typeof data === 'object') {
                    definicion = data.explicacion || data.definicion || '';
                    nivelImpacto = data.nivel_impacto || '';
                }
                const definicionGlobal = window.getDefinicionEtiqueta ? window.getDefinicionEtiqueta(name) : '';
                if (!definicion || definicion.trim() === '') {
                    definicion = definicionGlobal;
                }
                contextoEtiquetaTexto = `\n=== CONTEXTO ESPECÍFICO DEL USUARIO – ETIQUETA SELECCIONADA ===\nEtiqueta: "${name}"\nDefinición global: ${definicionGlobal || 'No especificada'}\nDescripción / explicación específica: ${definicion || 'No especificada'}\nGrado de impacto en este documento: ${nivelImpacto || 'No especificado'}\n`;
            }

            // Obtener perfil regulatorio del usuario
            const perfilRegulatorio = window.getPerfilRegulatorio ? window.getPerfilRegulatorio() : '';
            let contextoPerfilTexto = '';
            if (perfilRegulatorio && perfilRegulatorio.trim() !== '') {
                contextoPerfilTexto = `\n=== CONTEXTO – PERFIL REGULATORIO DE LA EMPRESA ===\n${perfilRegulatorio}\n`;
            }

            // Unir ambos contextos (perfil + etiqueta) para inyectarlos antes del resto del prompt
            const bloqueContexto = `${contextoPerfilTexto}${contextoEtiquetaTexto}\n`;
            console.log(bloqueContexto);
            
            // Set the specific prompt based on button type
            if (promptType === 'checklist') {
                userPrompt = `Eres un abogado senior especializado en compliance. Utiliza el contexto proporcionado para adaptar tu análisis.

${bloqueContexto}

Lee el siguiente documento PDF y genera un checklist de obligaciones:

IMPORTANTE: Ten en cuenta la etiqueta personalizada seleccionada. Si el *perfil regulatorio* indica que la empresa es una **consultora** o un **despacho de abogados**, el checklist debe estar orientado a los **clientes** de la empresa que estén afectados por dicha etiqueta, no a la empresa directamente.

INSTRUCCIONES CRÍTICAS DE FORMATO DE SALIDA  
1. **OBLIGATORIO – JSON estricto:** responde SIEMPRE con un objeto JSON válido.  
2. **Esquema único:** el objeto JSON debe tener UNA SOLA clave llamada \`html_response\`, cuyo valor sea un string que contenga SOLO el fragmento HTML.  
3. **Sin saltos de línea innecesarios:** el string HTML irá en una sola línea continua (o con los mínimos saltos indispensables para la legibilidad).  
4. **Basado en el PDF:** no inventes información. Si algo no figura, indica cortésmente: \`<p>El documento no proporciona información específica sobre este tema.</p>\`.  
5. **Citas internas:** cita siempre el artículo o sección del PDF cuando fundamentes tu respuesta.  
6. **Extensión:** máximo aproximado de 300 palabras dentro del string HTML.    
7. **Resúmenes concisos:** cuando se pida un resumen, que sea ordenado y breve.  
8. **Sensibilidad e implicaciones:** evalúa el impacto usando solo la información disponible; sin sesgos ni especulaciones.  
9. **Sin opiniones personales:** cualquier dato no contenido en el documento deberá declararse "No disponible".

REQUERIMIENTOS DEL CONTENIDO HTML  
• Dentro de \`html_response\` usa ÚNICAMENTE estas etiquetas: \`<h2>\`, \`<p>\`, \`<table>\`, \`<tr>\`, \`<th>\`, \`<td>\` y \`<b>\` donde resulte necesario.  
• Estructura de salida:  
  * \`<h2>Checklist de Cumplimiento</h2>\`  
  * \`<p>Resumen ejecutivo</p>\` (máx. 100 palabras con nº total de obligaciones y fecha de entrada en vigor).  
  * \`<table>\` con cinco columnas en este orden:  
    1. Obligación / Acción a realizar (≤ 25 palabras)  
    2. Artículo o disposición que la impone  
    3. Departamento interno responsable (Compliance, RR.HH., IT, Dirección Financiera, etc.)  
    4. Plazo exacto o frecuencia (fecha fija, "30 días", "trimestral"…).  
    5. Sanción o consecuencia por incumplimiento (importe o referencia al art.).  
  * Máximo 10 filas; si algún dato no aparece, escribe "No especificado".  
• No utilices ninguna otra etiqueta HTML ni Markdown.

**RECUERDA:** Tu salida debe ser únicamente el objeto JSON como el del ejemplo anterior, sin nada antes ni después. El string HTML dentro de \`html_response\` no debe contener saltos de línea innecesarios, solo el HTML puro.`;
            } else if (promptType === 'risks') {
                userPrompt = `Eres un socio de un despacho de abogados en España. Analiza la norma dentro de <PDF></PDF> y extrae riesgos, oportunidades para la empresa y servicios que el despacho puede ofrecer.

${bloqueContexto}

=== Indicaciones adicionales (contextualización por tipo de empresa) ===
• Si el *perfil regulatorio* indica que la empresa es una **empresa regulada** (por ejemplo, entidad financiera, aseguradora, eléctrica, etc.), genera **únicamente** los riesgos y oportunidades que afectan a **esa empresa**.  
  – Prioriza siempre la **etiqueta personalizada seleccionada**; si no se seleccionó ninguna, haz el análisis genérico sobre la norma.  
• Si el perfil indica que la empresa es un **despacho de abogados** o **consultora**, divide la respuesta en DOS grandes bloques diferenciados:  
  A) **Riesgos y oportunidades para clientes** (centrado en los clientes afectados por la etiqueta seleccionada; si no hay etiqueta, hazlo genérico) con sub-apartados 1. *Riesgos para clientes* y 2. *Oportunidades para clientes*.  
  B) **Riesgos y oportunidades para servicios profesionales** (oportunidades comerciales para la propia firma: captación de clientes, nuevos servicios, notificaciones proactivas, etc.).

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML solo puede incluir <h2>, <p>, <table>, <tr>, <th>, <td>, <b>. Nada más.  
• Sin saltos de línea innecesarios ni Markdown.  

=== Contenido HTML requerido (≤ 400 palabras) ===
<p>Introducción (≤ 60 palabras) situando la relevancia de la norma.</p>

<h2>1. Riesgos</h2>
<table>
<tr><th>Riesgo</th><th>Artículo</th><th>Probabilidad</th><th>Impacto</th><th>Mitigación</th></tr>
<!-- hasta 6 filas de riesgos -->
</table>

<!-- SOLO si hay oportunidades empresariales reales -->
<h2>[NÚMERO]. Oportunidades para empresas</h2>
<table>
<tr><th>Oportunidad Empresarial</th><th>Sector</th><th>Beneficio</th></tr>
<!-- hasta 4 filas de oportunidades empresariales -->
</table>

<!-- SOLO si hay oportunidades para servicios legales -->
<h2>[NÚMERO]. Oportunidades para servicios legales</h2>
<table>
<tr><th>Oportunidad de servicio legal</th><th>Etapa</th><th>Valor para el cliente</th></tr>
<!-- hasta 6 filas de servicios legales -->
</table>

<p><b>Conclusión:</b> Prioriza los 3 principales riesgos y las oportunidades más relevantes.</p>

=== Instrucciones específicas ===
• **Riesgos:** Siempre incluye la tabla de riesgos si existen en la norma (siempre será "1. Riesgos").
• **Numeración dinámica:** Los números de los títulos deben ajustarse según las tablas que realmente se muestren:
  - Si solo hay riesgos: solo "1. Riesgos"
  - Si hay riesgos + oportunidades empresariales: "1. Riesgos" y "2. Oportunidades para empresas"
  - Si hay riesgos + servicios legales: "1. Riesgos" y "2. Oportunidades para servicios legales"
  - Si hay las tres tablas: "1. Riesgos", "2. Oportunidades para empresas", "3. Oportunidades para servicios legales"
• **Oportunidades empresariales:** SOLO incluye esta tabla si la norma genera oportunidades reales para empresas (nuevos mercados, cambios regulatorios favorables, etc.). Si no hay oportunidades empresariales claras, omite completamente esta sección.
• **Oportunidades para servicios legales:** SOLO incluye esta tabla si la norma genera oportunidades de servicios para despachos de abogados (asesoramiento, implementación, compliance, litigios, etc.). Si no hay oportunidades para servicios legales, omite completamente esta sección.
• Si no hay ningún tipo de oportunidades, indica: <p>Esta norma no presenta oportunidades empresariales o de servicios legales evidentes.</p>
• Indica "No especificado" en las celdas donde el PDF carece de información necesaria.

=== Criterios analíticos ===
• Basado únicamente en el PDF; cita artículos concretos.  
• Estilo claro y preciso, sin opiniones personales ni especulación.
• Evalúa de forma realista si existen verdaderas oportunidades antes de incluir las tablas correspondientes.`;
            } else if (promptType === 'summary') {
                const tieneEtiqueta = !!etiquetaContext;
                const tituloImpacto = tieneEtiqueta ? `Impacto en ${etiquetaContext.name}` : 'Aspectos clave y puntos importantes';

                userPrompt = `Eres un abogado experto. Analiza el documento PDF y genera un resumen claro y conciso.

${bloqueContexto}

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML puede incluir <h2>, <p>, <ul>, <li>, <b>, <hr>. Nada más.  
• Usa <hr> (o dos saltos de línea) para separar visualmente secciones. No utilices Markdown.

=== Contenido HTML requerido (≤ 600 palabras) ===
<h2 style="font-size:1.3em; margin-bottom:12px;">Resumen de la Norma</h2>
<table style="width:100%; border-collapse:collapse; font-size:0.95em;">
  <tr style="background:#f8f8f8;">
    <th style="text-align:left; padding:6px 8px; color:#0b2431;">Concepto</th>
    <th style="text-align:left; padding:6px 8px; color:#455862;">Detalle</th>
  </tr>
  <tr><td style="padding:6px 8px;">Título completo</td><td style="padding:6px 8px;"></td></tr>
  <tr style="background:#fafafa;"><td style="padding:6px 8px;">Fecha de publicación</td><td style="padding:6px 8px;"></td></tr>
  <tr><td style="padding:6px 8px;">Entrada en vigor</td><td style="padding:6px 8px;"></td></tr>
  <tr style="background:#fafafa;"><td style="padding:6px 8px;">Ámbito de aplicación</td><td style="padding:6px 8px;"></td></tr>
</table>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Propósito principal de la norma</h3>
<p>Contenido de propósito principal de la norma</p>	
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Sujetos afectados</h3>
<p>Contenido de sujetos afectados</p>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h2 style="font-size:1.3em;">${tituloImpacto}</h2>
<h3>Implicaciones generales</h3>
<h3>Aspectos clave y puntos importantes a considerar.</h3>
<ul>
  <li style="margin:6px 0;">Principales disposiciones (máximo 5 puntos)</li>
</ul>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Próximos pasos recomendados</h3>

=== Criterios analíticos ===
• Basado únicamente en el PDF y el contexto proporcionado; cita artículos concretos.
• Estilo claro y preciso, sin opiniones personales ni especulación.`;
            }
            console.log(userPrompt);

            fetch('/api/analyze-norma', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/html; charset=utf-8'
                },
                body: JSON.stringify({ documentId: documentId, userPrompt: userPrompt, collectionName: collectionName })
            })
            .then(response => {
                // Ensure we're properly handling the UTF-8 encoding
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('charset=utf-8')) {
                    return response.text();
                }
                // Explicitly decode as UTF-8 if charset not specified
                return response.arrayBuffer().then(buffer => {
                    const decoder = new TextDecoder('utf-8');
                    return decoder.decode(buffer);
                });
            })
            .then(data => {
                // Process the response
                const htmlContent = data.replace(/^```html\s*|\s*```|^<\!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<\!DOCTYPE html>/g, '');
                
                // Complete the status workflow with success animation
                completeStatusWorkflow();
                
                // After status animation completes, show results with animation
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText; // Restore original button text
                    buttonElement.style.backgroundColor = ''; // Remove inline style
                    
                    // Enable all buttons again
                    setAnalysisButtonsState(false);
                    
                    // Set content and show with animation
                    analysisResultDiv.innerHTML = htmlContent; // Set as HTML
                    analysisResultDiv.classList.add('analysis-render'); // Add render animation
                    analysisResultDiv.style.display = 'block'; // Show the analysis result div
                    
                    showFeedbackSection();
                }, 1300); // Wait for status completion animation
            })
            .catch(error => {
                console.error('Error analyzing norma:', error);
                
                // Complete the status workflow first, then show error
                clearStatusWorkflow();
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalButtonText; // Restore original button text
                    buttonElement.classList.remove('active'); // Remove active state on error
                    
                    // Enable all buttons again
                    setAnalysisButtonsState(false);
                    
                    analysisResultDiv.textContent = 'Error analizando la norma. Por favor, inténtalo de nuevo.';
                    analysisResultDiv.classList.add('analysis-render'); // Add render animation
                    analysisResultDiv.style.display = 'block'; // Show the analysis result div
                }, 1300); // Wait for status completion animation
            });
        }

        // Fetch the document details (only the short_name for this example)
        fetch(`/api/norma-details?documentId=${documentId}&collectionName=${collectionName}`) // New endpoint in app.js
                .then(response => response.json())
                .then(data => {
                    shortNameSpan.textContent = data.short_name;
                     // Nuevo código para mostrar detalles adicionales
                    const extraDetailsDiv = document.getElementById('normaExtraDetails');
                    if (extraDetailsDiv) {
                        let detailsParts = [];

                        // data.collectionName ya lo estás recibiendo de la API
                        if (data.collectionName) {
                            detailsParts.push(data.collectionName);
                        }

                        if (data.rango_titulo) {
                            detailsParts.push(data.rango_titulo);
                        }

                        if (data.url_pdf) {
                            detailsParts.push(`<a href="${data.url_pdf}" target="_blank" style="color: #757575; text-decoration: underline;">Leer documento</a>`);
                        }
                        
                        // Une las partes con ' | ', filtrando las que estén vacías o nulas
                        extraDetailsDiv.innerHTML = detailsParts.filter(part => part !== null && part !== undefined && part !== '').join(' | ');

                        /* =========  NUEVO: Selector de etiquetas personalizadas  ========= */
                        const etiquetasData = data.user_etiquetas_personalizadas;
                        const perfilRegulatorioUser = data.perfil_regulatorio || '';
                        // Mapa de definiciones de todas las etiquetas del usuario
                        const definicionesMap = data.user_etiquetas_definiciones || {};

                        // Expose profile getter globally
                        window.getPerfilRegulatorio = () => perfilRegulatorioUser;
                        window.getDefinicionEtiqueta = (et) => definicionesMap[et] || '';
                        
                        // Expose etiquetas data and selection functions globally
                        let selectedEtiquetaName = null;
                        let selectedEtiquetaData = null;
                        
                        window.getEtiquetasData = () => etiquetasData || {};
                        window.setSelectedEtiqueta = (name, data) => {
                            selectedEtiquetaName = name;
                            selectedEtiquetaData = data;
                        };
                        window.getSelectedEtiquetaContext = () => {
                            if (!selectedEtiquetaName) return null;
                            return { name: selectedEtiquetaName, data: selectedEtiquetaData };
                        };
                        /* ==================================================================== */
                    }
                    pageLoaderOverlay.style.display = 'none';
    // Fin del nuevo código
                })
                .catch(error => {
                    console.error('Error fetching norma details:', error);
                    analysisResultDiv.textContent = 'Error fetching norma details.'; // show error if there's a problem
                    pageLoaderOverlay.style.display = 'none';// Hide the overlay even if there's an error
                });

        // Add click handlers for each button - now show dropdown instead of direct analysis
        analyzeButton.addEventListener('click', () => {
            showAnalysisDropdown('summary', analyzeButton);
        });

        checklistButton.addEventListener('click', () => {
            showAnalysisDropdown('checklist', checklistButton);
        });

        risksButton.addEventListener('click', () => {
            showAnalysisDropdown('risks', risksButton);
        });

        // Add click handler for start analysis button
        startAnalysisBtn.addEventListener('click', () => {
            if (currentAnalysisType && activeAnalysisButton && activeAnalysisButton.innerHTML) {
                // Store references before hiding dropdown (which resets them)
                const analysisType = currentAnalysisType;
                const buttonElement = activeAnalysisButton;
                
                hideAnalysisDropdown();
                performAnalysis(analysisType, buttonElement);
            } else {
                console.error('Error: activeAnalysisButton is null or invalid');
                alert('Error: No se pudo identificar el botón de análisis. Por favor, inténtalo de nuevo.');
            }
        });
            

            // Configurar los listeners para el feedback
            function setupFeedbackListeners() {
              // Toggle para mostrar/ocultar el contenido de feedback
              document.getElementById('feedbackToggle').addEventListener('click', function() {
                const feedbackContent = document.getElementById('feedbackContent');
                const chevron = this.querySelector('.fa');
                
                if (feedbackContent.style.display === 'none') {
                  feedbackContent.style.display = 'block';
                  chevron.classList.remove('fa-chevron-down');
                  chevron.classList.add('fa-chevron-up');
                } else {
                  feedbackContent.style.display = 'none';
                  chevron.classList.remove('fa-chevron-up');
                  chevron.classList.add('fa-chevron-down');
                }
              });

              // Enviar feedback
              document.getElementById('sendFeedbackBtn').addEventListener('click', function() {
                const feedbackText = document.getElementById('feedbackText').value.trim();
                
                if (!feedbackText) {
                  alert('Por favor, introduce tu feedback antes de enviar.');
                  return;
                }
                
                this.disabled = true;
                this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';
                
                const urlParams = new URLSearchParams(window.location.search);
                const documentId = urlParams.get('documentId');
                const collectionName = urlParams.get('collectionName');
                const userPrompt = document.getElementById('userPrompt').value;
                const analysisResults = document.getElementById('analysisResult').innerHTML;
                
                // Obtener fecha actual en formato yyyy-mm-dd
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                fetch('/api/feedback-analisis', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    documentId: documentId,
                    collectionName: collectionName,
                    userPrompt: userPrompt,
                    analysisResults: analysisResults,
                    fecha: dateStr,
                    feedback: feedbackText,
                    content_evaluated: 'analisis_impacto'
                  })
                })
                .then(response => response.json())
                .then(data => {
                  this.disabled = false;
                  this.innerHTML = 'Enviar feedback';
                  
                  if (data.success) {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'feedback-success';
                    successMsg.textContent = '¡Gracias por tu feedback!';
                    document.getElementById('feedbackContent').appendChild(successMsg);
                    
                    // Limpiar el textarea
                    document.getElementById('feedbackText').value = '';
                  
                  } else {
                    alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.');
                  }
                })
                .catch(error => {
                  console.error('Error sending feedback:', error);
                  this.disabled = false;
                  this.innerHTML = 'Enviar feedback';
                  alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.');
                });
              });
            }
            // Inicializar los listeners
            setupFeedbackListeners();

            // Add click outside to close dropdown
            document.addEventListener('click', function(event) {
                if (!analysisDropdown.contains(event.target) && 
                    !analyzeButton.contains(event.target) && 
                    !checklistButton.contains(event.target) && 
                    !risksButton.contains(event.target)) {
                    hideAnalysisDropdown();
                }
            });

        function startStatusWorkflow() {
            clearStatusWorkflow();
            console.log('[workflow] starting');
            analysisStatusDiv.style.display = 'flex';
            statusTextSpan.classList.remove('slide');
            void statusTextSpan.offsetWidth;
            statusTextSpan.textContent = 'Pensando…';
            const steps = [
                { text: 'Pensando…', duration: 3000 },
                { text: 'Accediendo a la fuente oficial…', duration: 2000 },
                { text: 'Analizando la norma…', duration: 3000 },
                { text: 'Personalizando el análisis…', duration: null } // stays until done
            ];

            let cumulative = 0;
            steps.forEach((step, idx) => {
                const t = setTimeout(() => {
                    console.log('[workflow] step', step.text);
                    statusTextSpan.classList.remove('slide');
                    void statusTextSpan.offsetWidth;
                    statusTextSpan.textContent = step.text;
                    statusTextSpan.classList.add('slide');
                }, cumulative);
                statusTimeouts.push(t);
                if (step.duration) cumulative += step.duration;
            });
        }

        function clearStatusWorkflow() {
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] cleared');
            analysisStatusDiv.style.display = 'none';
        }

        function completeStatusWorkflow() {
            // Cancel any pending timeouts but don't hide yet
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] completing with success');
            
            // Show completion status with tick
            const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
            spinnerIcon.className = 'fa fa-check'; // Change to tick
            statusTextSpan.textContent = 'Análisis Finalizado';
            
            // Animate out after showing completion
            setTimeout(() => {
                analysisStatusDiv.classList.add('status-completed');
                setTimeout(() => {
                    analysisStatusDiv.style.display = 'none';
                    analysisStatusDiv.classList.remove('status-completed');
                    // Reset spinner for next time
                    spinnerIcon.className = 'fa fa-spinner spinner';
                }, 500); // Match animation duration
            }, 800); // Show completed state for 800ms
        }
    });
</script>
<script>
        function toggleMenu() {
            const menu = document.querySelector('.menu');
            menu.classList.toggle('active');
             }
             // Close the menu if clicking outside of it
    document.addEventListener('click', function(event) {
        const menu = document.querySelector('.menu');
        const hamburger = document.querySelector('.hamburger');
        
        if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
            menu.classList.remove('active');
        }
    });
</script>

</body>
</html>