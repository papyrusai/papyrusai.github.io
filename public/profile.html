<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Profile</title>
  <link rel="icon" href="assets/reversa_logo.png" type="image/png"> 

  <!-- Font Awesome + Chart.js + Basic CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>

  <!-- Your existing CSS files -->
  <link rel="stylesheet" type="text/css" href="styles/styles.css" />
  <link rel="stylesheet" type="text/css" href="styles/menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
  <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
  <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/mobile.css" />
  <link rel="stylesheet" type="text/css" href="styles/sidebar_styles.css" />

  <!-- Text Editor JavaScript -->
  <script src="textEditor.js"></script>

  <style>
  html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    *, *:before, *:after {
      box-sizing: inherit;
    }
    /* Loader overlay styling */
    #pageLoaderOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .page-loader {
      width: 50px; height: 50px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    /* Dropdown styling for multi-check logic */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropbtn i {
      margin-left: 6px;
    }
    /* Show subramas dropdown on hover */
    .rama-label-container:hover .subramas-dropdown {
      display: block;
    }

    /* The actual dropdown menus */
    #myDropdown,
    #ramaDropdown,
    #boletinDropdown,
    #etiquetasDropdown,
    #rangoDropdown {
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      display: none; /* hidden by default */
    }
    #myDropdown.show,
    #ramaDropdown.show,
    #etiquetasDropdown.show,
    #boletinDropdown.show,
    #rangoDropdown.show {
      display: block;
    }

    /* Items inside the dropdown */
    #myDropdown label,
    #ramaDropdown label,
    #etiquetasDropdown label,
    #boletinDropdown label,
    #rangoDropdown label {
      display: block;
      padding: 4px 2px;
      margin: 0;
      cursor: pointer;
      font-size: 0.85em;
      border-bottom: 1px solid #ddd;
    }
    #myDropdown label:last-child,
    #ramaDropdown label:last-child,
    #etiquetasDropdown label:last-child,
    #boletinDropdown label:last-child,
    #rangoDropdown label:last-child {
      border-bottom: none;
    }
    #myDropdown input[type="checkbox"],
    #ramaDropdown input[type="checkbox"],
    #etiquetasDropdown input[type="checkbox"],
    #boletinDropdown input[type="checkbox"],
    #rangoDropdown input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #04db8d;
      margin-right: 6px;
    }

    /* Sub-ramas container */
    #subRamasCheckboxContainer {
      margin: 10px 0;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 6px;
      display: none; 
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* Estilos para los tags de nivel de impacto */
    .nivel-impacto-tag {
      display: inline-block;
      font-size: 0.7em;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
      white-space: nowrap;
    }
    
    .nivel-impacto-alto {
      background-color: #ffe6e6;
      color: #dc3545;
    }
    
    .nivel-impacto-medio {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .nivel-impacto-bajo {
      background-color: #d4edda;
      color: #155724;
    }
    
    /* Estilos para los círculos del filtro de nivel de impacto */
    .nivel-circulo {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      margin-left: 6px;
    }
    
    .nivel-circulo-todos {
      background-color: #e0e0e0;
    }
    
    .nivel-circulo-alto {
      background-color: #ffbaba;
    }
    
    .nivel-circulo-medio {
      background-color: #ffeb9c;
    }
    
    .nivel-circulo-bajo {
      background-color: #b3d9b3;
    }
    
    /* Ajustes para los radio buttons en el dropdown de nivel de impacto */
    #nivelImpactoDropdown input[type="radio"] {
      margin-right: 8px;
      accent-color: #04db8d;
      width: 12px;
      height: 12px;
      transform: scale(1);
      border: 1px solid white;
      outline: 1px solid #ccc;
    }
    
    #nivelImpactoDropdown label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    
    #nivelImpactoDropdown label:last-child {
      border-bottom: none;
    }
    
    #nivelImpactoDropdown label:hover {
      background-color: #f5f5f5;
    }
    
    /* Hide radio buttons */
    #nivelImpactoDropdown input[type="radio"] {
      display: none;
    }
    
    /* Green tick for selected option */
    #nivelImpactoDropdown input[type="radio"]:checked + .nivel-option-content::after {
      content: "✓";
      color: #04db8d;
      font-weight: bold;
      font-size: 14px;
      margin-left: auto;
    }
    
    .nivel-option-content {
      display: flex;
      align-items: center;
      width: 100%;
      justify-content: space-between;
    }
    
    /* Estilos específicos para el botón de nivel de impacto */
    #btnNivelImpacto {
      display: flex;
      align-items: center;
      transition: none !important;
      background-color: #f8f9fa !important;
    }
    
    #btnNivelImpacto:hover,
    #btnNivelImpacto:focus,
    #btnNivelImpacto:active,
    #btnNivelImpacto.show {
      background-color: #f8f9fa !important;
      color: inherit !important;
      transform: none !important;
      box-shadow: none !important;
      border: 1px solid #ccc !important;
      outline: none !important;
    }
    
    /* Sobrescribir cualquier regla de .dropbtn para este botón específico */
    .dropdown #btnNivelImpacto:hover,
    .dropdown #btnNivelImpacto:focus,
    .dropdown #btnNivelImpacto:active {
      background: #f8f9fa !important;
      color: #333 !important;
      border-color: #ccc !important;
      transform: translateY(0) !important;
      box-shadow: none !important;
    }
    
    #btnNivelImpacto #selectedNivelCirculo {
      margin-right: 8px;
      margin-left: 0;
    }
    
    /* Hover para mostrar el dropdown */
    .dropdown:hover #nivelImpactoDropdown {
      display: block;
    }
    #subRamasCheckboxContainer label {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
      font-size: 0.85em;
    }
    #subRamasCheckboxContainer input[type="checkbox"] {
      width: 16px; height: 16px; transform: scale(0.9); accent-color: #04db8d; margin-right: 6px;
    }

    /* Basic layout styling */
    .analytics-label {
      margin-top: 20px;
      font-weight: bold;
    }
    .detalle-cuenta {
      gap: 50px;
      margin-bottom: 20px;
    }
    .etiquetas-label {
      font-weight: bold;
    }
    .filter-item {
      margin-bottom: 10px;
    }
    .filter-section {
      margin-bottom: 10px;
    }
    .collectionDocs {
      margin-top: 10px;
    }
    .menu.active {
      display: block;
    }
    .filter-banner-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    .beta-banner {
      background-color: #455862;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Subramas dropdown styling */
    .rama-label-container {
      position: relative;
      display: block;
    }

    .subramas-dropdown {
      position: absolute;
      left: 100%;
      top: 0;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 150px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1100;
      margin-left: 5px;
    }

    .subramas-dropdown.active {
      display: block;
    }

    .subramas-toggle {
      cursor: pointer;
      margin-left: 5px;
      color: #666;
    }

    .subramas-toggle:hover {
      color: #04db8d;
    }

    .subramas-dropdown label {
      display: block;
      padding: 4px 2px;
      margin: 0;
      cursor: pointer;
      font-size: 0.85em;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
    }

    .subramas-dropdown label:last-child {
      border-bottom: none;
    }

    .subramas-dropdown input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #04db8d;
      margin-right: 6px;
    }

    #ramaDropdown {
      overflow: visible !important;
    }

    /* Estilos para agentes */
    .agente-item {
      display: inline-block;
      border-radius: 4px;
      margin-top: 15px;
      font-size: 0.9em;
    }

    .agente-nombre {
      font-weight: 500;
      color: #0b2431;
    }

    .agente-descripcion {
      margin-left: 5px;
      cursor: help;
      color: #666;
      display: inline-block; /* Asegura que esté en línea con el texto */
    }


    .tooltip {
      position: absolute;
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      max-width: 250px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .no-agentes {
      color: #666;
      font-style: italic;
    }

    .etiqueta-personalizada-value {
      box-shadow: 0 2px 4px rgba(4, 219, 141, 0.2);
      margin: 5px 0;
      background-color: rgba(4, 219, 141, 0.1); /* #04db8d1a */
      --tw-text-opacity: 1;
      color: rgb(4 219 141 / var(--tw-text-opacity));
      display: inline-flex;
      align-items: center;
      border-radius: 9999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .plan-badge {
      position: absolute;
    color: #092534;
    padding: 5px 10px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 14px;
    z-index: 9999;
    background-color: var(--border-color);
    }

    /* Estilos para el botón de guardar */
    .guardar-button {
      position: relative;
      display: inline-block;
      margin-left: 10px;
    }

    .save-btn {
      background-color: transparent;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .save-btn:hover {
      background-color: #e9ecef;
      border-color: #adb5bd;
    }

    .save-btn i {
      font-size: 12px;
    }

    /* Estilos para el desplegable de listas */
    .lists-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 200px;
      max-width: 300px;
      z-index: 1000;
      display: none;
      max-height: 300px;
      overflow: hidden;
    }

    .lists-dropdown.show {
      display: block;
    }

    .lists-dropdown-header {
      padding: 12px 16px;
      border-bottom: 1px solid #dee2e6;
      font-weight: 600;
      color: #495057;
      font-size: 14px;
      background: white;
      position: sticky;
      top: 0;
      z-index: 1001;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .lists-content {
      max-height: 200px;
      overflow-y: auto;
    }

    .list-item {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
      font-size: 14px;
      color: #495057;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .list-item:hover {
      background-color: #f8f9fa;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #04db8d;
      cursor: pointer;
    }

    .list-item label {
      cursor: pointer;
      flex: 1;
      margin: 0;
    }

    .add-new-list {
      padding: 10px 16px;
      cursor: pointer;
      border-top: 1px solid #dee2e6;
      font-size: 14px;
      color: #04db8d;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s ease;
    }

    .add-new-list:hover {
      background-color: #f8f9fa;
    }

    .add-new-list i {
      font-size: 12px;
    }

    /* Botón OK para guardar */
    .save-ok-btn {
      background-color: #04db8d;
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: none;
    }

    .save-ok-btn:hover {
      background-color: #03c57f;
    }

    .save-ok-btn.show {
      display: inline-block;
    }

    /* Estilos para el formulario de nueva lista */
    .new-list-form {
      padding: 12px 16px;
      border-top: 1px solid #dee2e6;
      display: none;
    }

    .new-list-form.show {
      display: block;
    }

    .new-list-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .new-list-input:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    .new-list-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .new-list-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .new-list-btn.save {
      background-color: #04db8d;
      color: white;
    }

    .new-list-btn.save:hover {
      background-color: #03c57f;
    }

    .new-list-btn.cancel {
      background-color: #6c757d;
      color: white;
    }

    .new-list-btn.cancel:hover {
      background-color: #5a6268;
    }

    /* Mensaje cuando no hay listas */
    .no-lists-message {
      padding: 16px;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
      font-style: italic;
    }

    /* Estilos para la sección Tus Listas */
    .listas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .lista-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s ease;
      position: relative;
    }

    .lista-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .lista-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .lista-title {
      font-size: 18px;
      font-weight: 600;
      color: #0b2431;
      margin: 0;
      flex: 1;
      margin-right: 10px;
    }

    .delete-lista-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      font-size: 16px;
    }

    .delete-lista-btn:hover {
      background-color: rgba(220, 53, 69, 0.1);
    }

    .lista-stats {
      margin-bottom: 20px;
    }

    .lista-stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .lista-stat-label {
      color: #6c757d;
      font-weight: 500;
    }

    .lista-stat-value {
      color: #0b2431;
      font-weight: 600;
    }

    .generar-contenido-btn {
      background-color: var(--text-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .generar-contenido-btn:hover {
      background-color: #03c57f;
    }

    .generar-contenido-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    /* Estilos para la página de generación de contenido */
    .generar-contenido-page {
      display: none;
      height: 100vh;
      overflow-y: auto;
    }

    .generar-contenido-page.active {
      display: block;
    }

    .generar-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #dee2e6;
    }

    .back-arrow {
      background: none;
      border: none;
      font-size: 20px;
      color: #6c757d;
      cursor: pointer;
      margin-right: 15px;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .back-arrow:hover {
      background-color: #f8f9fa;
      color: #04db8d;
    }

    .generar-title {
      font-size: 24px;
      font-weight: 600;
      color: #0b2431;
      margin: 0;
    }

    .generar-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      height: calc(100vh - 150px);
    }

    .ajustes-section {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      height: fit-content;
      position: relative;
      font-size: 15px;
    }

    .ajustes-title {
      font-size: 18px;
      font-weight: 600;
      color: #0b2431;
      margin: 0 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ajuste-subsection {
      margin-bottom: 25px;
    }

    .ajuste-subtitle {
      font-size: 15px;
      font-weight: 600;
      color: #455862;
      margin-bottom: 10px;
    }

    .ajuste-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 15px;
      resize: vertical;
      min-height: 80px;
      transition: border-color 0.2s ease;
    }

    .ajuste-input:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    .ajuste-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 15px;
      background-color: white;
      transition: border-color 0.2s ease;
    }

    .ajuste-select:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    .file-input-container {
      margin-bottom: 15px;
      position: relative;
    }

    .file-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 15px;
      background-color: white;
      transition: border-color 0.2s ease;
      opacity: 0;
      position: absolute;
      z-index: 2;
      cursor: pointer;
    }

    .file-input-custom {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      z-index: 1;
    }

    .file-input-custom:hover {
      border-color: #04db8d;
      background-color: #f8f9fa;
    }

    .file-input-icon {
      color: #6c757d;
      font-size: 16px;
    }

    .file-input-text {
      color: #6c757d;
      font-size: 15px;
      flex: 1;
    }

    .file-input-tooltip {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .file-input-custom:hover .file-input-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .save-ajustes-btn {
      background-color: var(--text-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
      display: none;
    }

    .save-ajustes-btn.show {
      display: inline-block;
    }

    .save-ajustes-btn:hover {
      background-color: #03c57f;
    }

    .generar-final-btn {
      background: linear-gradient(135deg, var(--text-color, #0b2431) 0%, var(--primary-color, #04db8d) 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(4, 219, 141, 0.3);
    }

    .generar-final-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(4, 219, 141, 0.4);
    }

    .generar-final-btn:active {
      transform: translateY(0);
    }

    .subsection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .subsection-item {
      display: flex;
      flex-direction: column;
    }

    .documentos-section {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0px 20px 20px 20px;
      overflow-y: auto;
      max-height: calc(100vh - 150px);
    }

    

    .documentos-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .documento-item {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 15px;
      background-color: #fafafa;
      transition: box-shadow 0.2s ease;
      position: relative;
      cursor: pointer;
    }

    .documento-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .documento-item.selected {
      border-color: #04db8d;
      background-color: rgba(4, 219, 141, 0.05);
    }

    .documento-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .documento-title {
      font-weight: 600;
      color: #0b2431;
      font-size: 16px;
      margin: 0;
      flex: 1;
    }

    .documento-date {
      color: #6c757d;
      font-size: 14px;
      font-style: italic;
    }

    .documento-checkbox {
      position: absolute;
      bottom: 15px;
      right: 15px;
      width: 18px;
      height: 18px;
      accent-color: #04db8d;
      cursor: pointer;
    }

    .documentos-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .select-all-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .select-all-checkbox {
      width: 18px;
      height: 18px;
      accent-color: #04db8d;
      cursor: pointer;
    }

    .select-all-label {
      font-weight: 500;
      color: #0b2431;
      cursor: pointer;
      margin: 0;
    }

    .selected-count {
      font-size: 14px;
      color: #6c757d;
      font-weight: 500;
    }

    .file-input, .ajuste-select {
      cursor: pointer;
    }

    .file-input:hover, .ajuste-select:hover {
      cursor: pointer;
    }

    .documento-meta {
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .documento-resumen {
      color: #455862;
      font-size: 15px;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .documento-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .documento-tag {
      background-color: rgba(4, 219, 141, 0.1);
      color: #04db8d;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .no-documentos {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 40px;
    }

    @media (max-width: 768px) {
      .generar-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .ajustes-section {
        order: 2;
      }
      
      .documentos-section {
        order: 1;
        max-height: 400px;
      }
    }

    .color-palette-container {
      margin-bottom: 15px;
    }

    .color-inputs-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .color-input-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .color-input {
      width: 50px;
      height: 35px;
      border: none;
      background-color: transparent;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .color-input:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    .hex-input {
      width: 80px;
      padding: 4px 6px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 13px;
      text-align: center;
      font-family: monospace;
    }

    .hex-input:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      padding: 15px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 280px;
      max-width: 90vw;
    }

    .modal-content h3 {
      margin: 0 0 8px 0;
      color: #0b2431;
      font-size: 16px;
      font-weight: 600;
    }

    .modal-content p {
      margin: 0 0 15px 0;
      color: #455862;
      font-size: 13px;
      line-height: 1.3;
    }

    .modal-ok-btn {
      background-color: #04db8d;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .modal-ok-btn:hover {
      background-color: #03c57f;
    }

    .contenido-html {
      background: white;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
    }

    /* Estilos dinámicos para el contenido generado - ahora aplicados via JavaScript */
    .contenido-html h1,
    .contenido-html h2,
    .contenido-html h3,
    .contenido-html h4,
    .contenido-html h5,
    .contenido-html h6 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .contenido-html p,
    .contenido-html li,
    .contenido-html span {
      line-height: 1.6;
    }

    .contenido-html ul,
    .contenido-html ol {
      padding-left: 20px;
    }

    .contenido-html blockquote {
      border-left: 4px solid #ccc;
      padding-left: 15px;
      margin: 15px 0;
      font-style: italic;
    }

    /* Botón de volver atrás */
    .back-to-documents-btn {
      background: none;
      border: none;
      color: #0b2431;
      font-size: 18px;
      cursor: pointer;
      margin-right: 15px;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .back-to-documents-btn:hover {
      background-color: rgba(4, 219, 141, 0.1);
      color: #04db8d;
      transform: translateX(-2px);
    }

    .back-to-documents-btn i {
      font-size: 16px;
    }

    /* Mejorar el título de documentos cuando incluye el botón */
    .documentos-title {
      display: flex;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
      color: #0b2431;
      margin: 20px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #dee2e6;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    /* Estilos para tablas en el contenido generado - colores aplicados via JavaScript */
    .contenido-html table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .contenido-html th,
    .contenido-html td {
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      text-align: left;
    }

    .contenido-html th {
      font-weight: 600;
    }

    /* Botón de copiar contenido */
    .copy-content-btn {
      background: none;
      border: none;
      color: #0b2431;
      font-size: 16px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .copy-content-btn:hover {
      background-color: rgba(4, 219, 141, 0.1);
      color: #04db8d;
    }

    .copy-content-btn i {
      font-size: 14px;
    }

    .copy-content-btn.copied {
      color: #04db8d;
    }

    .copy-content-btn.copied i:before {
      content: "\f00c"; /* Font Awesome check icon */
    }

    /* Botón de descarga PDF */
    .download-pdf-btn {
      background: none;
      border: none;
      color: #0b2431;
      font-size: 16px;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .download-pdf-btn:hover {
      background-color: rgba(4, 219, 141, 0.1);
      color: #04db8d;
    }

    .download-pdf-btn i {
      font-size: 14px;
    }

    /* Barra de herramientas de edición (oculta por defecto) */
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      margin-bottom: 15px;
      align-items: center;
      position: relative; /* Changed from fixed to relative */
      /* Removed fixed positioning properties */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .toolbar-group {
      display: flex;
      gap: 5px;
      align-items: center;
      padding-right: 10px;
      border-right: 1px solid #dee2e6;
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .toolbar-btn {
      background: white;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .toolbar-btn:hover {
      background-color: #e9ecef;
      border-color: #adb5bd;
    }

    .toolbar-btn.active {
      background-color: #04db8d;
      color: white;
      border-color: #04db8d;
    }

    .toolbar-select {
      background: white;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      min-width: 80px;
    }

    .toolbar-select:focus {
      outline: none;
      border-color: #04db8d;
      box-shadow: 0 0 0 2px rgba(4, 219, 141, 0.2);
    }

    /* Removed toolbar-color styles since color functionality was removed */

    /* Ajustar el contenido cuando la toolbar está visible */
    .contenido-html[contenteditable="true"] {
      border: 2px dashed #04db8d;
      background-color: #fafafa;
      outline: none;
      /* Removed margin-top since toolbar is no longer fixed */
    }

    .contenido-html[contenteditable="true"]:focus {
      border-color: #03c57f;
      background-color: white;
    }

    /* Export dropdown styles */
    .export-dropdown {
      position: relative;
      display: inline-block;
    }

    .export-btn {
      background: #04db8d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .export-btn:hover {
      background: #03c57f;
    }

    .export-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      border-radius: 4px;
      z-index: 1000;
      border: 1px solid #dee2e6;
    }

    .export-dropdown-content.show {
      display: block;
    }

    .export-option {
      color: #495057;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 14px;
    }

    .export-option:hover {
      background-color: #f8f9fa;
    }

    .export-option:first-child {
      border-radius: 4px 4px 0 0;
    }

    .export-option:last-child {
      border-radius: 0 0 4px 4px;
    }

    /* Contenido editable */
    .contenido-html[contenteditable="true"] {
      border: 2px dashed #04db8d;
      background-color: #fafafa;
      outline: none;
    }

    .contenido-html[contenteditable="true"]:focus {
      border-color: #03c57f;
      background-color: white;
    }

    /* Espacio entre título y sección de documentos */
    .documentos-spacer {
      background-color: white;
      height: 20px;
      position: relative;
      z-index: 10;
    }

    /* Asegurar que el área de documentos tenga fondo blanco */
    #data-container {
      background-color: white;
      position: relative;
      z-index: 5;
    }
    
    /* Estilos para la vista de nodos */
    .nodos-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-top: 10px;
      width: 800px !important;
      height: 400px !important;
      max-width: 800px !important;
      max-height: 400px !important;
      position: relative;
    }
    
    .nodos-menu {
      display: flex;
      border-bottom: 2px solid #f0f0f0;
      font-size: 20px;
      height: 60px;
      flex-shrink: 0;
    }
    
    .nodo-tab {
      flex: 1;
      padding: 15px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      font-size: 16px;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      color: #999;
      text-align: center;
    }
    
    .nodo-tab:hover {
      color: #666;
    }
    
    .nodo-tab.active {
      color: #04db8d;
      border-bottom-color: #04db8d;
    }
    
    .nodo-tab i {
      font-size: 1.1em;
    }
    
    .nodo-content {
      padding: 20px;
      height: 340px !important;
      overflow-y: auto;
      overflow-x: hidden;
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .nodo-agentes {
      display: none;
    }
    
    .nodo-agentes.active {
      display: block;
    }
    
    .nodo-agente-item {
      display: inline-block;
      margin: 5px 8px 5px 0;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 20px;
      font-size: 0.85em;
      color: #495057;
      transition: all 0.2s ease;
    }
    
    .nodo-agente-item:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
      .nodos-container {
        width: 100% !important;
        max-width: 100% !important;
        height: 400px !important;
      }
      
      .nodos-menu {
        flex-direction: column;
        height: auto;
      }
      
      .nodo-tab {
        justify-content: flex-start;
        padding: 12px 15px;
        height: 50px;
      }
      
      .nodo-content {
        top: auto;
        position: relative;
        height: 300px !important;
      }
    }
  </style>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "r7ltvtr85q");
</script>

</head>
<body>
  <!-- Loader overlay -->
  <div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

  <!-- Navbar -->
   <!--
  <nav class="navbar">
    <div class="logo">
      <a href="https://reversa.ai/" target="_blank">
        <img src="assets/papyrus_app.png" alt="Rev Logo">
      </a>
    </div>
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <ul class="menu">
      <li><a href="https://reversa.ai/">WEB</a></li>
      <li><a href="/profile">PANEL DE CONTROL</a></li>
      <li> <a href="#" id="editSuscription">CUENTA</a></li> 
      <li><a href="https://reversa.ai/pages/contact-1">AYUDA</a></li>
    </ul>
  </nav>
-->
  

  <!-- NUEVO CONTENEDOR PRINCIPAL -->
  <div class="profile-container">
    <!-- NUEVO MENÚ LATERAL -->
    <div id="sidebar">
      <div class="logo-reversa">
        <a href="https://reversa.ai/" target="_blank">
          <img src="assets/reversa_white.png" alt="Reversa Logo">
        </a>
      </div>
      <div class="border-menu"></div>
      <a href="#" class="sidebar-item active" data-target="content-agentes">
        <i class="fas fa-users"></i> Agentes
      </a>
      <a href="#" class="sidebar-item" data-target="content-boletin">
        <i class="fas fa-newspaper"></i> Boletín Diario
      </a>
      <a href="#" class="sidebar-item" data-target="content-busqueda">
        <i class="fas fa-search"></i> Búsqueda y Estadísticas
      </a>
      <a href="#" class="sidebar-item" data-target="content-listas">
        <i class="fas fa-list"></i> Tus listas
      </a>
      <a href="#" class="sidebar-item" data-target="content-configuracion">
        <i class="fas fa-cog"></i> Configuración
      </a>
      <a href="#" class="sidebar-item" id="editSuscription">
        <i class="fas fa-user-circle"></i> Cuenta
      </a>
    </div>

    <!-- NUEVA ÁREA DE CONTENIDO PRINCIPAL -->
    <div id="main-content">

      <!-- Sección Agentes (Contenido original de profile.html movido aquí) -->
      <div id="content-agentes" class="vision-section active">
         <h1>Hola {{name}}</h1> <!-- Título movido aquí -->

         <!-- Contenedor de datos original, ahora dentro de la sección Agentes -->
         <div id="data-container">
            <!-- Plan1 User Upsell Banner - Hidden by default -->
            <div id="radar-normativo-banner" style="display: none; margin-bottom: 25px; padding: 20px; border-radius: 10px; background-color: rgba(4, 219, 141, 0.1); border: 1px solid #04db8d;">
              <h2 id="radar-banner-title" style="color: #0b2431; margin-top: 0; font-size: 22px;">Búsqueda y análisis normativo personalizado por agentes</h2>
              <p id="radar-banner-description" style="color: #455862; margin-bottom: 15px;">Mejora tu plan para poder filtrar y analizar de manera automática la normativa que te afecta a través de nuestros agentes</p>
              
              <p style="color: #455862; margin-bottom: 20px; font-style: italic;">Ejemplos de agentes</p>
              
              <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 250px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                  <h3 style="color: #0b2431; margin-top: 0; font-size: 18px;">
                    <i class="fas fa-money-bill-wave" style="margin-right: 8px;"></i>
                    Cesión de créditos
                  </h3>
                  <p style="color: #455862; font-size: 14px;">El agente supervisa cualquier nueva regulación relacionada con la cesión de créditos, incluyendo requisitos de transparencia, protección del deudor y obligaciones del cesionario.</p>
                </div>
                <div style="flex: 1; min-width: 250px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                  <h3 style="color: #0b2431; margin-top: 0; font-size: 18px;">
                    <i class="fas fa-building" style="margin-right: 8px;"></i>
                    Alquiler en Barcelona
                  </h3>
                  <p style="color: #455862; font-size: 14px;">Este agente supervisa normativas sobre alquileres temporales, limitaciones de precio, requisitos para propietarios y cualquier otra regulación que afecte al mercado inmobiliario en Barcelona.</p>
                </div>
              </div>
              <a href="#" id="radar-banner-button" class="change-subscription" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background-color: #0b2431; color: white; text-decoration: none; border-radius: 20px; font-weight: 500;">Mejora tu plan</a>
            </div>

            <!-- Sección de Agentes Suscritos -->
            <div class="detalle-cuenta">
              <div>
                <div class="etiquetas-label">Agentes Suscritos</div>
                <div class="etiquetas-values" id="agentesContainer">
                  <!-- Los agentes se cargarán aquí dinámicamente -->
                </div>
              </div>
            </div>
            <a href="#" id="editSuscription2" class="change-subscription">Editar Agentes</a>

            <!-- Búsqueda Avanzada -->
            <div class="analytics-label busqueda">Búsqueda Avanzada</div>

            <!-- Scripts JSON (importante mantenerlos aquí si el JS los espera) -->
            <script id="industryTags" type="application/json">{{industry_tags_json}}</script>
            <script id="userSubIndustriaMap" type="application/json">{{subindustria_map_json}}</script>
            <script id="ramaJuridicas" type="application/json">{{rama_juridicas_json}}</script>
            <script id="userSubRamaMap" type="application/json">{{subrama_juridicas_json}}</script>
            <script id="userEtiquetasPersonalizadas" type="application/json">{{etiquetas_personalizadas_json}}</script>

            <div class="filter-banner-container">
              <div class="beta-banner">Búsqueda personalizada por agente activa desde {{registration_date_formatted}}</div>
            </div>

            <!-- Sección de Filtros -->
            <div id="Filtrar">
              <!-- Filtro Agentes -->
              <div class="filter-item" id="etiquetasPersonalizadasContainer" style="display: block;">
                <div class="etiquetas-label" id="etiquetas-label">Agentes</div>
                <div class="dropdown">
                  <button class="dropbtn" id="btnEtiquetasPersonalizadas" onclick="toggleEtiquetasDropdown()">
                    <span id="selectedEtiquetas">Todos</span> <i class="fa fa-caret-down"></i>
                  </button>
                  <div id="etiquetasDropdown" class="dropdown-content"></div>
                </div>
              </div>
              <!-- Filtro Boletín -->
              <div class="filter-item">
                 <div class="etiquetas-label">Fuente Oficial</div>
                 <div class="dropdown">
                   <button class="dropbtn" id="btnBoletin" onclick="toggleBoletinDropdown()">
                     <span id="selectedBoletines">Todos</span> <i class="fa fa-caret-down"></i>
                   </button>
                   <div id="boletinDropdown" class="dropdown-content"></div>
                 </div>
              </div>
              <!-- Filtro Rango -->
              <div class="filter-item">
                 <div class="etiquetas-label">Rango</div>
                 <div class="dropdown">
                   <button class="dropbtn" id="btnRango" onclick="toggleRangoDropdown()">
                     <span id="selectedRango">Todos</span> <i class="fa fa-caret-down"></i>
                   </button>
                   <div id="rangoDropdown" class="dropdown-content"></div>
                 </div>
              </div>
              <!-- Filtro Fecha -->
              <div class="filter-item">
                <div class="etiquetas-label">Fecha de publicación</div>
                <div class="date-filter">
                  <label for="startDate">Desde:</label>
                  <input type="date" id="startDate" name="startDate" />
                  <label for="endDate">Hasta:</label>
                  <input type="date" id="endDate" name="endDate" />
                </div>
              </div>
            </div>
            <div style="text-align: right;">
              <button id="buscarBtn" onclick="handleBuscar()">Buscar</button>
            </div>

            <!-- Estadísticas -->
            <div class="analytics-label">Estadísticas de la búsqueda</div>
            <div id="loading-icon-chart" style="display: none;"><div class="loader"></div></div>
            <div id="chartContainer">
              <canvas id="documentsChart"></canvas>
            </div>

            <!-- Filtro Nivel de Impacto -->
            <div style="margin-bottom: 15px;">
              <div class="etiquetas-label" style="margin-bottom: 8px;">Nivel de impacto</div>
              <div class="dropdown">
                <button class="dropbtn" id="btnNivelImpacto" onclick="toggleNivelImpactoDropdown()">
                  <span class="nivel-circulo nivel-circulo-todos" id="selectedNivelCirculo"></span>
                  <span id="selectedNivelImpacto">Todos</span> 
                  <i class="fa fa-caret-down"></i>
                </button>
                <div id="nivelImpactoDropdown" class="dropdown-content">
                  <label>
                    <input type="radio" name="nivelImpacto" value="todos" checked>
                    <div class="nivel-option-content">
                      <div style="display: flex; align-items: center;">
                        <span class="nivel-circulo nivel-circulo-todos"></span>
                        Todos
                      </div>
                    </div>
                  </label>
                  <label>
                    <input type="radio" name="nivelImpacto" value="alto">
                    <div class="nivel-option-content">
                      <div style="display: flex; align-items: center;">
                        <span class="nivel-circulo nivel-circulo-alto"></span>
                        Alto
                      </div>
                    </div>
                  </label>
                  <label>
                    <input type="radio" name="nivelImpacto" value="medio">
                    <div class="nivel-option-content">
                      <div style="display: flex; align-items: center;">
                        <span class="nivel-circulo nivel-circulo-medio"></span>
                        Medio
                      </div>
                    </div>
                  </label>
                  <label>
                    <input type="radio" name="nivelImpacto" value="bajo">
                    <div class="nivel-option-content">
                      <div style="display: flex; align-items: center;">
                        <span class="nivel-circulo nivel-circulo-bajo"></span>
                        Bajo
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            <div id="loading-icon" style="display: none;"><div class="loader"></div></div>
            <div class="collectionDocs">{{boeDocuments}}</div>
         </div> <!-- Fin de #data-container -->

         <!-- Logout (movido al final de la sección Agentes) -->
       <!--  <div class="logout-container">
           <a href="/logout">Logout</a>
         </div>
          -->
      </div> 
     

      <!-- Sección Boletín Diario (Contenido de marcador de posición) -->
      <div id="content-boletin" class="vision-section">
        <h2>Boletín Diario</h2>
        
        <!-- Newsletter Subscription Banner (hidden by default) -->
        <div id="newsletter-banner" style="display: none; background-color: #f9f9f9; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h3 style="color: var(--text-color); margin-top: 0;">Suscribete a nuestra newsletter</h3>
          <p style="color: var(--secondary-color); margin-bottom: 20px;">Accede a resúmenes diarios y clasificación por áreas de las disposiciones generales del BOE y DOUE de manera gratuita</p>
          <div style="display: flex; gap: 10px;">
            <button id="accept-newsletter" style="background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Aceptar suscripción</button>
            <button id="reject-newsletter" style="background-color: #f1f1f1; color: var(--text-color); border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; cursor: pointer;">No gracias</button>
          </div>
        </div>
        
        <div id="boletin-fecha" style="font-weight: bold; margin-bottom: 15px; font-size: 1.1em; color: var(--text-color);">Cargando fecha...</div>
      
        <!-- Filtros para Boletín Diario -->
        <div id="boletin-filtros" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; align-items: flex-end; border: 1px solid var(--border-color, #e0e0e0); padding: 15px; border-radius: 8px; background-color: rgba(69, 88, 98, 0.1);width:500px;">
          <!-- Filtro Boletín (Fuente Oficial) -->
          <div class="filter-item">
            <div class="etiquetas-label">Fuente Oficial</div>
            <div class="dropdown">
              <button class="dropbtn" id="btnBoletinDiario" onclick="toggleBoletinDiarioDropdown()">
                <span id="selectedBoletinesDiario">Todas</span>
                <i class="fa fa-caret-down"></i>
              </button>
              <div id="boletinDiarioDropdown" class="dropdown-content">
                <!-- Opciones se poblarán dinámicamente -->
              </div>
            </div>
          </div>
      
          <!-- Filtro Rango -->
          <div class="filter-item">
            <div class="etiquetas-label">Rango</div>
            <div class="dropdown">
              <button class="dropbtn" id="btnRangoDiario" onclick="toggleRangoDiarioDropdown()">
                <span id="selectedRangoDiario">Todos</span>
                <i class="fa fa-caret-down"></i>
              </button>
              <div id="rangoDiarioDropdown" class="dropdown-content">
                <!-- Opciones se poblarán dinámicamente -->
              </div>
            </div>
          </div>
      
          <!-- Botón Aplicar Filtros -->
          <button id="aplicarFiltrosBoletinBtn" onclick="fetchBoletinDiario()" style="padding: 8px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 20px; cursor: pointer; height: fit-content; font-size: 14px;">Aplicar Filtros</button>
        </div>
      
        <!-- Contenedor para los documentos del boletín -->
        <div id="boletin-loading-icon" style="display: none;">
            <div class="loader"></div> <!-- Reutiliza tu clase loader existente -->
        </div>
        <div id="boletin-documentos-container">
          <!-- Los documentos se cargarán aquí -->
          <p>Selecciona los filtros y pulsa "Aplicar Filtros" o espera a la carga inicial.</p>
        </div>
      </div>

      <!-- Sección Búsqueda y Estadísticas (Contenido de marcador de posición) -->
      <div id="content-busqueda" class="vision-section">
        <h2>Búsqueda y Estadísticas</h2>
        <p>Próximamente podrás acceder a estadísticas normativas y búsqueda por rama jurídica o actividad económica</p>
        <div class="plan-badge">Coming Soon</div>
      </div>

      <!-- Sección Tus Listas (Contenido de marcador de posición) -->
      <div id="content-listas" class="vision-section">
        <h2>Tus listas</h2>
        <div id="listas-loading" style="display: none;">
          <div class="loader"></div>
        </div>
        <div id="listas-container" class="listas-grid">
          <!-- Las listas se cargarán aquí dinámicamente -->
        </div>
        <div id="no-listas-message" style="display: none; text-align: center; padding: 40px; color: #666; font-style: italic;">
          No tienes listas creadas aún. Puedes crear listas guardando documentos desde el boletín diario o la búsqueda.
        </div>
      </div>

      <!-- Sección Generar Contenido -->
      <div id="content-generar-contenido" class="vision-section generar-contenido-page">
        <div class="generar-header">
          <button class="back-arrow" onclick="backToListas()" title="Volver a Tus listas">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div style="display: flex; align-items: center; gap: 15px;">
            <h2 class="generar-title" id="generar-lista-title">Generar contenido</h2>
            <span class="beta-banner">Beta</span>
          </div>
        </div>

        <div class="generar-container">
          <!-- Sección de Ajustes (1/3 del ancho) -->
          <div class="ajustes-section">
            <h3 class="ajustes-title">
              Ajustes de generación
              <button class="save-ajustes-btn" id="save-all-btn" onclick="saveAllSettings()">
                <i class="fas fa-save"></i> Guardar
              </button>
            </h3>
            
            <!-- Instrucciones generales -->
            <div class="ajuste-subsection">
              <div class="ajuste-subtitle">Instrucciones generales</div>
              <textarea 
                class="ajuste-input" 
                id="instrucciones-input" 
                placeholder="Describe cómo quieres que se genere el contenido. Por ejemplo: 'Crea un resumen ejecutivo destacando los puntos clave de cada documento...'"
                onchange="showSaveButton()">
              </textarea>
            </div>

            <!-- Formato y estilo -->
            <div class="ajuste-subsection">
              <div class="ajuste-subtitle">Formato y estilo</div>
              
              <div class="file-input-container">
                <label for="logo-upload" style="display: block; margin-bottom: 5px; font-size: 13px; color: #6c757d;">Logo de la empresa:</label>
                <div class="file-input-custom" onclick="document.getElementById('logo-upload').click()">
                  <i class="fas fa-paperclip file-input-icon"></i>
                  <span class="file-input-text" id="logo-file-text">Ningún archivo seleccionado</span>
                  <div class="file-input-tooltip">Subir archivo</div>
                </div>
                <input 
                  type="file" 
                  id="logo-upload" 
                  class="file-input" 
                  accept="image/*"
                  onchange="handleLogoUpload(this); showSaveButton()">
              </div>

              <div class="color-palette-container">
                <label style="display: block; margin-bottom: 10px; font-size: 13px; color: #6c757d;">Paleta de colores:</label>
                <div class="color-inputs-grid">
                  <div class="color-input-item">
                    <label for="primary-color" style="font-size: 12px; color: #6c757d; margin-bottom: 3px; display: block;">Primario:</label>
                    <input 
                      type="color" 
                      id="primary-color" 
                      class="color-input" 
                      value="#04db8d"
                      onchange="showSaveButton()">
                    <input 
                      type="text" 
                      id="primary-color-hex" 
                      class="hex-input" 
                      value="#04db8d"
                      placeholder="#000000"
                      onchange="updateColorFromHex('primary'); showSaveButton()"
                      oninput="updateColorFromHex('primary'); showSaveButton()">
                  </div>
                  
                  <div class="color-input-item">
                    <label for="secondary-color" style="font-size: 12px; color: #6c757d; margin-bottom: 3px; display: block;">Secundario:</label>
                    <input 
                      type="color" 
                      id="secondary-color" 
                      class="color-input" 
                      value="#0b2431"
                      onchange="showSaveButton()">
                    <input 
                      type="text" 
                      id="secondary-color-hex" 
                      class="hex-input" 
                      value="#0b2431"
                      placeholder="#000000"
                      onchange="updateColorFromHex('secondary'); showSaveButton()"
                      oninput="updateColorFromHex('secondary'); showSaveButton()">
                  </div>
                  
                  <div class="color-input-item">
                    <label for="tertiary-color" style="font-size: 12px; color: #6c757d; margin-bottom: 3px; display: block;">Texto:</label>
                    <input 
                      type="color" 
                      id="tertiary-color" 
                      class="color-input" 
                      value="#455862"
                      onchange="showSaveButton()">
                    <input 
                      type="text" 
                      id="tertiary-color-hex" 
                      class="hex-input" 
                      value="#455862"
                      placeholder="#000000"
                      onchange="updateColorFromHex('tertiary'); showSaveButton()"
                      oninput="updateColorFromHex('tertiary'); showSaveButton()">
                  </div>
                </div>
              </div>
            </div>

            <!-- Contenido -->
            <div class="ajuste-subsection">
              <div class="ajuste-subtitle">Contenido</div>
              
              <div class="subsection-grid">
                <div class="subsection-item">
                  <label for="lenguaje-select" style="display: block; margin-bottom: 5px; font-size: 13px; color: #6c757d;">Lenguaje:</label>
                  <select id="lenguaje-select" class="ajuste-select" onchange="showSaveButton()">
                    <option value="juridico">Jurídico</option>
                    <option value="lego">Lego</option>
                  </select>
                </div>

                <div class="subsection-item">
                  <label for="tipo-documento-select" style="display: block; margin-bottom: 5px; font-size: 13px; color: #6c757d;">Tipo de documento:</label>
                  <select id="tipo-documento-select" class="ajuste-select" onchange="showSaveButton()">
                    <option value="whatsapp">WhatsApp</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="newsletter">Newsletter</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Botón de generar contenido -->
            <button class="generar-final-btn" onclick="generarContenidoFinal()">
              <i class="fas fa-magic" style="margin-right: 8px;"></i>
              Generar contenido
            </button>
          </div>

          <!-- Sección de Documentos (2/3 del ancho) -->
          <div class="documentos-section">
            <h3 class="documentos-title">Documentos</h3>
            
            <!-- Controles de selección -->
            <div class="documentos-controls">
              <div class="select-all-container">
                <input type="checkbox" id="select-all-docs" class="select-all-checkbox" onchange="toggleSelectAllDocuments(this)">
                <label for="select-all-docs" class="select-all-label">Seleccionar todos</label>
              </div>
              <div class="selected-count" id="selected-count">
                Documentos seleccionados: 0
              </div>
            </div>
            
            <div id="documentos-list" class="documentos-list">
              <!-- Los documentos se cargarán aquí dinámicamente -->
            </div>
            
            <!-- Contenedor para mostrar el contenido generado -->
            <div id="contenido-generado" class="contenido-generado" style="display: none;">
              <div id="contenido-html" class="contenido-html">
                <!-- El contenido generado se mostrará aquí -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección Configuración -->
      <div id="content-configuracion" class="vision-section">
        <div id="configuracion-iframe-container" style="width: 100%; height: 100vh; border: none;">
          <!-- The configuration content will be loaded here -->
        </div>
      </div>

      <!-- Sección Cuenta (Contenido de marcador de posición) -->
      <div id="content-cuenta" class="vision-section">
        <h2>Cuenta</h2>
        <p>Estamos trabajando en desarrollar el producto para que próximamente tenga esta nueva funcionalidad.</p>
      </div>

    </div> <!-- Fin de #main-content -->
  </div> <!-- Fin de .profile-container -->


  <!-- Additional JSON data for the chart and plan, etc. -->
  <script id="monthsData" type="application/json">{{months_json}}</script>
  <script id="countsData" type="application/json">{{counts_json}}</script>
  <script id="userPlan" type="application/json">{{subscription_plan}}</script>
  <script id="startDateInput" type="application/json">{{start_date}}</script>
  <script id="endDateInput" type="application/json">{{end_date}}</script>
  <script id="userBoletines" type="application/json">{{user_boletines_json}}</script>
  <script id="userRangos" type="application/json">{{user_rangos_json}}</script>
              <script id="userAcceptedEmail" type="application/json">{{#if accepted_email}}{{accepted_email}}{{else}}null{{/if}}</script>
            <script id="userEmail" type="application/json">"{{email}}"</script>

            <script id="allRangosData" type="application/json">{{all_rangos_json}}</script>

  <!-- Modal para validación de documentos -->
  <div id="modal-no-documentos" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Selecciona documentos</h3>
      <p>Selecciona al menos un documento para generar contenido</p>
      <button class="modal-ok-btn" onclick="closeNoDocumentosModal()">OK</button>
    </div>
  </div>

  <!--<script src="editarSuscripcion.js"></script> -->
  <script src="editarsuscripcion2.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // --------------------- NAV / HAMBURGER ---------------------
    function toggleMenu() {
      const menu = document.querySelector('.menu');
      menu.classList.toggle('active');
    }
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.menu');
      const hamburger = document.querySelector('.hamburger');
      if (event.target && menu && hamburger && !menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    // --------------------- LOADER / CHART ON LOAD ---------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Hide initial loader
      const loaderOverlay = document.getElementById("pageLoaderOverlay");
      if (loaderOverlay) loaderOverlay.style.display = "none";

      // Get user plan early to use throughout the code - make it global
      window.userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');

      // Cargar las listas del usuario al inicio de la página
      loadUserListsFromBackend().then(() => {
        console.log('Listas del usuario cargadas al inicio:', userLists);
      }).catch(error => {
        console.error('Error cargando listas al inicio:', error);
      });

      // Handle plan-specific UI in agentes view
      const userEtiquetasPersonalizadas = JSON.parse(document.getElementById('userEtiquetasPersonalizadas').textContent || '{}');
      const hasEtiquetasPersonalizadas = userEtiquetasPersonalizadas && Object.keys(userEtiquetasPersonalizadas).length > 0;
      
      // Expose globally for later checks
      window.hasEtiquetasPersonalizadas = hasEtiquetasPersonalizadas;
      // Apply visibility rules for agentes view (plan2/3 with no tags)
      if (typeof applyAgentesAdvancedVisibility === 'function') {
        applyAgentesAdvancedVisibility();
      }
      
      // Show radar banner for plan1 users OR plan2/plan3 users without etiquetas_personalizadas
      if (window.userPlan === 'plan1' || ((window.userPlan === 'plan2' || window.userPlan === 'plan3') && !hasEtiquetasPersonalizadas)) {
        const radarBanner = document.getElementById('radar-normativo-banner');
        const betaBanner = document.querySelector('.beta-banner');
        const bannerTitle = document.getElementById('radar-banner-title');
        const bannerDescription = document.getElementById('radar-banner-description');
        const bannerButton = document.getElementById('radar-banner-button');
        
        if (radarBanner) radarBanner.style.display = 'block';
        if (betaBanner) betaBanner.style.display = 'none';
        
        // Update banner content based on plan
        if (window.userPlan === 'plan2' || window.userPlan === 'plan3') {
          // Change content for plan2/plan3 users
          if (bannerTitle) bannerTitle.textContent = 'Configura tu cuenta';
          if (bannerDescription) bannerDescription.textContent = 'Configura tu cuenta para poder filtrar y analizar de manera automática la normativa que te afecta a través de nuestros agentes';
          if (bannerButton) {
            bannerButton.textContent = 'Configura tu cuenta';
            bannerButton.onclick = function(e) {
              e.preventDefault();
              showConfiguracionSection();
              return false;
            };
          }
        } else {
          // Keep original content for plan1 users
          if (bannerButton) {
            bannerButton.onclick = function(e) {
              e.preventDefault();
              // Original plan1 behavior - you can add the subscription upgrade logic here
              window.location.href = 'https://reversa.ai/prices';
              return false;
            };
          }
        }
        
        // Modify the handleBuscar function for plan1 users
        if (window.userPlan === 'plan1') {
          const originalHandleBuscar = window.handleBuscar;
          window.handleBuscar = function() {
            if (window.userPlan === 'plan1') {
              // Show upgrade message instead of search results
              document.querySelector('.collectionDocs').innerHTML = `
                <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <h3 style="color: #0b2431;">¡Mejora tu plan para acceder a esta funcionalidad!</h3>
                  <p style="color: #455862;">Nuestros planes de pago te permiten realizar búsquedas avanzadas y filtrar normativa según tus necesidades específicas.</p>
                  <button onclick="window.location.href='https://reversa.ai/prices'" style="background-color: #04db8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Ver planes</button>
                </div>
              `;
              
              // Hide the analytics sections
              document.querySelectorAll('.analytics-label').forEach(label => {
                if (!label.classList.contains('busqueda')) {
                  label.style.display = 'none';
                }
              });
              const chartContainer = document.getElementById('chartContainer');
              if (chartContainer) {
                chartContainer.style.display = 'none';
              }
              
              // Hide loading indicators
              document.getElementById('loading-icon').style.display = 'none';
              document.getElementById('loading-icon-chart').style.display = 'none';
              
              return; // Stop execution here for plan1 users
            }
            
            // Call the original function for non-plan1 users
            if (typeof originalHandleBuscar === 'function') {
              originalHandleBuscar();
            }
          };
        }
      }

      // Fill default date from server
      const startDateInput = JSON.parse(document.getElementById("startDateInput").textContent || '"2024-01-01T00:00:00.000Z"');
      const formattedDate = new Date(startDateInput).toISOString().split('T')[0];
      const startDate = document.getElementById("startDate");
      if (formattedDate && startDate) {
        startDate.value = formattedDate;
      }

      // If we have months/counts => load chart on first load
      const monthsData = JSON.parse(document.getElementById('monthsData').textContent || '[]');
      const countsData = JSON.parse(document.getElementById('countsData').textContent || '[]');
      if (monthsData.length && countsData.length) {
        loadChart(monthsData, countsData);
      }

      // Check if we should show the newsletter banner
      checkAndShowNewsletterBanner();

       /* 1. Toggle al pulsar en cualquier .dropbtn ------------------ */
       document.querySelectorAll('.dropbtn').forEach(btn => {
         btn.addEventListener('click', e => {
           e.stopPropagation();                     // evita que el click burbujee
           const dropdown = btn.closest('.dropdown');
           const menu     = dropdown?.querySelector('.dropdown-content');
           if (!menu) return;
     
           // Cierra otros menús que pudieran estar abiertos
           document.querySelectorAll('.dropdown-content.show')
                   .forEach(el => { if (el !== menu) el.classList.remove('show'); });
     
           menu.classList.toggle('show');
         });
       });
     
       /* 2. Cerrar cuando se hace click FUERA de cualquier .dropdown -- */
       window.addEventListener('click', e => {
         // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
         const clickedInsideDropdown = e && e.target && typeof e.target.closest === 'function' && !!e.target.closest('.dropdown');
         if (clickedInsideDropdown) return;         // no cerramos nada
     
         // Click fuera  →  cerrar todos los menús abiertos
         document.querySelectorAll('.dropdown-content.show')
                 .forEach(el => el.classList.remove('show'));
       });
     
       // Inicializar las nuevas funciones
       loadAgentesContainer();
       loadEtiquetasDropdown();
       loadBoletinDropdown();
       loadRangoDropdown();
       
       // Inicializar el filtro de nivel de impacto
       handleNivelImpactoChange();
       
       // Check URL parameters to determine which section to show
       const urlParams = new URLSearchParams(window.location.search);
       const viewParam = urlParams.get('view');
       
       // Get user plan
       const userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
       
       // Show Boletín Diario by default for plan1 users or if view=boletin is specified
       if (viewParam === 'boletin' || (userPlan === 'plan1' && !viewParam)) {
         // Hide Agentes section, remove active class
         const agentesSection = document.getElementById('content-agentes');
         const agentesMenuItem = document.querySelector('.sidebar-item[data-target="content-agentes"]');
         if (agentesSection) {
           agentesSection.classList.remove('active');
           agentesSection.style.display = 'none';
         }
         if (agentesMenuItem) {
           agentesMenuItem.classList.remove('active');
         }
         
         // Show Boletín Diario section, add active class
         const boletinSection = document.getElementById('content-boletin');
         const boletinMenuItem = document.querySelector('.sidebar-item[data-target="content-boletin"]');
         if (boletinSection) {
           boletinSection.classList.add('active');
           boletinSection.style.display = 'block';
         }
         if (boletinMenuItem) {
           boletinMenuItem.classList.add('active');
         }
         
         // Populate Boletín Diario filters BEFORE the first data fetch so the dropdown is never empty
         try {
           const userBoletinesInit = JSON.parse(document.getElementById('userBoletines').textContent || '[]');
           const allRangosInit   = JSON.parse(document.getElementById('allRangosData').textContent || '[]');
           populateBoletinDiarioFilters(userBoletinesInit, allRangosInit);
         } catch (err) {
           console.warn('No initial boletín/rango data available, populating defaults.', err);
           populateBoletinDiarioFilters([], []);
         }
         
         // Load boletin data
         if (typeof fetchBoletinDiario === 'function') {
           fetchBoletinDiario();
           boletinDiarioLoaded = true;
         }
       } else if (viewParam === 'configuracion') {
         // Show configuration section by default
         showConfiguracionSection();
       } else {
         // *** EXISTENTE: Lógica para mostrar la sección por defecto (Agentes) ***
         // Asegurarse de que solo la sección activa sea visible al cargar
         document.querySelectorAll('.vision-section').forEach(section => {
           if (!section.classList.contains('active')) {
             section.style.display = 'none';
           } else {
             section.style.display = 'block';
           }
         });
       }
    });

    // --------------------- plan logic => disabling bulletins if plan1 ---------------------
    // Remove the userPlan variable since we're using window.userPlan now
    document.addEventListener("DOMContentLoaded", () => {
      // We already define userPlan in the main DOMContentLoaded event, don't redefine it here
      // userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
    });

    // --------------------- CHART FUNCTIONS ---------------------
   
    let myChart;
    function loadChart(months, counts) {
      const ctx = document.getElementById('documentsChart').getContext('2d');
      if (myChart) {
        myChart.destroy();
      }
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Documentos',
            data: counts,
            borderColor: '#04db8d',
            backgroundColor: 'rgba(4, 219, 141, 0.2)',
            borderWidth: 1,
            fill: true,
            tension: 0.1,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // --------------------- AGENTES ADVANCED SEARCH VISIBILITY ---------------------
    function applyAgentesAdvancedVisibility() {
      const noCustomTags = !window.hasEtiquetasPersonalizadas;
      // Hide advanced search (plan2/3 without tags)
      const hideAdvancedSearch = (window.userPlan === 'plan2' || window.userPlan === 'plan3') && noCustomTags;

      const advancedElements = [
        document.querySelector('.analytics-label.busqueda'),
        document.querySelector('.filter-banner-container'),
        document.getElementById('Filtrar'),
        (function(){ const btn=document.getElementById('buscarBtn'); return btn ? btn.parentElement : null; })()
      ];

      advancedElements.forEach(el => {
        if (el) el.style.display = hideAdvancedSearch ? 'none' : '';
      });

      // Hide "Editar Agentes" button when no custom tags regardless of plan
      const editBtn = document.getElementById('editSuscription2');
      if (editBtn) {
        editBtn.style.display = noCustomTags ? 'none' : '';
      }
    }

    // --------------------- DROPDOWN FUNCTIONS ---------------------
    function toggleIndustryDropdown() {
      document.getElementById("myDropdown").classList.toggle("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleRamaDropdown() {
      document.getElementById("ramaDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleBoletinDropdown() {
      document.getElementById("boletinDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }
    
    function toggleEtiquetasDropdown() {
      document.getElementById("etiquetasDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("rangoDropdown").classList.remove("show");
    }

    function toggleRangoDropdown() {
      document.getElementById("rangoDropdown").classList.toggle("show");
      document.getElementById("myDropdown").classList.remove("show");
      document.getElementById("ramaDropdown").classList.remove("show");
      document.getElementById("boletinDropdown").classList.remove("show");
      document.getElementById("etiquetasDropdown").classList.remove("show");
    }


    // --------------------- AGENTES FUNCTIONS ---------------------
    // Función para cargar y mostrar los agentes suscritos (etiquetas personalizadas)
    function loadAgentesContainer() {
  const agentesContainer = document.getElementById('agentesContainer');
  if (!agentesContainer) return;
  
  // Obtener el email del usuario para verificar si debe mostrar la vista de nodos
  let userEmail = null;
  try {
    // Intentar obtener el email desde el script del template
    const userEmailElement = document.getElementById('userEmail');
    if (userEmailElement && userEmailElement.textContent) {
      userEmail = JSON.parse(userEmailElement.textContent);
    }
  } catch (e) {
    console.log('Error al obtener email del template:', e);
  }
  
  // Si no se encuentra en el template, intentar desde sessionStorage
  if (!userEmail) {
    userEmail = sessionStorage.getItem('userEmail');
  }
  
  console.log('Email del usuario:', userEmail); // Para debug
  const showNodesView = userEmail === 'burgalonso@gmail.com';
  console.log('¿Mostrar vista de nodos?', showNodesView); // Para debug
  
  // Cambiar el título y la clase del contenedor según el usuario
  const etiquetasLabel = document.querySelector('.etiquetas-label');
  if (etiquetasLabel && showNodesView) {
    etiquetasLabel.textContent = 'Nodos';
    console.log('Título cambiado a "Nodos"'); // Para debug
    
    // Cambiar la clase del contenedor para evitar conflictos de CSS
    agentesContainer.className = 'nodos-container-section';
  } else {
    // Mantener la clase original para usuarios normales
    agentesContainer.className = 'etiquetas-values';
  }
  
  // Obtener las etiquetas personalizadas del usuario 
  const etiquetasPersonalizadas = JSON.parse(document.getElementById('userEtiquetasPersonalizadas').textContent || '{}');
  
  // En el documento de usuario, etiquetas_personalizadas es directamente el objeto de etiquetas,
  // no contiene un objeto anidado con userId como clave
  const etiquetasKeys = Object.keys(etiquetasPersonalizadas);
  
  // Si no hay etiquetas personalizadas, mostrar mensaje
  if (etiquetasKeys.length === 0) {
    agentesContainer.innerHTML = '<div class="no-agentes">No hay agentes configurados</div>';
    return;
  }
  
  if (showNodesView) {
    // Vista de nodos para el usuario específico
    loadNodesView(etiquetasPersonalizadas, agentesContainer);
  } else {
    // Vista normal para otros usuarios
    loadNormalView(etiquetasPersonalizadas, agentesContainer);
  }
}

// Vista normal de agentes
function loadNormalView(etiquetasPersonalizadas, agentesContainer) {
  // Crear HTML para mostrar las etiquetas personalizadas
  let agentesHtml = '';
  Object.entries(etiquetasPersonalizadas).forEach(([etiqueta, etiquetaData]) => {
    let descripcion = '';
    let nivelImpacto = '';
    
    if (typeof etiquetaData === 'string') {
      // Estructura antigua: solo string
      descripcion = etiquetaData;
    } else if (typeof etiquetaData === 'object' && etiquetaData !== null) {
      // Estructura nueva: objeto con explicacion y nivel_impacto
      descripcion = etiquetaData.explicacion || '';
      nivelImpacto = etiquetaData.nivel_impacto || '';
    }
    
    // Generar tag de nivel de impacto con colores
    let nivelTag = '';
    if (nivelImpacto) {
      let bgColor = '#f8f9fa';
      let textColor = '#6c757d';
      
      switch (nivelImpacto.toLowerCase()) {
        case 'alto':
          bgColor = '#ffe6e6';
          textColor = '#dc3545';
          break;
        case 'medio':
          bgColor = '#fff3cd';
          textColor = '#856404';
          break;
        case 'bajo':
          bgColor = '#d4edda';
          textColor = '#155724';
          break;
      }
      
      nivelTag = `<span class="nivel-impacto-tag" style="background-color: ${bgColor}; color: ${textColor}; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500; margin-left: 8px;">${nivelImpacto}</span>`;
    }
    
    agentesHtml += `
      <div class="agente-item">
        <span class="agente-nombre">
          ${etiqueta}${nivelTag}
          <i class="fas fa-info-circle agente-descripcion" title="${descripcion}"></i>
        </span>
      </div>
    `;
  });
  
  agentesContainer.innerHTML = agentesHtml;
}

// Vista de nodos para el usuario específico
function loadNodesView(etiquetasPersonalizadas, agentesContainer) {
  // Definir los nodos y sus agentes asociados
  const nodos = {
    'tecnologia': {
      nombre: 'Tecnología y Digitalización',
      icono: 'fas fa-laptop-code',
      agentes: [
        'Inteligencia regulatoria en asuntos públicos',
        'Competencias Digitales & STEM',
        'Consumidor Digital & E-Commerce',
        'IA & Tecnologías Emergentes',
        'Plataformas Digitales & Contenido',
        'Protección de Datos & Ciberseguridad',
        'Menores & Usuarios Vulnerables',
        'Atención Rural & Personalizada',
      ]
    },
    'banca': {
      nombre: 'Banca y Finanzas',
      icono: 'fas fa-university',
      agentes: [
        'Banca & Política Fiscal',
        'Crédito & Financiación',
        'Inclusión Financiera & Comisiones',
        'Mercados & Inversión Colectiva',
        'ESG & Buen Gobierno'
      ]
    },
    'energia': {
      nombre: 'Energía',
      icono: 'fas fa-bolt',
      agentes: [
        'Energía Convencional y Combustibles Fósiles',
        'Energías Renovables y Transición Energética',
        'Emisiones de Carbono, Captura y Economía Circular'
      ]
    },
    'salud': {
      nombre: 'Salud y Farma',
      icono: 'fas fa-heartbeat',
      agentes: [
        
        'Enfermedades Crónicas de Alto Impacto',
        'Enfermedades Raras y Medicamentos Huérfanos',
        'Oncología y Medicina de Precisión',
        'Política Farmacéutica, Acceso y Compra Innovadora',
        'Resistencias Antimicrobianas y Seguridad Clínica',
        'Vacunación, Inmunización y Enfermedades Infecciosas',
        'Salud Digital, IA y Datos Reales'
      ]
    },
    'residuos': {
      nombre: 'Gestión de Residuos y Reciclaje',
      icono: 'fas fa-recycle',
      agentes: [
        'Gestión y Tratamiento de Residuos',
        'Economía Circular & Responsabilidad del Productor',
        'Circularidad & Reporting ESG'
      ]
    }
  };
  
  // Filtrar solo los agentes que el usuario tiene configurados y que están en los nodos
  const agentesUsuario = Object.keys(etiquetasPersonalizadas);
  const nodosConAgentes = {};
  
  Object.entries(nodos).forEach(([nodoId, nodoData]) => {
    const agentesEncontrados = nodoData.agentes.filter(agente => 
      agentesUsuario.includes(agente)
    );
    if (agentesEncontrados.length > 0) {
      nodosConAgentes[nodoId] = {
        ...nodoData,
        agentesUsuario: agentesEncontrados
      };
    }
  });
  
  // Si no hay nodos con agentes, mostrar mensaje
  if (Object.keys(nodosConAgentes).length === 0) {
    agentesContainer.innerHTML = '<div class="no-agentes">No hay agentes configurados en los nodos disponibles</div>';
    return;
  }
  
  // Crear HTML para la vista de nodos
  let nodosHtml = `
    <div class="nodos-container">
      <div class="nodos-menu">
  `;
  
  // Crear los tabs de los nodos
  Object.entries(nodosConAgentes).forEach(([nodoId, nodoData], index) => {
    const activeClass = index === 0 ? 'active' : '';
    nodosHtml += `
      <div class="nodo-tab ${activeClass}" data-nodo="${nodoId}">
        <i class="${nodoData.icono}"></i>
        <span>${nodoData.nombre}</span>
      </div>
    `;
  });
  
  nodosHtml += `
      </div>
      <div class="nodo-content">
  `;
  
  // Crear el contenido de cada nodo
  Object.entries(nodosConAgentes).forEach(([nodoId, nodoData], index) => {
    const activeClass = index === 0 ? 'active' : '';
    nodosHtml += `
      <div class="nodo-agentes ${activeClass}" data-nodo="${nodoId}">
    `;
    
    nodoData.agentesUsuario.forEach(agente => {
      const etiquetaData = etiquetasPersonalizadas[agente];
      let descripcion = '';
      let nivelImpacto = '';
      
      if (typeof etiquetaData === 'string') {
        descripcion = etiquetaData;
      } else if (typeof etiquetaData === 'object' && etiquetaData !== null) {
        descripcion = etiquetaData.explicacion || '';
        nivelImpacto = etiquetaData.nivel_impacto || '';
      }
      
      // Generar tag de nivel de impacto
      let nivelTag = '';
      if (nivelImpacto) {
        let bgColor = '#f8f9fa';
        let textColor = '#6c757d';
        
        switch (nivelImpacto.toLowerCase()) {
          case 'alto':
            bgColor = '#ffe6e6';
            textColor = '#dc3545';
            break;
          case 'medio':
            bgColor = '#fff3cd';
            textColor = '#856404';
            break;
          case 'bajo':
            bgColor = '#d4edda';
            textColor = '#155724';
            break;
        }
        
        nivelTag = `<span class="nivel-impacto-tag" style="background-color: ${bgColor}; color: ${textColor}; padding: 2px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500; margin-left: 8px;">${nivelImpacto}</span>`;
      }
      
      nodosHtml += `
        <div class="nodo-agente-item" title="${descripcion}">
          ${agente}${nivelTag}
        </div>
      `;
    });
    
    nodosHtml += `
      </div>
    `;
  });
  
  nodosHtml += `
      </div>
    </div>
  `;
  
  agentesContainer.innerHTML = nodosHtml;
  
  // Agregar event listeners para los tabs
  document.querySelectorAll('.nodo-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const nodoId = this.dataset.nodo;
      
      // Remover clase active de todos los tabs y contenidos
      document.querySelectorAll('.nodo-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nodo-agentes').forEach(content => content.classList.remove('active'));
      
      // Agregar clase active al tab y contenido seleccionado
      this.classList.add('active');
      document.querySelector(`.nodo-agentes[data-nodo="${nodoId}"]`).classList.add('active');
      
      // Actualizar el dropdown de etiquetas para mostrar solo los agentes del nodo seleccionado
      loadEtiquetasDropdown();
    });
  });
}

// Función para obtener los agentes del nodo activo
function getAgentesFromActiveNode(etiquetasPersonalizadas) {
  // Definir los nodos y sus agentes (misma estructura que en loadNodesView)
  const nodos = {
    'tecnologia': {
      agentes: [
        'Inteligencia regulatoria en asuntos públicos',
        'Competencias Digitales & STEM',
        'Consumidor Digital & E-Commerce',
        'IA & Tecnologías Emergentes',
        'Plataformas Digitales & Contenido',
        'Protección de Datos & Ciberseguridad',
        'Menores & Usuarios Vulnerables'
      ]
    },
    'banca': {
      agentes: [
        'Banca & Política Fiscal',
        'Crédito & Financiación',
        'Inclusión Financiera & Comisiones',
        'Mercados & Inversión Colectiva',
        'ESG & Buen Gobierno'
      ]
    },
    'energia': {
      agentes: [
        'Energía Convencional y Combustibles Fósiles',
        'Energías Renovables y Transición Energética',
        'Emisiones de Carbono, Captura y Economía Circular'
      ]
    },
    'salud': {
      agentes: [
        'Atención Rural & Personalizada',
        'Enfermedades Crónicas de Alto Impacto',
        'Enfermedades Raras y Medicamentos Huérfanos',
        'Oncología y Medicina de Precisión',
        'Política Farmacéutica, Acceso y Compra Innovadora',
        'Resistencias Antimicrobianas y Seguridad Clínica',
        'Vacunación, Inmunización y Enfermedades Infecciosas',
        'Salud Digital, IA y Datos Reales'
      ]
    },
    'residuos': {
      agentes: [
        'Gestión y Tratamiento de Residuos',
        'Economía Circular & Responsabilidad del Productor',
        'Circularidad & Reporting ESG'
      ]
    }
  };
  
  // Encontrar el nodo activo
  const activeTab = document.querySelector('.nodo-tab.active');
  if (!activeTab) {
    // Si no hay nodo activo, devolver todas las etiquetas del usuario
    return Object.keys(etiquetasPersonalizadas);
  }
  
  const activeNodeId = activeTab.dataset.nodo;
  const activeNode = nodos[activeNodeId];
  
  if (!activeNode) {
    // Si no se encuentra el nodo, devolver todas las etiquetas del usuario
    return Object.keys(etiquetasPersonalizadas);
  }
  
  // Filtrar solo los agentes que el usuario tiene y que pertenecen al nodo activo
  const agentesUsuario = Object.keys(etiquetasPersonalizadas);
  return activeNode.agentes.filter(agente => agentesUsuario.includes(agente));
}

    // Función para cargar y mostrar las etiquetas personalizadas en el dropdown de búsqueda
    function loadEtiquetasDropdown() {
  const etiquetasDropdown = document.getElementById('etiquetasDropdown');
  if (!etiquetasDropdown) return;
  
  // Verificar si es el usuario específico y si está usando la vista de nodos
  let userEmail = null;
  try {
    const userEmailElement = document.getElementById('userEmail');
    if (userEmailElement && userEmailElement.textContent) {
      userEmail = JSON.parse(userEmailElement.textContent);
    }
  } catch (e) {
    userEmail = sessionStorage.getItem('userEmail');
  }
  
  const isNodesUser = userEmail === 'burgalonso@gmail.com';
  
  // Obtener las etiquetas personalizadas del usuario (directamente, no anidado por userId)
  const etiquetasPersonalizadas = JSON.parse(document.getElementById('userEtiquetasPersonalizadas').textContent || '{}');
  let etiquetasKeys = Object.keys(etiquetasPersonalizadas);
  
  // Si es el usuario de nodos, filtrar por el nodo activo
  if (isNodesUser) {
    etiquetasKeys = getAgentesFromActiveNode(etiquetasPersonalizadas);
  }
  
  // Si no hay etiquetas personalizadas, mostrar mensaje
  if (etiquetasKeys.length === 0) {
    etiquetasDropdown.innerHTML = '<div class="no-etiquetas">No hay agentes configurados</div>';
    return;
  }
  
  // Crear el checkbox "Todos"
  let html = `<label><input type="checkbox" value="Todas" id="chkAllEtiquetas" checked> Todos</label>`;
  
  // Crear un checkbox para cada etiqueta personalizada
  etiquetasKeys.forEach(etiqueta => {
    html += `<label><input type="checkbox" value="${etiqueta}" checked> ${etiqueta}</label>`;
  });
  
  etiquetasDropdown.innerHTML = html;
  
  // Añadir event listener al checkbox "Todos"
  const chkAllEtiquetas = document.getElementById('chkAllEtiquetas');
  if (chkAllEtiquetas) {
    chkAllEtiquetas.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      const etiquetasCheckboxes = etiquetasDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllEtiquetas)');
      etiquetasCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      updateSelectedEtiquetasText();
    });
  }
  
  // Añadir event listeners a los checkboxes de etiquetas
  const etiquetasCheckboxes = etiquetasDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllEtiquetas)');
  etiquetasCheckboxes.forEach(cb => {
    cb.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      // Verificar si todos los checkboxes están marcados o desmarcados
      const allChecked = Array.from(etiquetasCheckboxes).every(cb => cb.checked);
      const noneChecked = Array.from(etiquetasCheckboxes).every(cb => !cb.checked);
      
      // Actualizar el checkbox "Todos" según corresponda
      if (chkAllEtiquetas) {
        chkAllEtiquetas.checked = allChecked;
        chkAllEtiquetas.indeterminate = !allChecked && !noneChecked;
      }
      
      updateSelectedEtiquetasText();
    });
  });
  
  // Inicializar el texto seleccionado
  updateSelectedEtiquetasText();
}
   
// Función para actualizar el texto del botón de etiquetas
function updateSelectedEtiquetasText() {
  const etiquetasDropdown = document.getElementById('etiquetasDropdown');
  const selectedEtiquetasSpan = document.getElementById('selectedEtiquetas');
  if (!etiquetasDropdown || !selectedEtiquetasSpan) return;
  
  const etiquetasCheckboxes = etiquetasDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllEtiquetas)');
  const selectedEtiquetas = Array.from(etiquetasCheckboxes).filter(cb => cb.checked);
  
  if (selectedEtiquetas.length === 0) {
    selectedEtiquetasSpan.textContent = 'Ninguno';
  } else if (selectedEtiquetas.length === etiquetasCheckboxes.length) {
    selectedEtiquetasSpan.textContent = 'Todos';
  } else if (selectedEtiquetas.length <= 2) {
    selectedEtiquetasSpan.textContent = selectedEtiquetas.map(cb => cb.value).join(', ');
  } else {
    selectedEtiquetasSpan.textContent = `${selectedEtiquetas.length} seleccionados`;
  }
}

// Función para mostrar/ocultar el dropdown de etiquetas
function toggleEtiquetasDropdown(event) {
  if (event) event.stopPropagation(); // Detener la propagación del evento
  document.getElementById('etiquetasDropdown').classList.toggle('show');
}

//---------------------- Boletin functions---------------------
function loadBoletinDropdown() {
  const boletinDropdown = document.getElementById('boletinDropdown');
  if (!boletinDropdown) return;
  
  // Obtener las fuentes del usuario (cobertura_legal)
  const coberturaLegal = JSON.parse(document.getElementById('userBoletines').textContent || '[]');
  
  // Crear el checkbox "Todos"
  let html = `<label><input type="checkbox" value="Todos" id="chkAllBoletin" checked> Todos</label>`;
  
  // Añadir todas las fuentes del array directamente (solo las de la cobertura legal del usuario)
  if (Array.isArray(coberturaLegal)) {
    coberturaLegal.forEach(fuente => {
      html += `<label><input type="checkbox" value="${fuente}" checked> ${fuente.toUpperCase()}</label>`;
    });
  }
  
  boletinDropdown.innerHTML = html;
  
  // Añadir event listener al checkbox "Todos"
  const chkAllBoletin = document.getElementById('chkAllBoletin');
  if (chkAllBoletin) {
    chkAllBoletin.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      const boletinCheckboxes = boletinDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletin)');
      boletinCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      updateSelectedBoletinesText();
    });
  }
  
  // Añadir event listeners a los checkboxes de boletines
  const boletinCheckboxes = boletinDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletin)');
  boletinCheckboxes.forEach(cb => {
    cb.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      // Verificar si todos los checkboxes están marcados o desmarcados
      const allChecked = Array.from(boletinCheckboxes).every(cb => cb.checked);
      const noneChecked = Array.from(boletinCheckboxes).every(cb => !cb.checked);
      
      // Actualizar el checkbox "Todos" según corresponda
      if (chkAllBoletin) {
        chkAllBoletin.checked = allChecked;
        chkAllBoletin.indeterminate = !allChecked && !noneChecked;
      }
      
      updateSelectedBoletinesText();
    });
  });
  
  // Inicializar el texto seleccionado
  updateSelectedBoletinesText();
}
function updateSelectedBoletinesText() {
  const boletinDropdown = document.getElementById('boletinDropdown');
  const selectedBoletinesSpan = document.getElementById('selectedBoletines');
  if (!boletinDropdown || !selectedBoletinesSpan) return;
  
  const boletinCheckboxes = boletinDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletin)');
  const selectedBoletines = Array.from(boletinCheckboxes).filter(cb => cb.checked);
  
  if (selectedBoletines.length === 0) {
    selectedBoletinesSpan.textContent = 'Ninguno';
  } else if (selectedBoletines.length === boletinCheckboxes.length) {
    selectedBoletinesSpan.textContent = 'Todos';
  } else if (selectedBoletines.length <= 2) {
    selectedBoletinesSpan.textContent = selectedBoletines.map(cb => cb.value).join(', ');
  } else {
    selectedBoletinesSpan.textContent = `${selectedBoletines.length} seleccionados`;
  }
}

// Función para mostrar/ocultar el dropdown de boletines
function toggleBoletinDropdown(event) {
  if (event) event.stopPropagation(); // Detener la propagación del evento
  document.getElementById('boletinDropdown').classList.toggle('show');
}


//------------------------- Rangos --------------------------------
// Función para cargar los rangos en el dropdown

function loadRangoDropdown() {
  const rangoDropdown = document.getElementById('rangoDropdown');
  if (!rangoDropdown) return;
  
  // Obtener los rangos del usuario
  const userRangos = JSON.parse(document.getElementById('userRangos').textContent || '[]');
  
  // Crear el checkbox "Todos"
  let html = `<label><input type="checkbox" value="Todos" id="chkAllRango" checked> Todos</label>`;
  
  // Añadir todos los rangos del usuario
  if (Array.isArray(userRangos)) {
    userRangos.forEach(rango => {
      html += `<label><input type="checkbox" value="${rango}" checked> ${rango}</label>`;
    });
  }
  
  rangoDropdown.innerHTML = html;
  
  // Añadir event listener al checkbox "Todos"
  const chkAllRango = document.getElementById('chkAllRango');
  if (chkAllRango) {
    chkAllRango.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      const rangoCheckboxes = rangoDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
      rangoCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      updateSelectedRangoText();
    });
  }
  
  // Añadir event listeners a los checkboxes de rangos
  const rangoCheckboxes = rangoDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
  rangoCheckboxes.forEach(cb => {
    cb.addEventListener('change', function(event) {
      // Detener la propagación del evento para evitar que se cierre el dropdown
      event.stopPropagation();
      
      // Verificar si todos los checkboxes están marcados o desmarcados
      const allChecked = Array.from(rangoCheckboxes).every(cb => cb.checked);
      const noneChecked = Array.from(rangoCheckboxes).every(cb => !cb.checked);
      
      // Actualizar el checkbox "Todos" según corresponda
      if (chkAllRango) {
        chkAllRango.checked = allChecked;
        chkAllRango.indeterminate = !allChecked && !noneChecked;
      }
      
      updateSelectedRangoText();
    });
  });
  
  // Inicializar el texto seleccionado
  updateSelectedRangoText();
}
// Función para actualizar el texto de rangos seleccionados
function updateSelectedRangoText() {
  const rangoDropdown = document.getElementById('rangoDropdown');
  const selectedRangoSpan = document.getElementById('selectedRango');
  if (!rangoDropdown || !selectedRangoSpan) return;
  
  const rangoCheckboxes = rangoDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
  const selectedRangos = Array.from(rangoCheckboxes).filter(cb => cb.checked);
  
  if (selectedRangos.length === 0) {
    selectedRangoSpan.textContent = 'Ninguno';
  } else if (selectedRangos.length === rangoCheckboxes.length) {
    selectedRangoSpan.textContent = 'Todos';
  } else if (selectedRangos.length <= 2) {
    selectedRangoSpan.textContent = selectedRangos.map(cb => cb.value).join(', ');
  } else {
    selectedRangoSpan.textContent = `${selectedRangos.length} seleccionados`;
  }
}

// Función para mostrar/ocultar el dropdown de rangos
function toggleRangoDropdown(event) {
  if (event) event.stopPropagation(); // Detener la propagación del evento
  document.getElementById('rangoDropdown').classList.toggle('show');
}

// Función para mostrar/ocultar el dropdown de nivel de impacto
function toggleNivelImpactoDropdown(event) {
  if (event) event.stopPropagation(); // Detener la propagación del evento
  document.getElementById('nivelImpactoDropdown').classList.toggle('show');
}

// Función para filtrar documentos por nivel de impacto
function filterDocumentsByNivelImpacto(selectedLevel) {
  const documents = document.querySelectorAll('.data-item');
  let visibleCount = 0;
  
  documents.forEach(doc => {
    let shouldShow = true;
    
    if (selectedLevel !== 'todos') {
      // Buscar en la sección de impacto en agentes si existe
      const impactoSection = doc.querySelector('.impacto-agentes');
      let hasMatchingLevel = false;
      
      if (impactoSection) {
        // Buscar todos los spans que contienen nivel de impacto
        const nivelTags = impactoSection.querySelectorAll('span[style*="background-color"]');
        
        nivelTags.forEach(tag => {
          const tagText = tag.textContent.toLowerCase().trim();
          if (tagText === selectedLevel.toLowerCase()) {
            hasMatchingLevel = true;
          }
        });
      }
      
      // Solo mostrar documentos que tienen el nivel seleccionado
      shouldShow = hasMatchingLevel;
    }
    
    if (shouldShow) {
      doc.style.display = 'block';
      visibleCount++;
    } else {
      doc.style.display = 'none';
    }
  });
  
  // Actualizar contador si existe
  console.log(`Documentos visibles: ${visibleCount} de ${documents.length}`);
  
  // Mostrar mensaje si no hay documentos visibles
  const collectionDocs = document.querySelector('.collectionDocs');
  let noResultsMessage = collectionDocs.querySelector('.no-results-nivel');
  
  if (visibleCount === 0 && selectedLevel !== 'todos') {
    if (!noResultsMessage) {
      noResultsMessage = document.createElement('div');
      noResultsMessage.className = 'no-results-nivel';
      noResultsMessage.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0; background-color: #f9f9f9;';
      noResultsMessage.textContent = `No hay documentos con nivel de impacto "${selectedLevel.charAt(0).toUpperCase() + selectedLevel.slice(1)}"`;
      collectionDocs.appendChild(noResultsMessage);
    }
    noResultsMessage.style.display = 'block';
  } else if (noResultsMessage) {
    noResultsMessage.style.display = 'none';
  }
}

// Función para manejar el cambio de filtro de nivel de impacto
function handleNivelImpactoChange() {
  const nivelImpactoDropdown = document.getElementById('nivelImpactoDropdown');
  const selectedNivelSpan = document.getElementById('selectedNivelImpacto');
  const selectedNivelCirculo = document.getElementById('selectedNivelCirculo');
  
  if (!nivelImpactoDropdown || !selectedNivelSpan || !selectedNivelCirculo) return;
  
  const radioButtons = nivelImpactoDropdown.querySelectorAll('input[type="radio"]');
  
  radioButtons.forEach(radio => {
    radio.addEventListener('change', function(event) {
      event.stopPropagation();
      
      if (this.checked) {
        const selectedValue = this.value;
        const labelText = this.parentElement.textContent.trim();
        
        // Actualizar el texto del botón
        selectedNivelSpan.textContent = labelText;
        
        // Actualizar el círculo del botón
        const circuloClass = `nivel-circulo-${selectedValue}`;
        selectedNivelCirculo.className = `nivel-circulo ${circuloClass}`;
        
        // Filtrar documentos
        filterDocumentsByNivelImpacto(selectedValue);
        
        // Cerrar el dropdown
        nivelImpactoDropdown.classList.remove('show');
      }
    });
  });
}

    // --------------------- BÚSQUEDA FUNCTION ---------------------
    function handleBuscar() {
  // Mostrar loader
  document.getElementById('chartContainer').style.display = 'none';
  document.getElementById('loading-icon').style.display = 'block';
  document.getElementById('loading-icon-chart').style.display = 'block';
  
  // Recopilar los valores de los filtros
  
  // 1. Etiquetas personalizadas (filtro principal)
  let selectedEtiquetas = [];
  const etiquetasDropdown = document.getElementById('etiquetasDropdown');
  
  // Verificar si está seleccionado "Todos"
  const allEtiquetasSelected = document.getElementById('chkAllEtiquetas')?.checked;
  
  if (allEtiquetasSelected) {
    // Si "Todos" está seleccionado, usar todas las etiquetas del usuario (estructura directa)
    const etiquetasPersonalizadas = JSON.parse(document.getElementById('userEtiquetasPersonalizadas').textContent || '{}');
    selectedEtiquetas = Object.keys(etiquetasPersonalizadas).map(etiqueta => etiqueta.toLowerCase());
  } else if (etiquetasDropdown) {
    // Si no, usar solo las etiquetas seleccionadas
    const etiquetasCheckboxes = etiquetasDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllEtiquetas)');
    selectedEtiquetas = Array.from(etiquetasCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value.toLowerCase()); // Convertir a minúsculas para comparación case-insensitive
  }
  
  // Si no hay etiquetas seleccionadas, mostrar mensaje y no realizar la búsqueda
  if (selectedEtiquetas.length === 0) {
    document.querySelector('.collectionDocs').innerHTML = `
      <div class="no-results" style="color: #04db8d; font-weight: bold; padding: 20px; text-align: center; font-size: 16px; background-color: #f8f9fa; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        Por favor, selecciona al menos un agente para realizar la búsqueda.
      </div>
    `;
    document.getElementById('loading-icon').style.display = 'none';
    document.getElementById('loading-icon-chart').style.display = 'none';
    
    // Ocultar los títulos y el contenedor del gráfico
    const analyticsLabels = document.querySelectorAll('.analytics-label');
    analyticsLabels.forEach(label => {
      if (!label.classList.contains('busqueda')) {
        label.style.display = 'none';
      }
    });
    const chartContainer = document.getElementById('chartContainer');
    if (chartContainer) {
      chartContainer.style.display = 'none';
    }
    
    return;
  }
  
  // 2. Boletines
  let selectedBoletines = [];
  const boletinDropdown = document.getElementById('boletinDropdown');
  if (boletinDropdown) {
    const boletinCheckboxes = boletinDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletin)');
    selectedBoletines = Array.from(boletinCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
  }
  
  // 3. Rangos
  let selectedRangos = [];
  const rangoDropdown = document.getElementById('rangoDropdown');
  if (rangoDropdown) {
    const rangoCheckboxes = rangoDropdown.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
    selectedRangos = Array.from(rangoCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
  }
  
  // 4. Fechas
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  
  // Construir la URL con los parámetros de búsqueda
  let searchParams = new URLSearchParams();
  
  // Añadir etiquetas personalizadas
  if (selectedEtiquetas.length > 0) {
    searchParams.append('etiquetas', selectedEtiquetas.join('||'));
  }
  
  // Añadir boletines
  if (selectedBoletines.length > 0) {
    searchParams.append('collections', selectedBoletines.join('||'));
  }
  
  // Añadir rangos
  if (selectedRangos.length > 0) {
    searchParams.append('rango', selectedRangos.join('||'));
  }
  
  // Añadir fechas
  if (startDate) {
    searchParams.append('desde', startDate);
  }
  if (endDate) {
    searchParams.append('hasta', endDate);
  }
  
  // Realizar la petición al servidor
  fetch(`/data?${searchParams.toString()}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Error en la búsqueda: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      // Actualizar el contenido de documentos
      document.querySelector('.collectionDocs').innerHTML = data.documentsHtml;
      
      // Ocultar o mostrar los títulos de estadísticas y documentos según la respuesta
      const analyticsLabels = document.querySelectorAll('.analytics-label');
      const chartContainer = document.getElementById('chartContainer');
      
      if (data.hideAnalyticsLabels) {
        // Ocultar los títulos y el contenedor del gráfico
        analyticsLabels.forEach(label => {
          if (!label.classList.contains('busqueda')) {
            label.style.display = 'none';
          }
        });
        if (chartContainer) {
          chartContainer.style.display = 'none';
        }
      } else {
        // Mostrar los títulos y el contenedor del gráfico
        analyticsLabels.forEach(label => {
          if (!label.classList.contains('busqueda')) {
            label.style.display = 'block';
          }
        });
        if (chartContainer) {
          chartContainer.style.display = 'block';
        }
        
        // Si hay datos para el gráfico, actualizarlo
        if (data.monthsForChart && data.countsForChart) {
          loadChart(data.monthsForChart, data.countsForChart);
        }
      }
      
      // Ocultar los loaders
      document.getElementById('loading-icon').style.display = 'none';
      document.getElementById('loading-icon-chart').style.display = 'none';
      
      // Reiniciar el filtro de nivel de impacto a "Todos"
      const nivelImpactoRadio = document.querySelector('input[name="nivelImpacto"][value="todos"]');
      const selectedNivelSpan = document.getElementById('selectedNivelImpacto');
      const selectedNivelCirculo = document.getElementById('selectedNivelCirculo');
      if (nivelImpactoRadio && selectedNivelSpan && selectedNivelCirculo) {
        nivelImpactoRadio.checked = true;
        selectedNivelSpan.textContent = 'Todos';
        selectedNivelCirculo.className = 'nivel-circulo nivel-circulo-todos';
        filterDocumentsByNivelImpacto('todos');
      }
    })
          .catch(error => {
        console.error('Error:', error);
        document.querySelector('.collectionDocs').innerHTML = `<div class="no-results">Error al realizar la búsqueda: ${error.message}</div>`;
        document.getElementById('loading-icon').style.display = 'none';
        document.getElementById('loading-icon-chart').style.display = 'none';
        
        // Reiniciar el filtro de nivel de impacto a "Todos"
        const nivelImpactoRadio = document.querySelector('input[name="nivelImpacto"][value="todos"]');
        const selectedNivelSpan = document.getElementById('selectedNivelImpacto');
        const selectedNivelCirculo = document.getElementById('selectedNivelCirculo');
        if (nivelImpactoRadio && selectedNivelSpan && selectedNivelCirculo) {
          nivelImpactoRadio.checked = true;
          selectedNivelSpan.textContent = 'Todos';
          selectedNivelCirculo.className = 'nivel-circulo nivel-circulo-todos';
        }
      });
}
 
    // --------------------- FEEDBACK FUNCTION ---------------------
    async function sendFeedback(docId, feedbackType, element) {
      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            docId,
            feedbackType
          })
        });
        
        if (response.ok) {
          // Cambiar color del icono
          if (feedbackType === 'like') {
            element.style.color = '#04db8d';
            // Resetear el dislike si existe
            const dislikeIcon = element.nextElementSibling;
            if (dislikeIcon) dislikeIcon.style.color = '';
          } else {
            element.style.color = '#ff6b6b';
            // Resetear el like si existe
            const likeIcon = element.previousElementSibling;
            if (likeIcon) likeIcon.style.color = '';
          }
        }
      } catch (error) {
        console.error('Error sending feedback:', error);
      }
    }
/*----- Boletin diario ---------------*/

// --- LÓGICA PARA BOLETÍN DIARIO ---

let boletinDiarioData = { // Para almacenar los datos actuales
    date: null,
    documents: [],
    availableBoletines: [],
    availableRangos: []
};
let boletinDiarioLoaded = false; // Para cargar solo una vez al activar la sección

// Función para obtener los datos del Boletín Diario desde la API
async function fetchBoletinDiario() {
    const loadingIcon = document.getElementById('boletin-loading-icon');
    const container = document.getElementById('boletin-documentos-container');
    const fechaContainer = document.getElementById('boletin-fecha');

    if (!loadingIcon || !container || !fechaContainer) return; // Salir si los elementos no existen

    loadingIcon.style.display = 'block';
    container.innerHTML = ''; // Limpiar contenedor
    fechaContainer.textContent = 'Cargando fecha...';

    // Obtener filtros seleccionados
    const selectedBoletines = getSelectedCheckboxes('boletinDiarioDropdown');
    const selectedRangos = getSelectedCheckboxes('rangoDiarioDropdown');

    // Construir URL con parámetros
    const params = new URLSearchParams();
    // Solo añadir el parámetro si no se seleccionó 'Todos' (o si el array no está vacío)
    if (selectedBoletines.length > 0) {
        params.append('boletines', JSON.stringify(selectedBoletines));
    }
    if (selectedRangos.length > 0) {
        params.append('rangos', JSON.stringify(selectedRangos));
    }

    try {
        console.log(`Fetching /api/boletin-diario?${params.toString()}`);
        const response = await fetch(`/api/boletin-diario?${params.toString()}`);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        boletinDiarioData = await response.json();
        console.log('Boletin Diario Data Received:', boletinDiarioData);

        // Actualizar fecha
        if (boletinDiarioData.date) {
            fechaContainer.textContent = `Documentos del ${String(boletinDiarioData.date.dia).padStart(2, '0')}/${String(boletinDiarioData.date.mes).padStart(2, '0')}/${boletinDiarioData.date.anio}`;
        } else {
            fechaContainer.textContent = 'No se encontraron documentos para la fecha más reciente.';
        }

        // Renderizar documentos
        renderBoletinDocumentos(boletinDiarioData.documents);

        // Poblar filtros (solo la primera vez que se cargan los datos)
        if (!boletinDiarioLoaded) {
            // Usar los datos devueltos por la API para asegurar consistencia
            populateBoletinDiarioFilters(boletinDiarioData.availableBoletines || [], boletinDiarioData.availableRangos || []);
            boletinDiarioLoaded = true;
        }

    } catch (error) {
        console.error('Error fetching Boletin Diario:', error);
        container.innerHTML = `<p style="color: red;">Error al cargar los documentos del boletín diario. Detalles: ${error.message}</p>`;
        fechaContainer.textContent = 'Error al cargar la fecha.';
    } finally {
        if (loadingIcon) loadingIcon.style.display = 'none';
    }
}

// Función para renderizar los documentos del boletín
function renderBoletinDocumentos(documents) {
    const container = document.getElementById('boletin-documentos-container');
    if (!container) return;

    if (!documents || documents.length === 0) {
        container.innerHTML = '<div class="no-results" style="color: #04db8d; font-weight: bold; padding: 20px; text-align: center; font-size: 16px; background-color: #f8f9fa; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">No hay documentos para mostrar correspondientes a la fecha y filtros seleccionados.</div>';
        return;
    }

    const documentsHtml = documents.map(doc => {
        const rangoToShow = doc.rango_titulo || "Indefinido";
        const collectionName = doc.collectionName || "Fuente Desconocida";

        // Generar HTML para ramas_juridicas como tags
        const ramasHtml = (doc.ramas_juridicas && doc.ramas_juridicas.length > 0)
            ? `<span class="boletin-tags"> ${doc.ramas_juridicas.map(rama => `<span class="tag-rama">${rama}</span>`).join(' ')}</span>`
            : '';

        // Generar HTML para divisiones_cnae como tags (asumiendo que es un array)
        // Asegurarse que doc.divisiones_cnae existe y es un array
        const divisionesArray = Array.isArray(doc.divisiones) ? doc.divisiones : [];
        const divisionesHtml = (divisionesArray.length > 0)
            ? `<span class="boletin-tags">${divisionesArray.map(div => `<span class="tag-division">${div}</span>`).join(' ')}</span>`
            : '';

        // Reutilizar la estructura de .data-item
        return `
          <div class="data-item">
            <div class="header-row">
              <div class="id-values">${doc.short_name || 'Título no disponible'}</div>
              <span class="date"><em>${doc.dia}/${doc.mes}/${doc.anio}</em></span>
            </div>
            <div style="color: gray; font-size: 1.1em; margin-bottom: 6px;">
              ${rangoToShow} | ${collectionName}
            </div>
            ${ramasHtml}
            ${divisionesHtml}
            <div class="resumen-label">Resumen</div>
            <div class="resumen-content">${doc.resumen || 'Resumen no disponible.'}</div>
            <div class="margin-impacto">
              <a class="button-impacto"
                 href="/norma.html?documentId=${doc._id}&collectionName=${collectionName}">
                 Analizar documento
              </a>
            </div>
            <a class="leer-mas" href="${doc.url_pdf}" target="_blank" style="margin-right: 15px;">
              Leer más: ${doc._id}
            </a>
            
            <!-- Botón de Guardar -->
            <div class="guardar-button">
              <button class="save-btn" onclick="toggleListsDropdown(this, '${doc._id}', '${collectionName}')">
                <i class="fas fa-bookmark"></i>
                Guardar
              </button>
              <div class="lists-dropdown">
                <div class="lists-dropdown-header">
                  <span>Guardar en...</span>
                  <button class="save-ok-btn" onclick="saveToSelectedLists(this)">OK</button>
                </div>
                <div class="lists-content">
                  <div class="lists-container">
                    <!-- Las listas se cargarán dinámicamente -->
                  </div>
                  <div class="add-new-list" onclick="showNewListForm(this)">
                    <i class="fas fa-plus"></i>
                    Añadir nueva
                  </div>
                  <div class="new-list-form">
                    <input type="text" class="new-list-input" placeholder="Nombre de la nueva lista" maxlength="50">
                    <div class="new-list-buttons">
                      <button class="new-list-btn cancel" onclick="hideNewListForm(this)">Cancelar</button>
                      <button class="new-list-btn save" onclick="createNewList(this, '${doc._id}', '${collectionName}')">OK</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
    }).join('');

    container.innerHTML = documentsHtml;
}

// Función para poblar los dropdowns de filtros del Boletín Diario
function populateBoletinDiarioFilters(boletines, rangos) {
    const boletinDropdown = document.getElementById('boletinDiarioDropdown');
    const rangoDropdown = document.getElementById('rangoDiarioDropdown');

    if (!boletinDropdown || !rangoDropdown) return;

    // Poblar Boletines
    let boletinHtml = '<label><input type="checkbox" value="Todos" checked onchange="handleCheckboxChange(this, \'boletinDiarioDropdown\', \'selectedBoletinesDiario\')"> Todos</label>';
    
    // Si no hay boletines seleccionados por el usuario, mostrar todos los disponibles
    if (!boletines || !Array.isArray(boletines) || boletines.length === 0) {
        // Lista completa de fuentes de gobierno y reguladores
        const allBoletines = [
            "BOE", "DOUE", "BOCG", "BOA", "BOCYL", "BOCM", "DOGC", "DOG", "BOJA", "BOPV", 
            "CNMV", "CNMC", "AEPD"
        ];
        
        allBoletines.forEach(b => {
            boletinHtml += `<label><input type="checkbox" value="${b}" checked onchange="handleCheckboxChange(this, \'boletinDiarioDropdown\', \'selectedBoletinesDiario\')"> ${b}</label>`;
        });
    } else {
        // Añadir BOE por defecto si no está incluido
        if (!boletines.includes('BOE')) {
            boletinHtml += `<label><input type="checkbox" value="BOE" checked onchange="handleCheckboxChange(this, \'boletinDiarioDropdown\', \'selectedBoletinesDiario\')"> BOE</label>`;
        }
        
        // Añadir todas las fuentes del array directamente
        boletines.forEach(fuente => {
            if (fuente !== 'BOE' || !boletinHtml.includes('value="BOE"')) { // Evitar duplicar BOE
                boletinHtml += `<label><input type="checkbox" value="${fuente}" checked onchange="handleCheckboxChange(this, \'boletinDiarioDropdown\', \'selectedBoletinesDiario\')"> ${fuente}</label>`;
            }
        });
    }
    
    boletinDropdown.innerHTML = boletinHtml;
    updateSelectedText('boletinDiarioDropdown', 'selectedBoletinesDiario'); // Actualizar texto inicial

    // Poblar Rangos
    let rangoHtml = '<label><input type="checkbox" value="Todos" checked onchange="handleCheckboxChange(this, \'rangoDiarioDropdown\', \'selectedRangoDiario\')"> Todos</label>';

    // Determinar la lista de rangos a mostrar
    let rangosParaMostrar = [];

    if (!rangos || !Array.isArray(rangos) || rangos.length === 0) {
        // Intentar obtener el listado completo desde la etiqueta <script id="allRangosData">
        try {
            rangosParaMostrar = JSON.parse(document.getElementById('allRangosData').textContent || '[]');
        } catch (e) {
            console.warn('No se pudo parsear allRangosData, usando lista por defecto.', e);
        }

        // Si sigue vacío, usar un fallback hard-coded (catalogo_etiquetas.json > rangos_normativos)
        if (!Array.isArray(rangosParaMostrar) || rangosParaMostrar.length === 0) {
            rangosParaMostrar = [
                "Acuerdos Internacionales",
                "Normativa Europea",
                "Legislacion Nacional",
                "Normativa Reglamentaria",
                "Decisiones Judiciales",
                "Doctrina Administrativa",
                "Comunicados, Guias y Opiniones Consultivas",
                "Consultas Publicas",
                "Normativa en tramitación",
                "Otras"
            ];
        }
    } else {
        rangosParaMostrar = rangos;
    }

    // Generar los checkboxes
    rangosParaMostrar.forEach(r => {
        rangoHtml += `<label><input type="checkbox" value="${r}" checked onchange="handleCheckboxChange(this, \'rangoDiarioDropdown\', \'selectedRangoDiario\')"> ${r}</label>`;
    });
    
    rangoDropdown.innerHTML = rangoHtml;
    updateSelectedText('rangoDiarioDropdown', 'selectedRangoDiario'); // Actualizar texto inicial
}

// Funciones auxiliares para manejar dropdowns
function toggleBoletinDiarioDropdown() {
    closeOtherDropdowns('boletinDiarioDropdown');
    document.getElementById("boletinDiarioDropdown").classList.toggle("show");
}
function toggleRangoDiarioDropdown() {
    closeOtherDropdowns('rangoDiarioDropdown');
    document.getElementById("rangoDiarioDropdown").classList.toggle("show");
}

// (Asegúrate que closeOtherDropdowns existe o adáptala si es necesario)
function closeOtherDropdowns(excludeId) {
    const dropdowns = document.getElementsByClassName("dropdown-content");
    for (let i = 0; i < dropdowns.length; i++) {
        if (dropdowns[i].id !== excludeId && dropdowns[i].classList.contains('show')) {
            dropdowns[i].classList.remove('show');
        }
    }
}

// Reutilizar o adaptar handleCheckboxChange y updateSelectedText si ya existen y son compatibles
// Asegúrate de que estas funciones estén definidas en tu script global o cópialas/ajústalas aquí si es necesario.
// Ejemplo de implementación (si no existen):
if (typeof handleCheckboxChange !== 'function') {
    function handleCheckboxChange(checkbox, dropdownId, selectedSpanId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
        const todosCheckbox = checkboxes[0]; // Asume que "Todos" es el primero

        if (checkbox.value === "Todos") {
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        } else {
            if (!checkbox.checked) {
                todosCheckbox.checked = false;
            }
            let allOthersChecked = true;
            for (let i = 1; i < checkboxes.length; i++) {
                if (!checkboxes[i].checked) {
                    allOthersChecked = false;
                    break;
                }
            }
            // Solo marcar 'Todos' si *todos* los demás están marcados
            todosCheckbox.checked = allOthersChecked;
        }
        updateSelectedText(dropdownId, selectedSpanId);
    }
}

if (typeof updateSelectedText !== 'function') {
    function updateSelectedText(dropdownId, selectedSpanId) {
        const dropdown = document.getElementById(dropdownId);
        const selectedSpan = document.getElementById(selectedSpanId);
        if (!dropdown || !selectedSpan) return;

        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const todosCheckbox = dropdown.querySelector('input[value="Todos"]');
        let count = 0;
        let firstSelectedValue = '';

        checkboxes.forEach(cb => {
            if (cb.value !== 'Todos') {
                count++;
                if (count === 1) firstSelectedValue = cb.value;
            }
        });

        if (todosCheckbox.checked || count === 0) {
            selectedSpan.textContent = 'Todos';
        } else if (count === 1) {
            selectedSpan.textContent = firstSelectedValue;
        } else {
            selectedSpan.textContent = `${count} seleccionados`;
        }
    }
}

// Función auxiliar para obtener valores seleccionados (excluyendo "Todos" si otros están marcados)
function getSelectedCheckboxes(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    if (!dropdown) return [];
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const selectedValues = [];
    let todosSelected = false;

    checkboxes.forEach(cb => {
        if (cb.value === 'Todos') {
            todosSelected = true;
        } else {
            selectedValues.push(cb.value);
        }
    });

    // Si 'Todos' está seleccionado O no hay ninguna otra selección, el backend debe interpretar como 'todos'.
    // Devolvemos un array vacío en ese caso para que el backend aplique su lógica por defecto (usar todos los disponibles).
    if (todosSelected || selectedValues.length === 0) {
        return [];
    }
    // Si hay selecciones específicas (y 'Todos' no está marcado, o lo está pero hay otras selecciones), devolvemos esas selecciones.
    return selectedValues;
}

//Styles - Boletin Diario

const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `
.boletin-tags { margin: 8px 0; font-size: 0.9em; line-height: 1.6; }
.boletin-tags strong { margin-right: 5px; font-weight: 600; }
.tag-rama, .tag-division {
  display: inline-block;
  padding: 3px 10px;
  margin: 2px 4px 2px 0;
  border-radius: 14px;
  font-size: 0.85em;
  font-weight: 500;
  white-space: nowrap;
}
.tag-rama { background-color: rgba(69, 88, 98, 0.1); color: rgb(69 88 98); } /* Estilo secundario */
.tag-division { background-color: rgba(4, 219, 141, 0.1); color: rgb(4 219 141); } /* Estilo primario */

/* Ajustes para dropdowns del boletín */
#boletinDiarioDropdown, #rangoDiarioDropdown {
    max-height: 200px;
    overflow-y: auto;
    position: absolute;
    z-index: 1000;
    background: #fff;
    border: 1px solid #ccc;
    padding: 5px;
    display: none; /* hidden by default */
    min-width: 200px; /* Ajustar ancho mínimo */
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
#boletinDiarioDropdown.show, #rangoDiarioDropdown.show {
    display: block;
}
#boletinDiarioDropdown label, #rangoDiarioDropdown label {
    display: block;
    padding: 6px 8px;
    margin: 0;
    cursor: pointer;
    font-size: 0.9em;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
    transition: background-color 0.2s ease;
}
#boletinDiarioDropdown label:hover, #rangoDiarioDropdown label:hover {
    background-color: #f5f5f5;
}
#boletinDiarioDropdown label:last-child, #rangoDiarioDropdown label:last-child {
    border-bottom: none;
}
#boletinDiarioDropdown input[type="checkbox"], #rangoDiarioDropdown input[type="checkbox"] {
    width: 16px; height: 16px; transform: scale(0.9); accent-color: var(--primary-color, #04db8d); margin-right: 8px; vertical-align: middle;
}
`;
document.head.appendChild(styleSheet);


/*--------------Visiones--------------*/
 // *** NUEVO: Lógica de Navegación del Menú Lateral ***

 
 document.addEventListener('DOMContentLoaded', function() {

  
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const contentSections = document.querySelectorAll('.vision-section');

    // Función para manejar el cambio de sección
    function handleSectionChange(targetId) {
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
            contentSections.forEach(section => section.style.display = 'none');
            targetSection.style.display = 'block';

            // *** NUEVO/MODIFICADO: Cargar datos del boletín si es la sección correcta y no se ha cargado ***
            if (targetId === 'content-boletin' && !boletinDiarioLoaded) {
                // Intentar leer datos para poblar filtros iniciales (pueden no estar listos si la API no ha respondido aún)
                try {
                    const userBoletines = JSON.parse(document.getElementById('userBoletines').textContent || '[]');
                    const allRangos = JSON.parse(document.getElementById('allRangosData').textContent || '[]');
                    populateBoletinDiarioFilters(userBoletines, allRangos);
                } catch (e) {
                    console.warn("Datos iniciales para filtros de boletín no disponibles aún.", e);
                    // Poblar con vacío o esperar a la respuesta de la API
                    populateBoletinDiarioFilters([], []);
                }
                fetchBoletinDiario(); // Carga inicial de datos
                boletinDiarioLoaded = true;
            }
            
            // *** NUEVO: Cargar listas detalladas si es la sección de listas ***
            if (targetId === 'content-listas') {
                loadDetailedUserLists();
            }
            
            // *** NUEVO: Aplicar visibilidad condicional si es la sección Agentes ***
            if (targetId === 'content-agentes') {
                if (typeof applyAgentesAdvancedVisibility === 'function') {
                    applyAgentesAdvancedVisibility();
                }
            }
            
            // *** NUEVO: Cargar configuración si es la sección de configuración ***
            if (targetId === 'content-configuracion') {
                loadConfiguracionContent();
            }
            
            // Update URL with view parameter for navigation history
            if (targetId === 'content-boletin') {
                // If this is the boletín view, update URL to include view=boletin
                if (history.pushState) {
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('view', 'boletin');
                    window.history.pushState({path: newUrl.href}, '', newUrl.href);
                }
            } else if (targetId === 'content-agentes') {
                // If this is the agentes view, remove view parameter from URL
                if (history.pushState) {
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.delete('view');
                    window.history.pushState({path: newUrl.href}, '', newUrl.href);
                }
            }
        }
    }

    // Añadir listeners a los items del sidebar
    sidebarItems.forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            sidebarItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            handleSectionChange(targetId);
        });
    });

    // Mostrar la sección activa inicial y cargarla si es el Boletín
    const initialActiveItem = document.querySelector('.sidebar-item.active');
    if (initialActiveItem) {
        const initialTargetId = initialActiveItem.getAttribute('data-target');
        handleSectionChange(initialTargetId);
    } else {
        // Si no hay ninguno activo por defecto, activar 'Agentes' y mostrarlo
        const defaultItem = document.querySelector('.sidebar-item[data-target="content-agentes"]');
        const defaultSection = document.getElementById('content-agentes');
        if (defaultItem && defaultSection) {
            defaultItem.classList.add('active');
            defaultSection.style.display = 'block';
        }
    }

    // Cerrar dropdowns al hacer clic fuera (código existente adaptado)
    window.addEventListener('click', e => {
        // Check if the dropdown elements exist before accessing them
        const dropdownContents = document.querySelectorAll('.dropdown-content.show');
        if (dropdownContents.length > 0) {
            // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
            const clickedInsideDropdown = e.target.closest && e.target.closest('.dropdown');
            if (clickedInsideDropdown) return;         // no cerramos nada
            
            // Click fuera  →  cerrar todos los menús abiertos
            dropdownContents.forEach(el => el.classList.remove('show'));
        }
    });

    // Set up event listener for editSuscription buttons - both in the sidebar and content area
    document.querySelectorAll('#editSuscription, #editSuscription2, #editSuscription3').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        // Show subscription container instead of redirecting
        if (typeof showSubscriptionModal === 'function') {
          showSubscriptionModal();
        } else {
          // Fallback if the function isn't available
          const modal = document.getElementById('subscription-container');
          if (modal) {
            modal.style.display = 'block';
          } else {
            console.error('Subscription container not found');
            alert('La funcionalidad de editar suscripción estará disponible próximamente.');
          }
        }
      });
    });

    /* === Intercept "Analizar documento" para usuarios plan1 === */
    document.body.addEventListener('click', function(e) {
      const impactoLink = e.target && e.target.closest && e.target.closest('.button-impacto');
      if (!impactoLink) return; // Click no proveniente del enlace

      if (window.userPlan === 'plan1') {
        e.preventDefault();
        showUpgradePlanBanner();
      }
    });

    /* === Banner de mejora de plan === */
    function showUpgradePlanBanner() {
      // Evitar duplicados
      let overlay = document.getElementById('upgrade-plan-overlay');
      let banner  = document.getElementById('upgrade-plan-banner');

      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'upgrade-plan-overlay';
        Object.assign(overlay.style, {
          position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
          background: 'rgba(0,0,0,0.4)', zIndex: 9998
        });
        document.body.appendChild(overlay);
        // Cerrar al hacer clic en overlay
        overlay.addEventListener('click', () => { hideBanner(); });
      }

      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'upgrade-plan-banner';
        Object.assign(banner.style, {
          position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
          background: '#fff', padding: '25px 30px', borderRadius: '10px',
          boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 9999, maxWidth: '400px', width: '90%'
        });

        banner.innerHTML = `
          <button id="close-upgrade-banner" style="position:absolute; top:8px; right:10px; background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
          <h3 style="margin:0 0 15px 0; color:#0b2431; font-size:20px;">Mejora tu plan para poder analizar cualquier norma con IA</h3>
          <div style="text-align:center;">
            <button id="upgrade-plan-btn" style="background:#04db8d; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:500;">Mejora tu plan</button>
          </div>
          <div id="upgrade-loader" style="display:none; text-align:center; margin-top:15px;">
            <div style="display:inline-block; width:30px; height:30px; border:3px solid rgba(4,219,141,0.3); border-radius:50%; border-top-color:#04db8d; animation:spin 1s linear infinite;"></div>
          </div>
        `;
        document.body.appendChild(banner);

        // Añadir keyframes para la animación del loader si no existen ya
        if (!document.getElementById('loader-keyframes')) {
          const style = document.createElement('style');
          style.id = 'loader-keyframes';
          style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
          document.head.appendChild(style);
        }

        // Listeners de los botones
        banner.querySelector('#close-upgrade-banner').addEventListener('click', hideBanner);
        banner.querySelector('#upgrade-plan-btn').addEventListener('click', () => {
          // Mostrar loader
          banner.querySelector('#upgrade-plan-btn').style.display = 'none';
          banner.querySelector('#upgrade-loader').style.display = 'block';

          // Esperar brevemente para asegurar que se muestra el loader
          setTimeout(() => {
            hideBanner();
            if (typeof showSubscriptionModal === 'function') {
              showSubscriptionModal();
            } else {
              const modal = document.getElementById('subscription-container');
              if (modal) modal.style.display = 'block';
            }
          }, 300);
        });
      }

      overlay.style.display = 'block';
      banner.style.display   = 'block';

      // Helper para ocultar
      function hideBanner() {
        if (overlay) overlay.style.display = 'none';
        if (banner)  banner.style.display  = 'none';
      }
    }
 });
  </script>
  <script>
    /* ===========  DROPDOWNS GENÉRICOS  ===================
       – Cualquier .dropbtn abre / cierra su propio menú
       – Sólo se puede abrir un menú a la vez
       – Si se hace click FUERA de .dropdown   ⇒  se cierran todos
       – Si se hace click dentro del menú      ⇒  NO se cierra          */
    document.addEventListener('DOMContentLoaded', () => {
    
      /* 1. Toggle al pulsar en cualquier .dropbtn ------------------ */
      document.querySelectorAll('.dropbtn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();                     // evita que el click burbujee
          const dropdown = btn.closest('.dropdown');
          const menu     = dropdown?.querySelector('.dropdown-content');
          if (!menu) return;
    
          // Cierra otros menús que pudieran estar abiertos
          document.querySelectorAll('.dropdown-content.show')
                  .forEach(el => { if (el !== menu) el.classList.remove('show'); });
    
          menu.classList.toggle('show');
        });
      });
    
      /* 2. Cerrar cuando se hace click FUERA de cualquier .dropdown -- */
      window.addEventListener('click', e => {
        // ¿Hemos hecho click dentro de un .dropdown (botón o contenido)?
        const clickedInsideDropdown = e && e.target && typeof e.target.closest === 'function' && !!e.target.closest('.dropdown');
        if (clickedInsideDropdown) return;         // no cerramos nada
    
        // Click fuera  →  cerrar todos los menús abiertos
        document.querySelectorAll('.dropdown-content.show')
                .forEach(el => el.classList.remove('show'));
      });
    });
    
    // Newsletter Subscription Banner Logic
    function checkAndShowNewsletterBanner() {
      try {
        // Using window.userPlan instead of local userPlan
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        
        try {
          // Get accepted_email value, default to null if there are any issues
          const acceptedEmailElement = document.getElementById('userAcceptedEmail');
          let acceptedEmail = null;
          if (acceptedEmailElement) {
            const rawVal = acceptedEmailElement.textContent && acceptedEmailElement.textContent.trim();
            try {
              acceptedEmail = rawVal ? JSON.parse(rawVal) : null;
            } catch (e) {
              acceptedEmail = null;
            }
          }
          
          // Check if this is a plan1 user who hasn't set email preference and is in the appropriate view
          if (window.userPlan === 'plan1') {
            // Show radar normativo banner in agentes section
            const agentesSectionActive = document.getElementById('content-agentes')?.classList.contains('active');
            
            // Get the radar banner element
            const radarBanner = document.getElementById('radar-normativo-banner');
            
            if (radarBanner && agentesSectionActive) {
              // Show radar normativo banner
              radarBanner.style.display = 'block';
              
              // Hide no results message if it exists
              const noResultsElement = document.querySelector('.no-results');
              if (noResultsElement) {
                noResultsElement.style.display = 'none';
              }
              
              // Hide beta banner for plan1 users
              const betaBanner = document.querySelector('.beta-banner');
              if (betaBanner) {
                betaBanner.style.display = 'none';
              }
            }
            
            // Show newsletter banner if user hasn't set email preference and is viewing boletín
            const newsletterBanner = document.getElementById('newsletter-banner');
            const boletinSectionActive = document.getElementById('content-boletin')?.classList.contains('active');
            
            if (newsletterBanner && acceptedEmail === null && boletinSectionActive) {
              newsletterBanner.style.display = 'block';
              
              // Get the accept and reject buttons
              const acceptBtn = document.getElementById('accept-newsletter');
              const rejectBtn = document.getElementById('reject-newsletter');
              
              // Remove any existing event listeners by cloning the buttons
              if (acceptBtn) {
                const newAcceptBtn = acceptBtn.cloneNode(true);
                acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
                newAcceptBtn.addEventListener('click', function() {
                  saveEmailPreference(true);
                });
              }
              
              if (rejectBtn) {
                const newRejectBtn = rejectBtn.cloneNode(true);
                rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                newRejectBtn.addEventListener('click', function() {
                  saveEmailPreference(false);
                });
              }
            }
          }
        } catch (error) {
          console.error('Error processing email preferences:', error);
        }
      } catch (error) {
        console.error('Error in checkAndShowNewsletterBanner:', error);
      }
    }
    
    // Function to save the user's email preference
    function saveEmailPreference(preference) {
      // Create loading overlay
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.position = 'fixed';
      loadingOverlay.style.top = '0';
      loadingOverlay.style.left = '0';
      loadingOverlay.style.width = '100%';
      loadingOverlay.style.height = '100%';
      loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      loadingOverlay.style.display = 'flex';
      loadingOverlay.style.justifyContent = 'center';
      loadingOverlay.style.alignItems = 'center';
      loadingOverlay.style.zIndex = '9999';
      
      const spinner = document.createElement('div');
      spinner.className = 'loader';
      spinner.style.border = '5px solid #f3f3f3';
      spinner.style.borderTop = '5px solid #04db8d';
      spinner.style.borderRadius = '50%';
      spinner.style.width = '50px';
      spinner.style.height = '50px';
      spinner.style.animation = 'spin 2s linear infinite';
      
      // Add animation keyframes
      const style = document.createElement('style');
      style.innerHTML = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
      document.head.appendChild(style);
      
      loadingOverlay.appendChild(spinner);
      document.body.appendChild(loadingOverlay);
      
      // Convert boolean preference to string value that the server expects
      const accepted_email = preference === true ? 'yes' : 'no';
      
      // Make API call to update preferences
      fetch('/api/update-user-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          accepted_email: accepted_email
        }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Hide newsletter banner
        const banner = document.getElementById('newsletter-banner');
        if (banner) {
          banner.style.display = 'none';
        }
        
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.style.padding = '10px';
        successMessage.style.backgroundColor = '#d4edda';
        successMessage.style.color = '#155724';
        successMessage.style.borderRadius = '4px';
        successMessage.style.marginBottom = '20px';
        successMessage.style.textAlign = 'center';
        successMessage.innerHTML = preference ? 
          'Gracias por suscribirte a nuestras actualizaciones.' : 
          'Tus preferencias han sido actualizadas.';
        
        // Find a good place to add the message
        const contentBoletin = document.getElementById('content-boletin');
        if (contentBoletin) {
          contentBoletin.insertBefore(successMessage, contentBoletin.firstChild);
          
          // Remove message after 5 seconds
          setTimeout(() => {
            successMessage.remove();
          }, 5000);
        }
      })
      .catch(error => {
        console.error('Error updating preferences:', error);
        alert('Error al guardar tus preferencias. Por favor, inténtalo de nuevo.');
      })
      .finally(() => {
        // Remove loading overlay
        loadingOverlay.remove();
      });
    }
    </script>
    
    <script>
    // ==================== FUNCIONES PARA MANEJO DE LISTAS ====================
    
    // Variable global para almacenar las listas del usuario
    let userLists = [];
    
    // Función para añadir una nueva lista al storage
    function addListToStorage(newList) {
      userLists.push(newList);
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para limpiar el cache de listas (útil para forzar recarga desde servidor)
    function clearListsCache() {
      sessionStorage.removeItem('userLists');
      userLists = [];
      console.log('Cache de listas limpiado');
    }
    
    // Función para verificar si el cache es válido (opcional: añadir timestamp)
    function isCacheValid() {
      const cacheTimestamp = sessionStorage.getItem('userListsTimestamp');
      if (!cacheTimestamp) return false;
      
      const now = Date.now();
      const cacheTime = parseInt(cacheTimestamp);
      const maxAge = 30 * 60 * 1000; // 30 minutos
      
      return (now - cacheTime) < maxAge;
    }
    
    // Función mejorada para cargar las listas con validación de cache
    async function loadUserListsFromBackend(forceRefresh = false) {
      try {
        // Si se fuerza la recarga, limpiar cache
        if (forceRefresh) {
          clearListsCache();
        }
        
        // Intentar cargar desde sessionStorage primero si el cache es válido
        const cachedLists = sessionStorage.getItem('userLists');
        if (cachedLists && !forceRefresh && isCacheValid()) {
          userLists = JSON.parse(cachedLists);
          console.log('Listas cargadas desde sessionStorage:', userLists);
          return;
        }
        
        // Si no hay datos en cache o no es válido, cargar desde el servidor
        console.log('Cargando listas desde el servidor...');
        const response = await fetch('/api/get-user-lists');
        if (response.ok) {
          const data = await response.json();
          userLists = data.lists || [];
          
          // Guardar en sessionStorage con timestamp para futuras cargas
          sessionStorage.setItem('userLists', JSON.stringify(userLists));
          sessionStorage.setItem('userListsTimestamp', Date.now().toString());
          console.log('Listas cargadas desde servidor y guardadas en sessionStorage:', userLists);
        } else {
          console.error('Error loading user lists:', response.statusText);
          userLists = [];
        }
      } catch (error) {
        console.error('Error loading user lists:', error);
        userLists = [];
      }
    }
    
    // Función para actualizar las listas en sessionStorage
    function updateUserListsInStorage(newLists) {
      userLists = newLists;
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para añadir una nueva lista al storage
    function addListToStorage(newList) {
      userLists.push(newList);
      sessionStorage.setItem('userLists', JSON.stringify(userLists));
      sessionStorage.setItem('userListsTimestamp', Date.now().toString());
    }
    
    // Función para extraer información del documento desde el DOM
    function extractDocumentData(dataItem) {
      const documentData = {};
      
      try {
        // Extraer información básica
        documentData.short_name = dataItem.querySelector('.id-values')?.textContent?.trim() || null;
        documentData.resumen = dataItem.querySelector('.resumen-content')?.textContent?.trim() || null;
        
        // Extraer fecha
        const dateElement = dataItem.querySelector('.date em');
        if (dateElement) {
          const dateText = dateElement.textContent.trim();
          const dateParts = dateText.split('/');
          if (dateParts.length === 3) {
            documentData.dia = parseInt(dateParts[0]) || null;
            documentData.mes = parseInt(dateParts[1]) || null;
            documentData.anio = parseInt(dateParts[2]) || null;
          }
        }
        
        // Extraer rango_titulo - buscar en diferentes posibles ubicaciones
        let rangoTitulo = null;
        
        // Buscar en el elemento con estilo de color gris
        const rangoElement = dataItem.querySelector('div[style*="color: gray"], div[style*="color:gray"]');
        if (rangoElement) {
          const rangoText = rangoElement.textContent.trim();
          const rangoParts = rangoText.split('|');
          if (rangoParts.length > 0) {
            rangoTitulo = rangoParts[0].trim();
          }
        }
        
        // Si no se encontró, buscar en otros elementos posibles
        if (!rangoTitulo) {
          const possibleRangoElements = dataItem.querySelectorAll('div');
          for (const element of possibleRangoElements) {
            const text = element.textContent.trim();
            if (text.includes('|') && (text.includes('BOE') || text.includes('DOUE') || text.includes('BOCG'))) {
              const parts = text.split('|');
              if (parts.length > 0) {
                rangoTitulo = parts[0].trim();
                break;
              }
            }
          }
        }
        
        documentData.rango_titulo = rangoTitulo;
        
        // Extraer URL del PDF
        const pdfLink = dataItem.querySelector('.leer-mas, a[href*=".pdf"], a[target="_blank"]');
        if (pdfLink) {
          documentData.url_pdf = pdfLink.getAttribute('href');
        }
        
        // Extraer etiquetas personalizadas de múltiples fuentes
        const etiquetas = [];
        
        // 1. Obtener etiquetas de ramas jurídicas
        const ramaTags = dataItem.querySelectorAll('.tag-rama');
        ramaTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText) etiquetas.push(tagText);
        });
        
        // 2. Obtener etiquetas de divisiones
        const divisionTags = dataItem.querySelectorAll('.tag-division');
        divisionTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText) etiquetas.push(tagText);
        });
        
        // 3. Buscar en elementos con clases de etiquetas
        const etiquetaTags = dataItem.querySelectorAll('.etiqueta-personalizada-value, .tag, [class*="tag-"], [class*="etiqueta"]');
        etiquetaTags.forEach(tag => {
          const tagText = tag.textContent.trim();
          if (tagText && !etiquetas.includes(tagText)) {
            etiquetas.push(tagText);
          }
        });
        
        // 4. Buscar en spans con estilos específicos (como los que tienen colores de etiquetas)
        const styledSpans = dataItem.querySelectorAll('span[style*="background"], span[class*="badge"], span[class*="chip"]');
        styledSpans.forEach(span => {
          const spanText = span.textContent.trim();
          if (spanText && !etiquetas.includes(spanText)) {
            etiquetas.push(spanText);
          }
        });
        
        documentData.etiquetas_personalizadas = etiquetas;
        
        console.log('Datos extraídos del documento:', documentData);
        
      } catch (error) {
        console.error('Error extracting document data:', error);
      }
      
      return documentData;
    }
    
    // Función para mostrar/ocultar el desplegable de listas
    async function toggleListsDropdown(buttonElement, documentId, collectionName) {
      // Cerrar otros desplegables abiertos
      document.querySelectorAll('.lists-dropdown.show').forEach(dropdown => {
        if (dropdown !== buttonElement.nextElementSibling) {
          dropdown.classList.remove('show');
        }
      });
      
      const dropdown = buttonElement.nextElementSibling;
      const isShowing = dropdown.classList.contains('show');
      
      if (!isShowing) {
        // Cargar las listas del usuario (desde cache o servidor)
        await loadUserListsFromBackend();
        
        // Cargar las listas del usuario antes de mostrar
        loadUserLists(dropdown);
        
        // Ocultar el botón OK inicialmente
        const saveButton = dropdown.querySelector('.save-ok-btn');
        saveButton.classList.remove('show');
        
        // Desmarcar todos los checkboxes
        const checkboxes = dropdown.querySelectorAll('.lists-container input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        dropdown.classList.add('show');
      } else {
        dropdown.classList.remove('show');
      }
      
      // Prevenir que el evento se propague
      event.stopPropagation();
    }
    
    // Función para cargar las listas del usuario en el desplegable
    function loadUserLists(dropdown) {
      const listsContainer = dropdown.querySelector('.lists-container');
      
      if (userLists.length === 0) {
        listsContainer.innerHTML = '<div class="no-lists-message">No tienes listas creadas</div>';
      } else {
        listsContainer.innerHTML = userLists.map(list => 
          `<div class="list-item">
            <input type="checkbox" id="list_${list.id}" value="${list.id}" onchange="updateSaveButton(this)">
            <label for="list_${list.id}">${list.name}</label>
          </div>`
        ).join('');
      }
    }
    
    // Función para actualizar la visibilidad del botón OK
    function updateSaveButton(checkbox) {
      const dropdown = checkbox.closest('.lists-dropdown');
      const saveButton = dropdown.querySelector('.save-ok-btn');
      const checkedBoxes = dropdown.querySelectorAll('.lists-container input[type="checkbox"]:checked');
      
      if (checkedBoxes.length > 0) {
        saveButton.classList.add('show');
      } else {
        saveButton.classList.remove('show');
      }
    }
    
    // Función para guardar en las listas seleccionadas
    async function saveToSelectedLists(okButton) {
      const dropdown = okButton.closest('.lists-dropdown');
      const checkedBoxes = dropdown.querySelectorAll('.lists-container input[type="checkbox"]:checked');
      
      if (checkedBoxes.length === 0) {
        alert('Por favor, selecciona al menos una lista');
        return;
      }
      
      // Obtener información del documento
      const saveButton = dropdown.closest('.guardar-button');
      const dataItem = saveButton.closest('.data-item');
      
      // Obtener el documentId y collectionName desde el botón
      const mainButton = saveButton.querySelector('.save-btn');
      const onclickAttr = mainButton.getAttribute('onclick');
      const matches = onclickAttr.match(/toggleListsDropdown\(this, '([^']+)', '([^']+)'\)/);
      const documentId = matches ? matches[1] : null;
      const collectionName = matches ? matches[2] : null;
      
      if (!documentId || !collectionName) {
        alert('Error: No se pudo obtener la información del documento');
        return;
      }
      
      // Extraer información completa del documento
      const documentData = extractDocumentData(dataItem);
      
      // Obtener las listas seleccionadas
      const selectedListIds = Array.from(checkedBoxes).map(cb => cb.value);
      
      try {
        // Guardar el documento en las listas seleccionadas
        const response = await fetch('/api/save-document-to-lists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            documentId: documentId,
            collectionName: collectionName,
            listIds: selectedListIds,
            documentData: documentData
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Documento guardado exitosamente:', result);
          
          // Mostrar feedback visual en el botón principal
          const mainSaveBtn = saveButton.querySelector('.save-btn');
          const originalText = mainSaveBtn.innerHTML;
          mainSaveBtn.innerHTML = '<i class="fas fa-check"></i> Guardado';
          mainSaveBtn.style.backgroundColor = '#04db8d';
          mainSaveBtn.style.color = 'white';
          
          // Cerrar el desplegable inmediatamente
          dropdown.classList.remove('show');
          
          // Resetear checkboxes y botón OK
          checkedBoxes.forEach(cb => cb.checked = false);
          okButton.classList.remove('show');
          
          setTimeout(() => {
            mainSaveBtn.innerHTML = originalText;
            mainSaveBtn.style.backgroundColor = '';
            mainSaveBtn.style.color = '';
          }, 2000);
        } else {
          const error = await response.json();
          alert('Error al guardar el documento: ' + (error.message || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error saving document:', error);
        alert('Error al guardar el documento. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Función para guardar un documento en una lista existente (DEPRECATED - mantenida por compatibilidad)
    function saveToList(listId, listName, element) {
      // Esta función ya no se usa con la nueva lógica de checkboxes
      console.log('saveToList is deprecated, use saveToSelectedLists instead');
    }
    
    // Función para mostrar el formulario de nueva lista
    function showNewListForm(element) {
      const dropdown = element.closest('.lists-dropdown');
      const newListForm = dropdown.querySelector('.new-list-form');
      const addNewButton = dropdown.querySelector('.add-new-list');
      
      addNewButton.style.display = 'none';
      newListForm.classList.add('show');
      
      // Enfocar el input
      const input = newListForm.querySelector('.new-list-input');
      input.focus();
      input.value = '';
    }
    
    // Función para ocultar el formulario de nueva lista
    function hideNewListForm(element) {
      const dropdown = element.closest('.lists-dropdown');
      const newListForm = dropdown.querySelector('.new-list-form');
      const addNewButton = dropdown.querySelector('.add-new-list');
      
      newListForm.classList.remove('show');
      addNewButton.style.display = 'flex';
    }
    
    // Función para crear una nueva lista
    async function createNewList(element, documentId, collectionName) {
      const dropdown = element.closest('.lists-dropdown');
      const input = dropdown.querySelector('.new-list-input');
      const listName = input.value.trim();
      
      if (!listName) {
        alert('Por favor, introduce un nombre para la lista');
        input.focus();
        return;
      }
      
      // Verificar que no existe una lista con el mismo nombre
      if (userLists.some(list => list.name.toLowerCase() === listName.toLowerCase())) {
        alert('Ya existe una lista con ese nombre');
        input.focus();
        return;
      }
      
      try {
        // Crear nueva lista en el backend
        const response = await fetch('/api/create-user-list', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            listName: listName
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Lista creada exitosamente:', result);
          
          // Añadir la nueva lista al array local y sessionStorage
          const newList = {
            id: result.listId,
            name: listName
          };
          addListToStorage(newList);
          
          // Recargar las listas en el desplegable
          loadUserLists(dropdown);
          
          // Seleccionar automáticamente la nueva lista
          const newCheckbox = dropdown.querySelector(`input[value="${newList.id}"]`);
          if (newCheckbox) {
            newCheckbox.checked = true;
            updateSaveButton(newCheckbox);
          }
          
          // Ocultar el formulario
          hideNewListForm(element);
        } else {
          const error = await response.json();
          alert('Error al crear la lista: ' + (error.message || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error creating list:', error);
        alert('Error al crear la lista. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Cerrar desplegables al hacer clic fuera
    document.addEventListener('click', function(event) {
      if (event.target && !event.target.closest('.guardar-button')) {
        document.querySelectorAll('.lists-dropdown.show').forEach(dropdown => {
          dropdown.classList.remove('show');
        });
      }
    });
    
    // Manejar Enter en el input de nueva lista
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' && event.target.classList.contains('new-list-input')) {
        const saveButton = event.target.closest('.new-list-form').querySelector('.new-list-btn.save');
        saveButton.click();
      }
    });
    
    // ==================== FUNCIONES PARA LA SECCIÓN "TUS LISTAS" ====================
    
    // Función para cargar las listas detalladas desde el backend
    async function loadDetailedUserLists() {
      const loadingElement = document.getElementById('listas-loading');
      const containerElement = document.getElementById('listas-container');
      const noListasMessage = document.getElementById('no-listas-message');
      
      if (!loadingElement || !containerElement || !noListasMessage) return;
      
      try {
        loadingElement.style.display = 'block';
        containerElement.innerHTML = '';
        noListasMessage.style.display = 'none';
        
        const response = await fetch('/api/get-user-lists');
        if (!response.ok) {
          throw new Error('Error al cargar las listas');
        }
        
        const data = await response.json();
        const lists = data.lists || [];
        
        if (lists.length === 0) {
          noListasMessage.style.display = 'block';
        } else {
          renderListCards(lists, data.guardados || {});
        }
        
      } catch (error) {
        console.error('Error loading detailed lists:', error);
        containerElement.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">Error al cargar las listas</div>';
      } finally {
        loadingElement.style.display = 'none';
      }
    }
    
    // Función para renderizar las tarjetas de listas
    function renderListCards(lists, guardadosData) {
      const container = document.getElementById('listas-container');
      if (!container) return;
      
      const cardsHtml = lists.map(list => {
        const listData = guardadosData[list.name] || {};
        const documents = Object.values(listData);
        const documentCount = documents.length;
        
        // Encontrar el último documento añadido
        let lastAddedDate = 'Nunca';
        if (documentCount > 0) {
          const sortedDocs = documents.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
          const lastDoc = sortedDocs[0];
          if (lastDoc && lastDoc.savedAt) {
            const date = new Date(lastDoc.savedAt);
            lastAddedDate = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()}`;
          }
        }
        
        return `
          <div class="lista-card">
            <div class="lista-card-header">
              <h3 class="lista-title">${list.name}</h3>
              <button class="delete-lista-btn" onclick="deleteUserList('${list.name}')" title="Eliminar lista">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="lista-stats">
              <div class="lista-stat">
                <span class="lista-stat-label">Número de documentos:</span>
                <span class="lista-stat-value">${documentCount}</span>
              </div>
              <div class="lista-stat">
                <span class="lista-stat-label">Último documento añadido:</span>
                <span class="lista-stat-value">${lastAddedDate}</span>
              </div>
            </div>
            <button class="generar-contenido-btn" onclick="generarContenido('${list.name}')" ${documentCount === 0 ? 'disabled' : ''}>
              Generar contenido
            </button>
          </div>
        `;
      }).join('');
      
      container.innerHTML = cardsHtml;
    }
    
    // Función para eliminar una lista
    async function deleteUserList(listName) {
      if (!confirm(`¿Estás seguro de que quieres eliminar la lista "${listName}"? Esta acción no se puede deshacer.`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/delete-user-list', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            listName: listName
          })
        });
        
        if (response.ok) {
          // Actualizar el cache local
          userLists = userLists.filter(list => list.name !== listName);
          updateUserListsInStorage(userLists);
          
          // Recargar la vista de listas
          loadDetailedUserLists();
          
          console.log('Lista eliminada exitosamente:', listName);
        } else {
          const error = await response.json();
          alert('Error al eliminar la lista: ' + (error.message || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error deleting list:', error);
        alert('Error al eliminar la lista. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Función placeholder para generar contenido
    function generarContenido(listName) {
      // Cambiar a la vista de generación de contenido
      showGenerarContenidoPage(listName);
    }
    
    // ==================== FUNCIONES PARA LA PÁGINA DE GENERACIÓN DE CONTENIDO ====================
    
    let currentListName = '';
    
    // Función para mostrar la página de generación de contenido
    function showGenerarContenidoPage(listName) {
      currentListName = listName;
      
      // Ocultar la sección de listas
      const listasSection = document.getElementById('content-listas');
      if (listasSection) {
        listasSection.style.display = 'none';
      }
      
      // Mostrar la sección de generación de contenido
      const generarSection = document.getElementById('content-generar-contenido');
      if (generarSection) {
        generarSection.classList.add('active');
        generarSection.style.display = 'block';
      }
      
      // Actualizar el título
      const titleElement = document.getElementById('generar-lista-title');
      if (titleElement) {
        titleElement.textContent = `Generar contenido - ${listName}`;
      }
      
      // Cargar los documentos de la lista
      loadDocumentosForGeneration(listName);
      
      // Cargar configuraciones guardadas
      loadSavedSettings(listName);
    }
    
    // Función para volver a la vista de listas
    function backToListas() {
      // Ocultar la sección de generación de contenido
      const generarSection = document.getElementById('content-generar-contenido');
      if (generarSection) {
        generarSection.classList.remove('active');
        generarSection.style.display = 'none';
      }
      
      // Mostrar la sección de listas
      const listasSection = document.getElementById('content-listas');
      if (listasSection) {
        listasSection.style.display = 'block';
      }
      
      currentListName = '';
    }
    
    // Función para cargar los documentos de una lista específica
    async function loadDocumentosForGeneration(listName) {
      const documentosContainer = document.getElementById('documentos-list');
      if (!documentosContainer) return;
      
      try {
        documentosContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loader"></div></div>';
        
        const response = await fetch('/api/get-user-lists');
        if (!response.ok) {
          throw new Error('Error al cargar los documentos');
        }
        
        const data = await response.json();
        const guardados = data.guardados || {};
        const listData = guardados[listName] || {};
        const documents = Object.values(listData);
        
        if (documents.length === 0) {
          documentosContainer.innerHTML = '<div class="no-documentos">No hay documentos en esta lista</div>';
          // Ocultar controles si no hay documentos
          const controls = document.querySelector('.documentos-controls');
          if (controls) controls.style.display = 'none';
          return;
        }
        
        // Mostrar controles si hay documentos
        const controls = document.querySelector('.documentos-controls');
        if (controls) controls.style.display = 'flex';
        
        // Renderizar los documentos
        const documentsHtml = documents.map((doc, index) => {
          const fecha = doc.dia && doc.mes && doc.anio ? 
            `${doc.dia}/${doc.mes}/${doc.anio}` : 
            (doc.savedAt ? new Date(doc.savedAt).toLocaleDateString('es-ES') : 'Fecha no disponible');
          
          const etiquetasHtml = doc.etiquetas_personalizadas && doc.etiquetas_personalizadas.length > 0 ?
            doc.etiquetas_personalizadas.map(tag => `<span class="documento-tag">${tag}</span>`).join('') :
            '';
          
          return `
            <div class="documento-item" data-doc-index="${index}" onclick="toggleDocumentSelection(${index})">
              <div class="documento-header">
                <h4 class="documento-title">${doc.short_name || doc.documentId || 'Título no disponible'}</h4>
                <span class="documento-date">${fecha}</span>
              </div>
              <div class="documento-meta">
                ${doc.rango_titulo || 'Rango no especificado'} | ${doc.collectionName || 'Fuente desconocida'}
              </div>
              ${doc.resumen ? `<div class="documento-resumen">${doc.resumen}</div>` : ''}
              ${etiquetasHtml ? `<div class="documento-tags">${etiquetasHtml}</div>` : ''}
              ${doc.url_pdf ? `<a href="${doc.url_pdf}" class="leer-mas" style="display: none;" target="_blank">PDF</a>` : ''}
              <input type="checkbox" class="documento-checkbox" data-doc-index="${index}" onclick="event.stopPropagation(); toggleDocumentSelection(${index})">
            </div>
          `;
        }).join('');
        
        documentosContainer.innerHTML = documentsHtml;
        
        // Resetear contador
        updateSelectedCount();
        
      } catch (error) {
        console.error('Error loading documents for generation:', error);
        documentosContainer.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">Error al cargar los documentos</div>';
      }
    }
    
    // Función para cargar configuraciones guardadas
    function loadSavedSettings(listName) {
      // Cargar desde MongoDB primero, luego localStorage como fallback
      loadSettingsFromMongoDB(listName).then(settings => {
        if (settings) {
          // Cargar instrucciones
          if (settings.instrucciones_generales) {
            const instructionsInput = document.getElementById('instrucciones-input');
            if (instructionsInput) {
              instructionsInput.value = settings.instrucciones_generales;
            }
          }
          
          // Cargar paleta de colores
          if (settings.color_palette) {
            if (settings.color_palette.primary) {
              document.getElementById('primary-color').value = settings.color_palette.primary;
              document.getElementById('primary-color-hex').value = settings.color_palette.primary;
            }
            if (settings.color_palette.secondary) {
              document.getElementById('secondary-color').value = settings.color_palette.secondary;
              document.getElementById('secondary-color-hex').value = settings.color_palette.secondary;
            }
            if (settings.color_palette.tertiary) {
              document.getElementById('tertiary-color').value = settings.color_palette.tertiary;
              document.getElementById('tertiary-color-hex').value = settings.color_palette.tertiary;
            }
          }
          
          // Cargar información del logo
          if (settings.logo) {
            const fileText = document.getElementById('logo-file-text');
            if (fileText) {
              fileText.textContent = 'Logo guardado';
              fileText.style.color = '#0b2431';
            }
            // Guardar el logo en la variable global para uso posterior
            window.currentLogoBase64 = settings.logo;
          }
        } else {
          // Fallback a localStorage
          loadSettingsFromLocalStorage(listName);
        }
      }).catch(error => {
        console.error('Error loading settings from MongoDB:', error);
        // Fallback a localStorage
        loadSettingsFromLocalStorage(listName);
      });
      
      // Cargar configuraciones de contenido (estas siguen en localStorage por ahora)
      const savedLanguage = localStorage.getItem(`language_${listName}`);
      if (savedLanguage) {
        const languageSelect = document.getElementById('lenguaje-select');
        if (languageSelect) {
          languageSelect.value = savedLanguage;
        }
      }
      
      const savedDocType = localStorage.getItem(`doctype_${listName}`);
      if (savedDocType) {
        const docTypeSelect = document.getElementById('tipo-documento-select');
        if (docTypeSelect) {
          docTypeSelect.value = savedDocType;
        }
      }
    }
    
    // Función para cargar configuraciones desde localStorage (fallback)
    function loadSettingsFromLocalStorage(listName) {
      const savedInstructions = localStorage.getItem(`instructions_${listName}`);
      if (savedInstructions) {
        const instructionsInput = document.getElementById('instrucciones-input');
        if (instructionsInput) {
          instructionsInput.value = savedInstructions;
        }
      }
    }
    
    // Función para cargar configuraciones desde MongoDB
    async function loadSettingsFromMongoDB(listName) {
      try {
        const response = await fetch('/api/get-generation-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ listName: listName })
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.settings;
        }
        return null;
      } catch (error) {
        console.error('Error fetching settings from MongoDB:', error);
        return null;
      }
    }
    
    // Función para sincronizar color picker con input hex (mejorada)
    function updateColorFromHex(colorType) {
      const hexInput = document.getElementById(`${colorType}-color-hex`);
      const colorInput = document.getElementById(`${colorType}-color`);
      
      if (hexInput && colorInput) {
        let hexValue = hexInput.value.trim();
        
        // Validar formato hex
        if (hexValue.match(/^#[0-9A-Fa-f]{6}$/)) {
          colorInput.value = hexValue;
        } else if (hexValue.match(/^[0-9A-Fa-f]{6}$/)) {
          // Añadir # si no lo tiene
          hexValue = '#' + hexValue;
          hexInput.value = hexValue;
          colorInput.value = hexValue;
        } else if (hexValue.match(/^#[0-9A-Fa-f]{3}$/)) {
          // Convertir formato corto #abc a #aabbcc
          const shortHex = hexValue.substring(1);
          const longHex = '#' + shortHex.split('').map(char => char + char).join('');
          hexInput.value = longHex;
          colorInput.value = longHex;
        }
      }
    }
    
    // Función para sincronizar hex input con color picker
    function updateHexFromColor(colorType) {
      const hexInput = document.getElementById(`${colorType}-color-hex`);
      const colorInput = document.getElementById(`${colorType}-color`);
      
      if (hexInput && colorInput) {
        hexInput.value = colorInput.value;
      }
    }
    
    // Event listeners para sincronizar color picker con hex input (mejorados)
    document.addEventListener('DOMContentLoaded', function() {
      ['primary', 'secondary', 'tertiary'].forEach(colorType => {
        const colorInput = document.getElementById(`${colorType}-color`);
        const hexInput = document.getElementById(`${colorType}-color-hex`);
        
        if (colorInput && hexInput) {
          // Sincronizar cuando cambia el color picker
          colorInput.addEventListener('input', function() {
            updateHexFromColor(colorType);
            showSaveButton();
          });
          
          colorInput.addEventListener('change', function() {
            updateHexFromColor(colorType);
            showSaveButton();
          });
          
          // Sincronizar cuando cambia el input hex (con validación en tiempo real)
          hexInput.addEventListener('input', function() {
            updateColorFromHex(colorType);
          });
          
          hexInput.addEventListener('change', function() {
            updateColorFromHex(colorType);
            showSaveButton();
          });
        }
      });
    });
    
    // Función para manejar la subida de logo (actualizada para mostrar nombre del archivo)
    function handleLogoUpload(input) {
      const fileText = document.getElementById('logo-file-text');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        console.log('Logo seleccionado:', file.name);
        
        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          alert('Por favor, selecciona un archivo de imagen válido.');
          input.value = '';
          if (fileText) fileText.textContent = 'Ningún archivo seleccionado';
          return;
        }
        
        // Validar tamaño (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('El archivo es demasiado grande. Por favor, selecciona una imagen menor a 5MB.');
          input.value = '';
          if (fileText) fileText.textContent = 'Ningún archivo seleccionado';
          return;
        }
        
        // Actualizar el texto mostrado
        if (fileText) {
          fileText.textContent = file.name;
          fileText.style.color = '#0b2431';
        }
        
        // Convertir a base64 para guardar
        const reader = new FileReader();
        reader.onload = function(e) {
          // Guardar el logo en base64 en una variable global para usar en saveAllSettings
          window.currentLogoBase64 = e.target.result.split(',')[1]; // Remover el prefijo data:image/...;base64,
          console.log('Logo convertido a base64');
        };
        reader.readAsDataURL(file);
        
        console.log('Logo válido seleccionado:', file.name);
      } else {
        // No hay archivo seleccionado
        if (fileText) {
          fileText.textContent = 'Ningún archivo seleccionado';
          fileText.style.color = '#6c757d';
        }
        window.currentLogoBase64 = null;
      }
    }
    
    // Función para guardar todas las configuraciones (actualizada para MongoDB)
    async function saveAllSettings() {
      if (!currentListName) return;
      
      // Recopilar todas las configuraciones
      const settings = {
        listName: currentListName,
        instrucciones_generales: document.getElementById('instrucciones-input')?.value?.trim() || '',
        color_palette: {
          primary: document.getElementById('primary-color-hex')?.value || '#04db8d',
          secondary: document.getElementById('secondary-color-hex')?.value || '#0b2431',
          text: document.getElementById('tertiary-color-hex')?.value || '#455862'
        },
        language: document.getElementById('lenguaje-select')?.value || 'juridico',
        documentType: document.getElementById('tipo-documento-select')?.value || 'whatsapp'
      };
      
      // Añadir logo si existe
      if (window.currentLogoBase64) {
        settings.logo = window.currentLogoBase64;
      }
      
      try {
        // Guardar en MongoDB
        const response = await fetch('/api/save-generation-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          // También guardar en localStorage como backup
          localStorage.setItem(`instructions_${currentListName}`, settings.instrucciones_generales);
          localStorage.setItem(`language_${currentListName}`, settings.language);
          localStorage.setItem(`doctype_${currentListName}`, settings.documentType);
          
          // Mostrar feedback
          const button = document.getElementById('save-all-btn');
          const originalText = button.innerHTML;
          button.innerHTML = '<i class="fas fa-check"></i> Guardado';
          button.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
            button.classList.remove('show');
          }, 2000);
          
          console.log('Configuraciones guardadas en MongoDB:', settings);
        } else {
          throw new Error('Error al guardar en el servidor');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Error al guardar las configuraciones. Por favor, inténtalo de nuevo.');
      }
    }
    
    // Función para generar contenido final
    function generarContenidoFinal() {
      if (!currentListName) {
        alert('Error: No se ha seleccionado una lista');
        return;
      }
      
      console.log('Starting content generation for list:', currentListName);
      
      // Verificar que hay documentos seleccionados
      const selectedDocuments = getSelectedDocumentsData();
      if (selectedDocuments.length === 0) {
        console.log('No documents selected, showing modal');
        // Mostrar modal de validación
        showNoDocumentosModal();
        return;
      }
      
      console.log(`${selectedDocuments.length} documents selected for content generation`);
      
      // Recopilar todas las configuraciones
      const settings = {
        listName: currentListName,
        selectedDocuments: selectedDocuments,
        instructions: document.getElementById('instrucciones-input')?.value?.trim() || '',
        language: document.getElementById('lenguaje-select')?.value || 'juridico',
        documentType: document.getElementById('tipo-documento-select')?.value || 'whatsapp',
        colorPalette: {
          primary: document.getElementById('primary-color-hex')?.value || '#04db8d',
          secondary: document.getElementById('secondary-color-hex')?.value || '#0b2431',
          text: document.getElementById('tertiary-color-hex')?.value || '#455862'
        }
      };
      
      console.log('Generation settings:', settings);
      
      // Validar que hay instrucciones
      if (!settings.instructions) {
        alert('Por favor, introduce algunas instrucciones antes de generar el contenido.');
        document.getElementById('instrucciones-input')?.focus();
        return;
      }
      
      // Validar que los documentos tienen información mínima
      const validDocuments = selectedDocuments.filter(doc => 
        doc.short_name && doc.short_name.trim() !== ''
      );
      
      if (validDocuments.length === 0) {
        alert('Los documentos seleccionados no tienen información suficiente para generar contenido.');
        return;
      }
      
      if (validDocuments.length < selectedDocuments.length) {
        console.warn(`${selectedDocuments.length - validDocuments.length} documents have insufficient data`);
      }
      
      // Actualizar la configuración con documentos válidos
      settings.selectedDocuments = validDocuments;
      
      // Mostrar loader en el botón
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> Generando...';
      button.disabled = true;
      
      console.log('Calling AI generation with final settings:', settings);
      
      // Llamar al backend para generar contenido
      generateContentWithAI(settings)
        .then(result => {
          console.log('AI generation result:', result);
          if (result.success) {
            console.log('Content generated successfully, displaying result');
            // Mostrar el contenido generado
            displayGeneratedContent(result.content, settings.colorPalette);
          } else {
            console.error('AI generation failed:', result.error);
            alert('Error al generar contenido: ' + (result.error || 'Error desconocido'));
          }
        })
        .catch(error => {
          console.error('Error generating content:', error);
          alert('Error al generar contenido. Por favor, inténtalo de nuevo.\n\nDetalles: ' + error.message);
        })
        .finally(() => {
          // Restaurar el botón
          button.innerHTML = originalText;
          button.disabled = false;
        });
    }

    // Función para mostrar el modal de validación
    function showNoDocumentosModal() {
      const modal = document.getElementById('modal-no-documentos');
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    // Función para cerrar el modal de validación
    function closeNoDocumentosModal() {
      const modal = document.getElementById('modal-no-documentos');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Función para obtener los datos completos de los documentos seleccionados
    function getSelectedDocumentsData() {
      const selectedCheckboxes = document.querySelectorAll('.documento-checkbox:checked');
      const selectedDocuments = [];
      
      console.log(`Getting data for ${selectedCheckboxes.length} selected documents`);
      
      selectedCheckboxes.forEach((checkbox, index) => {
        const docIndex = parseInt(checkbox.dataset.docIndex);
        const documentItem = document.querySelector(`[data-doc-index="${docIndex}"]`);
        
        if (documentItem) {
          const documentData = {
            short_name: documentItem.querySelector('.documento-title')?.textContent?.trim() || '',
            collectionName: extractCollectionFromMeta(documentItem),
            resumen: documentItem.querySelector('.documento-resumen')?.textContent?.trim() || '',
            fecha: extractDateFromDocument(documentItem),
            rango: extractRangoFromDocument(documentItem),
            etiquetas: extractEtiquetasFromDocument(documentItem),
            url_pdf: extractUrlFromDocument(documentItem)
          };
          
          console.log(`Document ${index + 1} data:`, documentData);
          selectedDocuments.push(documentData);
        } else {
          console.warn(`Document item not found for index ${docIndex}`);
        }
      });
      
      console.log('Final selected documents data:', selectedDocuments);
      return selectedDocuments;
    }

    // Funciones auxiliares para extraer datos de los documentos
    function extractCollectionFromMeta(documentItem) {
      const metaElement = documentItem.querySelector('.documento-meta');
      if (metaElement) {
        const metaText = metaElement.textContent;
        const parts = metaText.split('|');
        if (parts.length > 1) {
          return parts[1].trim();
        }
      }
      return 'Fuente desconocida';
    }

    function extractDateFromDocument(documentItem) {
      const dateElement = documentItem.querySelector('.documento-date');
      if (dateElement) {
        return dateElement.textContent.trim();
      }
      return '';
    }

    function extractRangoFromDocument(documentItem) {
      const metaElement = documentItem.querySelector('.documento-meta');
      if (metaElement) {
        const metaText = metaElement.textContent;
        const parts = metaText.split('|');
        if (parts.length > 0) {
          return parts[0].trim();
        }
      }
      return '';
    }

    function extractEtiquetasFromDocument(documentItem) {
      const etiquetas = [];
      const tagElements = documentItem.querySelectorAll('.documento-tag');
      tagElements.forEach(tag => {
        const tagText = tag.textContent.trim();
        if (tagText) {
          etiquetas.push(tagText);
        }
      });
      return etiquetas;
    }

    function extractUrlFromDocument(documentItem) {
      const urlElement = documentItem.querySelector('.leer-mas, a[href*=".pdf"], a[target="_blank"]');
      if (urlElement) {
        return urlElement.getAttribute('href');
      }
      return '';
    }

    // Función para llamar al backend y generar contenido con IA
    async function generateContentWithAI(settings) {
      try {
        console.log('Sending data to backend:', settings);
        
        const response = await fetch('/api/generate-marketing-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('HTTP error response:', errorText);
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const result = await response.json();
        console.log('Backend response:', result);
        return result;
      } catch (error) {
        console.error('Error calling AI generation API:', error);
        throw error;
      }
    }

    // Función para mostrar el contenido generado
    function displayGeneratedContent(htmlContent, colorPalette) {
      const documentosSection = document.querySelector('.documentos-section');
      const documentosTitle = document.querySelector('.documentos-title');
      const documentosControls = document.querySelector('.documentos-controls');
      const documentosList = document.getElementById('documentos-list');
      const contenidoContainer = document.getElementById('contenido-generado');
      const contenidoHtml = document.getElementById('contenido-html');
      
      if (!documentosSection || !documentosTitle || !contenidoContainer || !contenidoHtml) return;
      
      // Cambiar el título de la sección con botón de copiar
      documentosTitle.innerHTML = `
        <div style="display: flex; align-items: center; width: 100%;">
          <button class="back-to-documents-btn" onclick="backToDocumentSelection()" title="Volver a selección de documentos">
            <i class="fas fa-arrow-left"></i>
          </button>
          <span style="flex: 1;">Contenido Generado</span>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="edit-content-btn" onclick="toggleEditing()" title="Editar contenido" style="background: none; border: none; color: #0b2431; font-size: 16px; cursor: pointer; padding: 5px; border-radius: 4px; transition: all 0.2s ease;">
              <i class="fas fa-edit"></i> Editar
            </button>
            <div class="export-dropdown">
              <button class="export-btn" onclick="toggleExportDropdown()" title="Exportar contenido">
                <i class="fas fa-download"></i> Exportar
              </button>
              <div class="export-dropdown-content" id="export-dropdown-content">
                <button class="export-option" onclick="copyGeneratedContent(); hideExportDropdown()">
                  <i class="fas fa-copy"></i> Copiar
                </button>
                <button class="export-option" onclick="downloadAsPDF(); hideExportDropdown()">
                  <i class="fas fa-file-pdf"></i> PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Ocultar controles de documentos y lista de documentos
      if (documentosControls) documentosControls.style.display = 'none';
      if (documentosList) documentosList.style.display = 'none';
      
      // Crear o encontrar la toolbar y posicionarla después del título
      let toolbar = document.querySelector('.editor-toolbar');
      if (!toolbar) {
        // Crear la toolbar si no existe
        toolbar = document.createElement('div');
        toolbar.className = 'editor-toolbar';
        toolbar.style.display = 'none';
        toolbar.innerHTML = `
          <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('bold')" title="Negrita">
              <i class="fas fa-bold"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('italic')" title="Cursiva">
              <i class="fas fa-italic"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('underline')" title="Subrayado">
              <i class="fas fa-underline"></i>
            </button>
          </div>
          
          <div class="toolbar-group">
            <select class="toolbar-select" onchange="changeFontSize(this.value)" title="Tamaño de fuente">
              <option value="">Tamaño</option>
              <option value="1">Muy pequeño</option>
              <option value="2">Pequeño</option>
              <option value="3">Normal</option>
              <option value="4">Grande</option>
              <option value="5">Muy grande</option>
              <option value="6">Extra grande</option>
              <option value="7">Máximo</option>
            </select>
          </div>
          
          <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Lista con viñetas">
              <i class="fas fa-list-ul"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Lista numerada">
              <i class="fas fa-list-ol"></i>
            </button>
          </div>
          
          <div class="toolbar-group">
            <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="Alinear izquierda">
              <i class="fas fa-align-left"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="Centrar">
              <i class="fas fa-align-center"></i>
            </button>
            <button class="toolbar-btn" onclick="formatText('justifyRight')" title="Alinear derecha">
              <i class="fas fa-align-right"></i>
            </button>
          </div>
        `;
      }
      
      // Insertar la toolbar después del título si no está ya ahí
      if (!toolbar.parentNode || toolbar.parentNode !== documentosSection) {
        documentosSection.insertBefore(toolbar, contenidoContainer);
      }
      
      // Preparar el contenido con logo si existe
      prepareContentWithLogo(htmlContent).then(finalContent => {
        // Insertar el contenido HTML
        contenidoHtml.innerHTML = finalContent;
        
        // Aplicar la paleta de colores solo al contenido generado
        applyColorPaletteToContent(contenidoHtml, colorPalette);
        
        // Mostrar el contenedor de contenido generado
        contenidoContainer.style.display = 'block';
        
        // Hacer scroll hacia el contenido generado
        documentosSection.scrollIntoView({ behavior: 'smooth' });
      });
    }

    // Función para preparar el contenido con logo si existe
    async function prepareContentWithLogo(htmlContent) {
      try {
        // Obtener configuraciones guardadas para la lista actual
        const response = await fetch('/api/get-generation-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ listName: currentListName })
        });
        
        if (response.ok) {
          const data = await response.json();
          const settings = data.settings;
          
          if (settings && settings.logo) {
            // Si hay un logo guardado, añadirlo al inicio del contenido
            const logoHtml = `<div class="content-logo" style="text-align: center; margin-bottom: 20px;"><img src="data:image/*;base64,${settings.logo}" alt="Logo" style="max-width: 200px; max-height: 80px; object-fit: contain;" /></div>`;
            return logoHtml + htmlContent;
          }
        }
      } catch (error) {
        console.log('No logo found or error loading logo:', error);
      }
      
      return htmlContent;
    }

    // Función para aplicar la paleta de colores solo al contenido generado
    function applyColorPaletteToContent(container, colorPalette) {
      // Aplicar colores a headings (primary color) - solo si no tienen color personalizado
      const headings = container.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach(heading => {
        // Solo aplicar si no tiene un color personalizado (inline style)
        if (!heading.style.color || heading.style.color === '') {
          heading.style.color = colorPalette.primary;
        }
      });
      
      // Aplicar colores a texto principal (text color) - solo si no tienen color personalizado
      const textElements = container.querySelectorAll('p, li, span:not(.detail):not(.meta)');
      textElements.forEach(element => {
        // Solo aplicar si no tiene un color personalizado (inline style)
        if (!element.style.color || element.style.color === '') {
          element.style.color = colorPalette.text;
        }
      });
      
      // Aplicar colores a elementos de detalle (secondary color) - solo si no tienen color personalizado
      const detailElements = container.querySelectorAll('b, strong, .detail, .meta, small');
      detailElements.forEach(element => {
        // Solo aplicar si no tiene un color personalizado (inline style)
        if (!element.style.color || element.style.color === '') {
          element.style.color = colorPalette.secondary;
        }
      });
      
      // Aplicar colores a bordes y elementos especiales
      const blockquotes = container.querySelectorAll('blockquote');
      blockquotes.forEach(blockquote => {
        blockquote.style.borderLeftColor = colorPalette.primary;
        // Solo aplicar color de texto si no tiene uno personalizado
        if (!blockquote.style.color || blockquote.style.color === '') {
          blockquote.style.color = colorPalette.text;
        }
      });
      
      // Aplicar colores a tablas
      const tableHeaders = container.querySelectorAll('th');
      tableHeaders.forEach(th => {
        th.style.backgroundColor = `${colorPalette.primary}1a`; // 10% opacity
        // Solo aplicar color de texto si no tiene uno personalizado
        if (!th.style.color || th.style.color === '') {
          th.style.color = colorPalette.secondary;
        }
      });
      
      const tableCells = container.querySelectorAll('td');
      tableCells.forEach(td => {
        // Solo aplicar color de texto si no tiene uno personalizado
        if (!td.style.color || td.style.color === '') {
          td.style.color = colorPalette.text;
        }
      });
    }

    // Función para volver a la selección de documentos
    function backToDocumentSelection() {
      const documentosTitle = document.querySelector('.documentos-title');
      const documentosControls = document.querySelector('.documentos-controls');
      const documentosList = document.getElementById('documentos-list');
      const contenidoContainer = document.getElementById('contenido-generado');
      const toolbar = document.querySelector('.editor-toolbar');
      const contenidoHtml = document.getElementById('contenido-html');
      
      // Restaurar el título original
      if (documentosTitle) {
        documentosTitle.innerHTML = 'Documentos';
      }
      
      // Ocultar y resetear la toolbar
      if (toolbar) {
        toolbar.style.display = 'none';
      }
      
      // Resetear el estado de edición del contenido
      if (contenidoHtml) {
        contenidoHtml.contentEditable = 'false';
        contenidoHtml.style.marginTop = '';
      }
      
      // Mostrar controles de documentos y lista de documentos
      if (documentosControls) documentosControls.style.display = 'flex';
      if (documentosList) documentosList.style.display = 'flex';
      
      // Ocultar el contenedor de contenido generado
      if (contenidoContainer) contenidoContainer.style.display = 'none';
      
      // Hacer scroll hacia la sección de documentos
      const documentosSection = document.querySelector('.documentos-section');
      if (documentosSection) {
        documentosSection.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // ==================== FUNCIONES PARA SELECCIÓN DE DOCUMENTOS ====================
     
    // Función para alternar la selección de un documento específico
    function toggleDocumentSelection(index) {
      const documentItem = document.querySelector(`[data-doc-index="${index}"]`);
      const checkbox = document.querySelector(`input[data-doc-index="${index}"]`);
      
      if (!documentItem || !checkbox) return;
      
      // Alternar el estado del checkbox
      checkbox.checked = !checkbox.checked;
      
      // Actualizar la apariencia visual del documento
      if (checkbox.checked) {
        documentItem.classList.add('selected');
      } else {
        documentItem.classList.remove('selected');
      }
      
      // Actualizar el contador y el estado del "seleccionar todos"
      updateSelectedCount();
      updateSelectAllState();
    }
    
    // Función para seleccionar/deseleccionar todos los documentos
    function toggleSelectAllDocuments(selectAllCheckbox) {
      const documentCheckboxes = document.querySelectorAll('.documento-checkbox');
      const documentItems = document.querySelectorAll('.documento-item');
      
      documentCheckboxes.forEach((checkbox, index) => {
        checkbox.checked = selectAllCheckbox.checked;
        
        const documentItem = documentItems[index];
        if (selectAllCheckbox.checked) {
          documentItem.classList.add('selected');
        } else {
          documentItem.classList.remove('selected');
        }
      });
      
      updateSelectedCount();
    }
    
    // Función para actualizar el contador de documentos seleccionados
    function updateSelectedCount() {
      const selectedCheckboxes = document.querySelectorAll('.documento-checkbox:checked');
      const countElement = document.getElementById('selected-count');
      
      if (countElement) {
        countElement.textContent = `Documentos seleccionados: ${selectedCheckboxes.length}`;
      }
    }
    
    // Función para actualizar el estado del checkbox "seleccionar todos"
    function updateSelectAllState() {
      const selectAllCheckbox = document.getElementById('select-all-docs');
      const documentCheckboxes = document.querySelectorAll('.documento-checkbox');
      const selectedCheckboxes = document.querySelectorAll('.documento-checkbox:checked');
      
      if (!selectAllCheckbox || documentCheckboxes.length === 0) return;
      
      if (selectedCheckboxes.length === 0) {
        // Ninguno seleccionado
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (selectedCheckboxes.length === documentCheckboxes.length) {
        // Todos seleccionados
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        // Algunos seleccionados
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }
    
    // Función para obtener los documentos seleccionados (versión simple para compatibilidad)
    function getSelectedDocuments() {
      const selectedCheckboxes = document.querySelectorAll('.documento-checkbox:checked');
      const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.docIndex));
      return selectedIndices;
    }

    // Función para mostrar el botón de guardar cuando se edita algo
    function showSaveButton() {
      const saveButton = document.getElementById('save-all-btn');
      if (saveButton) {
        saveButton.classList.add('show');
      }
    }

    // Función para guardar instrucciones (mantenida por compatibilidad)
    function saveInstrucciones() {
      // Redirigir a la nueva función
      saveAllSettings();
    }

    // Función para guardar formato (mantenida por compatibilidad)
    function saveFormato() {
      // Redirigir a la nueva función
      saveAllSettings();
    }

    // Función para copiar el contenido generado
    async function copyGeneratedContent() {
      const contenidoHtml = document.getElementById('contenido-html');
      const exportButton = document.querySelector('.export-btn');
      
      if (!contenidoHtml) {
        alert('No hay contenido para copiar');
        return;
      }
      
      try {
        // Crear una versión del contenido con estilos inline para mantener el formato
        const styledContent = createStyledContentForCopy(contenidoHtml);
        
        // Intentar copiar usando la API moderna primero
        if (navigator.clipboard && window.isSecureContext) {
          // Crear elementos para clipboard
          const clipboardItem = new ClipboardItem({
            'text/html': new Blob([styledContent], { type: 'text/html' }),
            'text/plain': new Blob([contenidoHtml.textContent || contenidoHtml.innerText], { type: 'text/plain' })
          });
          
          await navigator.clipboard.write([clipboardItem]);
        } else {
          // Fallback para navegadores más antiguos
          const tempTextArea = document.createElement('textarea');
          tempTextArea.value = contenidoHtml.textContent || contenidoHtml.innerText;
          tempTextArea.style.position = 'fixed';
          tempTextArea.style.left = '-9999px';
          document.body.appendChild(tempTextArea);
          tempTextArea.select();
          document.execCommand('copy');
          document.body.removeChild(tempTextArea);
        }
        
        // Mostrar feedback visual
        showCopyFeedback(exportButton);
        
      } catch (error) {
        console.error('Error copying content:', error);
        
        // Fallback: copiar solo texto plano
        try {
          const textContent = contenidoHtml.textContent || contenidoHtml.innerText;
          await navigator.clipboard.writeText(textContent);
          showCopyFeedback(exportButton);
        } catch (textError) {
          console.error('Error copying text:', textError);
          alert('Error al copiar el contenido. Por favor, selecciona y copia manualmente.');
        }
      }
    }

    // Función para crear contenido con estilos inline para copiar
    function createStyledContentForCopy(container) {
      const clone = container.cloneNode(true);
      
      // Aplicar estilos inline para mantener el formato al pegar
      const headings = clone.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach(heading => {
        const currentColor = heading.style.color || '#04db8d';
        heading.style.cssText = `color: ${currentColor}; font-weight: 600; margin: 20px 0 10px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;`;
      });
      
      const paragraphs = clone.querySelectorAll('p');
      paragraphs.forEach(p => {
        const currentColor = p.style.color || '#455862';
        p.style.cssText = `color: ${currentColor}; line-height: 1.6; margin: 10px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;`;
      });
      
      const lists = clone.querySelectorAll('ul, ol');
      lists.forEach(list => {
        list.style.cssText = `padding-left: 20px; margin: 10px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;`;
      });
      
      const listItems = clone.querySelectorAll('li');
      listItems.forEach(li => {
        const currentColor = li.style.color || '#455862';
        li.style.cssText = `color: ${currentColor}; line-height: 1.6; margin: 5px 0;`;
      });
      
      const boldElements = clone.querySelectorAll('b, strong');
      boldElements.forEach(bold => {
        const currentColor = bold.style.color || '#0b2431';
        bold.style.cssText = `color: ${currentColor}; font-weight: 600;`;
      });
      
      const tables = clone.querySelectorAll('table');
      tables.forEach(table => {
        table.style.cssText = `width: 100%; border-collapse: collapse; margin: 15px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;`;
      });
      
      const tableCells = clone.querySelectorAll('th, td');
      tableCells.forEach(cell => {
        cell.style.cssText = `border: 1px solid #dee2e6; padding: 8px 12px; text-align: left;`;
      });
      
      const tableHeaders = clone.querySelectorAll('th');
      tableHeaders.forEach(th => {
        th.style.cssText += `background-color: rgba(4, 219, 141, 0.1); font-weight: 600;`;
      });
      
      // Añadir estilos generales al contenedor
      clone.style.cssText = `font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #455862;`;
      
      return clone.outerHTML;
    }

    // Función para mostrar feedback visual del copiado
    function showCopyFeedback(button) {
      const originalIcon = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i>';
      button.classList.add('copied');
      
      setTimeout(() => {
        button.innerHTML = originalIcon;
        button.classList.remove('copied');
      }, 2000);
    }

      </script>
    <script>
    // Function to show the configuration section
    function showConfiguracionSection() {
      // Remove active class from all sidebar items
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      
      // Add active class to configuration sidebar item
      const configItem = document.querySelector('.sidebar-item[data-target="content-configuracion"]');
      if (configItem) {
        configItem.classList.add('active');
      }
      
      // Hide all content sections
      document.querySelectorAll('.vision-section').forEach(section => section.style.display = 'none');
      
      // Show configuration section
      const configSection = document.getElementById('content-configuracion');
      if (configSection) {
        configSection.style.display = 'block';
        loadConfiguracionContent();
      }
    }
    
    // Function to load configuration content
    function loadConfiguracionContent() {
      const container = document.getElementById('configuracion-iframe-container');
      if (!container) return;
      
      // Check if content is already loaded
      if (container.innerHTML.trim() !== '<!-- The configuration content will be loaded here -->') {
        // Content already loaded, just initialize the menu
        if (window.initializeConfigurationMenu) {
          window.initializeConfigurationMenu();
        }
        return;
      }
      
      // Load the configuration content
      fetch('configuracion_cuenta.html')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(html => {
          // Extract the body content from the HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const bodyContent = doc.body.innerHTML;
          
          container.innerHTML = bodyContent;
          
          // Append styles from the loaded document head to the main document head
          const headStyles = doc.head.querySelectorAll('style, link[rel="stylesheet"]');
          headStyles.forEach(styleEl => {
            document.head.appendChild(styleEl.cloneNode(true));
          });
          
          // Re-execute any scripts in the loaded content
          const scripts = container.querySelectorAll('script');
          scripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.head.appendChild(newScript);
            script.remove();
          });
          
          // Initialize the configuration menu after a short delay to ensure DOM is ready
          setTimeout(() => {
            if (window.initializeConfigurationMenu) {
              window.initializeConfigurationMenu();
            }
          }, 200);
        })
        .catch(error => {
          console.error('Error loading configuration content:', error);
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
              <h3>Error al cargar la configuración</h3>
              <p>Por favor, inténtalo de nuevo más tarde.</p>
            </div>
          `;
        });
    }
    </script>
</body>
</html>
