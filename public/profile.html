<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Profile</title>
  <link rel="icon" href="assets/papyrus_logo.png" type="image/png"> 

  <!-- Font Awesome + Chart.js + Basic CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>

  <!-- Your existing CSS files -->
  <link rel="stylesheet" type="text/css" href="styles/styles.css" />
  <link rel="stylesheet" type="text/css" href="styles/menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
  <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
  <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/mobile.css" />

  <style>
    /* Loader overlay styling */
    #pageLoaderOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .page-loader {
      width: 50px; height: 50px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    /* Dropdown styling for multi-check logic */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropbtn i {
      margin-left: 6px;
    }

    /* The actual dropdown menus */
    #myDropdown,
    #ramaDropdown,
    #boletinDropdown,
    #rangoDropdown {
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      display: none; /* hidden by default */
    }
    #myDropdown.show,
    #ramaDropdown.show,
    #boletinDropdown.show,
    #rangoDropdown.show {
      display: block;
    }

    /* Items inside the dropdown */
    #myDropdown label,
    #ramaDropdown label,
    #boletinDropdown label,
    #rangoDropdown label {
      display: block;
      padding: 4px 2px;
      margin: 0;
      cursor: pointer;
      font-size: 0.85em;
      border-bottom: 1px solid #ddd;
    }
    #myDropdown label:last-child,
    #ramaDropdown label:last-child,
    #boletinDropdown label:last-child,
    #rangoDropdown label:last-child {
      border-bottom: none;
    }
    #myDropdown input[type="checkbox"],
    #ramaDropdown input[type="checkbox"],
    #boletinDropdown input[type="checkbox"],
    #rangoDropdown input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #04db8d;
      margin-right: 6px;
    }

    /* Sub-ramas container */
    #subRamasCheckboxContainer {
      margin: 10px 0;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 6px;
      display: none; 
      max-height: 200px;
      overflow-y: auto;
    }
    #subRamasCheckboxContainer label {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
      font-size: 0.85em;
    }
    #subRamasCheckboxContainer input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #04db8d;
      margin-right: 6px;
    }

    /* Basic layout styling */
    .analytics-label {
      margin-top: 20px;
      font-weight: bold;
    }
    .detalle-cuenta {
      display: flex;
      gap: 50px;
      margin-bottom: 20px;
    }
    .etiquetas-label {
      font-weight: bold;
    }
    .filter-item {
      margin-bottom: 10px;
    }
    .filter-section {
      margin-bottom: 10px;
    }
    .collectionDocs {
      margin-top: 10px;
    }
    .menu.active {
      display: block;
    }
    .filter-banner-container {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 10px;
}

.beta-banner {
  background-color: #455862;
  color: white;
  padding: 8px 15px;
  border-radius: 4px;
  font-size: 0.9em;
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Subramas dropdown styling */
/* Subramas dropdown styling */
.rama-label-container {
  position: relative;
  display: block;
}

.subramas-dropdown {
  position: absolute;
  left: 100%;
  top: 0;
  background: #fff;
  border: 1px solid #ccc;
  padding: 5px;
  border-radius: 4px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  min-width: 150px;
  max-height: 200px;
  overflow-y: auto;
  display: none;
  z-index: 1100;
  margin-left: 5px;
}

.subramas-dropdown.active {
  display: block;
}

.subramas-toggle {
  cursor: pointer;
  margin-left: 5px;
  color: #666;
}

.subramas-toggle:hover {
  color: #04db8d;
}

.subramas-dropdown label {
  display: block;
  padding: 4px 2px;
  margin: 0;
  cursor: pointer;
  font-size: 0.85em;
  border-bottom: 1px solid #ddd;
  white-space: nowrap;
}

.subramas-dropdown label:last-child {
  border-bottom: none;
}

.subramas-dropdown input[type="checkbox"] {
  width: 16px;
  height: 16px;
  transform: scale(0.9);
  accent-color: #04db8d;
  margin-right: 6px;
}

#ramaDropdown {
  overflow: visible !important;
}



  </style>
</head>
<body>
  <!-- Loader overlay -->
  <div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">
      <a href="https://papyrus-ai.com/" target="_blank">
        <img src="assets/papyrus_app.png" alt="Papyrus Logo">
      </a>
    </div>
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <ul class="menu">
      <li><a href="https://papyrus-ai.com/">WEB</a></li>
      <li><a href="/profile">PANEL DE CONTROL</a></li>
      <li><a href="http://app.papyrus-ai.com/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
      <li><a href="https://papyrus-ai.com/pages/contact-1">AYUDA</a></li>
    </ul>
  </nav>

  <h1>Hola {{name}}</h1>

  <div id="data-container">
    <!-- 1) Show user-subscribed Industries / Ramas in .etiquetas-values -->
    <div class="detalle-cuenta">
      <div>
        <div class="etiquetas-label">Sectores Económicos Suscritos</div>
        <div class="etiquetas-values" id="etiquetasContainer"></div>
      </div>
      <div>
        <div class="etiquetas-label">Ramas Jurídicas Suscritas</div>
        <div class="etiquetas-values" id="ramasContainer"></div>
      </div>
    </div>

    <a href="#" id="editSuscription" class="change-subscription">Editar Suscripción</a>
    <div class="analytics-label busqueda">Búsqueda Avanzada</div>

    <!-- JSON data for industries, ramas, subramas, etc. -->
    <script id="industryTags" type="application/json">{{industry_tags_json}}</script>
    <script id="ramaJuridicas" type="application/json">{{rama_juridicas_json}}</script>
    <script id="userSubRamaMap" type="application/json">{{subrama_juridicas_json}}</script>

    <div class="filter-banner-container">
      <div class="beta-banner">
        Búsqueda anterior a 21/03/2025 en versión Beta
      </div>
    </div>
    

    <!-- Filter Section -->
    <div id="Filtrar">
      <!-- Sector Económico multi-check -->
      <div class="filter-item">
        <div class="etiquetas-label">Sector Económico</div>
        <div class="dropdown">
          <button class="dropbtn" id="btnSectorEconomico" onclick="toggleIndustryDropdown()">
            <span id="selectedIndustry">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="myDropdown" class="dropdown-content">
            <!-- Populated on DOMContentLoaded -->
          </div>
        </div>
      </div>

      <!-- Rama Jurídica multi-check + sub-ramas -->
      <div class="filter-item">
        <div class="etiquetas-label">Rama Jurídica</div>
        <div class="dropdown" style="margin-bottom: 10px;">
          <button class="dropbtn" id="btnRamaJuridica" onclick="toggleRamaDropdown()">
            <span id="selectedRama">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="ramaDropdown" class="dropdown-content">
            <!-- Populated on DOMContentLoaded -->
          </div>
        </div>
        <!-- sub-ramas container if a single rama is chosen -->
        <div id="subRamasCheckboxContainer"></div>
      </div>

      <!-- Boletín Oficial multi-check -->
      <div class="filter-item">
        <div class="etiquetas-label">Boletín Oficial</div>
        <div class="dropdown">
          <button class="dropbtn" id="btnBoletin" onclick="toggleBoletinDropdown()">
            <span id="selectedBoletines">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="boletinDropdown" class="dropdown-content">
            <!-- "Todos" + bulletins, all checked by default, on DOMContentLoaded -->
          </div>
        </div>
      </div>

      <!-- RANGO multi-check -->
      <div class="filter-item">
        <div class="etiquetas-label">Rango</div>
        <div class="dropdown" style="margin-bottom: 10px;">
          <button class="dropbtn" id="btnRango" onclick="toggleRangoDropdown()">
            <span id="selectedRango">Todos</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="rangoDropdown" class="dropdown-content">
            <label><input type="checkbox" value="Todos" id="chkAllRango" checked> Todos</label>
            <label><input type="checkbox" value="Leyes" checked> Leyes</label>
            <label><input type="checkbox" value="Reglamentos" checked> Reglamentos</label>
            <label><input type="checkbox" value="Decisiones interpretativas y Reguladores" checked> Decisiones interpretativas y Reguladores</label>
            <label><input type="checkbox" value="Jurisprudencia" checked> Jurisprudencia</label>
            <label><input type="checkbox" value="Ayudas,subvenciones y premios" checked> Ayudas,subvenciones y premios</label>
            <label><input type="checkbox" value="Otras" checked> Otras</label>
          </div>
        </div>
      </div>

      <!-- Date filters -->
      <div class="filter-item">
        <div class="etiquetas-label">Fecha de publicación</div>
        <div class="date-filter">
          <label for="startDate">Desde:</label>
          <input type="date" id="startDate" name="startDate" />
          <label for="endDate">Hasta:</label>
          <input type="date" id="endDate" name="endDate" />
        </div>
      </div>
    </div>

    <div style="text-align: right;">
      <button id="buscarBtn" onclick="handleBuscar()">Buscar</button>
    </div>

    <div class="analytics-label">Estadísticas de la búsqueda</div>
    <div id="loading-icon-chart" style="display: none;">
      <div class="loader"></div>
    </div>
    <div id="chartContainer">
      <canvas id="documentsChart"></canvas>
    </div>

    <div class="analytics-label">Documentos</div>
    <div id="loading-icon" style="display: none;">
      <div class="loader"></div>
    </div>
    <div class="collectionDocs">{{boeDocuments}}</div>
  </div>

  <div class="logout-container">
    <a href="/logout">Logout</a>
  </div>

  <!-- Additional JSON data for the chart and plan, etc. -->
  <script id="monthsData" type="application/json">{{months_json}}</script>
  <script id="countsData" type="application/json">{{counts_json}}</script>
  <script id="userPlan" type="application/json">{{subscription_plan}}</script>
  <script id="startDateInput" type="application/json">{{start_date}}</script>
  <script id="endDateInput" type="application/json">{{end_date}}</script>
  <script id="userBoletines" type="application/json">{{user_boletines_json}}</script>
  <script id="userRangos" type="application/json">{{user_rangos_json}}</script>

  <script src="editarSuscripcion.js"></script>

  <script>
    // --------------------- NAV / HAMBURGER ---------------------
    function toggleMenu() {
      const menu = document.querySelector('.menu');
      menu.classList.toggle('active');
    }
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.menu');
      const hamburger = document.querySelector('.hamburger');
      if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    // --------------------- LOADER / CHART ON LOAD ---------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Hide initial loader
      const loaderOverlay = document.getElementById("pageLoaderOverlay");
      if (loaderOverlay) loaderOverlay.style.display = "none";

      // Fill default date from server
      const startDateInput = JSON.parse(document.getElementById("startDateInput").textContent || '"2024-01-01T00:00:00.000Z"');
      const formattedDate = new Date(startDateInput).toISOString().split('T')[0];
      const startDate = document.getElementById("startDate");
      if (formattedDate && startDate) {
        startDate.value = formattedDate;
      }

      // If we have months/counts => load chart on first load
      const monthsData = JSON.parse(document.getElementById('monthsData').textContent || '[]');
      const countsData = JSON.parse(document.getElementById('countsData').textContent || '[]');
      if (monthsData.length && countsData.length) {
        loadChart(monthsData, countsData);
      }
    });

    // --------------------- EDIT SUBSCRIPTION LINK ---------------------
   
   /* document.getElementById('editIndustriesLink').addEventListener('click', function(e){
      e.preventDefault();
      window.location.href = '/suscripcion.html';
    });
    */

    // --------------------- plan logic => disabling bulletins if plan1 ---------------------
    let userPlan;
    document.addEventListener("DOMContentLoaded", () => {
      userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
    });

    // --------------------- LOAD USER DATA ---------------------
    let userIndustries = [];
    let userRamas = [];
    let userSubRamaMap = {};
    let userBoletines = []; // Changed from const allBulletins
    let userRangos = [];    // Changed from const allRangos

    (function initUserData(){
      // parse user industries
      const industryTagScript = document.getElementById('industryTags');
      if (industryTagScript) {
        userIndustries = JSON.parse(industryTagScript.textContent) || [];
      }
      // parse user Ramas
      const ramaScript = document.getElementById('ramaJuridicas');
      if (ramaScript) {
        userRamas = JSON.parse(ramaScript.textContent) || [];
      }
      // parse userSubRamaMap
      const subRamaScript = document.getElementById('userSubRamaMap');
      if (subRamaScript) {
        userSubRamaMap = JSON.parse(subRamaScript.textContent) || {};
      }
      // NEW: parse userBoletines
      const boletinesScript = document.getElementById('userBoletines');
        if (boletinesScript) {
          userBoletines = JSON.parse(boletinesScript.textContent) || ["BOE"];
        }
        
        // NEW: parse userRangos
        const rangosScript = document.getElementById('userRangos');
        console.log(rangosScript);
        if (rangosScript) {
          userRangos = JSON.parse(rangosScript.textContent) || [
            "Leyes", "REGLAMENTOS", "DECISIONES INTERPRETATIVAS Y REGULADORES",
            "JURISPRUDENCIA", "AYUDAS,SUBVENCIONES Y PREMIOS", "OTRAS"
          ];
        }
      // Show user data in #etiquetasContainer / #ramasContainer
      const etcContainer = document.getElementById('etiquetasContainer');
      if (etcContainer) {
        if (userIndustries.length > 0) {
          etcContainer.innerHTML = userIndustries.map(i => `<span>${i}</span>`).join('');
        } else {
          etcContainer.innerHTML = `<span>No hay sectores suscritos</span>`;
        }
      }
      const ramaContainer = document.getElementById('ramasContainer');
      if (ramaContainer) {
        if (userRamas.length > 0) {
          ramaContainer.innerHTML = userRamas.map(r => `<span>${r}</span>`).join('');
        } else {
          ramaContainer.innerHTML = `<span>No hay ramas suscritas</span>`;
        }
      }
    })();

    // --------------------- DROPDOWN for Sector Económico ---------------------
    function populateIndustryDropdown() {
      const container = document.getElementById('myDropdown');
      if (!container) return;
      container.innerHTML = '';

      // "Todos" => checked
      const lblTodos = document.createElement('label');
      lblTodos.innerHTML = `<input type="checkbox" id="chkAllIndustry" value="Todos" checked> Todos`;
      container.appendChild(lblTodos);

      userIndustries.forEach(ind => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${ind}" checked> ${ind}`;
        container.appendChild(lbl);
      });

      const chkAllIndustry = lblTodos.querySelector('#chkAllIndustry');
      chkAllIndustry.addEventListener('change', () => {
        const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
        if (chkAllIndustry.checked) {
          others.forEach(o => o.checked = true);
        } else {
          others.forEach(o => o.checked = false);
        }
        updateIndustryLabel();
      });
      const otherBoxes = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
      otherBoxes.forEach(box => {
        box.addEventListener('change', () => {
          const allChecked = [...otherBoxes].every(b => b.checked);
          chkAllIndustry.checked = allChecked;
          updateIndustryLabel();
        });
      });

      document.getElementById('selectedIndustry').textContent = 'Todas';
    }
    function toggleIndustryDropdown() {
      document.getElementById('myDropdown').classList.toggle('show');
    }
    function updateIndustryLabel() {
      const container = document.getElementById('myDropdown');
      const chkAllIndustry = container.querySelector('#chkAllIndustry');
      const otherBoxes = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
      const labelSpan = document.getElementById('selectedIndustry');

      if (chkAllIndustry.checked) {
        labelSpan.textContent = 'Todas';
        return;
      }
      let checkedCount = 0;
      let singleValue = '';
      otherBoxes.forEach(b => {
        if (b.checked) {
          checkedCount++;
          singleValue = b.value;
        }
      });
      if (checkedCount === 0) {
        labelSpan.textContent = '-';
      } else if (checkedCount === 1) {
        labelSpan.textContent = singleValue;
      } else if (checkedCount === otherBoxes.length) {
        labelSpan.textContent = 'Todas';
        chkAllIndustry.checked = true;
      } else {
        labelSpan.textContent = checkedCount + ' seleccionados';
      }
    }

    // --------------------- DROPDOWN for Ramas ---------------------
  // NEW: Replace the existing populateRamaDropdown function with this updated version
function populateRamaDropdown() {
  const container = document.getElementById('ramaDropdown');
  if (!container) return;
  container.innerHTML = '';
  
  // Ensure the container has the right overflow setting
  container.style.overflow = 'visible';
  
  // "Todos" => checked
  const lblTodos = document.createElement('label');
  lblTodos.innerHTML = `<input type="checkbox" id="chkAllRamas" value="Todos" checked> Todos`;
  
  // NEW: Prevent default label behavior for "Todos" as well
  lblTodos.addEventListener('click', function(e) {
    if (e.target.type !== 'checkbox') {
      e.preventDefault();
    }
  });
  
  container.appendChild(lblTodos);

  userRamas.forEach(r => {
    // Create a container for the rama label and its subramas dropdown
    const ramaContainer = document.createElement('div');
    ramaContainer.className = 'rama-label-container';
    
    const lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" value="${r}" checked> <span class="rama-text">${r}</span>`;

    // Create the subramas dropdown
    const subRamasDropdown = document.createElement('div');
    subRamasDropdown.className = 'subramas-dropdown';
    subRamasDropdown.setAttribute('data-rama', r);
    
    // NEW: Single event listener for label click that handles both checkbox and text
    lbl.addEventListener('click', function(e) {
      // If checkbox was clicked, let the default behavior happen
      if (e.target.type === 'checkbox') {
        return;
      }
      
      // If toggle button was clicked, let its own handler work
      if (e.target.closest('.subramas-toggle')) {
        return;
      }
      
      // For any other part of the label (text), prevent default and toggle dropdown
      e.preventDefault();
      e.stopPropagation();
      
      // Close all other open subramas dropdowns
      document.querySelectorAll('.subramas-dropdown.active').forEach(dropdown => {
        if (dropdown !== subRamasDropdown) {
          dropdown.classList.remove('active');
        }
      });
      
      // Toggle this dropdown
      subRamasDropdown.classList.toggle('active');
    });
    
    // NEW: Add a toggle button for subramas that doesn't interfere with checkbox
    const toggleBtn = document.createElement('span');
    toggleBtn.className = 'subramas-toggle';
    toggleBtn.innerHTML = ' <i class="fa fa-caret-right"></i>';
    toggleBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      // Close all other open subramas dropdowns
      document.querySelectorAll('.subramas-dropdown.active').forEach(dropdown => {
        if (dropdown !== subRamasDropdown) {
          dropdown.classList.remove('active');
        }
      });
      // Toggle this dropdown
      subRamasDropdown.classList.toggle('active');
    });
    
    lbl.appendChild(toggleBtn);
    ramaContainer.appendChild(lbl);
    
    // Add subramas checkboxes if available for this rama
    if (userSubRamaMap[r] && userSubRamaMap[r].length > 0) {
      userSubRamaMap[r].forEach(sub => {
        const subLabel = document.createElement('label');
        subLabel.innerHTML = `<input type="checkbox" class="subrama-checkbox" data-rama="${r}" data-subrama="${sub}" checked> ${sub}`;
        subRamasDropdown.appendChild(subLabel);
      });
    } else {
      const noSubLabel = document.createElement('div');
      noSubLabel.textContent = "No hay subramas";
      noSubLabel.style.padding = "5px";
      noSubLabel.style.fontStyle = "italic";
      noSubLabel.style.color = "#666";
      subRamasDropdown.appendChild(noSubLabel);
    }
    
    ramaContainer.appendChild(subRamasDropdown);
    container.appendChild(ramaContainer);
  });

  const chkAllRamas = lblTodos.querySelector('#chkAllRamas');
  chkAllRamas.addEventListener('change', () => {
    const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas):not(.subrama-checkbox)');
    if (chkAllRamas.checked) {
      others.forEach(o => o.checked = true);
      // Also check all subramas
      container.querySelectorAll('.subrama-checkbox').forEach(s => s.checked = true);
    } else {
      others.forEach(o => o.checked = false);
      // Also uncheck all subramas
      container.querySelectorAll('.subrama-checkbox').forEach(s => s.checked = false);
    }
    updateRamaLabel();
  });
  
  const otherRamas = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas):not(.subrama-checkbox)');
  otherRamas.forEach(box => {
    box.addEventListener('change', () => {
      const allChecked = [...otherRamas].every(b => b.checked);
      chkAllRamas.checked = allChecked;
      
      // When a rama is unchecked, uncheck all its subramas
      const rama = box.value;
      if (!box.checked) {
        container.querySelectorAll(`.subrama-checkbox[data-rama="${rama}"]`).forEach(s => s.checked = false);
      } else {
        // When a rama is checked, check all its subramas
        container.querySelectorAll(`.subrama-checkbox[data-rama="${rama}"]`).forEach(s => s.checked = true);
      }
      
      updateRamaLabel();
    });
  });
  
  // Add event listeners for subrama checkboxes
  const subRamaCheckboxes = container.querySelectorAll('.subrama-checkbox');
  subRamaCheckboxes.forEach(subBox => {
    subBox.addEventListener('change', (e) => {
      e.stopPropagation(); // Prevent event bubbling
      const rama = subBox.getAttribute('data-rama');
      
      const ramaSubramas = container.querySelectorAll(`.subrama-checkbox[data-rama="${rama}"]`);
      const anySubramaChecked = [...ramaSubramas].some(s => s.checked);
      
      // Update rama checkbox if at least one subrama is checked
      const ramaCheckbox = container.querySelector(`input[type="checkbox"][value="${rama}"]:not(.subrama-checkbox)`);
      if (ramaCheckbox) {
        ramaCheckbox.checked = anySubramaChecked;
      }
      
      // Update "Todos" checkbox only if all ramas are checked
      const allRamasChecked = [...otherRamas].every(r => r.checked);
      chkAllRamas.checked = allRamasChecked;
      
      updateRamaLabel();
    });
  });

  document.getElementById('selectedRama').textContent = 'Todas';
  document.getElementById('subRamasCheckboxContainer').style.display = 'none';
}



    function toggleRamaDropdown() {
      document.getElementById('ramaDropdown').classList.toggle('show');
    }
    function updateRamaLabel() {
      const container = document.getElementById('ramaDropdown');
      const chkAllRamas = container.querySelector('#chkAllRamas');
      const otherRamas = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
      const labelSpan = document.getElementById('selectedRama');
      const subRamasContainer = document.getElementById('subRamasCheckboxContainer');

      if (chkAllRamas.checked) {
        labelSpan.textContent = 'Todas';
        subRamasContainer.style.display = 'none';
        return;
      }
      let checkedCount = 0;
      let singleVal = '';
      otherRamas.forEach(b => {
        if (b.checked) {
          checkedCount++;
          singleVal = b.value;
        }
      });
      if (checkedCount === 0) {
        labelSpan.textContent = '-';
        subRamasContainer.style.display = 'none';
      } else if (checkedCount === 1) {
        labelSpan.textContent = singleVal;
        fillSubRamas(singleVal);
      } else if (checkedCount === otherRamas.length) {
        labelSpan.textContent = 'Todas';
        chkAllRamas.checked = true;
        subRamasContainer.style.display = 'none';
      } else {
        labelSpan.textContent = checkedCount + ' seleccionados';
        subRamasContainer.style.display = 'none';
      }
    }
    function fillSubRamas(ramaName) {
      const subRamasContainer = document.getElementById('subRamasCheckboxContainer');
      subRamasContainer.innerHTML = '';
      if (!userSubRamaMap[ramaName] || !userSubRamaMap[ramaName].length) {
        subRamasContainer.style.display = 'none';
        return;
      }
      subRamasContainer.style.display = 'block';
      userSubRamaMap[ramaName].forEach(sub => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${sub}" checked> ${sub}`;
        subRamasContainer.appendChild(lbl);
      });
    }

    // --------------------- DROPDOWN for BOLETINES  ---------------------

    function toggleBoletinDropdown() {
  document.getElementById('boletinDropdown').classList.toggle('show');
}

    function populateBoletinDropdown() {
  const container = document.getElementById('boletinDropdown');
  if (!container) return;
  container.innerHTML = '';

  const lblTodos = document.createElement('label');
  lblTodos.innerHTML = `<input type="checkbox" id="chkAllBoletines" value="Todos" checked> Todos`;
  container.appendChild(lblTodos);

  // Use userBoletines instead of allBulletins
  userBoletines.forEach(bol => {
    const lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" value="${bol}" checked> ${bol}`;
    container.appendChild(lbl);
  });

  // plan1 => disable everything except BOE
  if (userPlan === 'plan1') {
    container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      if (cb.value !== 'Todos' && cb.value !== 'BOE') {
        cb.disabled = true;
        cb.parentElement.style.opacity = '0.5';
      }
    });
  }

  const chkAllBol = lblTodos.querySelector('#chkAllBoletines');
  chkAllBol.addEventListener('change', () => {
    const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
    if (chkAllBol.checked) {
      others.forEach(o => { 
        if (!o.disabled) o.checked = true; 
      });
    } else {
      others.forEach(o => { 
        if (!o.disabled) o.checked = false; 
      });
    }
    updateBoletinLabel();
  });
  const otherBol = container.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
  otherBol.forEach(box => {
    box.addEventListener('change', () => {
      const allChecked = [...otherBol].filter(x=>!x.disabled).every(b => b.checked);
      chkAllBol.checked = allChecked;
      updateBoletinLabel();
    });
  });

  document.getElementById('selectedBoletines').textContent = 'Todas';
}

function updateBoletinLabel() {
  const chkAllBol = document.getElementById('chkAllBoletines');
  const others = document.querySelectorAll('#boletinDropdown input[type="checkbox"]:not(#chkAllBoletines)');
  let selectedCount = 0;
  let singleVal = '';

  others.forEach(cb => {
    if (cb.checked && !cb.disabled) {  // Account for disabled checkboxes
      selectedCount++;
      singleVal = cb.value;
    }
  });

  // Update "Todos" checkbox state
  const activeCheckboxes = [...others].filter(cb => !cb.disabled);
  const allActiveChecked = activeCheckboxes.every(cb => cb.checked);
  chkAllBol.checked = allActiveChecked;

  const boletinSpan = document.getElementById('selectedBoletines');
  if (selectedCount === 0) {
    boletinSpan.textContent = 'Ninguno';
  } else if (allActiveChecked) {
    boletinSpan.textContent = 'Todos';
  } else if (selectedCount === 1) {
    boletinSpan.textContent = singleVal;
  } else {
    boletinSpan.textContent = selectedCount + ' seleccionados';
  }
}


    // --------------------- DROPDOWN for RANGO (server filtering) ---------------------
    function toggleRangoDropdown() {
      document.getElementById('rangoDropdown').classList.toggle('show');
    }
    function populateRangoDropdown() {
  const container = document.getElementById('rangoDropdown');
  if (!container) return;
  container.innerHTML = '';

  // "Todos" => checked
  const lblTodos = document.createElement('label');
  lblTodos.innerHTML = `<input type="checkbox" id="chkAllRango" value="Todos" checked> Todos`;
  container.appendChild(lblTodos);

  // Add each rango as stored (original case)
  userRangos.forEach(rango => {
    const lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" value="${rango}" checked> ${rango}`;
    container.appendChild(lbl);
  });

  const chkAllRango = lblTodos.querySelector('#chkAllRango');
  chkAllRango.addEventListener('change', () => {
    const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
    if (chkAllRango.checked) {
      others.forEach(o => o.checked = true);
    } else {
      others.forEach(o => o.checked = false);
    }
    updateRangoLabel();
  });

  const otherBoxes = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
  otherBoxes.forEach(box => {
    box.addEventListener('change', () => {
      const allChecked = [...otherBoxes].every(b => b.checked);
      chkAllRango.checked = allChecked;
      updateRangoLabel();
    });
  });

  document.getElementById('selectedRango').textContent = 'Todos';
}


    // We'll gather these in handleBuscar to pass as "rango=r1||r2||..."
    function getSelectedRangos() {
      const chkAllRango = document.getElementById('chkAllRango');
      const others = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      if (chkAllRango.checked) {
        // "Todos" => skip param => no filter
        return [];
      }
      let selected = [];
      others.forEach(cb => {
        if (cb.checked) {
          selected.push(cb.value);
        }
      });
      return selected;
    }

    // We also update the label
    function updateRangoLabel() {
      const chkAllRango = document.getElementById('chkAllRango');
      const others = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      let selectedCount = 0;
      let singleVal = '';

      others.forEach(cb => {
        if (cb.checked) {
          selectedCount++;
          singleVal = cb.value;
        }
      });
      // If all are selected => "Todos"
      if (selectedCount === others.length) {
        chkAllRango.checked = true;
      } else {
        chkAllRango.checked = false;
      }

      const rangoSpan = document.getElementById('selectedRango');
      if (selectedCount === 0) {
        rangoSpan.textContent = 'Ninguno';
      } else if (selectedCount === others.length) {
        rangoSpan.textContent = 'Todos';
      } else if (selectedCount === 1) {
        rangoSpan.textContent = singleVal;
      } else {
        rangoSpan.textContent = selectedCount + ' seleccionados';
      }
    }

    document.addEventListener('click', function(e) {
      const isRangoButton = e.target.closest('#btnRango');
      const isRangoDropdown = e.target.closest('#rangoDropdown');
      if (!isRangoButton && !isRangoDropdown) {
        document.getElementById('rangoDropdown').classList.remove('show');
      }
    });

    // "Todos" => check / uncheck
    function toggleAllRango() {
      const chkAll = document.getElementById('chkAllRango');
      const others = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      if (chkAll.checked) {
        others.forEach(o => o.checked = true);
      } else {
        others.forEach(o => o.checked = false);
      }
      updateRangoLabel();
    }

    // --------------------- handleBuscar => calls /data with query params ---------------------
    async function handleBuscar() {
  const parts = [];
      // 1) Gather bulletins
  const containerBol = document.getElementById('boletinDropdown');
  const chkAllBol = containerBol.querySelector('#chkAllBoletines');
  const othersBol = containerBol.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
  let selectedBulletins = [];
  if (!chkAllBol.checked) {
    const checkedBols = [];
    othersBol.forEach(cb => {
      if (cb.checked && !cb.disabled) checkedBols.push(cb.value);
    });
    if (checkedBols.length > 0) {
      selectedBulletins = checkedBols;
    }
  } else {
    // "Todos" - include all available bulletins
    if (userPlan === 'plan1') {
      selectedBulletins = ["BOE"];
    } else {
      selectedBulletins = userBoletines.slice();
    }
  }

  // 2) Industry
  const containerInd = document.getElementById('myDropdown');
  const chkAllIndustry = containerInd.querySelector('#chkAllIndustry');
  const otherInds = containerInd.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
  let selectedIndustries = [];
  if (!chkAllIndustry.checked) {
    const checkedInds = [];
    otherInds.forEach(cb => {
      if (cb.checked) checkedInds.push(cb.value);
    });
    if (checkedInds.length > 0) {
      selectedIndustries = checkedInds;
    }
  } else {
    // "Todas" - include all user industries
    selectedIndustries = userIndustries.slice();
  }

  // 3) Ramas
  const containerRama = document.getElementById('ramaDropdown');
  const chkAllRamas = containerRama.querySelector('#chkAllRamas');
  const otherRamas = containerRama.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
  let selectedRamas = [];
  if (!chkAllRamas.checked) {
    const checkedRamas = [];
    otherRamas.forEach(cb => {
      if (cb.checked) checkedRamas.push(cb.value);
    });
    if (checkedRamas.length > 0) {
      selectedRamas = checkedRamas;
    }
  } else {
    // "Todas" - include all user ramas
    selectedRamas = userRamas.slice();
  }
  
  // subRamas handling
  let selectedSubRamas = {};
if (selectedRamas.length > 0) {
  // For each selected rama, get its selected subramas
  selectedRamas.forEach(rama => {
    const subBoxes = document.querySelectorAll(`.subrama-checkbox[data-rama="${rama}"]`);
    const checkedSubBoxes = Array.from(subBoxes).filter(sb => sb.checked);
    console.log(checkedSubBoxes);
    // If there are checked subramas for this rama
    if (checkedSubBoxes.length > 0) {
      // Add them to the selectedSubRamas object
      selectedSubRamas[rama] = checkedSubBoxes.map(sb => sb.getAttribute('data-subrama'));
    } else if (subBoxes.length > 0) {
      // If no subramas are checked but subramas exist, send an empty array
      selectedSubRamas[rama] = [];
    }
  });
}

// Modify the query building part for subramas
if (Object.keys(selectedSubRamas).length > 0) {
  console.log(selectedSubRamas);
  parts.push(`subRamas=${encodeURIComponent(JSON.stringify(selectedSubRamas))}`);
}

  // 4) Rango
  const containerRango = document.getElementById('rangoDropdown');
  const chkAllRango = containerRango.querySelector('#chkAllRango');
  const rangoBoxes = containerRango.querySelectorAll('input[type="checkbox"]:not(#chkAllRango)');
  let selectedRangos = [];
  if (!chkAllRango.checked) {
    rangoBoxes.forEach(cb => {
      if (cb.checked) selectedRangos.push(cb.value);
    });
  } else {
    // "Todos" - include all user rangos
    selectedRangos = userRangos.slice();
  }

  // 5) date range
  const desde = document.getElementById('startDate').value;
  const hasta = document.getElementById('endDate').value;

  // 6) Build query for /data

  // bulletins => collections[]=...
  if (selectedBulletins.length > 0) {
    selectedBulletins.forEach(b => {
      parts.push(`collections[]=${encodeURIComponent(b)}`);
    });
  }
  
  // Industry - always include, even if "Todas" is selected
  parts.push(`industry=${encodeURIComponent(selectedIndustries.join('||'))}`);
  
  // Ramas - always include, even if "Todas" is selected
  parts.push(`rama=${encodeURIComponent(selectedRamas.join('||'))}`);
  
  // subRamas
  if (selectedSubRamas.length > 0) {
    parts.push(`subRamas=${encodeURIComponent(selectedSubRamas.join(','))}`);
  }
  
  // Rango - always include, even if "Todos" is selected
  parts.push(`rango=${encodeURIComponent(selectedRangos.join('||'))}`);
  
  // date
  if (desde) parts.push(`desde=${encodeURIComponent(desde)}`);
  if (hasta) parts.push(`hasta=${encodeURIComponent(hasta)}`);

  const finalQuery = parts.join('&');
  console.log(finalQuery);
  const url = `/data?${finalQuery}`;

  // Show loaders
  document.getElementById('chartContainer').style.display = 'none';
  document.getElementById('loading-icon-chart').style.display = 'block';
  document.getElementById('loading-icon').style.display = 'block';

  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Network error fetching data');
    const data = await resp.json();
    // Insert HTML
    document.querySelector('.collectionDocs').innerHTML = data.documentsHtml || '';
    // Chart
    if (data.months && data.counts) {
      loadChart(data.months, data.counts);
    } else {
      loadChart([], []);
    }
  } catch(err) {
    console.error('Error searching data:', err);
  } finally {
    document.getElementById('loading-icon').style.display = 'none';
    document.getElementById('loading-icon-chart').style.display = 'none';
    document.getElementById('chartContainer').style.display = 'block';
  }
}
document.addEventListener('DOMContentLoaded', () => {
       populateIndustryDropdown();
       populateRamaDropdown();
       document.addEventListener('click', function(e) {
        // Close subramas dropdowns when clicking outside or on another rama
        if (!e.target.closest('.subramas-dropdown') && 
            !e.target.classList.contains('subramas-toggle') && 
            !e.target.closest('.subramas-toggle')) {
          document.querySelectorAll('.subramas-dropdown.active').forEach(dropdown => {
            dropdown.classList.remove('active');
          });
        }
        
        // Prevent event propagation when clicking on subramas
        if (e.target.closest('.subramas-dropdown') || 
            e.target.classList.contains('subrama-checkbox')) {
          e.stopPropagation();
        }
        
        // Close the main dropdowns when clicking outside
        const isRamaButton = e.target.closest('#btnRamaJuridica');
        const isRamaDropdown = e.target.closest('#ramaDropdown');
        if (!isRamaButton && !isRamaDropdown) {
          document.getElementById('ramaDropdown').classList.remove('show');
        } });
       populateBoletinDropdown();
       populateRangoDropdown(); // Add this line
     });
    // --------------------- CHART LOAD ---------------------
    let myChart;
    function loadChart(months, counts) {
      const ctx = document.getElementById('documentsChart').getContext('2d');
      if (myChart) {
        myChart.destroy();
      }
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Documentos',
            data: counts,
            borderColor: '#04db8d',
                backgroundColor: '#04db8d',
                fill: true,
                tension: 0.1,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // --------------------- ON PAGE LOAD => fill dropdowns ---------------------
    document.addEventListener('DOMContentLoaded', () => {
       populateIndustryDropdown();
       populateRamaDropdown();
      document.addEventListener('click', function(e) {
          // Close subramas dropdowns when clicking outside
          if (!e.target.closest('.rama-label-container') && 
              !e.target.closest('.subramas-dropdown')) {
            document.querySelectorAll('.subramas-dropdown.active').forEach(dropdown => {
              dropdown.classList.remove('active');
            });
          }
          
          // Close the main dropdowns when clicking outside
          const isRamaButton = e.target.closest('#btnRamaJuridica');
          const isRamaDropdown = e.target.closest('#ramaDropdown');
          if (!isRamaButton && !isRamaDropdown) {
            document.getElementById('ramaDropdown').classList.remove('show');
      } })
       populateBoletinDropdown();
       populateRangoDropdown(); // Add this line
     });
  </script>
</body>
</html>
