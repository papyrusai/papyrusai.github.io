# NEWSLETTER.JS - EXPLICACI√ìN SIMPLIFICADA

## 1. ESCENARIOS POSIBLES Y OUTCOMES

### 1.1 Sin logs a las 9:00 AM, con logs a las 10:00 AM

**üïò 9:00 AM - Primer Run (Sin logs)**
- checkWebscrapingRanToday() ‚Üí NO encuentra logs ‚Üí returns false
- Script termina enviando solo warning email a info@reversa.ai
- **OUTCOME**: NO se procesan usuarios, NO se env√≠an newsletters

**üïô 10:00 AM - Segundo Run (Con logs)**
- checkWebscrapingRanToday() ‚Üí S√ç encuentra logs ‚Üí returns true
- getFirstShipmentInfo() ‚Üí NO encuentra first_shipment ‚Üí returns { exists: false }
- **OUTCOME**: Funciona como PRIMER ENV√çO del d√≠a (env√≠o normal completo)

### 1.2 Con logs a las 9:00 AM, sin nuevas colecciones a las 10:00 AM

**üïò 9:00 AM - Primer Run**
- getFirstShipmentInfo() ‚Üí NO encuentra first_shipment ‚Üí returns { exists: false }
- collectionsToProcess = ["BOE", "CNMV"] (todas disponibles)
- isExtraVersion = false
- **OUTCOME**: Env√≠o normal completo a todos los usuarios

**üïô 10:00 AM - Segundo Run**
- getFirstShipmentInfo() ‚Üí S√ç encuentra first_shipment ‚Üí returns { exists: true }
- getNewCollections() ‚Üí [] (sin colecciones nuevas)
- **OUTCOME**: Script termina sin enviar correos (no hay contenido nuevo)

### 1.3 Con logs a las 9:00 AM, con nuevas colecciones a las 10:00 AM

**üïò 9:00 AM - Primer Run**
- getFirstShipmentInfo() ‚Üí NO encuentra first_shipment ‚Üí returns { exists: false }
- collectionsToProcess = ["BOE", "CNMV"] (disponibles en ese momento)
- isExtraVersion = false
- **OUTCOME**: Env√≠o normal con colecciones iniciales

**üïô 10:00 AM - Segundo Run**
- getFirstShipmentInfo() ‚Üí S√ç encuentra first_shipment ‚Üí returns { exists: true }
- getNewCollections() ‚Üí ["BOJA"] (nueva colecci√≥n que apareci√≥)
- collectionsToProcess = ["BOJA"] (solo la nueva)
- isExtraVersion = true
- **OUTCOME**: Env√≠o extra solo con documentos de BOJA

### 1.4 Webscraping intermedio entre runs

**üïò 9:00 AM - Primer Run**
- Env√≠o normal con colecciones ["BOE"]
- logFirstShipment() actualiza log con first_shipment

**üïò 9:30 AM - Webscraping corre**
- Crea NUEVO log con datetime_run 9:30 AM
- Este log NO tiene first_shipment

**üïô 10:00 AM - Segundo Run**
- getFirstShipmentInfo() busca logs con first_shipment (NO el m√°s reciente)
- Encuentra el log del env√≠o de 9:00 AM (aunque hay log m√°s reciente de 9:30)
- **OUTCOME**: Detecta env√≠o previo correctamente, NO hay duplicados

## 2. DETALLE DE FUNCIONES Y LOGS

### 2.1 Funciones Clave

**getFirstShipmentInfo():**
```javascript
// Busca CUALQUIER log del d√≠a que YA tenga first_shipment
const logEntry = await logsCollection.findOne({
  datetime_run: { $gte: startOfDay, $lte: endOfDay },
  "run_info.environment": "production",
  "first_shipment": { $exists: true }  // ‚Üê CLAVE: solo logs con env√≠o previo
}, { sort: { "first_shipment.time_stamp": -1 } });
```

**logFirstShipment():**
```javascript
// Busca el log M√ÅS RECIENTE del d√≠a para agregarle first_shipment
const recentLogEntry = await logsCollection.findOne({
  datetime_run: { $gte: startOfDay, $lte: endOfDay },
  "run_info.environment": "production"
}, { sort: { datetime_run: -1 } });
```

**Extra Version Update:**
```javascript
// Busca el MISMO log que tiene first_shipment (consistente con getFirstShipmentInfo)
const currentLog = await logsCollection.findOne({
  datetime_run: { $gte: startOfDay, $lte: endOfDay },
  "run_info.environment": "production",
  "first_shipment": { $exists: true }  // ‚Üê MISMO CRITERIO
}, { sort: { "first_shipment.time_stamp": -1 } });
```

### 2.2 Estructura de Logs

**Log despu√©s del primer env√≠o:**
```json
{
  "_id": "...",
  "datetime_run": "2024-01-15T08:00:00.000Z",
  "etl_detailed_stats": { ... },
  "first_shipment": {
    "time_stamp": "2024-01-15T09:00:00.000Z",
    "collections": ["BOE", "CNMV", "DOG"]
  }
}
```

**Log despu√©s del segundo env√≠o (extra):**
```json
{
  "_id": "...",
  "datetime_run": "2024-01-15T08:00:00.000Z",
  "etl_detailed_stats": { ... },
  "first_shipment": {
    "time_stamp": "2024-01-15T09:00:00.000Z",
    "collections": ["BOE", "CNMV", "DOG", "BOJA"],
    "last_update": "2024-01-15T10:00:00.000Z"
  }
}
```

### 2.3 Variables de Control

- **collectionsToProcess**: Colecciones que se van a procesar en este run
- **isExtraVersion**: Boolean que determina si es env√≠o extra (afecta template del email)
- **firstShipmentInfo.exists**: Boolean que indica si ya hubo un env√≠o previo
- **availableCollections**: Todas las colecciones con documentos del d√≠a
