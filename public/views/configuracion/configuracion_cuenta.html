<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuraci√≥n de Cuenta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* Configuration specific styles with higher specificity */
    #configuracion-iframe-container {
      --primary-color: #04db8d;
      --text-color: #455862;
      --dark-color: #0b2431;
    }

    #configuracion-iframe-container .config-body {
      margin: 0;
      padding: 20px;
      font-family: 'Satoshi', sans-serif;
    }
    
    #configuracion-iframe-container .config-menu {
      display: flex !important;
      justify-content: center;
      align-items: center;
      gap: 40px;
      padding-bottom: 20px;
      flex-direction: row !important;
    }
    
    #configuracion-iframe-container .config-menu-item {
      display: flex !important;
      align-items: center;
      gap: 8px;
      color: var(--text-color);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: color 0.3s ease;
      user-select: none;
      text-decoration: none;
    }
    
    #configuracion-iframe-container .config-menu-item:hover {
      color: var(--dark-color);
    }
    
    #configuracion-iframe-container .config-menu-item.active {
      color: var(--primary-color) !important;
      border-bottom: 2px solid var(--primary-color) !important;
      padding-bottom: 8px !important;
    }
    
    #configuracion-iframe-container .config-menu-item i {
      font-size: 18px;
    }
    
    #configuracion-iframe-container .config-content {
      display: none !important;
      padding: 40px;
      background: white;
      border-radius: 8px;
      text-align: center;
      min-height: 300px;
      justify-content: center;
      flex-direction: column;
    }
    
    #configuracion-iframe-container .config-content.active {
      display: flex !important;
    }
    
    #configuracion-iframe-container .content-text {
      font-size: 24px;
      color: var(--text-color);
      font-weight: 500;
    }

    #configuracion-iframe-container .content-title {
      font-size: 20px;
      color: var(--dark-color);
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
      line-height: 1.4;
    }

    /* ---------- Onboarding form styles (scoped) ---------- */
    #configuracion-iframe-container #onboarding-container {
      width: 100%;
      max-width: 660px;
    }
    #configuracion-iframe-container #summary-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 30px;
    }
    #configuracion-iframe-container .summary-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--primary-color);
      color: #fff;
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      cursor: pointer;
    }
    #configuracion-iframe-container .summary-tag .tick { font-weight: 700; }
    #configuracion-iframe-container .form-step { display:none; }
    #configuracion-iframe-container .form-step.active { display:block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    #configuracion-iframe-container .step-header { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:16px; }
    #configuracion-iframe-container .question-text { font-size:20px; font-weight:700; }
    #configuracion-iframe-container .step-tracker { font-size:14px; color: var(--secondary-color); }
    #configuracion-iframe-container .options { display:flex; flex-wrap:wrap; gap:12px; }
    #configuracion-iframe-container .option-box {
      flex: 1 1 calc(50% - 12px);
      background: transparent;
      border: 2px solid var(--border-color, #e0e0e0);
      border-radius: 12px;
      padding: 14px 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-color);
      min-width: 120px;
    }
    #configuracion-iframe-container .option-box:hover { border-color: var(--primary-color); background: rgba(4,219,141,0.08); }
    #configuracion-iframe-container .option-box.selected { background: var(--primary-color); border-color: var(--primary-color); color:#fff; }
    #configuracion-iframe-container #completion-message { text-align:center; font-size:22px; font-weight:600; }



    /* ---------- NEW STYLES ---------- */
    #configuracion-iframe-container .main-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--dark-color), var(--primary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: left;
    }
    #configuracion-iframe-container .main-title i {
      font-size: 26px;
      color: var(--text-color);
    }
    /* Content title consistent styling */
    #configuracion-iframe-container .content-title {
      font-size: 16px;
      color: #7a8a93;
      margin-bottom: 24px;
      text-align: left;
    }
    /* Reduce top padding so title sits closer to the menu */
    #configuracion-iframe-container .config-content {
      padding-top: 30px;
    }
    /* Option box elevation style */
    #configuracion-iframe-container .option-box {
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    #configuracion-iframe-container .option-box:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    #configuracion-iframe-container .option-box.selected {
      border: 1px solid var(--text-color);
      box-shadow: 0 4px 12px rgba(69,88,98,0.4);
      color: var(--text-color) !important;
      background:none;
    }

    /* Generic input style for onboarding */
    #configuracion-iframe-container .input-field {
      width: 100%;
      max-width: 420px;
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: border-color 0.2s ease;
    }
    #configuracion-iframe-container .input-field:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(4,219,141,0.15);
    }

    #configuracion-iframe-container .save-btn {
      margin-top: 18px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    #configuracion-iframe-container .save-btn:hover {
      background:#03c77d;
    }

    /* Web empresa button with gradient style */
    #configuracion-iframe-container .web-empresa-btn {
      background: linear-gradient(90deg, var(--dark-color), var(--primary-color)) !important;
      color: white !important;
      border: none !important;
      border-radius: 10px !important;
      padding: 12px 24px !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      cursor: pointer;
      transition: all 0.3s ease !important;
      margin: 20px auto 0 auto !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(69,88,98,0.3) !important;
      width: fit-content;
    }
    #configuracion-iframe-container .web-empresa-btn:hover {
      background: linear-gradient(90deg, var(--dark-color), var(--primary-color)) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 16px rgba(69,88,98,0.4) !important;
    }

    /* Custom input container when user selects 'Otro' */
    #configuracion-iframe-container .custom-input-container{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      margin-top:24px;
    }
    #configuracion-iframe-container .next-btn{
      background:var(--dark-color);
      color:#fff;
      border:none;
      padding:10px 40px;
      border-radius:8px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      transition:background .25s ease;
    }
    #configuracion-iframe-container .next-btn:hover{background:#03c77d;}

    /* Custom tags inside custom input */
    #configuracion-iframe-container .custom-tags-wrap{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      width:100%;
    }
    #configuracion-iframe-container .custom-tag{
      background:#e5e5e5;
      color:var(--dark-color);
      border-radius:14px;
      padding:4px 10px;
      font-size:13px;
      display:flex;
      align-items:center;
    }
    #configuracion-iframe-container .custom-tag .remove-tag{
      margin-left:6px;
      cursor:pointer;
      font-weight:700;
      line-height:1;
    }

    /* Loader overlay */
    #configuracion-iframe-container #config-loader{
      position:absolute;
      inset:0;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    #configuracion-iframe-container .spinner{
      width:40px;
      height:40px;
      border:4px solid #f3f3f3;
      border-top:4px solid var(--primary-color);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{transform:rotate(360deg);} }

    /* Styles for the final summary view */
    #configuracion-iframe-container #profile-summary-view {
      animation: fadeIn 0.5s ease-in-out;
    }
    #configuracion-iframe-container .summary-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark-color);
      margin-top: 30px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    #configuracion-iframe-container .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #configuracion-iframe-container .summary-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 15px;
      color: var(--text-color);
    }
    #configuracion-iframe-container .summary-table td:first-child {
      font-weight: 500;
      width: 30%;
      color: var(--dark-color);
    }
    #configuracion-iframe-container .regulatory-summary {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-color);
    }
    #configuracion-iframe-container .regulatory-summary p {
      margin-bottom: 1em;
      font-weight: normal !important;
      text-align: left !important;
    }
    /* Animation for transition */
    @keyframes slideUpAndFadeOut {
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
    #configuracion-iframe-container .fading-out {
      animation: slideUpAndFadeOut 0.4s forwards;
    }

    /* --- Fuentes Section Carousel --- */
    #configuracion-iframe-container .fuentes-subsection {
        margin-top: 20px;
    }
    #configuracion-iframe-container .fuentes-subsection-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 8px;
    }
    #configuracion-iframe-container .fuentes-grid-container {
        position: relative;
        padding: 0 40px; /* space for arrows */
        min-height: 120px; /* to avoid layout shifts */
    }
    #configuracion-iframe-container .grid-nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: #f0f0f0;
        color: var(--text-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
        user-select: none;
    }
    #configuracion-iframe-container .grid-nav-arrow:hover {
        background: #e0e0e0;
        transform: translateY(-50%) scale(1.1);
    }
    #configuracion-iframe-container .grid-nav-arrow.prev {
        left: 0;
    }
    #configuracion-iframe-container .grid-nav-arrow.next {
        right: 0;
    }
    #configuracion-iframe-container .grid-nav-arrow i {
      font-size: 14px;
    }

    /* --- Fuentes Section Styles --- */
    #configuracion-iframe-container .configura-cobertura-btn {
        display: none; /* Hidden by default */
        background: #e8f5e8;
        color: var(--dark-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 14px 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 20px 0;
        width: 100%;
        text-align: left;
    }
    #configuracion-iframe-container .configura-cobertura-btn:hover {
        background: #d8f0d8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #configuracion-iframe-container .configura-agentes-btn {
        display: none; /* Hidden by default */
        background: #e8f5e8;
        color: var(--dark-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 14px 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 20px 0;
        width: 100%;
        text-align: left;
    }
    #configuracion-iframe-container .configura-agentes-btn:hover {
        background: #d8f0d8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #configuracion-iframe-container .fuentes-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 10px;
        margin-bottom: 30px;
    }
    #configuracion-iframe-container .fuente-box {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s ease;
        max-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-start;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    #configuracion-iframe-container .fuente-box:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #configuracion-iframe-container .fuente-box.selected {
        background: rgba(4, 219, 141, 0.2);
        border-color:rgba(4, 219, 141, 0.2);
        color: var(--primary-color);
    }
    #configuracion-iframe-container .fuente-box strong {
        font-size: 16px;
        margin-bottom: 5px;
        padding-bottom: 3px;
        border-bottom: 1px solid #e0e0e0;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #configuracion-iframe-container .fuente-box span {
        font-size: 12px;
        color: #7a8a93;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        flex: 1;
    }
    #configuracion-iframe-container .fuente-box.selected span {
        color: var(--primary-color);
    }
    #configuracion-iframe-container .fuente-box.selected strong {
        border-bottom-color: rgba(4, 219, 141, 0.1);
    }
         #configuracion-iframe-container .save-fuentes-btn-inline {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: auto;
    }
     #configuracion-iframe-container .save-fuentes-btn-inline:hover {
        background: #03c77d;
     }
     #configuracion-iframe-container .save-fuentes-btn-inline.success {
        background: #28a745;
     }
     #configuracion-iframe-container .save-fuentes-btn-inline.loading {
        background: #6c757d;
        cursor: not-allowed;
     }
     #configuracion-iframe-container .button-spinner {
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
     }
     #configuracion-iframe-container .save-status {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 5px;
        font-size: 12px;
        color: #dc3545;
        font-weight: 500;
     }
     
           /* Selected tags styles */
      #configuracion-iframe-container .section-header {
         display: flex;
         align-items: center;
         gap: 15px;
         margin-bottom: 15px;
         flex-wrap: wrap;
         position: relative;
      }
     #configuracion-iframe-container .selected-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
     }
           #configuracion-iframe-container .selected-tag {
         background: var(--primary-color);
         color: white;
         padding: 4px 8px;
         border-radius: 12px;
         font-size: 11px;
         font-weight: 500;
      }
      
      /* Crear agente button styles */
      #configuracion-iframe-container .crear-agente-btn {
         background: linear-gradient(90deg, var(--dark-color), var(--primary-color));
         color: white;
         border: none;
         border-radius: 10px;
         padding: 10px 18px;
         font-size: 14px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         margin-bottom: 20px;
         display: flex;
         align-items: center;
         gap: 6px;
         box-shadow: 0 4px 12px rgba(69,88,98,0.3);
         width: fit-content;
      }
      #configuracion-iframe-container .crear-agente-btn:hover {
         transform: translateY(-2px);
         box-shadow: 0 6px 16px rgba(69,88,98,0.4);
      }
             #configuracion-iframe-container .crear-agente-btn i {
          font-size: 12px;
       }

       /* Agent template selection box */
       #configuracion-iframe-container .agent-template-box {
          width: 100%;
          background: white;
          border-radius: 12px;
          padding: 25px;
          margin-top: 30px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.12);
          animation: fadeInUp 0.3s ease-out;
          position: relative;
       }

       #configuracion-iframe-container .close-template-box {
          position: absolute;
          top: 15px;
          right: 15px;
          background: transparent;
          border: none;
          color: #999;
          font-size: 16px;
          cursor: pointer;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: all 0.2s ease;
       }

       #configuracion-iframe-container .close-template-box:hover {
          background: #f5f5f5;
          color: var(--dark-color);
       }

               #configuracion-iframe-container .template-title {
           font-size: 16px;
           font-weight: 600;
           color: var(--dark-color);
           margin-bottom: 20px;
           text-align: center;
           line-height: 1.4;
           padding-right: 40px;
        }

        /* Override text alignment for product details form */
        #configuracion-iframe-container .product-details-form .template-title {
           text-align: left;
        }

       #configuracion-iframe-container .template-options {
          display: flex;
          flex-direction: column;
          gap: 12px;
       }

       #configuracion-iframe-container .template-btn {
          width: 100%;
          background: transparent;
          border: 2px solid var(--text-color);
          border-radius: 10px;
          padding: 16px 18px;
          color: var(--text-color);
          cursor: pointer;
          transition: all 0.3s ease;
          text-align: left;
       }

       #configuracion-iframe-container .template-btn:hover {
          border-color: var(--primary-color);
          color: var(--primary-color);
          transform: translateY(-1px);
          box-shadow: 0 3px 8px rgba(4,219,141,0.2);
       }

       #configuracion-iframe-container .template-btn-content {
          width: 100%;
       }

       #configuracion-iframe-container .template-btn-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 8px;
       }

       #configuracion-iframe-container .template-btn-header i {
          font-size: 16px;
          width: 20px;
          text-align: center;
       }

       #configuracion-iframe-container .template-btn-title {
          font-size: 14px;
          font-weight: 600;
       }

       #configuracion-iframe-container .template-btn-description {
          font-size: 12px;
          color: #7a8a93;
          line-height: 1.4;
          margin: 0;
          text-align: left;
       }

       #configuracion-iframe-container .template-btn-description em {
          font-style: italic;
          color: #999;
       }

       #configuracion-iframe-container .template-btn:hover .template-btn-description {
          color: #7a8a93;
       }

               @keyframes fadeInUp {
           from {
               opacity: 0;
               transform: translateY(20px);
           }
           to {
               opacity: 1;
               transform: translateY(0);
           }
        }

        /* Product details form styles */
        #configuracion-iframe-container .product-details-form {
           width: 100%;
           background: white;
           border-radius: 12px;
           padding: 25px;
           margin-top: 30px;
           box-shadow: 0 8px 24px rgba(0,0,0,0.12);
           animation: fadeInUp 0.3s ease-out;
           position: relative;
        }

        #configuracion-iframe-container .product-form-fields {
           margin-bottom: 30px;
        }

        #configuracion-iframe-container .form-field {
           margin-bottom: 20px;
        }

        #configuracion-iframe-container .field-label {
           display: block;
           font-size: 14px;
           font-weight: 700;
           color: var(--dark-color);
           margin-bottom: 8px;
           line-height: 1.4;
           text-align: left;
        }

        #configuracion-iframe-container .field-label-with-info {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        #configuracion-iframe-container .info-icon {
           width: 16px;
           height: 16px;
           border-radius: 50%;
           background: rgba(11,36,49,0.9);
           color: white;
           display: inline-flex;
           align-items: center;
           justify-content: center;
           font-size: 10px;
           font-weight: 600;
           cursor: pointer;
           position: relative;
           transition: all 0.2s ease;
           margin-bottom: 5px;
         }
        #configuracion-iframe-container .info-icon:hover::after {
           content: attr(data-tooltip);
           position: absolute;
           bottom: 120%;
           left: 0;
           background: var(--dark-color);
           color: white;
           padding: 8px 12px;
           border-radius: 6px;
           font-size: 12px;
           line-height: 1.4;
           white-space: normal;
           z-index: 1000;
           box-shadow: 0 4px 12px rgba(0,0,0,0.2);
           width: 300px;
           min-height: 100px;
         }
        #configuracion-iframe-container .info-icon:hover::before {
          content: '';
          position: absolute;
          bottom: 110%;
          left: 8px;
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid var(--dark-color);
        }

        #configuracion-iframe-container .product-input,
         #configuracion-iframe-container .product-select {
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            color: var(--text-color);
            transition: border-color 0.3s ease;
            background: white;
            resize: vertical;
         }

        #configuracion-iframe-container .product-input:focus,
        #configuracion-iframe-container .product-select:focus {
           border-color: var(--primary-color);
           outline: none;
           box-shadow: 0 0 0 2px rgba(4,219,141,0.15);
        }

        #configuracion-iframe-container .product-input::placeholder {
           color: #999;
           font-style: normal;
        }

        #configuracion-iframe-container .product-select {
           cursor: pointer;
        }

        #configuracion-iframe-container .generate-agent-container {
           display: flex;
           justify-content: center;
           margin-top: 30px;
        }

        #configuracion-iframe-container .generate-agent-btn {
           background: linear-gradient(90deg, var(--dark-color), var(--primary-color));
           color: white;
           border: none;
           border-radius: 12px;
           padding: 16px 32px;
           font-size: 16px;
           font-weight: 600;
           cursor: pointer;
           transition: all 0.3s ease;
           display: flex;
           align-items: center;
           gap: 10px;
           box-shadow: 0 4px 12px rgba(69,88,98,0.3);
        }

        #configuracion-iframe-container .generate-agent-btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 16px rgba(69,88,98,0.4);
        }

                #configuracion-iframe-container .generate-agent-btn i {
            font-size: 16px;
         }

         #configuracion-iframe-container .custom-input-container {
            margin-top: 10px;
            animation: fadeIn 0.3s ease-out;
         }

         @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
         }

         /* Generated agent display styles */
         #configuracion-iframe-container .generated-agent-box {
            background: white;
            border: 1px solid var(--dark-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 12px rgba(4,219,141,0.15);
            animation: fadeInUp 0.4s ease-out;
            text-align: left;
         }

         #configuracion-iframe-container .generated-agent-content {
            padding-right: 35px;
            text-align: left;
         }

         #configuracion-iframe-container .agent-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-color);
            margin: 0 0 8px 0;
            line-height: 1.3;
            text-align: left;
         }

         #configuracion-iframe-container .agent-definition {
            font-size: 13px;
            color: var(--text-color);
            line-height: 1.4;
            margin: 0;
            text-align: left;
         }

         #configuracion-iframe-container .close-agent-box {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: #495057;
            font-size: 12px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
         }

         #configuracion-iframe-container .close-agent-box:hover {
            background: #f5f5f5;
            color: #c82333;
            transform: scale(1.1);
         }

         /* Agent editing styles */
         #configuracion-iframe-container .agent-edit-controls {
            position: absolute;
            top: 15px;
            right: 45px;
            display: flex;
            align-items: center;
            gap: 8px;
         }

         #configuracion-iframe-container .edit-agent-btn,
         #configuracion-iframe-container .save-agent-btn,
         #configuracion-iframe-container .cancel-agent-btn {
            background: transparent;
            border: none;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
         }

         #configuracion-iframe-container .edit-agent-btn:hover,
         #configuracion-iframe-container .save-agent-btn:hover,
         #configuracion-iframe-container .cancel-agent-btn:hover {
            background: #f5f5f5;
         }

         #configuracion-iframe-container .save-agent-btn {
            color: var(--primary-color);
         }

         #configuracion-iframe-container .save-agent-btn:disabled {
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
         }

         #configuracion-iframe-container .cancel-agent-btn {
            color: #dc3545;
         }

         #configuracion-iframe-container .agent-name-edit,
         #configuracion-iframe-container .agent-definition-edit {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 8px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
         }

         #configuracion-iframe-container .agent-name-edit {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
         }

         #configuracion-iframe-container .agent-definition-edit {
            font-size: 13px;
            min-height: 60px;
         }

         /* Ensure the generated agent box maintains width during editing */
         #configuracion-iframe-container .generated-agent-box {
            min-width: 400px;
            width: 100%;
            max-width: 800px;
            transition: min-height 0.5s ease, padding 0.5s ease, margin-bottom 0.5s ease;
         }

         #configuracion-iframe-container .generated-agent-content {
            width: 100%;
            box-sizing: border-box;
         }

         /* Expanded state for editing */
         #configuracion-iframe-container .generated-agent-box.editing {
            min-height: 200px;
            padding-bottom: 25px;
            margin-bottom: 25px;
         }

         #configuracion-iframe-container .generated-agent-box.editing .generated-agent-content {
            padding-top: 30px;
         }

         #configuracion-iframe-container .generated-agent-box.editing .agent-definition-edit {
            min-height: 120px;
         }

         /* Character counter styles */
         #configuracion-iframe-container .character-counter-container {
            position: relative;
            margin-top: 8px;
         }

         #configuracion-iframe-container .character-counter {
            font-size: 12px;
            color: #7a8a93;
            text-align: left;
            transition: color 0.3s ease;
         }

         #configuracion-iframe-container .character-counter.over-limit {
            color: #dc3545;
            font-weight: 600;
         }

         #configuracion-iframe-container .character-error-message {
            color: #dc3545;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
         }

         /* Edit context styles */
         #configuracion-iframe-container .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
         }

         #configuracion-iframe-container .edit-context-btn {
            background: transparent;
            border: none;
            color: var(--dark-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
         }

         #configuracion-iframe-container .edit-context-btn:hover {
            background: rgba(69,88,98,0.1);
         }

         #configuracion-iframe-container .edit-context-controls {
            display: flex;
            gap: 10px;
         }

         #configuracion-iframe-container .cancel-edit-btn {
            background: transparent;
            border: 1px solid var(--dark-color);
            color: var(--dark-color);
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
         }

         #configuracion-iframe-container .cancel-edit-btn:hover {
            background: rgba(69,88,98,0.1);
         }

         #configuracion-iframe-container .save-edit-btn {
            background: var(--dark-color);
            border: none;
            color: white;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
         }

         #configuracion-iframe-container .save-edit-btn:hover {
            background: #0a1f2a;
         }

         #configuracion-iframe-container .save-edit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
         }

         /* Editable table styles */
         #configuracion-iframe-container .summary-table.editing td:nth-child(2) {
            padding: 4px;
         }

         #configuracion-iframe-container .summary-table.editing .editable-field {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 15px;
            color: var(--text-color);
            font-family: inherit;
         }

         #configuracion-iframe-container .summary-table.editing .editable-field:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(4,219,141,0.15);
         }

         /* Editable profile styles */
         #configuracion-iframe-container .regulatory-summary.editing {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
         }

         #configuracion-iframe-container .regulatory-summary.editing .editable-profile {
            width: 100%;
            border: none;
            outline: none;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-color);
            font-family: inherit;
            resize: vertical;
            height: 600px;
         }

         #configuracion-iframe-container .regulatory-summary.editing .editable-profile:focus {
            box-shadow: none;
         }

    /* --- Align contexto & agentes content same as fuentes --- */
    #configuracion-iframe-container #contexto-content,
    #configuracion-iframe-container #agentes-content {
      align-items: flex-start !important;
      text-align: left !important;
      width: 100% !important;
      max-width: 900px !important;
      margin: 0 auto !important;
    }

    /* Usage tracker styles */
    #configuracion-iframe-container .usage-tracker {
      margin-left: auto;
      font-size: 14px;
      color: var(--text-color);
      font-weight: 500;
      padding: 6px 12px;
      background: rgba(69, 88, 98, 0.1);
      border-radius: 20px;
      white-space: nowrap;
    }

    #configuracion-iframe-container .usage-tracker.unlimited {
      color: white;
      font-weight: 600;
    }

    #configuracion-iframe-container .usage-tracker.at-limit {
   
      color: #c62828;
     
    }

   /* #configuracion-iframe-container .usage-tracker.near-limit {
      background: #fff3e0;
      color: #ef6c00;
      border: 1px solid #ff9800;
    } */

    /* ‚úÖ ESTILOS COMPLETOS PARA WARNING ICON DE EXTRACCI√ìN WEB */
    #configuracion-iframe-container .web-warning-icon {
      color: #ff9800 !important; /* ‚úÖ Color naranja visible */
      margin-left: 8px;
      font-size: 16px !important; /* ‚úÖ Tama√±o visible */
      cursor: pointer;
      transition: color 0.2s ease;
      position: relative;
      display: inline-block !important; /* ‚úÖ Asegurar que sea visible */
      opacity: 1 !important; /* ‚úÖ Totalmente opaco */
      visibility: visible !important; /* ‚úÖ Totalmente visible */
    }
    
    #configuracion-iframe-container .web-warning-icon:hover {
      color: #f57c00 !important; /* ‚úÖ Color hover m√°s oscuro */
    }
    
    /* ‚úÖ CREAR TOOLTIP PERSONALIZADO SIN USAR ATTR(TITLE) */
    #configuracion-iframe-container .web-warning-icon::after {
      content: "No se pudo acceder a la p√°gina web, por favor, revisa el URL compartido y prueba de nuevo";
      position: absolute;
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      white-space: normal;
      word-wrap: break-word;
      z-index: 1000;
      left: calc(100% + 40px);
      top: 50%;
      transform: translateY(-50%);
      width: 240px;
      min-height: 80px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      line-height: 1.4;
      pointer-events: none;
      display: flex;
      align-items: center;
      text-align: left;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    
    /* ‚úÖ MOSTRAR TOOLTIP AL HOVER */
    #configuracion-iframe-container .web-warning-icon:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* Scoped styles for Agents UI */
    #configuracion-iframe-container .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      width: 100%;
      margin: 12px 0 24px 0;
    }
    #configuracion-iframe-container .agent-box {
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    #configuracion-iframe-container .agent-box:hover {
      transform: translateY(-2px);
      border-color: var(--primary-color);
      box-shadow: 0 6px 14px rgba(4,219,141,0.18);
    }
    #configuracion-iframe-container .agent-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    #configuracion-iframe-container .agent-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--dark-color);
      font-weight: 700;
      max-width: 75%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #configuracion-iframe-container .agent-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 14px;
      background: rgba(69,88,98,0.1);
      color: var(--text-color);
      font-size: 12px;
      font-weight: 600;
    }
    #configuracion-iframe-container .agent-status i { color: #18b27d; font-size: 10px; }
    #configuracion-iframe-container .agent-objective {
      color: var(--text-color);
      font-size: 13px;
      margin: 0;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 58px;
    }

    /* Overlay & modal */
    #configuracion-iframe-container .agent-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(11,36,49,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    #configuracion-iframe-container .agent-modal {
      width: min(920px, 94%);
      max-height: calc(100vh - 120px);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
      overflow: hidden;
      animation: fadeInUp 0.25s ease-out;
      display: flex;
      flex-direction: column;
    }
    #configuracion-iframe-container .agent-modal.small { width: min(520px, 92%); }
    #configuracion-iframe-container .agent-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    #configuracion-iframe-container #agentModalTitle {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 0;
    }
    #configuracion-iframe-container #agentModalTitle #agentTitleText {
      background: linear-gradient(90deg, var(--dark-color), var(--primary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 20px;
      font-weight: 700;
      margin-left: 4px;
    }
    #configuracion-iframe-container .edit-name-btn {
      background: rgba(69,88,98,0.1);
      border: none;
      color: var(--dark-color);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #configuracion-iframe-container .edit-name-btn:hover {
      background: rgba(69,88,98,0.15);
    }
    #configuracion-iframe-container .agent-modal .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: var(--dark-color);
    }
    #configuracion-iframe-container .agent-modal .close-modal {
      background: transparent;
      border: none;
      color: #999;
      font-size: 16px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    #configuracion-iframe-container .agent-modal .close-modal:hover {
      background: #f5f5f5;
      color: var(--dark-color);
    }
    #configuracion-iframe-container .agent-detail-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
    }
    #configuracion-iframe-container #saveAgentChangesBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #configuracion-iframe-container .agent-detail-actions .generate-agent-btn,
    #configuracion-iframe-container .agent-detail-actions .cancel-edit-btn,
    #configuracion-iframe-container .agent-detail-actions .crear-agente-btn {
      border-radius: 20px !important;
    }
    #configuracion-iframe-container #saveAgentChangesBtn {
      background: #0b2431 !important;
      color: white !important;
    }
    #configuracion-iframe-container #saveAgentChangesBtn:hover {
      background: #081a24 !important;
    }
    #configuracion-iframe-container #saveAgentChangesBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #configuracion-iframe-container .agent-skeleton {
      background: #f3f5f6;
      border-radius: 12px;
      height: 120px;
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
  </style>
</head>
<body>
  <div class="config-body" style="position:relative;">
    <div id="config-loader" class="loader-overlay"><div class="spinner"></div></div>
    <div class="config-body">
      <div class="config-menu">
        <div class="config-menu-item active" data-content="contexto">
          <i class="fas fa-info-circle"></i>
          <span>Contexto</span>
        </div>
        <div class="config-menu-item" data-content="fuentes">
          <i class="fas fa-database"></i>
          <span>Fuentes</span>
        </div>
        <div class="config-menu-item" data-content="agentes">
          <i class="fas fa-users"></i>
          <span>Agentes</span>
        </div>
      </div>
      
      <div id="contexto-content" class="config-content active">
        <div class="main-title"><i class="fas fa-search"></i><span>Proporciona contexto</span></div>
        <div class="content-title">Proporciona informaci√≥n sobre tu empresa y necesidades para personalizar tu experiencia</div>

        <!-- Onboarding form -->
        <div id="onboarding-container">
          <div id="summary-tags"></div>
          <div id="onboarding-form">
            <!-- Step 1 -->
            <section class="form-step" data-step="0">
              <div class="step-header">
                <p class="question-text">¬øQu√© tipo de empresa se ajusta a tu perfil?</p>
                <span class="step-tracker"></span>
              </div>
              <div class="options">
                <div class="option-box" data-value="Consultora">Consultora</div>
                <div class="option-box" data-value="Despacho">Despacho</div>
                <div class="option-box" data-value="Empresa Regulada">Empresa Regulada</div>
                <div class="option-box" data-value="Otros">Otros</div>
              </div>
            </section>
            <!-- Step 2 -->
            <section class="form-step" data-step="1">
              <div class="step-header">
                <p class="question-text">¬øCu√°l es tu especializaci√≥n?</p>
                <span class="step-tracker"></span>
              </div>
              <div class="options">
                <div class="option-box" data-value="Energ√≠a">Energ√≠a</div>
                <div class="option-box" data-value="Construcci√≥n">Construcci√≥n</div>
                <div class="option-box" data-value="Agr√≠cola">Agr√≠cola</div>
                <div class="option-box" data-value="Financiero">Financiero</div>
              </div>
            </section>
          </div>
          <div id="completion-message" style="display:none;"></div>
        </div>
        <!-- End onboarding form -->
        
        <!-- Final Profile View (hidden by default) -->
        <div id="profile-summary-view" style="display: none; width: 100%; max-width: 800px; text-align: left;">
            <button id="configuraCoberturaBtn" class="configura-cobertura-btn">
                Configura tu cobertura legal <i class="fas fa-arrow-right" style="float: right;"></i>
            </button>
            <div class="context-header">
                <h3 class="summary-title">Informaci√≥n de empresa</h3>
                <button id="editContextBtn" class="edit-context-btn">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <div id="editContextControls" class="edit-context-controls" style="display: none;">
                    <button id="cancelEditBtn" class="cancel-edit-btn">Cancelar</button>
                    <button id="saveEditBtn" class="save-edit-btn">Guardar</button>
                </div>
            </div>
            <table class="summary-table" id="contextTable">
                <tbody>
                    <!-- Rows will be injected by JS -->
                </tbody>
            </table>
            <h3 class="summary-title">Resumen perfil regulatorio</h3>
            <div id="regulatory-profile-content" class="regulatory-summary">
                <!-- Content will be injected by JS -->
            </div>
        </div>
      </div>
      
      <div id="fuentes-content" class="config-content" style="display: none; flex-direction: column; align-items: flex-start; text-align: left; width: 100%; max-width: 900px; margin: 0 auto !important;">
          <div class="main-title">
            <i class="fas fa-database"></i><span>Selecciona tus fuentes oficiales</span>
            <div id="fuentes-usage-tracker" class="usage-tracker"></div>
          </div>
          <div class="content-title">Configura tu cobertura legal seleccionando las fuentes de tu inter√©s</div>

          <!-- Banner for users without custom agents -->
          <button id="configuraAgentesBtn" class="configura-agentes-btn" style="display: none;">
              Configura tus agentes regulatorios <i class="fas fa-arrow-right" style="float: right;"></i>
          </button>

          <div id="fuentes-container" style="width: 100%;">
              <!-- Sections will be injected here -->
          </div>
          

      </div>
      
      <div id="agentes-content" class="config-content">
        <div class="main-title">
          <i class="fas fa-users"></i><span>Configura tus agentes</span>
          <div id="agentes-usage-tracker" class="usage-tracker"></div>
        </div>
        <div class="content-title">Crea tus agentes personalizados que autom√°ticamente analizar√°n toda la normativa por ti</div>
        
        <!-- Scoped styles for Agents UI -->
        <style>
          #configuracion-iframe-container .agents-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
             gap: 20px;
             width: 100%;
             margin: 12px 0 24px 0;
           }
           #configuracion-iframe-container .agent-box {
             background: #fff;
             border: 2px solid #e0e0e0;
             border-radius: 14px;
             padding: 18px;
             cursor: pointer;
             transition: all 0.2s ease;
             box-shadow: 0 3px 10px rgba(0,0,0,0.08);
           }
          #configuracion-iframe-container .agent-box:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            box-shadow: 0 6px 14px rgba(4,219,141,0.18);
          }
          #configuracion-iframe-container .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
          }
          #configuracion-iframe-container .agent-header h3 {
            margin: 0;
            font-size: 16px;
            color: var(--dark-color);
            font-weight: 700;
            max-width: 75%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }
          #configuracion-iframe-container .agent-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 14px;
            background: rgba(69,88,98,0.1);
            color: var(--text-color);
            font-size: 12px;
            font-weight: 600;
          }
          #configuracion-iframe-container .agent-status i { color: #18b27d; font-size: 10px; }
          #configuracion-iframe-container .agent-objective {
            color: var(--text-color);
            font-size: 13px;
            margin: 0;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 58px;
          }

          /* Overlay & modal */
          #configuracion-iframe-container .agent-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(11,36,49,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
          }
                    #configuracion-iframe-container .agent-modal {
             width: min(920px, 94%);
             max-height: calc(100vh - 120px);
             background: #fff;
             border-radius: 14px;
             box-shadow: 0 16px 40px rgba(0,0,0,0.25);
             overflow: hidden;
             animation: fadeInUp 0.25s ease-out;
             display: flex;
             flex-direction: column;
           }
          #configuracion-iframe-container .agent-modal.small { width: min(520px, 92%); }
                     #configuracion-iframe-container .agent-modal .modal-header {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 10px 12px;
             border-bottom: 1px solid #f0f0f0;
           }
           #configuracion-iframe-container #agentModalTitle {
             display: flex;
             align-items: center;
             gap: 16px;
             margin: 0;
           }
           #configuracion-iframe-container #agentModalTitle #agentTitleText {
             background: linear-gradient(90deg, var(--dark-color), var(--primary-color));
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             font-size: 20px;
             font-weight: 700;
             margin-left: 4px;
           }
           #configuracion-iframe-container .edit-name-btn {
             background: rgba(69,88,98,0.1);
             border: none;
             color: var(--dark-color);
             width: 28px;
             height: 28px;
             border-radius: 50%;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             transition: all 0.2s ease;
           }
           #configuracion-iframe-container .edit-name-btn:hover {
             background: rgba(69,88,98,0.15);
           }
          #configuracion-iframe-container .agent-modal .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--dark-color);
          }
          #configuracion-iframe-container .agent-modal .close-modal {
            background: transparent;
            border: none;
            color: #999;
            font-size: 16px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
          }
          #configuracion-iframe-container .agent-modal .close-modal:hover {
            background: #f5f5f5;
            color: var(--dark-color);
          }
          #configuracion-iframe-container .agent-detail-actions {
             display: flex;
             align-items: center;
             gap: 10px;
             justify-content: flex-end;
           }
           #configuracion-iframe-container .agent-detail-actions .generate-agent-btn,
           #configuracion-iframe-container .agent-detail-actions .cancel-edit-btn,
           #configuracion-iframe-container .agent-detail-actions .crear-agente-btn {
             border-radius: 20px !important;
           }
           #configuracion-iframe-container #saveAgentChangesBtn {
             background: #0b2431 !important;
             color: white !important;
           }
           #configuracion-iframe-container #saveAgentChangesBtn:hover {
             background: #081a24 !important;
           }
           #configuracion-iframe-container #saveAgentChangesBtn:disabled {
             opacity: 0.6;
             cursor: not-allowed;
           }
           
           /* Contact info box styles */
           #configuracion-iframe-container .contact-info-box {
             background: #f5f5f5;
             border: 1px solid #e0e0e0;
             border-radius: 12px;
             padding: 20px;
             margin: 20px 0;
             text-align: center;
           }
           
           #configuracion-iframe-container .contact-info-box p {
             margin: 0;
             color: #666;
             font-size: 14px;
             line-height: 1.5;
           }
           
           #configuracion-iframe-container .contact-info-box a {
             color: var(--primary-color);
             text-decoration: none;
             font-weight: 600;
           }
           
           #configuracion-iframe-container .contact-info-box a:hover {
             text-decoration: underline;
           }
         </style>
        
        <!-- Agents grid -->
        <div id="agentsGrid" class="agents-grid"></div>

        <!-- Contact information box -->
        <div class="contact-info-box">
          <p>Estamos trabajando en desarrollar la funcionalidad para automatizar la creaci√≥n de agentes. Mientras tanto, si quiere crear un nuevo agente p√≥ngase en contacto con el equipo de Reversa en <a href="mailto:tomas@reversa.ai">tomas@reversa.ai</a> o <a href="mailto:info@reversa.ai">info@reversa.ai</a>. ¬°Gracias!</p>
        </div>

        <!-- Toast notifications -->
        <div id="agentsToast" style="position: fixed; top: 20px; right: 20px; z-index: 4000; display: none; background: #e8f5e8; color: var(--dark-color); border: 1px solid var(--primary-color); padding: 12px 16px; border-radius: 10px; box-shadow: 0 6px 16px rgba(0,0,0,0.1); font-weight: 600; font-size: 14px; min-width: 280px; align-items:center; gap:10px;"></div>

        <!-- Agent detail overlay -->
        <div id="agentDetailOverlay" class="agent-detail-overlay" style="display: none;">
          <div class="agent-modal">
            <div class="modal-header">
              <h2 id="agentModalTitle"><span id="agentTitleText">Detalle del agente</span> <button class="edit-name-btn" id="editAgentNameBtn" title="Editar nombre"><i class="fas fa-edit"></i></button></h2>
              <button class="close-modal" id="closeAgentModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="product-details-form" style="margin: 0; box-shadow: none; padding-top: 10px; padding-bottom: 10px; flex: 1 1 auto; overflow: auto;">
              <div class="product-form-fields">
                
               <div class="form-field">
                   <div class="field-label-with-info">
                     <label class="field-label">Contexto</label>
                     <span class="info-icon" data-tooltip="Introduce un breve contexto sobre la actividad econ√≥mica de tu empresa (sector en el que opera, tipo de clientes a los que da servicio...) que ayude al agente a personalizar el impacto normativo.">i</span>
                   </div>
                   <textarea class="product-input" id="agentContexto" rows="3" placeholder="Contexto"></textarea>
                 </div>
                 <div class="form-field">
                   <div class="field-label-with-info">
                     <label class="field-label">Objetivo</label>
                     <span class="info-icon" data-tooltip="Describe el objetivo general de este agente (ej: detectar cambios normativos relevantes en protecci√≥n de datos).">i</span>
                   </div>
                   <textarea class="product-input" id="agentObjetivo" rows="3" placeholder="Objetivo"></textarea>
                 </div>
                 <div class="form-field">
                   <div class="field-label-with-info">
                     <label class="field-label">Contenido (criterios de inclusi√≥n)</label>
                     <span class="info-icon" data-tooltip="Para asegurar que el agente detecta lo relevante, detalla los supuestos en los que quieres recibir notificaciones, especificando rango normativo y efectos jur√≠dicos.">i</span>
                   </div>
                   <textarea class="product-input" id="agentContenido" rows="8" placeholder="Contenido"></textarea>
                 </div>
                 <div class="form-field">
                   <div class="field-label-with-info">
                     <label class="field-label">Documentos no incluidos</label>
                     <span class="info-icon" data-tooltip="Para asegurar que el agente elimina el ruido, determina qu√© tipo de contenido no debe ser incluido.">i</span>
                   </div>
                   <textarea class="product-input" id="agentNoIncluidos" rows="8" placeholder="Documentos no incluidos"></textarea>
                 </div>
             </div>
             <div class="agent-detail-actions">
                <button id="saveAgentChangesBtn" class="generate-agent-btn" disabled><i class="fas fa-save"></i> Guardar</button>
              </div>
           </div>
         </div>
        </div>

        <!-- Unsaved changes confirmation -->
        <div id="unsavedConfirmOverlay" class="agent-detail-overlay" style="display: none;">
          <div class="agent-modal small">
            <div class="modal-header">
              <h2>¬øGuardar cambios?</h2>
              <button class="close-modal" id="closeUnsavedConfirm"><i class="fas fa-times"></i></button>
            </div>
            <div class="product-details-form" style="margin: 0; box-shadow: none;">
              <p style="color: var(--text-color); margin: 0 0 16px 0;">Tienes cambios sin guardar. ¬øQuieres guardarlos antes de cerrar?</p>
              <div class="agent-detail-actions">
                <button id="discardChangesBtn" class="cancel-edit-btn">Descartar</button>
                <button id="saveAndCloseBtn" class="generate-agent-btn"><i class="fas fa-save"></i> Guardar y cerrar</button>
              </div>
            </div>
          </div>
        </div>
 
        <!-- Generated agents will be dynamically inserted here -->
 <!--
        <button id="crearAgenteBtn" class="crear-agente-btn">
          <i class="fas fa-plus"></i> Crear agente
        </button>
 -->
        <!-- Agent Template Selection Box -->
        <div id="agentTemplateBox" class="agent-template-box" style="display: none;">
          <button class="close-template-box" id="closeTemplateBox">
            <i class="fas fa-times"></i>
          </button>
          <h3 class="template-title">Elige de entre nuestras plantillas pre-configuradas que tipo de agente quieres crear</h3>
          
          <div class="template-options">
            <button class="template-btn" data-type="producto">
              <div class="template-btn-content">
                <div class="template-btn-header">
                  <i class="fas fa-box"></i>
                  <span class="template-btn-title">Producto</span>
                </div>
                <p class="template-btn-description">
                  Agente especializado en identificaci√≥n de novedades regulatorias que impacten un producto concreto 
                  <em>(ej: producto c√°rnico porcino)</em>
                </p>
              </div>
            </button>

            <button class="template-btn" data-type="cliente">
              <div class="template-btn-content">
                <div class="template-btn-header">
                  <i class="fas fa-user-tie"></i>
                  <span class="template-btn-title">Cliente</span>
                </div>
                <p class="template-btn-description">
                  Agente especializado en identificaci√≥n de novedades regulatorias que impacten un cliente espec√≠fico 
                  <em>(ej: empresa farmac√©utica multinacional)</em>
                </p>
              </div>
            </button>

            <button class="template-btn" data-type="sector">
              <div class="template-btn-content">
                <div class="template-btn-header">
                  <i class="fas fa-industry"></i>
                  <span class="template-btn-title">Sector</span>
                </div>
                <p class="template-btn-description">
                  Agente especializado en identificaci√≥n de novedades regulatorias que impacten un sector completo 
                  <em>(ej: sector energ√©tico renovable)</em>
                </p>
              </div>
            </button>

            <button class="template-btn" data-type="personalizado">
              <div class="template-btn-content">
                <div class="template-btn-header">
                  <i class="fas fa-cog"></i>
                  <span class="template-btn-title">Personalizado</span>
                </div>
                <p class="template-btn-description">
                  Define exactamente que quieres que trackee tu agente
                </p>
              </div>
            </button>
          </div>
        </div>

        <!-- Product Details Form -->
        <div id="productDetailsForm" class="product-details-form" style="display: none;">
          <button class="close-template-box" id="closeProductForm">
            <i class="fas fa-times"></i>
          </button>
          <h3 class="template-title">Proporciona algunos detalles sobre el producto</h3>
          
          <div class="product-form-fields">
            <div class="form-field">
              <label class="field-label">Nombre y descripci√≥n corta del producto</label>
              <textarea class="product-input" id="productDescription" placeholder="Ej.: &quot;Vacuna veterinaria porcina basada en ARNm&quot;" rows="3"></textarea>
            </div>

            <div class="form-field">
              <label class="field-label">Fase regulatoria o de mercado en la que se encuentra</label>
              <select class="product-select" id="productPhase">
                <option value="">Selecciona una fase</option>
                <option value="investigacion">Investigaci√≥n-I+D</option>
                <option value="ensayo">Ensayo/piloto</option>
                <option value="precomercializacion">Pre-comercializaci√≥n (solicitud de autorizaci√≥n)</option>
                <option value="comercializado">Comercializado</option>
                <option value="postcomercializacion">Post-comercializaci√≥n</option>
                <option value="otro">Otro</option>
              </select>
              <div id="customPhaseContainer" class="custom-input-container" style="display: none;">
                <input type="text" class="product-input" id="customPhase" placeholder="Especifica la fase regulatoria">
              </div>
            </div>

            <div class="form-field">
              <label class="field-label">Caracter√≠sticas del producto especialmente relevantes para la regulaci√≥n</label>
              <textarea class="product-input" id="productCharacteristics" placeholder="Ej.: &quot;Contiene ingredientes de origen animal&quot;, &quot;Integra IA generativa para diagn√≥stico&quot;, &quot;Usa nanomateriales&quot;, &quot;Alto potencial medioambiental&quot;" rows="3"></textarea>
            </div>
          </div>

          <div class="generate-agent-container">
            <button id="generateAgentBtn" class="generate-agent-btn">
              <i class="fas fa-magic"></i> Generar Agente
            </button>
          </div>
        </div>

        <!-- Client Details Form -->
        <div id="clientDetailsForm" class="product-details-form" style="display: none;">
          <button class="close-template-box" id="closeClientForm">
            <i class="fas fa-times"></i>
          </button>
          <h3 class="template-title">Proporciona algunos detalles sobre el cliente</h3>
          
          <div class="product-form-fields">
            <div class="form-field">
              <label class="field-label">Nombre y descripci√≥n del cliente</label>
              <textarea class="product-input" id="clientDescription" placeholder="Ej.: &quot;Banco digital especializado en servicios financieros para pymes&quot;" rows="3"></textarea>
            </div>

            <div class="form-field">
              <label class="field-label">P√°gina web del cliente</label>
              <input type="url" class="product-input" id="clientWebsite" placeholder="https://www.ejemplo.com">
            </div>

            <div class="form-field">
              <label class="field-label">Sectores y √°reas de inter√©s regulatorio</label>
              <textarea class="product-input" id="clientScope" placeholder="Ej.: &quot;Servicios de pago, pr√©stamos digitales, protecci√≥n de datos financieros, blanqueo de capitales&quot;" rows="3"></textarea>
            </div>
          </div>

          <div class="generate-agent-container">
            <button id="generateClientAgentBtn" class="generate-agent-btn">
              <i class="fas fa-magic"></i> Generar Agente
            </button>
          </div>
        </div>

        <!-- Sector Details Form -->
        <div id="sectorDetailsForm" class="product-details-form" style="display: none;">
          <button class="close-template-box" id="closeSectorForm">
            <i class="fas fa-times"></i>
          </button>
          <h3 class="template-title">Proporciona algunos detalles sobre el sector</h3>
          
          <div class="product-form-fields">
            <div class="form-field">
              <label class="field-label">Defina brevemente el sector o rama jur√≠dica que desea monitorizar</label>
              <textarea class="product-input" id="sectorDescription" placeholder="Ej.: &quot;Protecci√≥n de datos&quot;" rows="3"></textarea>
            </div>

            <div class="form-field">
              <label class="field-label">Indique el √°mbito geogr√°fico o la jurisdicci√≥n principal</label>
              <input type="text" class="product-input" id="sectorGeographicScope" placeholder="Ej.: &quot;Espa√±a y UE&quot;">
            </div>

            <div class="form-field">
              <label class="field-label">¬øCu√°l es el motivo u objetivo por el que quieres hacer este seguimiento regulatorio?</label>
              <textarea class="product-input" id="sectorSubtopics" placeholder="Ej.: &quot;Evitar sanciones por no cumplir con la normativa&quot;" rows="3"></textarea>
            </div>
          </div>

          <div class="generate-agent-container">
            <button id="generateSectorAgentBtn" class="generate-agent-btn">
              <i class="fas fa-magic"></i> Generar Agente
            </button>
          </div>
        </div>

        <!-- Custom Details Form -->
        <div id="customDetailsForm" class="product-details-form" style="display: none;">
          <button class="close-template-box" id="closeCustomForm">
            <i class="fas fa-times"></i>
          </button>
          <h3 class="template-title">Describe qu√© contenido quieres que el agente rastree de manera autom√°tica</h3>
          
          <div class="product-form-fields">
            <div class="form-field">
              <textarea class="product-input" id="customDescription" placeholder="Ej.: &quot;Novedades en contrataci√≥n p√∫blica electr√≥nica que afecten a peque√±as empresas de servicios tecnol√≥gicos&quot;" rows="4" style="margin-top: 10px;"></textarea>
            </div>
          </div>

          <div class="generate-agent-container">
            <button id="generateCustomAgentBtn" class="generate-agent-btn">
              <i class="fas fa-magic"></i> Generar Agente
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Use a function that can be called when content is loaded dynamically
    function initializeConfigurationMenu() {
      const container = document.getElementById('configuracion-iframe-container');
      if (!container) return;
      
      const menuItems = container.querySelectorAll('.config-menu-item');
      const contents = container.querySelectorAll('.config-content');
      
      // Remove any existing event listeners to avoid duplicates
      menuItems.forEach(item => {
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
      });
      
      // Get the updated menu items after cloning
      const newMenuItems = container.querySelectorAll('.config-menu-item');
      
      newMenuItems.forEach(item => {
        item.addEventListener('click', function() {
          const targetContent = this.getAttribute('data-content');
          
          // Remove active class from all menu items and contents
          newMenuItems.forEach(menuItem => menuItem.classList.remove('active'));
          contents.forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked menu item and corresponding content
          this.classList.add('active');
          const targetElement = container.querySelector('#' + targetContent + '-content');
          if (targetElement) {
            targetElement.classList.add('active');
            

            
            // If switching to fuentes content, check for banner display
            if (targetContent === 'fuentes') {
              setTimeout(() => checkAndShowAgentesRegulatoryBanner(), 100);
            }
          }
        });
      });
      

    }
    


    function checkAndShowAgentesRegulatoryBanner() {
      let hasEtiquetasPersonalizadas = false;
      
      try {
        // Try to get etiquetas personalizadas from parent window
        if (window.parent && window.parent.document) {
          const etiquetasElement = window.parent.document.getElementById('userEtiquetasPersonalizadas');
          if (etiquetasElement) {
            const etiquetas = JSON.parse(etiquetasElement.textContent || '{}');
            hasEtiquetasPersonalizadas = Object.keys(etiquetas).length > 0;
          }
        }
      } catch (error) {
        console.log('Could not access parent window data:', error);
      }
      
      const agentesBtn = document.getElementById('configuraAgentesBtn');
      if (agentesBtn) {
        if (!hasEtiquetasPersonalizadas) {
          agentesBtn.style.display = 'block';
          agentesBtn.onclick = () => {
            // Switch to "Agentes" tab
            const menuItems = document.querySelectorAll('.config-menu-item');
            menuItems.forEach(item => {
              if (item.dataset.content === 'agentes') {
                item.click();
              }
            });
          };
        } else {
          agentesBtn.style.display = 'none';
        }
      }
    }
    
    // Agent management functions (moved outside to be globally accessible)
    
    // Function to load existing agents from database
    const AGENTS_STATE = { currentAgentKey: null, originalXml: '', originalVars: null, isEditing: false, isDirty: false };

    function extractTag(xmlString, tagName){
      if(!xmlString) return '';
      try{
        const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<\\/${tagName}>`, 'i');
        const match = xmlString.match(regex);
        return match ? match[1].trim() : '';
      } catch(e){
        return '';
      }
    }

    function parseEtiquetaDefinition(xmlString){
      return {
        NombreEtiqueta: extractTag(xmlString, 'NombreEtiqueta'),
        tipo: extractTag(xmlString, 'tipo'),
        Contexto: extractTag(xmlString, 'Contexto'),
        Objetivo: extractTag(xmlString, 'Objetivo'),
        Contenido: extractTag(xmlString, 'Contenido'),
        DocumentosNoIncluidos: extractTag(xmlString, 'DocumentosNoIncluidos')
      };
    }

    function buildEtiquetaXml(vars){
      const s = v => (v ?? '').toString().trim();
      return `<Etiqueta>\n<NombreEtiqueta>${s(vars.NombreEtiqueta)}</NombreEtiqueta>\n<tipo>${s(vars.tipo)}</tipo>\n<Contexto>${s(vars.Contexto)}</Contexto>\n<Objetivo>${s(vars.Objetivo)}</Objetivo>\n<Contenido>\n${s(vars.Contenido)}\n</Contenido>\n<DocumentosNoIncluidos>\n${s(vars.DocumentosNoIncluidos)}\n</DocumentosNoIncluidos>\n</Etiqueta>`;
    }

    function renderAgentsGrid(etiquetas){
      const grid = document.getElementById('agentsGrid');
      if(!grid) return;
      // Show 6 skeletons while loading
      grid.innerHTML = '<div class="agent-skeleton"></div>'.repeat(6);
      const entries = Object.entries(etiquetas || {});
      if(entries.length===0){
        grid.innerHTML = '<div style="color:#7a8a93; font-size:14px;">No tienes agentes a√∫n. Crea tu primer agente.</div>';
        return;
      }
      // Build HTML first, then attach events to reduce reflow
      let html = '';
      const data = [];
      entries.reverse().forEach(([key, xml])=>{
        const parsed = parseEtiquetaDefinition(xml);
        const name = parsed.NombreEtiqueta || key;
        const obj = parsed.Objetivo || '';
        data.push({key, xml});
        html += `
          <div class="agent-box" data-key="${encodeURIComponent(key)}">
            <div class="agent-header">
              <h3>${name}</h3>
              <div class="agent-status"><i class="fas fa-circle"></i><span>Activo</span></div>
            </div>
            <p class="agent-objective">${obj}</p>
          </div>`;
      });
      grid.innerHTML = html;
      grid.querySelectorAll('.agent-box').forEach(box=>{
        const key = decodeURIComponent(box.getAttribute('data-key'));
        const xml = etiquetas[key];
        box.addEventListener('click', ()=> window.openAgentDetail && window.openAgentDetail(key, xml));
      });
    }

    async function loadExistingAgents(){
      try{
        const response = await fetch('/api/get-user-data');
        const userData = await response.json();
        updateUsageTrackers(userData);
        renderAgentsGrid(userData.etiquetas_personalizadas || {});
      }catch(error){
        console.error('Error loading existing agents:', error);
      }
    }

    
         // Function to display existing agents
     function displayExistingAgents(etiquetas) {
         const agentesContainer = document.querySelector('#agentes-content');
         const crearAgenteBtn = document.getElementById('crearAgenteBtn');
         
         // Get current agent names to avoid duplicates
         const existingBoxes = agentesContainer.querySelectorAll('.generated-agent-box');
         const currentAgentNames = new Set();
         existingBoxes.forEach(box => {
             const nameElement = box.querySelector('.agent-name');
             if (nameElement) {
                 currentAgentNames.add(nameElement.textContent);
             }
         });
         
         // Only create boxes for agents that don't already exist in the UI
         const etiquetasArray = Object.entries(etiquetas).reverse();
         etiquetasArray.forEach(([etiquetaName, etiquetaDefinition]) => {
             if (!currentAgentNames.has(etiquetaName)) {
                 createAgentBox(etiquetaName, etiquetaDefinition, crearAgenteBtn);
             }
         });
         
         // Remove any agent boxes that no longer exist in the data
         existingBoxes.forEach(box => {
             const nameElement = box.querySelector('.agent-name');
             if (nameElement && !etiquetas[nameElement.textContent]) {
                 box.remove();
             }
         });
     }
    
         // Function to create an agent box
     function createAgentBox(name, definition, insertAfter) {
         const agentBox = document.createElement('div');
         agentBox.className = 'generated-agent-box';
         
         // Create content elements safely without innerHTML
         const agentContent = document.createElement('div');
         agentContent.className = 'generated-agent-content';
         
         const agentName = document.createElement('h4');
         agentName.className = 'agent-name';
         agentName.textContent = name;
         
         const agentDefinition = document.createElement('p');
         agentDefinition.className = 'agent-definition';
         agentDefinition.textContent = definition;
         
         agentContent.appendChild(agentName);
         agentContent.appendChild(agentDefinition);
         
         // Create edit controls
         const editControls = document.createElement('div');
         editControls.className = 'agent-edit-controls';
         
         const editBtn = document.createElement('button');
         editBtn.className = 'edit-agent-btn';
         editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
         editBtn.addEventListener('click', () => editAgent(editBtn, name));
         
         editControls.appendChild(editBtn);
         
                   // Create close button
          const closeBtn = document.createElement('button');
          closeBtn.className = 'close-agent-box';
          closeBtn.innerHTML = '<i class="fas fa-trash"></i>';
          closeBtn.addEventListener('click', () => deleteAgent(closeBtn, name));
         
                   // Assemble the agent box
          agentBox.appendChild(agentContent);
          agentBox.appendChild(editControls);
          agentBox.appendChild(closeBtn);
          
          // Insert after the "Crear agente" button
          insertAfter.parentNode.insertBefore(agentBox, insertAfter.nextSibling);
     }
    
         // Function to edit an agent
     function editAgent(button, originalName) {
         const agentBox = button.closest('.generated-agent-box');
         const agentName = agentBox.querySelector('.agent-name');
         const agentDefinition = agentBox.querySelector('.agent-definition');
         const editControls = agentBox.querySelector('.agent-edit-controls');
         
         // Add editing class to expand the box
         agentBox.classList.add('editing');
         
         // Store original values
         const originalDefinition = agentDefinition.textContent;
         
         // Replace content with editable inputs
         const nameInput = document.createElement('input');
         nameInput.type = 'text';
         nameInput.className = 'agent-name-edit';
         nameInput.value = originalName;
         agentName.innerHTML = '';
         agentName.appendChild(nameInput);
         
         const definitionTextarea = document.createElement('textarea');
         definitionTextarea.className = 'agent-definition-edit';
         definitionTextarea.value = originalDefinition;
         definitionTextarea.maxLength = 2000;
         agentDefinition.innerHTML = '';
         agentDefinition.appendChild(definitionTextarea);

         // Add character counter
         const counterContainer = document.createElement('div');
         counterContainer.className = 'character-counter-container';
         
         const errorMessage = document.createElement('span');
         errorMessage.className = 'character-error-message';
         errorMessage.style.display = 'none';
         
         const counter = document.createElement('span');
         counter.className = 'character-counter';
         
         function updateCounter() {
             const length = definitionTextarea.value.length;
             counter.textContent = `${length} /1000`;
             
             if (length > 1000) {
                 counter.classList.add('over-limit');
                 errorMessage.textContent = 'N√∫mero m√°ximo de car√°cteres superado';
                 errorMessage.style.display = 'inline';
             } else {
                 counter.classList.remove('over-limit');
                 errorMessage.style.display = 'none';
             }
         }
         
         definitionTextarea.addEventListener('input', updateCounter);
         
         counterContainer.appendChild(errorMessage);
         counterContainer.appendChild(counter);
         agentDefinition.appendChild(counterContainer);
         
         // Initial counter update
         updateCounter();
         
         // Replace edit button with save and cancel buttons
         editControls.innerHTML = '';
         
         const saveBtn = document.createElement('button');
         saveBtn.className = 'save-agent-btn';
         saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
         saveBtn.addEventListener('click', () => saveAgent(saveBtn, originalName));
         
         const cancelBtn = document.createElement('button');
         cancelBtn.className = 'cancel-agent-btn';
         cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
         cancelBtn.addEventListener('click', () => cancelEdit(cancelBtn, originalName, originalDefinition));
         
         editControls.appendChild(saveBtn);
         editControls.appendChild(cancelBtn);
     }
    
         // Function to save agent changes
     async function saveAgent(button, originalName) {
         const agentBox = button.closest('.generated-agent-box');
         const nameInput = agentBox.querySelector('.agent-name-edit');
         const definitionInput = agentBox.querySelector('.agent-definition-edit');
         
         const newName = nameInput.value.trim();
         const newDefinition = definitionInput.value.trim();
         
         if (!newName || !newDefinition) {
             alert('Por favor, completa todos los campos.');
             return;
         }
         
         if (newDefinition.length > 1000) {
             // Show error message if not already visible
             const errorMessage = agentBox.querySelector('.character-error-message');
             const counter = agentBox.querySelector('.character-counter');
             if (errorMessage && counter) {
                 errorMessage.textContent = 'N√∫mero m√°ximo de car√°cteres superado';
                 errorMessage.style.display = 'inline';
                 counter.classList.add('over-limit');
             }
             return;
         }
         
         // Show loading state
         const originalButtonContent = button.innerHTML;
         button.disabled = true;
         button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
         
         try {
            // Get current user data
            const response = await fetch('/api/get-user-data');
            const userData = await response.json();
            
            // Update etiquetas_personalizadas
            const etiquetas = userData.etiquetas_personalizadas || {};
            
            // Remove old key if name changed
            if (originalName !== newName) {
                delete etiquetas[originalName];
            }
            
            // Add/update with new values
            etiquetas[newName] = newDefinition;
            
            // Save to database
            const updateResponse = await fetch('/api/update-user-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    etiquetas_personalizadas: etiquetas
                })
            });
            
                              if (updateResponse.ok) {
                      // Update UI first
                      agentBox.querySelector('.agent-name').textContent = newName;
                      agentBox.querySelector('.agent-definition').textContent = newDefinition;
                      
                      // Restore edit controls
                      const editControls = agentBox.querySelector('.agent-edit-controls');
                      editControls.innerHTML = '';
                      
                      const editBtn = document.createElement('button');
                      editBtn.className = 'edit-agent-btn';
                      editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                      editBtn.addEventListener('click', () => editAgent(editBtn, newName));
                      
                      editControls.appendChild(editBtn);
                      
                      // Remove editing class with slight delay for smoother transition
                      setTimeout(() => {
                          agentBox.classList.remove('editing');
                      }, 100);
                      
                      // Refresh usage tracker
                      loadExistingAgents();
                  } else {
                      // Restore button state on error
                      button.disabled = false;
                      button.innerHTML = originalButtonContent;
                      alert('Error al guardar los cambios. Por favor, int√©ntalo de nuevo.');
                  }
              } catch (error) {
                  console.error('Error saving agent:', error);
                  // Restore button state on error
                  button.disabled = false;
                  button.innerHTML = originalButtonContent;
                  alert('Error al guardar los cambios. Por favor, int√©ntalo de nuevo.');
              }
    }
    
         // Function to cancel editing
     function cancelEdit(button, originalName, originalDefinition) {
         const agentBox = button.closest('.generated-agent-box');
         
         // Restore original content first
         agentBox.querySelector('.agent-name').textContent = originalName;
         agentBox.querySelector('.agent-definition').textContent = originalDefinition;
         
         // Restore edit controls
         const editControls = agentBox.querySelector('.agent-edit-controls');
         editControls.innerHTML = '';
         
         const editBtn = document.createElement('button');
         editBtn.className = 'edit-agent-btn';
         editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
         editBtn.addEventListener('click', () => editAgent(editBtn, originalName));
         
         editControls.appendChild(editBtn);
         
         // Remove editing class with slight delay for smoother transition
         setTimeout(() => {
             agentBox.classList.remove('editing');
         }, 100);
     }
    
    // Function to delete an agent
    async function deleteAgent(button, agentName) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar el agente "${agentName}"?`)) {
            return;
        }
        
        try {
            // Get current user data
            const response = await fetch('/api/get-user-data');
            const userData = await response.json();
            
            // Remove from etiquetas_personalizadas
            const etiquetas = userData.etiquetas_personalizadas || {};
            delete etiquetas[agentName];
            
            // Save to database
            const updateResponse = await fetch('/api/update-user-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    etiquetas_personalizadas: etiquetas
                })
            });
            
            if (updateResponse.ok) {
                // Remove from UI
                button.closest('.generated-agent-box').remove();
                
                // Refresh usage tracker
                loadExistingAgents();
            } else {
                alert('Error al eliminar el agente. Por favor, int√©ntalo de nuevo.');
            }
        } catch (error) {
            console.error('Error deleting agent:', error);
            alert('Error al eliminar el agente. Por favor, int√©ntalo de nuevo.');
        }
    }
    
         // Function to show generated agent
     function showGeneratedAgent(agentData) {
         const crearAgenteBtn = document.getElementById('crearAgenteBtn');
         
         if (agentData.etiqueta_personalizada && crearAgenteBtn) {
             // Show the agent immediately by creating it directly in the UI
             const agentName = Object.keys(agentData.etiqueta_personalizada)[0];
             const agentDefinition = agentData.etiqueta_personalizada[agentName];
             
             // Create the agent box immediately
             createAgentBox(agentName, agentDefinition, crearAgenteBtn);
             
             // Update usage trackers in background
             setTimeout(() => {
                 loadExistingAgents();
             }, 100);
             
             // Scroll to top smoothly
             setTimeout(() => {
                 const configMenu = document.querySelector('.config-menu');
                 if (configMenu) {
                     configMenu.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 }
             }, 200);
         }
     }
    
    // Initialize agent template functionality
    function initializeAgentTemplates() {
      const crearAgenteBtn = document.getElementById('crearAgenteBtn');
      const agentTemplateBox = document.getElementById('agentTemplateBox');
      const closeTemplateBox = document.getElementById('closeTemplateBox');
      const productDetailsForm = document.getElementById('productDetailsForm');
      const closeProductForm = document.getElementById('closeProductForm');
      const clientDetailsForm = document.getElementById('clientDetailsForm');
      const closeClientForm = document.getElementById('closeClientForm');
      const sectorDetailsForm = document.getElementById('sectorDetailsForm');
      const closeSectorForm = document.getElementById('closeSectorForm');
      const customDetailsForm = document.getElementById('customDetailsForm');
      const closeCustomForm = document.getElementById('closeCustomForm');
      const generateAgentBtn = document.getElementById('generateAgentBtn');
      const generateClientAgentBtn = document.getElementById('generateClientAgentBtn');
      const generateSectorAgentBtn = document.getElementById('generateSectorAgentBtn');
      const generateCustomAgentBtn = document.getElementById('generateCustomAgentBtn');
      
      // Load existing agents on initialization
      loadExistingAgents();
      
      if (crearAgenteBtn && agentTemplateBox) {
          // Function to show template box
          function showTemplateBox() {
              agentTemplateBox.style.display = 'block';
              crearAgenteBtn.style.display = 'none';
              if (productDetailsForm) productDetailsForm.style.display = 'none';
              if (clientDetailsForm) clientDetailsForm.style.display = 'none';
              if (sectorDetailsForm) sectorDetailsForm.style.display = 'none';
              if (customDetailsForm) customDetailsForm.style.display = 'none';
              
              // Hide agents grid while creating from template
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'none';
              
              // Scroll to the box smoothly
              setTimeout(() => {
                  agentTemplateBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }, 100);
          }

          // Function to hide template box
          function hideTemplateBox() {
              agentTemplateBox.style.display = 'none';
              crearAgenteBtn.style.display = 'flex';
              if (productDetailsForm) productDetailsForm.style.display = 'none';
              if (clientDetailsForm) clientDetailsForm.style.display = 'none';
              if (sectorDetailsForm) sectorDetailsForm.style.display = 'none';
              if (customDetailsForm) customDetailsForm.style.display = 'none';
              
              // Show agents grid again
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'grid';
          }

          // Function to show product details form
          function showProductForm() {
              agentTemplateBox.style.display = 'none';
              if (productDetailsForm) {
                  // Reset form fields
                  const productDescription = document.getElementById('productDescription');
                  const productPhase = document.getElementById('productPhase');
                  const productCharacteristics = document.getElementById('productCharacteristics');
                  const customPhase = document.getElementById('customPhase');
                  const customPhaseContainer = document.getElementById('customPhaseContainer');
                  const generateBtn = document.getElementById('generateAgentBtn');
                  
                  if (productDescription) productDescription.value = '';
                  if (productPhase) productPhase.value = '';
                  if (productCharacteristics) productCharacteristics.value = '';
                  if (customPhase) customPhase.value = '';
                  if (customPhaseContainer) customPhaseContainer.style.display = 'none';
                  if (generateBtn) {
                      generateBtn.disabled = false;
                      generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
                  
                  productDetailsForm.style.display = 'block';
                  // Scroll to the form smoothly
                  setTimeout(() => {
                      productDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                  }, 100);
              }
          }

          // Function to show client form
          function showClientForm() {
              agentTemplateBox.style.display = 'none';
              if (clientDetailsForm) {
                  // Reset form fields
                  const clientDescription = document.getElementById('clientDescription');
                  const clientWebsite = document.getElementById('clientWebsite');
                  const clientScope = document.getElementById('clientScope');
                  const generateBtn = document.getElementById('generateClientAgentBtn');
                  
                  if (clientDescription) clientDescription.value = '';
                  if (clientWebsite) clientWebsite.value = '';
                  if (clientScope) clientScope.value = '';
                  if (generateBtn) {
                      generateBtn.disabled = false;
                      generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
                  
                  clientDetailsForm.style.display = 'block';
                  // Scroll to the form smoothly
                  setTimeout(() => {
                      clientDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                  }, 100);
              }
          }

          // Function to show sector form
          function showSectorForm() {
              agentTemplateBox.style.display = 'none';
              if (sectorDetailsForm) {
                  // Reset form fields
                  const sectorDescription = document.getElementById('sectorDescription');
                  const sectorGeographicScope = document.getElementById('sectorGeographicScope');
                  const sectorSubtopics = document.getElementById('sectorSubtopics');
                  const generateBtn = document.getElementById('generateSectorAgentBtn');
                  
                  if (sectorDescription) sectorDescription.value = '';
                  if (sectorGeographicScope) sectorGeographicScope.value = '';
                  if (sectorSubtopics) sectorSubtopics.value = '';
                  if (generateBtn) {
                      generateBtn.disabled = false;
                      generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
                  
                  sectorDetailsForm.style.display = 'block';
                  // Scroll to the form smoothly
                  setTimeout(() => {
                      sectorDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                  }, 100);
              }
          }

          // Function to show custom form
          function showCustomForm() {
              agentTemplateBox.style.display = 'none';
              if (customDetailsForm) {
                  // Reset form fields
                  const customDescription = document.getElementById('customDescription');
                  const generateBtn = document.getElementById('generateCustomAgentBtn');
                  
                  if (customDescription) customDescription.value = '';
                  if (generateBtn) {
                      generateBtn.disabled = false;
                      generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
                  
                  customDetailsForm.style.display = 'block';
                  // Scroll to the form smoothly
                  setTimeout(() => {
                      customDetailsForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                  }, 100);
              }
          }

          // Function to hide product details form
          function hideProductForm() {
              if (productDetailsForm) productDetailsForm.style.display = 'none';
              crearAgenteBtn.style.display = 'flex';
              
              // Show agents grid again
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'grid';
          }

          // Function to hide client details form
          function hideClientForm() {
              if (clientDetailsForm) clientDetailsForm.style.display = 'none';
              crearAgenteBtn.style.display = 'flex';
              
              // Show agents grid again
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'grid';
          }

          // Function to hide sector details form
          function hideSectorForm() {
              if (sectorDetailsForm) sectorDetailsForm.style.display = 'none';
              crearAgenteBtn.style.display = 'flex';
              
              // Show agents grid again
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'grid';
          }

          // Function to hide custom details form
          function hideCustomForm() {
              if (customDetailsForm) customDetailsForm.style.display = 'none';
              crearAgenteBtn.style.display = 'flex';
              
              // Show agents grid again
              const agentsGrid = document.getElementById('agentsGrid');
              if (agentsGrid) agentsGrid.style.display = 'grid';
          }

          // Note: Agent boxes are now managed dynamically with individual delete buttons

          // Show template box when "Crear agente" is clicked
          crearAgenteBtn.addEventListener('click', async () => {
            // Check if user can create more agents
            try {
              const response = await fetch('/api/get-user-data');
              const userData = await response.json();
              
              const defaultLimits = getDefaultLimits(userData.subscription_plan || 'plan1');
              const limitAgentes = userData.limit_agentes !== undefined ? userData.limit_agentes : defaultLimits.limit_agentes;
              const currentAgentes = Object.keys(userData.etiquetas_personalizadas || {}).length;
              
              if (limitAgentes !== null && currentAgentes >= limitAgentes) {
                alert(`Has alcanzado el l√≠mite de ${limitAgentes} agentes para tu plan actual. Para crear m√°s agentes, actualiza tu suscripci√≥n.`);
                return;
              }
              
              openNewAgentModal();
            } catch (error) {
              console.error('Error checking agent limits:', error);
              openNewAgentModal(); // Show anyway if there's an error
            }
          });

          // Hide template box when close button is clicked
          if (closeTemplateBox) {
              closeTemplateBox.addEventListener('click', hideTemplateBox);
          }

          // Hide product form when close button is clicked
          if (closeProductForm) {
              closeProductForm.addEventListener('click', hideProductForm);
          }

          // Hide client form when close button is clicked
          if (closeClientForm) {
              closeClientForm.addEventListener('click', hideClientForm);
          }

          // Hide sector form when close button is clicked
          if (closeSectorForm) {
              closeSectorForm.addEventListener('click', hideSectorForm);
          }

          // Hide custom form when close button is clicked
          if (closeCustomForm) {
              closeCustomForm.addEventListener('click', hideCustomForm);
          }

          // Note: Agent boxes are now managed dynamically with individual delete buttons

          // Add click handlers for template buttons
          const templateBtns = agentTemplateBox.querySelectorAll('.template-btn');
          templateBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                  const agentType = btn.dataset.type;
                  console.log('Selected agent type:', agentType);
                  
                  if (agentType === 'producto') {
                      showProductForm();
                  } else if (agentType === 'cliente') {
                      showClientForm();
                  } else if (agentType === 'sector') {
                      showSectorForm();
                  } else if (agentType === 'personalizado') {
                      showCustomForm();
                  } else {
                      // For other agent types, just hide template box for now
                      hideTemplateBox();
                  }
              });
          });

          // Handle custom phase input toggle
          const productPhaseSelect = document.getElementById('productPhase');
          const customPhaseContainer = document.getElementById('customPhaseContainer');
          
          if (productPhaseSelect && customPhaseContainer) {
              productPhaseSelect.addEventListener('change', (e) => {
                  if (e.target.value === 'otro') {
                      customPhaseContainer.style.display = 'block';
                  } else {
                      customPhaseContainer.style.display = 'none';
                      // Clear custom input when hiding
                      const customPhaseInput = document.getElementById('customPhase');
                      if (customPhaseInput) customPhaseInput.value = '';
                  }
              });
          }

          // Handle generate agent button click
          if (generateAgentBtn) {
              generateAgentBtn.addEventListener('click', async () => {
                  // Get form values
                  const productDescription = document.getElementById('productDescription')?.value || '';
                  let productPhase = document.getElementById('productPhase')?.value || '';
                  const productCharacteristics = document.getElementById('productCharacteristics')?.value || '';
                  
                  // If "Otro" is selected, use the custom input value
                  if (productPhase === 'otro') {
                      const customPhase = document.getElementById('customPhase')?.value || '';
                      productPhase = customPhase;
                  }

                  // Validate required fields
                  if (!productDescription.trim()) {
                      alert('Por favor, proporciona una descripci√≥n del producto.');
                      return;
                  }

                  // Show loading state
                  generateAgentBtn.disabled = true;
                  generateAgentBtn.innerHTML = '<div class="button-spinner"></div> Generando...';
                  
                  try {
                      // Make API call to generate agent (server handles prompt creation)
                      const response = await fetch('/api/generate-agent', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                              productData: {
                                  description: productDescription,
                                  phase: productPhase,
                                  characteristics: productCharacteristics
                              }
                          })
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }

                      const result = await response.json();
                      
                      if (result.success && result.agent) {
                          // Show generated agent first (this will handle the delay and reload)
                          showGeneratedAgent(result.agent);
                          
                          // Close forms and reset button immediately
                          setTimeout(() => {
                              hideProductForm();
                              hideTemplateBox();
                              generateAgentBtn.disabled = false;
                              generateAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                          }, 300); // Quick transition
                          
                          return; // Don't execute the catch block
                      } else {
                          throw new Error(result.error || 'Error generating agent');
                      }

                  } catch (error) {
                      console.error('Error generating agent:', error);
                      alert('Error al generar el agente. Por favor, int√©ntalo de nuevo.');
                      
                      // Reset button state
                      generateAgentBtn.disabled = false;
                      generateAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
              });
          }

          // Handle generate client agent button click
          if (generateClientAgentBtn) {
              generateClientAgentBtn.addEventListener('click', async () => {
                  // Get form values
                  const clientDescription = document.getElementById('clientDescription')?.value || '';
                  const clientWebsite = document.getElementById('clientWebsite')?.value || '';
                  const clientScope = document.getElementById('clientScope')?.value || '';

                  // Validate required fields
                  if (!clientDescription.trim()) {
                      alert('Por favor, proporciona una descripci√≥n del cliente.');
                      return;
                  }

                  // Show loading state
                  generateClientAgentBtn.disabled = true;
                  generateClientAgentBtn.innerHTML = '<div class="button-spinner"></div> Generando...';
                  
                  try {
                      // Make API call to generate client agent
                      const response = await fetch('/api/generate-client-agent', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                              clientData: {
                                  description: clientDescription,
                                  website: clientWebsite,
                                  scope: clientScope
                              }
                          })
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }

                      const result = await response.json();
                      
                      if (result.success && result.agent) {
                          // Show generated agent first (this will handle the delay and reload)
                          showGeneratedAgent(result.agent);
                          
                          // Close forms and reset button immediately
                          setTimeout(() => {
                              hideClientForm();
                              hideTemplateBox();
                              generateClientAgentBtn.disabled = false;
                              generateClientAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                          }, 300); // Quick transition
                          
                          return; // Don't execute the catch block
                      } else {
                          throw new Error(result.error || 'Error generating client agent');
                      }

                  } catch (error) {
                      console.error('Error generating client agent:', error);
                      alert('Error al generar el agente. Por favor, int√©ntalo de nuevo.');
                      
                      // Reset button state
                      generateClientAgentBtn.disabled = false;
                      generateClientAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
              });
          }

          // Handle generate sector agent button click
          if (generateSectorAgentBtn) {
              generateSectorAgentBtn.addEventListener('click', async () => {
                  // Get form values
                  const sectorDescription = document.getElementById('sectorDescription')?.value || '';
                  const sectorGeographicScope = document.getElementById('sectorGeographicScope')?.value || '';
                  const sectorSubtopics = document.getElementById('sectorSubtopics')?.value || '';

                  // Validate required fields
                  if (!sectorDescription.trim()) {
                      alert('Por favor, proporciona una descripci√≥n del sector.');
                      return;
                  }

                  // Show loading state
                  generateSectorAgentBtn.disabled = true;
                  generateSectorAgentBtn.innerHTML = '<div class="button-spinner"></div> Generando...';
                  
                  try {
                      // Make API call to generate sector agent
                      const response = await fetch('/api/generate-sector-agent', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                              sectorData: {
                                  description: sectorDescription,
                                  geographicScope: sectorGeographicScope,
                                  subtopics: sectorSubtopics
                              }
                          })
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }

                      const result = await response.json();
                      
                      if (result.success && result.agent) {
                          // Show generated agent first (this will handle the delay and reload)
                          showGeneratedAgent(result.agent);
                          
                          // Close forms and reset button immediately
                          setTimeout(() => {
                              hideSectorForm();
                              hideTemplateBox();
                              generateSectorAgentBtn.disabled = false;
                              generateSectorAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                          }, 300); // Quick transition
                          
                          return; // Don't execute the catch block
                      } else {
                          throw new Error(result.error || 'Error generating sector agent');
                      }

                  } catch (error) {
                      console.error('Error generating sector agent:', error);
                      alert('Error al generar el agente. Por favor, int√©ntalo de nuevo.');
                      
                      // Reset button state
                      generateSectorAgentBtn.disabled = false;
                      generateSectorAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
              });
          }

          // Handle generate custom agent button click
          if (generateCustomAgentBtn) {
              generateCustomAgentBtn.addEventListener('click', async () => {
                  // Get form values
                  const customDescription = document.getElementById('customDescription')?.value || '';

                  // Validate required fields
                  if (!customDescription.trim()) {
                      alert('Por favor, describe qu√© contenido quieres que el agente rastree.');
                      return;
                  }

                  // Show loading state
                  generateCustomAgentBtn.disabled = true;
                  generateCustomAgentBtn.innerHTML = '<div class="button-spinner"></div> Generando...';
                  
                  try {
                      // Make API call to generate custom agent
                      const response = await fetch('/api/generate-custom-agent', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify({
                              customData: {
                                  description: customDescription
                              }
                          })
                      });

                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }

                      const result = await response.json();
                      
                      if (result.success && result.agent) {
                          // Show generated agent first (this will handle the delay and reload)
                          showGeneratedAgent(result.agent);
                          
                          // Close forms and reset button immediately
                          setTimeout(() => {
                              hideCustomForm();
                              hideTemplateBox();
                              generateCustomAgentBtn.disabled = false;
                              generateCustomAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                          }, 300); // Quick transition
                          
                          return; // Don't execute the catch block
                      } else {
                          throw new Error(result.error || 'Error generating custom agent');
                      }

                  } catch (error) {
                      console.error('Error generating custom agent:', error);
                      alert('Error al generar el agente. Por favor, int√©ntalo de nuevo.');
                      
                      // Reset button state
                      generateCustomAgentBtn.disabled = false;
                      generateCustomAgentBtn.innerHTML = '<i class="fas fa-magic"></i> Generar Agente';
                  }
              });
          }
      }
    }

    // Initialize immediately if DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeConfigurationMenu();
        initializeAgentTemplates();
      });
    } else {
      // If content is loaded dynamically, initialize immediately
      setTimeout(() => {
        initializeConfigurationMenu();
        initializeAgentTemplates();
      }, 100);
    }
    
    // Function to get default limits based on plan
    function getDefaultLimits(plan) {
      switch (plan) {
        case 'plan1':
          return { limit_agentes: 0, limit_fuentes: 0 };
        case 'plan2':
          return { limit_agentes: 5, limit_fuentes: 3 };
        case 'plan3':
          return { limit_agentes: 10, limit_fuentes: 10 };
        case 'plan4':
          return { limit_agentes: null, limit_fuentes: null }; // unlimited
        default:
          return { limit_agentes: 0, limit_fuentes: 0 };
      }
    }

    // Function to update usage trackers
    function updateUsageTrackers(userData) {
      const agentesTracker = document.getElementById('agentes-usage-tracker');
      const fuentesTracker = document.getElementById('fuentes-usage-tracker');
      
      if (!userData) return;
      
      // Get default limits if not defined
      const defaultLimits = getDefaultLimits(userData.subscription_plan || 'plan1');
      const limitAgentes = userData.limit_agentes !== undefined ? userData.limit_agentes : defaultLimits.limit_agentes;
      const limitFuentes = userData.limit_fuentes !== undefined ? userData.limit_fuentes : defaultLimits.limit_fuentes;
      
      // Count current usage
      const currentAgentes = Object.keys(userData.etiquetas_personalizadas || {}).length;
      const currentFuentes = (userData.cobertura_legal?.fuentes_gobierno || []).length + 
                            (userData.cobertura_legal?.fuentes_reguladores || []).length;
      
      // Update agentes tracker
      if (agentesTracker) {
        if (limitAgentes === null) {
          // Unlimited
          agentesTracker.textContent = 'N√∫mero de agentes ilimitado';
          agentesTracker.className = 'usage-tracker unlimited';
        } else {
          agentesTracker.textContent = `${currentAgentes}/${limitAgentes} disponibles`;
          agentesTracker.className = 'usage-tracker';
          
          // Add warning classes
          if (currentAgentes >= limitAgentes) {
            agentesTracker.classList.add('at-limit');
          } else if (currentAgentes >= limitAgentes * 0.8) {
            agentesTracker.classList.add('near-limit');
          }
        }
      }
      
      // Update fuentes tracker
      if (fuentesTracker) {
        if (limitFuentes === null) {
          // Unlimited
          fuentesTracker.textContent = 'N√∫mero de fuentes ilimitado';
          fuentesTracker.className = 'usage-tracker unlimited';
        } else {
          fuentesTracker.textContent = `${currentFuentes}/${limitFuentes} disponibles`;
          fuentesTracker.className = 'usage-tracker';
          
          // Add warning classes
          if (currentFuentes >= limitFuentes) {
            fuentesTracker.classList.add('at-limit');
          } else if (currentFuentes >= limitFuentes * 0.8) {
            fuentesTracker.classList.add('near-limit');
          }
        }
      }
    }

    // Expose functions globally so they can be called from dynamic HTML
    window.initializeConfigurationMenu = initializeConfigurationMenu;
    window.loadExistingAgents = loadExistingAgents;
    window.renderAgentsGrid = renderAgentsGrid;
    window.showGeneratedAgent = showGeneratedAgent;
    window.updateUsageTrackers = updateUsageTrackers;

    function hideLoader(){
      const l=document.getElementById('config-loader');
      if(l) l.style.display='none';
    }
  </script>
  <!-- Onboarding form logic -->
  <script>
  (function(){
    /* ------------------ DATA ------------------ */
    let onboardingStructure = null;
    const onboardingContainer = document.getElementById('onboarding-container');
    const profileView = document.getElementById('profile-summary-view');
    const configLoader = document.getElementById('config-loader');
    
    // Check for existing profile data on load
    fetch('/api/get-user-data')
        .then(res => res.json())
        .then(userData => {
            // Update usage trackers with user data
            updateUsageTrackers(userData);
            
            // Always populate fuentes when user data is loaded
            populateFuentes(userData.cobertura_legal);
            
            if (userData && userData.perfil_regulatorio) {
                // If profile exists, display it directly
                renderFinalView(userData);
                if (onboardingContainer) onboardingContainer.style.display = 'none';
                if (profileView) profileView.style.display = 'block';
            } else {
                // If not, fetch the form structure and start onboarding
                return fetch('/views/configuracion/estructura_onboarding.json')
                  .then(res=>res.json())
                  .then(json=>{
                    onboardingStructure=json;
                    startOnboarding();
                  })
            }
        })
        .catch(err => {
            console.error('Error fetching initial data:', err);
            // On error, try to show the form as a fallback
            if(onboardingContainer) onboardingContainer.style.display = 'block';
            // Still try to populate fuentes even on error
            populateFuentes(null);
        })
        .finally(() => {
            if (configLoader) configLoader.style.display = 'none';
        });

    /* -------------- HELPERS -------------- */
    const onboardingForm = document.getElementById('onboarding-form');
    const summaryContainer = document.getElementById('summary-tags');
    const completionMessage = document.getElementById('completion-message');
    const answers = [];
    const answerByKey = {};
    window.onboardingAnswers = answerByKey;

    function toTitle(str){
      if (!str) return '';
      const lower=str.replace(/^pregunta[_ ]?/i,'').replace(/_/g,' ').trim().toLowerCase();
      const titled=lower.replace(/(^|[\s\|])\p{L}/gu, match=>match.toUpperCase());
      return titled.replace(/\b(De|Del|Y)\b/g, m=>m.toLowerCase()).replace(/M&a/i,'M&A').replace(/Esg/i,'ESG').replace(/Tmt/i,'TMT');
    }

    function renderSummary(){
      summaryContainer.innerHTML='';
      answers.forEach(({question,answer}, idx)=>{
        const tag=document.createElement('span');
        tag.className='summary-tag';
        tag.innerHTML=`<strong>${toTitle(question)}:</strong> ${answer} <span class="tick">‚úì</span>`;
        tag.addEventListener('click', ()=> goToStep(idx) );
        summaryContainer.appendChild(tag);
      });
    }

    // Store original data for edit functionality
    let originalContextData = {};

    function renderFinalView(data) {
        const tableBody = document.querySelector('#profile-summary-view .summary-table tbody');
        const profileContent = document.getElementById('regulatory-profile-content');
        const coberturaBtn = document.getElementById('configuraCoberturaBtn');

        if (!tableBody || !profileContent || !coberturaBtn) return;
        
        // Store original data for editing
        originalContextData = {
            tipo_empresa: data.tipo_empresa || '',
            sector: data.detalle_empresa?.sector || '',
            actividad: data.detalle_empresa?.actividad || '',
            interes: data.interes || '',
            tama√±o_empresa: data.tama√±o_empresa || '',
            web: data.web || '',
            perfil_regulatorio: data.perfil_regulatorio || ''
        };
        
        // Siempre mostrar el bot√≥n de cobertura
        coberturaBtn.style.display = 'block';
        coberturaBtn.onclick = () => {
            // Switch to "Fuentes" tab
            const menuItems = document.querySelectorAll('.config-menu-item');
            menuItems.forEach(item => {
                if (item.dataset.content === 'fuentes') {
                    item.click();
                }
            });
        };

        tableBody.innerHTML = '';
        profileContent.innerHTML = '';

        const createRow = (variable, valor, fieldKey) => {
            if (!valor || valor.trim() === '') return '';
            let displayValue = fieldKey === 'web' ? `<a href="${valor}" target="_blank">${valor}</a>` : valor;
            
            // ‚úÖ MEJORA 2: Agregar warning icon para web si hay errores de extracci√≥n
            if (fieldKey === 'web' && data.website_extraction_status && !data.website_extraction_status.success) {
                // ‚úÖ Agregar warning icon solo si hubo error de extracci√≥n
                const warningIcon = `<span class="web-warning-icon">&#9888;</span>`; /* ‚ö†Ô∏è */
                displayValue += ` ${warningIcon}`;
            } else if (fieldKey === 'web') {
                // ‚úÖ No warning icon needed for web field (successful extraction or no status)
                console.log('‚úÖ No warning icon needed for web field');
            }
            
            return `<tr data-field="${fieldKey}"><td>${variable}</td><td class="field-value">${displayValue}</td></tr>`;
        };

        let tableHtml = '';
        tableHtml += createRow('Tipo de Empresa', data.tipo_empresa, 'tipo_empresa');
        if (data.detalle_empresa) {
            tableHtml += createRow('Sector', data.detalle_empresa.sector, 'sector');
            tableHtml += createRow('Actividad', data.detalle_empresa.actividad, 'actividad');
        }
        tableHtml += createRow('Inter√©s', data.interes, 'interes');
        tableHtml += createRow('Tama√±o Empresa', data.tama√±o_empresa, 'tama√±o_empresa');
        tableHtml += createRow('Web', data.web, 'web');
        tableBody.innerHTML = tableHtml;

        profileContent.innerHTML = data.perfil_regulatorio || '<p>No se ha generado un perfil regulatorio.</p>';
        
        // Initialize edit functionality
        initializeContextEdit();
    }

    function initializeContextEdit() {
        const editBtn = document.getElementById('editContextBtn');
        const editControls = document.getElementById('editContextControls');
        const cancelBtn = document.getElementById('cancelEditBtn');
        const saveBtn = document.getElementById('saveEditBtn');
        const contextTable = document.getElementById('contextTable');
        const profileContent = document.getElementById('regulatory-profile-content');

        if (!editBtn || !editControls || !cancelBtn || !saveBtn || !contextTable || !profileContent) return;

        editBtn.addEventListener('click', () => enterEditMode());
        cancelBtn.addEventListener('click', () => exitEditMode());
        saveBtn.addEventListener('click', () => saveContextChanges());

        function enterEditMode() {
            editBtn.style.display = 'none';
            editControls.style.display = 'flex';
            contextTable.classList.add('editing');
            profileContent.classList.add('editing');

                         // Convert table cells to inputs
             const tableRows = contextTable.querySelectorAll('tbody tr');
             tableRows.forEach(row => {
                 const fieldKey = row.dataset.field;
                 const valueCell = row.querySelector('.field-value');
                 if (valueCell && fieldKey) {
                     const currentValue = getPlainTextValue(originalContextData[fieldKey] || '');
                     
                     // Create text input for all fields
                     const inputElement = document.createElement('input');
                     inputElement.type = 'text';
                     inputElement.className = 'editable-field';
                     inputElement.value = currentValue;
                     
                     // Add placeholder text for guidance
                     if (fieldKey === 'tipo_empresa') {
                         inputElement.placeholder = 'Ej: Consultora, Despacho, Empresa Regulada, etc.';
                     } else if (fieldKey === 'interes') {
                         inputElement.placeholder = 'Ej: Energ√≠a, Construcci√≥n, Agr√≠cola, Financiero, etc.';
                     } else if (fieldKey === 'tama√±o_empresa') {
                         inputElement.placeholder = 'Ej: 0-20 empleados, 20-100 empleados, etc.';
                     } else if (fieldKey === 'web') {
                         inputElement.placeholder = 'Ej: https://www.ejemplo.com';
                     } else if (fieldKey === 'sector') {
                         inputElement.placeholder = 'Ej: Tecnolog√≠a, Consultor√≠a, etc.';
                     } else if (fieldKey === 'actividad') {
                         inputElement.placeholder = 'Ej: Desarrollo de software, Asesor√≠a legal, etc.';
                     }
                     
                     valueCell.innerHTML = '';
                     valueCell.appendChild(inputElement);
                 }
             });

            // Convert profile content to textarea
            const currentProfileContent = profileContent.innerHTML;
            profileContent.innerHTML = `<textarea class="editable-profile">${getPlainTextValue(originalContextData.perfil_regulatorio)}</textarea>`;
        }

        function exitEditMode() {
            editBtn.style.display = 'flex';
            editControls.style.display = 'none';
            contextTable.classList.remove('editing');
            profileContent.classList.remove('editing');

            // Restore original values
            const tableRows = contextTable.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                const fieldKey = row.dataset.field;
                const valueCell = row.querySelector('.field-value');
                if (valueCell && fieldKey) {
                    const originalValue = originalContextData[fieldKey] || '';
                    let displayValue = fieldKey === 'web' && originalValue ? 
                        `<a href="${originalValue}" target="_blank">${originalValue}</a>` : originalValue;
                    
                    // ‚úÖ Restaurar warning icon si hab√≠a error de extracci√≥n web
                    if (fieldKey === 'web' && originalContextData.website_extraction_status && !originalContextData.website_extraction_status.success) {
                        const warningIcon = `<span class="web-warning-icon">&#9888;</span>`;
                        displayValue += ` ${warningIcon}`;
                    }
                    
                    valueCell.innerHTML = displayValue;
                }
            });

            // Restore profile content
            profileContent.innerHTML = originalContextData.perfil_regulatorio || '<p>No se ha generado un perfil regulatorio.</p>';
        }

                 async function saveContextChanges() {
             try {
                 saveBtn.disabled = true;
                 saveBtn.innerHTML = '<div class="button-spinner"></div>';
                 saveBtn.style.width = saveBtn.offsetWidth + 'px'; // Prevent button resize

                // Collect updated data
                const updatedData = {};
                const detalleEmpresa = {};
                
                const tableRows = contextTable.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const fieldKey = row.dataset.field;
                    const input = row.querySelector('.editable-field');
                    if (input && fieldKey) {
                        const value = input.value.trim();
                        if (fieldKey === 'sector' || fieldKey === 'actividad') {
                            detalleEmpresa[fieldKey] = value;
                        } else {
                            updatedData[fieldKey] = value;
                        }
                    }
                });

                // Add detalle_empresa if it has content
                if (Object.keys(detalleEmpresa).length > 0) {
                    updatedData.detalle_empresa = detalleEmpresa;
                }

                // Get updated profile content
                const profileTextarea = profileContent.querySelector('.editable-profile');
                if (profileTextarea) {
                    updatedData.perfil_regulatorio = profileTextarea.value.trim();
                }

                // Send to server
                const response = await fetch('/api/update-user-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) {
                    throw new Error('Failed to save changes');
                }

                const result = await response.json();
                
                if (result.success) {
                    // Update original data
                    Object.assign(originalContextData, {
                        ...updatedData,
                        sector: detalleEmpresa.sector || originalContextData.sector,
                        actividad: detalleEmpresa.actividad || originalContextData.actividad
                    });

                    // Exit edit mode and refresh display
                    exitEditMode();
                    
                                         // Show success message briefly
                     saveBtn.innerHTML = '‚úì Guardado';
                     setTimeout(() => {
                         saveBtn.innerHTML = 'Guardar';
                         saveBtn.disabled = false;
                         saveBtn.style.width = 'auto'; // Reset button width
                     }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to save changes');
                }

                         } catch (error) {
                 console.error('Error saving context changes:', error);
                 alert('Error al guardar los cambios. Por favor, int√©ntalo de nuevo.');
                 
                 saveBtn.innerHTML = 'Guardar';
                 saveBtn.disabled = false;
                 saveBtn.style.width = 'auto'; // Reset button width
             }
        }

        function getPlainTextValue(htmlContent) {
            if (!htmlContent) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        
    }

    function populateFuentes(cobertura_legal) {
        const container = document.getElementById('fuentes-container');
        if (!container) return;

        // Check if user has etiquetas_personalizadas and show/hide banner accordingly
        checkAndShowAgentesRegulatoryBanner();

        const fuentesData = {
          "Boletines Europeos, Nacionales y Regionales": {
              "A) Europeos y Nacionales": [
                  { sigla: "DOUE", nombre: "Diario Oficial de la Uni√≥n Europea", tipo: "fuentes-gobierno" },
                  { sigla: "BOE", nombre: "Bolet√≠n Oficial del Estado", tipo: "fuentes-gobierno" },
                 
              ],
              "B) Regionales": [
                  { sigla: "BOPV", nombre: "Bolet√≠n Oficial del Pa√≠s Vasco", tipo: "fuentes-gobierno" },
                  { sigla: "CGCC", nombre: "Consejo de Gobierno Comunidad de Catalunya", tipo: "fuentes-gobierno" },
                  { sigla: "DOGC", nombre: "Diari Oficial de la Generalitat de Catalunya", tipo: "fuentes-gobierno" },
                  { sigla: "DOG", nombre: "Diario Oficial de Galicia", tipo: "fuentes-gobierno" },
                  { sigla: "BOC", nombre: "Bolet√≠n Oficial de Cantabria", tipo: "fuentes-gobierno" },
                  { sigla: "BORM", nombre: "Bolet√≠n Oficial de la Regi√≥n de Murcia", tipo: "fuentes-gobierno" },
                  { sigla: "BOA", nombre: "Bolet√≠n Oficial de Arag√≥n", tipo: "fuentes-gobierno" },
                  { sigla: "BOCM", nombre: "Bolet√≠n Oficial de la Comunidad de Madrid", tipo: "fuentes-gobierno" },
                  { sigla: "DOE", nombre: "Diario Oficial de Extremadura", tipo: "fuentes-gobierno" },
                  { sigla: "BOCYL", nombre: "Bolet√≠n Oficial de Castilla y Le√≥n", tipo: "fuentes-gobierno" },
                  { sigla: "BOJA", nombre: "Bolet√≠n Oficial de la Junta de Andaluc√≠a", tipo: "fuentes-gobierno" },
                  { sigla: "BOIB", nombre: "Bolet√≠n Oficial de las Islas Baleares", tipo: "fuentes-gobierno" },
                  { sigla: "BOPA", nombre: "Bolet√≠n Oficial del Principado de Asturias", tipo: "fuentes-gobierno" },
                  { sigla: "DOGV", nombre: "Diario Oficial de la Generalitat Valenciana", tipo: "fuentes-gobierno" },
                  { sigla: "BOCA", nombre: "Bolet√≠n Oficial de Canarias", tipo: "fuentes-gobierno" },
              ]
          },
          "Reguladores": [
              { sigla: "EBA", nombre: "European Banking Authority", tipo: "fuentes-reguladores" },
              { sigla: "EBA_QA", nombre: "European Banking Authority (QA)", tipo: "fuentes-reguladores" },
              { sigla: "ESMA", nombre: "European Securities and Markets Authority", tipo: "fuentes-reguladores" },
              { sigla: "ESMA_QA", nombre: "European Securities and Markets Authority (QA)", tipo: "fuentes-reguladores" },
              { sigla: "CNMV", nombre: "Comisi√≥n Nacional del Mercado de Valores", tipo: "fuentes-reguladores" },
              { sigla: "INCIBE", nombre: "Instituto Nacional de Ciberseguridad", tipo: "fuentes-reguladores" },
              { sigla: "CNMC", nombre: "Comisi√≥n Nacional de los Mercados y la Competencia", tipo: "fuentes-reguladores" },
              { sigla: "AEPD", nombre: "Agencia Espa√±ola de Protecci√≥n de Datos", tipo: "fuentes-reguladores" },
              { sigla: "NIST", nombre: "National Institute of Standards and Technology", tipo: "fuentes-reguladores" },
              { sigla: "EDPB", nombre: "European Data Protection Board", tipo: "fuentes-reguladores" },
              { sigla: "SEPBLAC", nombre: "Servicio Ejecutivo de la Comisi√≥n de Prevenci√≥n del Blanqueo de Capitales e Infracciones Monetarias", tipo: "fuentes-reguladores" },
              { sigla: "AEPD_guias", nombre: "Agencia Espa√±ola de Protecci√≥n de Datos - Gu√≠as", tipo: "fuentes-reguladores" },

          ],
          "Normativa en tramitaci√≥n": [
            { sigla: "BOCG", nombre: "Bolet√≠n Oficial de las Cortes Generales", tipo: "fuentes-gobierno" },
          ],
          "Comunicados y prensa":[
          { sigla: "CEPC", nombre: "Comisi√≥n Europea Press Corner", tipo: "fuentes-gobierno" },
          { sigla: "NIST_NEWS", nombre: "National Institute of Standards and Technology News", tipo: "fuentes-reguladores" },
          { sigla: "EIOPA_news", nombre: "European Insurance and Occupational Pensions Authority News", tipo: "fuentes-reguladores" },
          { "sigla": "EUROPARL_NOTICIAS", "nombre": "Sala de prensa del Parlamento Europeo", "tipo": "fuentes-gobierno" },
          { "sigla": "CEPC", "nombre": "Sala de prensa de la Comisi√≥n Europea", "tipo": "fuentes-gobierno" },
          { "sigla": "CE_ALL_NOTICIAS", "nombre": "Noticias de la Comisi√≥n Europea", "tipo": "fuentes-gobierno" },
          { "sigla": "DANISH_PRESIDENCY_NOTICIAS", "nombre": "Web de la Presidencia danesa del Consejo de la UE", "tipo": "fuentes-gobierno" },
          ],
          "Ministerios": [
          { "sigla": "MITES_NOTICIAS", "nombre": "Ministerio de Trabajo", "tipo": "fuentes-gobierno" },
          { "sigla": "MITECO_NOTICIAS", "nombre": "Ministerio de Transici√≥n Ecol√≥gica", "tipo": "fuentes-gobierno" },
          { "sigla": "MAPA_NOTICIAS", "nombre": "Ministerio de Agricultura, Pesca y Alimentaci√≥n", "tipo": "fuentes-gobierno" },
          { "sigla": "EXTERIORES_NOTICIAS", "nombre": "Ministerio de Asuntos Exteriores", "tipo": "fuentes-gobierno" },
          { "sigla": "MICIU_NOTICIAS", "nombre": "Ministerio de Ciencia, Innovaci√≥n y Universidades", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_CULTURA_NOTICIAS", "nombre": "Ministerio de Cultura", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_DEFENSA_NOTICIAS", "nombre": "Ministerio de Defensa", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_DCSA_NOTICIAS", "nombre": "Ministerio de Derechos Sociales, Consumo y Agenda 2030", "tipo": "fuentes-gobierno" },
          { "sigla": "MINECO_NOTICIAS", "nombre": "Ministerio de Econom√≠a, Comercio y Empresa", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_EDUCACIONFPYDEPORTES_NOTICIAS", "nombre": "Ministerio de Educaci√≥n", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_HACIENDA_NOTICIAS", "nombre": "Ministerio de Hacienda", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_INDUSTRIAYTURISMO_NOTICIAS", "nombre": "Ministerio de Industria y Turismo", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_INTERIOR_NOTICIAS", "nombre": "Ministerio del Interior", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_JUSTICIA_NOTICIAS", "nombre": "Ministerio de Justicia", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_MPT_NOTICIAS", "nombre": "Ministerio de Pol√≠tica Territorial", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_SANIDAD_NOTICIAS", "nombre": "Ministerio de Sanidad", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_DIGITAL_NOTICIAS", "nombre": "Ministerio de Transformaci√≥n Digital", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_MIVAU_NOTICIAS", "nombre": "Ministerio de Vivienda", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_INCLUSION_NOTICIAS", "nombre": "Ministerio de Inclusi√≥n", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_JUVENTUDEINFANCIA_NOTICIAS", "nombre": "Ministerio de Juventud e Infancia", "tipo": "fuentes-gobierno" },
          { "sigla": "MIN_TRANSPORTES_NOTICIAS", "nombre": "Ministerio de Transportes", "tipo": "fuentes-gobierno" }
        ]
        };
        
        let html = '';
        const itemsPerPage = 4;

        const createGrid = (items, sectionKey) => {
            let gridHtml = `<div class="fuentes-grid-container" data-section="${sectionKey}"><div class="fuentes-grid">`;
            items.forEach(fuente => {
                gridHtml += `<div class="fuente-box" data-sigla="${fuente.sigla}" data-tipo="${fuente.tipo}" data-section="${sectionKey}"><strong>${fuente.sigla}</strong><span>${fuente.nombre}</span></div>`;
            });
            gridHtml += `</div>`;
            // Always add navigation arrows for sections with more than 4 items
            if (items.length > itemsPerPage) {
                gridHtml += `<div class="grid-nav-arrow prev" style="display: none;"><i class="fas fa-chevron-left"></i></div><div class="grid-nav-arrow next"><i class="fas fa-chevron-right"></i></div>`;
            }
            gridHtml += `</div>`;
            return gridHtml;
        };

        for (const sectionTitle in fuentesData) {
            const sectionKey = sectionTitle.toLowerCase().replace(/\s+/g, '-');
            html += `<div class="section-header">`;
            html += `<h3 class="summary-title">${sectionTitle}</h3>`;
            html += `<div class="selected-tags-container" id="selected-tags-${sectionKey}"></div>`;
            // Add save button only for the first section (Boletines)
            if (sectionTitle === "Boletines Europeos, Nacionales y Regionales") {
                html += `<button id="saveFuentesBtn" class="save-fuentes-btn-inline">Guardar</button>`;
                html += `<div id="saveStatus" class="save-status"></div>`;
            }
            html += `</div>`;
            const sectionContent = fuentesData[sectionTitle];

            if (Array.isArray(sectionContent)) { // For Reguladores, Normativa
                html += createGrid(sectionContent, sectionKey);
            } else { // For Boletines with subsections
                for (const subsectionTitle in sectionContent) {
                    html += `<div class="fuentes-subsection">`;
                    const subsectionKey = subsectionTitle.toLowerCase().replace(/[()]/g, '').replace(/\s+/g, '-');
                    html += `<div class="section-header">`;
                    html += `<h4 class="fuentes-subsection-title">${subsectionTitle}</h4>`;
                    html += `<div class="selected-tags-container" id="selected-tags-${subsectionKey}"></div>`;
                    html += `</div>`;
                    html += createGrid(sectionContent[subsectionTitle], subsectionKey);
                    html += `</div>`;
                }
            }
        }
        container.innerHTML = html;

        // Pagination logic - Apply to all grid containers
        document.querySelectorAll('.fuentes-grid-container').forEach(gridContainer => {
            const grid = gridContainer.querySelector('.fuentes-grid');
            const items = Array.from(grid.querySelectorAll('.fuente-box'));
            const prevArrow = gridContainer.querySelector('.prev');
            const nextArrow = gridContainer.querySelector('.next');
            let currentPage = 0;
            const totalItems = items.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            function showPage(page) {
                items.forEach((item, index) => {
                    const isVisible = index >= page * itemsPerPage && index < (page + 1) * itemsPerPage;
                    item.style.display = isVisible ? 'flex' : 'none';
                });

                // Show/hide arrows based on current page and total pages
                if (prevArrow) prevArrow.style.display = page > 0 ? 'flex' : 'none';
                if (nextArrow) nextArrow.style.display = page < totalPages - 1 ? 'flex' : 'none';
            }

            // Initialize first page display
            if (totalItems > 0) {
                showPage(0);
            }

            // Add event listeners for navigation
            if (nextArrow) {
                nextArrow.addEventListener('click', () => {
                    if (currentPage < totalPages - 1) {
                        currentPage++;
                        showPage(currentPage);
                    }
                });
            }
            if (prevArrow) {
                prevArrow.addEventListener('click', () => {
                    if (currentPage > 0) {
                        currentPage--;
                        showPage(currentPage);
                    }
                });
            }
        });

        // Function to update selected tags display
        function updateSelectedTags() {
            // Clear all tag containers
            document.querySelectorAll('.selected-tags-container').forEach(container => {
                container.innerHTML = '';
            });

            // Get all selected boxes and group by section
            const selectedBySection = {};
            document.querySelectorAll('.fuente-box.selected').forEach(box => {
                const sigla = box.dataset.sigla;
                const sectionKey = box.dataset.section;
                
                if (!selectedBySection[sectionKey]) {
                    selectedBySection[sectionKey] = [];
                }
                selectedBySection[sectionKey].push(sigla);
            });

            // Update each section's tags
            Object.keys(selectedBySection).forEach(sectionKey => {
                const container = document.getElementById(`selected-tags-${sectionKey}`);
                if (container) {
                    selectedBySection[sectionKey].forEach(sigla => {
                        const tag = document.createElement('span');
                        tag.className = 'selected-tag';
                        tag.textContent = sigla;
                        container.appendChild(tag);
                    });
                }
            });
        }

        // Add click listeners and pre-select
        // Normalizar las fuentes existentes (convertir todo a may√∫sculas para comparaci√≥n)
        const selectedFuentes = (cobertura_legal?.fuentes_gobierno || 
                               cobertura_legal?.['fuentes-gobierno'] || 
                               cobertura_legal?.fuentes || []).map(f => f.toUpperCase());
        const selectedReguladores = (cobertura_legal?.fuentes_reguladores || 
                                   cobertura_legal?.['fuentes-reguladores'] || 
                                   cobertura_legal?.['fuentes-regulador'] ||  // Para usuarios muy antiguos
                                   cobertura_legal?.reguladores || []).map(f => f.toUpperCase());
        const allSelections = [...selectedFuentes, ...selectedReguladores];

        document.querySelectorAll('.fuente-box').forEach(box => {
            // Comparar en may√∫sculas para evitar problemas de case sensitivity
            if (allSelections.includes(box.dataset.sigla.toUpperCase())) {
                box.classList.add('selected');
            }
            box.addEventListener('click', async () => {
                // If trying to select a new source, check limits
                if (!box.classList.contains('selected')) {
                    try {
                        const response = await fetch('/api/get-user-data');
                        const userData = await response.json();
                        
                        const defaultLimits = getDefaultLimits(userData.subscription_plan || 'plan1');
                        const limitFuentes = userData.limit_fuentes !== undefined ? userData.limit_fuentes : defaultLimits.limit_fuentes;
                        const currentFuentes = (userData.cobertura_legal?.fuentes_gobierno || []).length + 
                                               (userData.cobertura_legal?.fuentes_reguladores || []).length;
                        
                        if (limitFuentes !== null && currentFuentes >= limitFuentes) {
                            alert(`Has alcanzado el l√≠mite de ${limitFuentes} fuentes para tu plan actual. Para seleccionar m√°s fuentes, actualiza tu suscripci√≥n.`);
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking fuentes limits:', error);
                        // Continue anyway if there's an error
                    }
                }
                
                box.classList.toggle('selected');
                updateSelectedTags(); // Update tags when selection changes
            });
        });

        // Initial tags update
        updateSelectedTags();

        // Save button logic
        document.getElementById('saveFuentesBtn').addEventListener('click', () => {
            const saveBtn = document.getElementById('saveFuentesBtn');
            const saveStatus = document.getElementById('saveStatus');
            
            // Clear any previous status and show loader
            saveStatus.textContent = '';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="button-spinner"></div>';
            saveBtn.classList.add('loading');
            
            const newCobertura = {
                'fuentes-gobierno': [],
                'fuentes-reguladores': [],
                'fuentes-tramitacion': [] // This key exists but isn't part of the final payload
            };
            document.querySelectorAll('.fuente-box.selected').forEach(box => {
                const tipo = box.dataset.tipo;
                const sigla = box.dataset.sigla;
                if (newCobertura[tipo]) {
                    newCobertura[tipo].push(sigla);
                }
            });
            
            const finalPayload = {
                cobertura_legal: {
                    fuentes_gobierno: newCobertura['fuentes-gobierno'],
                    fuentes_reguladores: newCobertura['fuentes-reguladores']
                },
                rangos: ["Acuerdos Internacionales","Normativa Europea","Legislacion Nacional","Normativa Reglamentaria","Decisiones Judiciales","Doctrina Administrativa","Comunicados, Guias y Opiniones Consultivas","Consultas Publicas","Normativa en tramitaci√≥n","Otras"]
            };

            fetch('/api/update-user-data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(finalPayload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Show success state
                    saveBtn.classList.remove('loading');
                    saveBtn.innerHTML = '‚úì Guardado';
                    saveBtn.classList.add('success');
                    
                    // Refresh usage tracker after successful save
                    fetch('/api/get-user-data')
                        .then(res => res.json())
                        .then(userData => updateUsageTrackers(userData))
                        .catch(err => console.error('Error updating tracker:', err));
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        saveBtn.innerHTML = 'Guardar';
                        saveBtn.classList.remove('success');
                        saveBtn.disabled = false;
                    }, 2000);
                } else {
                    // Show error
                    saveBtn.classList.remove('loading');
                    saveBtn.innerHTML = 'Guardar';
                    saveStatus.textContent = 'Error, pruebe de nuevo';
                    saveBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error('Error saving fuentes:', err);
                saveBtn.classList.remove('loading');
                saveBtn.innerHTML = 'Guardar';
                saveStatus.textContent = 'Error, pruebe de nuevo';
                saveBtn.disabled = false;
            });
        });
    }

    /* --------- STEP MANAGEMENT --------- */
    const steps = [];
    function clearStepsFrom(index){
      while(steps.length > index){
        const s = steps.pop();
        const removedKey = s.element.dataset.key;
        if(removedKey) delete answerByKey[removedKey];
        s.element.remove();
        answers.splice(index,1);
      }
      // Reset flags based on remaining steps
      motivacionAsked = steps.some(st => st.element.dataset.key === 'motivacion_principal');
      extraInfoAsked = steps.some(st => st.element.dataset.key === 'num_empleados');
      renderSummary();
      updateTrackers();
    }

    function goToStep(idx){
      steps.forEach((st,i)=> st.element.classList.toggle('active', i===idx));
    }

    function createStepElement(questionText){
      const section=document.createElement('section');
      section.className='form-step';
      section.innerHTML=`<div class="step-header"><p class="question-text">${questionText}</p><span class="step-tracker"></span></div>`;
      onboardingForm.appendChild(section);
      steps.push({element:section});
      return section;
    }

    function updateTrackers(){
      // Calculate total steps dynamically based on flow
      const hasOtroEmpresa = steps.some(st => st.element.dataset.key === 'empresa_otro_detalle');
      const TOTAL_STEPS = hasOtroEmpresa ? 6 : 5;
      
      const getStepNumber = (key)=>{
        if(key==='tipo_empresa') return 1;
        if(key==='empresa_otro_detalle') return 2;
        if(key==='motivacion_principal') return hasOtroEmpresa ? 3 : 3;
        if(key==='num_empleados') return hasOtroEmpresa ? 4 : 4;
        if(key==='web_empresa') return hasOtroEmpresa ? 5 : 5;
        return hasOtroEmpresa ? 3 : 2; // Default for other second-level questions
      };
      steps.forEach((s)=>{
        const tracker=s.element.querySelector('.step-tracker');
        if(tracker){
          const num = getStepNumber(s.element.dataset.key);
          tracker.textContent=`${num} de ${TOTAL_STEPS}`;
        }
      });
    }

    function showCustomInput(section, questionText, questionKey, proceedCallback) {
      // Remove existing custom input if any
      const existingCustomInput = section.querySelector('.custom-input-container');
      if (existingCustomInput) {
        existingCustomInput.remove();
      }
      
      // Create custom input container
      const customContainer = document.createElement('div');
      customContainer.className = 'custom-input-container';
      
      // Create input field
      const customInput = document.createElement('input');
      customInput.type = 'text';
      customInput.className = 'input-field';
      customInput.placeholder = 'Especifica tu respuesta...';
      customInput.style.marginBottom = '12px';
      
      // Create confirm button
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'next-btn';
      confirmBtn.textContent = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const customValue = customInput.value.trim();
        if (!customValue) {
          alert('Por favor, introduce una respuesta.');
          return;
        }
        
        // Handle the custom answer
        handleAnswer(section, questionText, customValue);
        proceedCallback(customValue);
      });
      
      // Handle Enter key
      customInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          confirmBtn.click();
        }
      });
      
      // Append to container
      customContainer.appendChild(customInput);
      customContainer.appendChild(confirmBtn);
      
      // Add to section
      section.appendChild(customContainer);
      
      // Focus on input
      setTimeout(() => customInput.focus(), 100);
    }

    function showCustomInputMultiSelect(section, questionText, questionKey, selectedValues, proceedCallback) {
      // Remove existing custom input if any
      const existingCustomInput = section.querySelector('.custom-input-container');
      if (existingCustomInput) {
        existingCustomInput.remove();
      }
      
      // Create custom input container
      const customContainer = document.createElement('div');
      customContainer.className = 'custom-input-container';
      
      // Show selected values (excluding "Otro")
      const otherValues = selectedValues.filter(val => val.toLowerCase() !== 'otro');
      if (otherValues.length > 0) {
        const selectedText = document.createElement('p');
        selectedText.style.fontSize = '14px';
        selectedText.style.color = '#7a8a93';
        selectedText.style.marginBottom = '12px';
        selectedText.textContent = `Seleccionado: ${otherValues.map(val => toTitle(val)).join(', ')}`;
        customContainer.appendChild(selectedText);
      }
      
      // Create input field for custom value
      const customInput = document.createElement('input');
      customInput.type = 'text';
      customInput.className = 'input-field';
      customInput.placeholder = 'Especifica la opci√≥n "Otro"...';
      customInput.style.marginBottom = '12px';
      
      // Create confirm button
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'next-btn';
      confirmBtn.textContent = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const customValue = customInput.value.trim();
        if (!customValue) {
          alert('Por favor, especifica la opci√≥n "Otro".');
          return;
        }
        
        // Combine other selected values with custom value
        const finalValues = [...otherValues.map(val => toTitle(val)), customValue];
        const answerText = finalValues.join(', ');
        
        // Handle the combined answer
        handleAnswer(section, questionText, answerText);
        proceedCallback(null);
      });
      
      // Handle Enter key
      customInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          confirmBtn.click();
        }
      });
      
      // Append to container
      customContainer.appendChild(customInput);
      customContainer.appendChild(confirmBtn);
      
      // Add to section
      section.appendChild(customContainer);
      
      // Focus on input
      setTimeout(() => customInput.focus(), 100);
    }

    function addOptionsStep(questionKey, questionText, optionsArray, currentNode, subtreeMap){
      const section=createStepElement(questionText);
      section.dataset.type='select';
      section.dataset.key=questionKey;

      const userTipo = (answerByKey['tipo_empresa']||'').toLowerCase();
      const previousAnswerDepartamentos = answerByKey['pregunta_origen_interes']||'';
      
      // Define which questions should allow multiple selection
      const isDespachoAreaMulti = userTipo==='despacho' && questionKey==='pregunta_area_practica';
      // For empresa_regulada, both sector and activity questions should be multiselect
      const isEmpresaReguladaSector = userTipo==='empresa_regulada' && questionKey==='pregunta_sector';
      const isEmpresaReguladaActividad = userTipo==='empresa_regulada' && questionKey==='pregunta_actividad';
      const isMotivacionMulti = questionKey==='motivacion_principal';
      const multiSelect = isDespachoAreaMulti || isEmpresaReguladaSector || isEmpresaReguladaActividad || isMotivacionMulti;
      
      // Debug log to verify multiselect detection
      console.log(`Question: ${questionKey}, UserTipo: ${userTipo}, MultiSelect: ${multiSelect}`);

      const optionsWrap=document.createElement('div');
      optionsWrap.className='options';

      if(userTipo==='consultora' && questionKey==='pregunta_especializacion'){
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">¬øEn qu√© tipo de consultor√≠a est√°s especializado?</p>');
      }
      if(userTipo==='despacho' && questionKey==='pregunta_origen_interes'){
        questionText='Departamentos interesados';
        section.querySelector('.question-text').textContent=questionText;
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">Selecciona los departamentos interesados del despacho.</p>');
        optionsArray=['Departamento del conocimiento | Varios departamentos','√Årea pr√°ctica concreta'];
      }
      if(questionKey==='motivacion_principal'){
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">Selecciona uno o m√°s de uno</p>');
      }
      if(questionKey==='pregunta_area_practica'){
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">Selecciona una o m√°s √°reas de pr√°ctica</p>');
      }
      if(questionKey==='pregunta_sector'){
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">Selecciona uno o m√°s sectores</p>');
      }
      if(questionKey==='pregunta_actividad' && userTipo==='empresa_regulada'){
        section.insertAdjacentHTML('beforeend', '<p style="font-size:14px;color:#7a8a93;margin-bottom:18px;">Selecciona una o m√°s actividades</p>');
      }

      // Add "Select All" checkbox for multiselect questions
      if(multiSelect){
        const selectAllContainer = document.createElement('div');
        selectAllContainer.style.marginBottom = '15px';
        selectAllContainer.style.padding = '10px';
        selectAllContainer.style.backgroundColor = '#f8f9fa';
        selectAllContainer.style.borderRadius = '8px';
        selectAllContainer.style.border = '1px solid #e9ecef';
        
        const selectAllCheckbox = document.createElement('input');
        selectAllCheckbox.type = 'checkbox';
        selectAllCheckbox.id = `selectAll_${questionKey}`;
        selectAllCheckbox.style.marginRight = '8px';
        
        const selectAllLabel = document.createElement('label');
        selectAllLabel.htmlFor = `selectAll_${questionKey}`;
        selectAllLabel.textContent = 'Seleccionar todos';
        selectAllLabel.style.fontSize = '14px';
        selectAllLabel.style.fontWeight = '500';
        selectAllLabel.style.cursor = 'pointer';
        selectAllLabel.style.color = 'var(--text-color)';
        
        selectAllContainer.appendChild(selectAllCheckbox);
        selectAllContainer.appendChild(selectAllLabel);
        section.appendChild(selectAllContainer);
        
        // Handle select all functionality
        selectAllCheckbox.addEventListener('change', ()=>{
          const allOptions = section.querySelectorAll('.option-box');
          if(selectAllCheckbox.checked){
            allOptions.forEach(opt => opt.classList.add('selected'));
          } else {
            allOptions.forEach(opt => opt.classList.remove('selected'));
          }
        });
      }

      optionsArray.forEach(opt=>{
        const box=document.createElement('div');
        box.className='option-box';
        let displayText=toTitle(opt);
        if(questionKey==='num_empleados') displayText+= ' empleados';
        box.textContent=displayText;
        box.dataset.value=opt;
        box.addEventListener('click',()=>{
          if(multiSelect){
            box.classList.toggle('selected');
            
            // Update "Select All" checkbox state
            const selectAllCheckbox = section.querySelector(`#selectAll_${questionKey}`);
            if(selectAllCheckbox){
              const allOptions = section.querySelectorAll('.option-box');
              const selectedOptions = section.querySelectorAll('.option-box.selected');
              selectAllCheckbox.checked = allOptions.length === selectedOptions.length;
            }
          } else {
            section.querySelectorAll('.option-box').forEach(o=>o.classList.remove('selected'));
            box.classList.add('selected');
            
            // Check if "Otro" was selected and show custom input
            if(opt.toLowerCase() === 'otro'){
              showCustomInput(section, questionText, questionKey, proceedAfterSelection);
            } else {
              handleAnswer(section, questionText, toTitle(opt));
              proceedAfterSelection(opt);
            }
          }
        });
        optionsWrap.appendChild(box);
      });
      section.appendChild(optionsWrap);

      if(multiSelect){
        const nextBtn=document.createElement('button');
        nextBtn.className='next-btn';
        nextBtn.textContent='Siguiente';
        nextBtn.style.marginTop='18px';
        nextBtn.addEventListener('click',()=>{
          const selectedBoxes=[...section.querySelectorAll('.option-box.selected')];
          if(!selectedBoxes.length) {
            alert('Por favor, selecciona al menos una opci√≥n.');
            return;
          }
          
          const selectedValues = selectedBoxes.map(b=>b.dataset.value);
          const hasOtro = selectedValues.some(val => val.toLowerCase() === 'otro');
          
          if(hasOtro){
            showCustomInputMultiSelect(section, questionText, questionKey, selectedValues, proceedAfterSelection);
          } else {
            const answerText = selectedBoxes.map(b=>toTitle(b.dataset.value)).join(', ');
            handleAnswer(section, questionText, answerText);
            
            // For empresa_regulada multiselect, we need special handling
            if(userTipo==='empresa_regulada' && questionKey==='pregunta_sector'){
              // Pass all selected sectors to continue the flow
              proceedAfterSelection(selectedValues);
            } else {
              proceedAfterSelection(null);
            }
          }
        });
        section.appendChild(nextBtn);
      }
      showOnly(section);
      updateTrackers();

      function proceedAfterSelection(optChosen){
        // Helper function to deep clone objects to avoid mutating the original structure
        const cloneDeep = (obj) => obj ? JSON.parse(JSON.stringify(obj)) : null;
        
        if(questionKey==='tipo_empresa'){
          // Special case for "otro" - go directly to custom input
          if(optChosen && optChosen.toLowerCase() === 'otro'){
            addInputStep('empresa_otro_detalle','Indicanos a que se dedica tu empresa','Describe brevemente la actividad de tu empresa');
            return;
          }
          
          const freshBranch = subtreeMap ? cloneDeep(subtreeMap[optChosen]) : null;
          generateFromNode(freshBranch);
          return;
        }
        if(questionKey==='num_empleados'){
          addInputStep('web_empresa','¬øCu√°l es la p√°gina web de tu empresa?','');
          return;
        }
        
        // Special handling for empresa_regulada multiselect
        if(userTipo==='empresa_regulada' && questionKey==='pregunta_sector' && Array.isArray(optChosen)){
          // Combine activities from all selected sectors
          const combinedActivities = new Set();
          optChosen.forEach(sector => {
            if(subtreeMap && subtreeMap[sector] && subtreeMap[sector].pregunta_actividad){
              subtreeMap[sector].pregunta_actividad.forEach(activity => {
                combinedActivities.add(activity);
              });
            }
          });
          
          if(combinedActivities.size > 0){
            // Create a synthetic node with combined activities
            const syntheticNode = {
              pregunta_actividad: Array.from(combinedActivities).sort()
            };
            generateFromNode(syntheticNode);
            return;
          }
        }
        
        // Get the next branch data without mutating the original
        const nextData = subtreeMap ? cloneDeep(subtreeMap[(optChosen||'')]) : null;
        
        // Clone current node and remove the current question to avoid repeating it
        const currentNodeClone = cloneDeep(currentNode);
        if(currentNodeClone && questionKey in currentNodeClone) {
          delete currentNodeClone[questionKey];
        }
        
        generateFromNode(nextData || currentNodeClone);
      }
    }

    function addInputStep(questionKey, questionText, placeholder){
      const section=createStepElement(questionText);
      section.dataset.type='input';
      section.dataset.key=questionKey;
      
      if(questionKey === 'web_empresa'){
        // Create a container for the URL input with fixed prefix
        const urlContainer = document.createElement('div');
        urlContainer.style.display = 'flex';
        urlContainer.style.alignItems = 'center';
        urlContainer.style.maxWidth = '420px';
        urlContainer.style.margin = '0 auto';
        urlContainer.style.border = '2px solid #e0e0e0';
        urlContainer.style.borderRadius = '10px';
        urlContainer.style.transition = 'border-color 0.2s ease';
        
        // Create the fixed prefix
        const prefix = document.createElement('span');
        prefix.textContent = 'https://';
        prefix.style.padding = '12px 8px 12px 16px';
        prefix.style.fontSize = '15px';
        prefix.style.color = '#7a8a93';
        prefix.style.borderRight = '1px solid #e0e0e0';
        prefix.style.whiteSpace = 'nowrap';
        
        // Create the input field
        const input = document.createElement('input');
        input.type = 'text';
        input.style.flex = '1';
        input.style.padding = '12px 16px 12px 8px';
        input.style.fontSize = '15px';
        input.style.border = 'none';
        input.style.outline = 'none';
        input.style.borderRadius = '0 8px 8px 0';
        input.placeholder = placeholder || 'www.ejemplo.com';
        
        // Focus/blur events for container border
        input.addEventListener('focus', () => {
          urlContainer.style.borderColor = 'var(--primary-color)';
          urlContainer.style.boxShadow = '0 0 0 2px rgba(4,219,141,0.15)';
        });
        input.addEventListener('blur', () => {
          urlContainer.style.borderColor = '#e0e0e0';
          urlContainer.style.boxShadow = 'none';
        });
        
        urlContainer.appendChild(prefix);
        urlContainer.appendChild(input);
        section.appendChild(urlContainer);
      } else {
        section.insertAdjacentHTML('beforeend', `<input type="text" class="input-field" placeholder="${placeholder || ''}">`);
      }
      
      const saveBtn=document.createElement('button');
      if(questionKey === 'web_empresa'){
        saveBtn.className='save-btn web-empresa-btn';
        saveBtn.textContent='Generar perfil';
      } else if(questionKey === 'empresa_otro_detalle'){
        saveBtn.className='save-btn';
        saveBtn.textContent='Siguiente';
      } else {
        saveBtn.className='save-btn';
        saveBtn.textContent='Siguiente';
      }
      const input = section.querySelector('input');
      saveBtn.addEventListener('click',()=>{
        let val=input.value.trim();
        if(!val) return;
        if(questionKey==='web_empresa') {
          // ‚úÖ MEJORA 1: Solo agregar https:// si no est√° presente
          if (!val.match(/^https?:\/\//i)) {
            val = 'https://' + val;
          }
        }
        handleAnswer(section, questionText, val);
        
        // Special handling for "empresa_otro_detalle" - continue to motivacion_principal
        if(questionKey==='empresa_otro_detalle'){
          if(!motivacionAsked){
            motivacionAsked=true;
            addOptionsStep('motivacion_principal','¬øQu√© te interesa?', onboardingStructure.motivacion_principal, null);
          } else if(!extraInfoAsked){
            extraInfoAsked=true;
            addOptionsStep('num_empleados','¬øCu√°l es el tama√±o de tu empresa?', ['0-20','20-100','100-1000','+1000'], null);
          } else {
            finalizeOnboarding();
          }
        } else {
          finalizeOnboarding();
        }
      });
      input.addEventListener('keypress',e=> e.key==='Enter' && saveBtn.click() );
      section.appendChild(saveBtn);
      showOnly(section);
      updateTrackers();
    }

    function showOnly(section){
      steps.forEach(st=>st.element.classList.remove('active'));
      section.classList.add('active');
    }

    function handleAnswer(section, questionText, answerText){
      const idx = steps.findIndex(s=>s.element===section);
      answers[idx] = {question:section.dataset.key, answer:answerText};
      answerByKey[section.dataset.key]=answerText;
      
      // Reset progression flags when going back to certain key steps
      if(section.dataset.key === 'tipo_empresa' || section.dataset.key === 'empresa_otro_detalle'){
        motivacionAsked = false;
        extraInfoAsked  = false;
      }
      
      renderSummary();
      clearStepsFrom(idx+1);
    }

    /* --------- GENERATION LOGIC --------- */
    let motivacionAsked=false;
    let extraInfoAsked=false;

    function generateFirstArrayInNode(node){
      if(!node) return false;
      for(const [k,v] of Object.entries(node)){
        if(Array.isArray(v)){
          addOptionsStep(k,toTitle(k),v,node,null);
          return true;
        }
      }
      return false;
    }

    function generateFromNode(node){
      if(node && Object.keys(node).length===0) node=null;
      if(!node){
        if(!motivacionAsked){
          motivacionAsked=true;
          addOptionsStep('motivacion_principal','¬øQu√© te interesa?', onboardingStructure.motivacion_principal, null);
        } else if(!extraInfoAsked){
          extraInfoAsked=true;
          addOptionsStep('num_empleados','¬øCu√°l es el tama√±o de tu empresa?', ['0-20','20-100','100-1000','+1000'], null);
        } else {
          finalizeOnboarding();
        }
        return;
      }
      
      // First try to find and generate the first array in the current node
      if(generateFirstArrayInNode(node)){ 
        return; 
      }
      
      // Then look for nested objects to continue the flow
      for(const [k,v] of Object.entries(node)){
        if(typeof v==='object' && !Array.isArray(v)){
          // Pass a clean clone to avoid mutations affecting subsequent flows
          const cleanClone = JSON.parse(JSON.stringify(node));
          addOptionsStep(k,toTitle(k),Object.keys(v),cleanClone,v);
          return;
        }
      }
    }

    function finalizeOnboarding(){
      if (onboardingForm) onboardingForm.style.display = 'none';
      if (summaryContainer) summaryContainer.classList.add('fading-out');
      
      if(completionMessage){
        completionMessage.innerHTML = '<div class="spinner" style="margin:20px auto;"></div><p style="margin-top:12px;font-weight:500;color:var(--text-color);">Creando perfil regulatorio‚Ä¶</p>';
        completionMessage.style.display = 'block';
      }

      const answersPayload = window.onboardingAnswers || {};
      const knownKeys = ['tipo_empresa', 'motivacion_principal', 'num_empleados', 'web_empresa'];
      const detailKeys = Object.keys(answersPayload).filter(k => !knownKeys.includes(k));
      const detalle_empresa = {};
      if (detailKeys.length > 0 && answersPayload[detailKeys[0]]) detalle_empresa.sector = answersPayload[detailKeys[0]];
      if (detailKeys.length > 1 && answersPayload[detailKeys[1]]) detalle_empresa.actividad = answersPayload[detailKeys[1]];

      const onboardingDataToSave = {
        tipo_empresa: answersPayload['tipo_empresa'],
        interes: answersPayload['motivacion_principal'],
        tama√±o_empresa: answersPayload['num_empleados'],
        web: answersPayload['web_empresa'],
        detalle_empresa: detalle_empresa
      };

      fetch('/api/save-onboarding-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(onboardingDataToSave)
      }).catch(err => console.error('Could not save onboarding data:', err));

      fetch('/api/regulatory-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers: answersPayload })
      })
      .then(res => res.json())
      .then(data => {
        // ‚úÖ DEBUG: Log received data
        console.log('üì• Received regulatory profile data:', {
          has_html_response: !!data.html_response,
          website_extraction_status: data.website_extraction_status
        });
        
        if(data && data.html_response){
          // ‚úÖ MEJORA 2: Incluir estado de extracci√≥n web en finalData
          const finalData = { 
            ...onboardingDataToSave, 
            perfil_regulatorio: data.html_response,
            website_extraction_status: data.website_extraction_status || { success: true, error: null }
          };
          
          // ‚úÖ DEBUG: Log finalData being sent to renderFinalView
          console.log('üîÑ Calling renderFinalView with finalData:', {
            has_website_extraction_status: !!finalData.website_extraction_status,
            extraction_success: finalData.website_extraction_status?.success,
            extraction_error: finalData.website_extraction_status?.error
          });
          
          fetch('/api/save-regulatory-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              perfil_regulatorio: data.html_response,
              website_extraction_status: data.website_extraction_status
            })
          }).catch(err => console.error('Could not save regulatory profile:', err));
          
          setTimeout(() => {
              if (completionMessage) completionMessage.style.display = 'none';
              if (summaryContainer) summaryContainer.style.display = 'none';
              renderFinalView(finalData);
              if (profileView) profileView.style.display = 'block';
          }, 400);

        } else {
          completionMessage.innerHTML = '<p style="color:red;">No se pudo generar el perfil regulatorio.</p>';
        }
      })
      .catch(err => {
        console.error('Error generando perfil regulatorio:', err);
        completionMessage.innerHTML = '<p style="color:red;">Ocurri√≥ un error generando el perfil regulatorio.</p>';
      });
    }

    /* --------- BOOTSTRAP --------- */
    function startOnboarding(){
      if (onboardingStructure && onboardingStructure.tipo_empresa) {
        generateFromNode({tipo_empresa:onboardingStructure.tipo_empresa});
      }
    }

    function openAgentDetail(agentKey, xml){
      const overlay = document.getElementById('agentDetailOverlay');
      const title = document.getElementById('agentModalTitle');
      const titleText = document.getElementById('agentTitleText');
      const editNameBtn = document.getElementById('editAgentNameBtn');
      const ctxInput = document.getElementById('agentContexto');
      const objInput = document.getElementById('agentObjetivo');
      const contInput = document.getElementById('agentContenido');
      const noInclInput = document.getElementById('agentNoIncluidos');
      const saveBtn = document.getElementById('saveAgentChangesBtn');
      const closeBtn = document.getElementById('closeAgentModal');

      const vars = parseEtiquetaDefinition(xml);
      titleText.textContent = vars.NombreEtiqueta || agentKey;
      ctxInput.value = vars.Contexto || '';
      objInput.value = vars.Objetivo || '';
      contInput.value = vars.Contenido || '';
      noInclInput.value = vars.DocumentosNoIncluidos || '';

      // Inputs editables por defecto
      const setDisabled = (disabled)=>{
        [ctxInput, objInput, contInput, noInclInput].forEach(el=>{
          el.disabled = disabled;
          if(el.tagName === 'TEXTAREA') el.readOnly = disabled;
        });
      };
      setDisabled(false);
      saveBtn.disabled = true;

      AGENTS_STATE.currentAgentKey = agentKey;
      AGENTS_STATE.originalXml = xml;
      AGENTS_STATE.originalVars = vars;
      AGENTS_STATE.isDirty = false;
      AGENTS_STATE.isEditing = true; // siempre en modo edici√≥n

      const markDirty = ()=>{
        AGENTS_STATE.isDirty = true;
        saveBtn.disabled = false;
      };
      [ctxInput, objInput, contInput, noInclInput].forEach(el=>{ el.oninput = markDirty; });

      // Edici√≥n de nombre en el t√≠tulo
      if (editNameBtn){
        editNameBtn.onclick = ()=>{
          // Cambiar a modo edici√≥n inline del t√≠tulo (usar span actual para evitar referencias obsoletas)
          const spanNow = document.getElementById('agentTitleText');
          const current = (spanNow?.textContent) || '';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = current;
          input.className = 'product-input';
          input.style.height = '32px';
          input.style.fontSize = '16px';
          input.style.padding = '6px 10px';
          input.style.marginLeft = '0';
          // Reemplazar el span por el input temporalmente
          (spanNow || titleText).replaceWith(input);
          input.focus();
          const commit = ()=>{
            const trimmed = (input.value || '').trim();
            const newSpan = document.createElement('span');
            newSpan.id = 'agentTitleText';
            newSpan.textContent = trimmed || current;
            input.replaceWith(newSpan);
            // Actualizar referencia local y marcar dirty si cambi√≥
            if ((trimmed || current) !== current) {
              AGENTS_STATE.isDirty = true;
              const saveBtn = document.getElementById('saveAgentChangesBtn');
              if (saveBtn) saveBtn.disabled = false;
            }
          };
          input.addEventListener('blur', commit);
          input.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter'){ e.preventDefault(); input.blur(); }
            if(e.key === 'Escape'){ input.value = current; input.blur(); }
          });
        };
      }

      saveBtn.onclick = ()=> {
        // Cambio inmediato del bot√≥n ANTES de cualquier await
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="button-spinner"></div> Guardando...';
        saveAgentChanges(false, saveBtn);
      };
      closeBtn.onclick = ()=> attemptCloseAgentModal();

      overlay.style.display = 'flex';
    }

    function attemptCloseAgentModal(){
      if(AGENTS_STATE.isEditing && AGENTS_STATE.isDirty){
        const confirmOverlay = document.getElementById('unsavedConfirmOverlay');
        const discardBtn = document.getElementById('discardChangesBtn');
        const saveAndCloseBtn = document.getElementById('saveAndCloseBtn');
        const closeConfirmBtn = document.getElementById('closeUnsavedConfirm');
        confirmOverlay.style.display = 'flex';
        discardBtn.onclick = ()=>{ confirmOverlay.style.display='none'; closeAgentOverlay(); };
        saveAndCloseBtn.textContent = 'Guardar';
        saveAndCloseBtn.style.background = '#0b2431';
        saveAndCloseBtn.onclick = async ()=>{
          // Cambio inmediato del bot√≥n ANTES de cualquier await
          saveAndCloseBtn.disabled = true;
          saveAndCloseBtn.innerHTML = '<div class="button-spinner"></div> Guardando...';
          try {
            await saveAgentChanges(true, saveAndCloseBtn);
            // Mostrar tick por 1 segundo antes de cerrar
            saveAndCloseBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              confirmOverlay.style.display='none';
              // Mostrar toast tras cerrar el modal de confirmaci√≥n
              showAgentsToast('Agente actualizado correctamente', 'success');
              // NO cerrar el modal principal, mantenerlo abierto para seguir editando
            }, 1000);
          } catch(err) {
            console.error('Error saving from confirm modal:', err);
            saveAndCloseBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
            // Mostrar toast de error tras 1s
            setTimeout(() => {
              showAgentsToast('Problema actualizando el agente, pruebe de nuevo por favor', 'error');
            }, 1000);
          }
          saveAndCloseBtn.disabled = false;
        };
        closeConfirmBtn.onclick = ()=>{ confirmOverlay.style.display='none'; };
      } else {
        closeAgentOverlay();
      }
    }

    function closeAgentOverlay(){
      const overlay = document.getElementById('agentDetailOverlay');
      const saveBtn = document.getElementById('saveAgentChangesBtn');
      AGENTS_STATE.currentAgentKey = null;
      AGENTS_STATE.originalXml = '';
      AGENTS_STATE.originalVars = null;
      AGENTS_STATE.isDirty = false;
      AGENTS_STATE.isEditing = false;
      if(saveBtn) saveBtn.disabled = true;
      overlay.style.display = 'none';
    }

    function showAgentsToast(message, type){
      const el = document.getElementById('agentsToast');
      if(!el) return;
      // reset base styles
      el.style.display = 'flex';
      el.style.background = type === 'error' ? '#fff9e6' : '#e8f5e8';
      el.style.border = type === 'error' ? '1px solid #ff9800' : '1px solid var(--primary-color)';
      el.style.color = 'var(--dark-color)';
      el.innerHTML = type === 'error' ? '‚ö†Ô∏è ' + message : '‚úì ' + message;
      setTimeout(()=>{ el.style.display = 'none'; }, 2000);
    }

    async function saveAgentChanges(closeAfterSave, triggerBtn){
      try{
        if (AGENTS_STATE.isSaving) return; // prevent duplicate saves
        AGENTS_STATE.isSaving = true;
        const titleText = document.getElementById('agentTitleText');
        const ctxInput = document.getElementById('agentContexto');
        const objInput = document.getElementById('agentObjetivo');
        const contInput = document.getElementById('agentContenido');
        const noInclInput = document.getElementById('agentNoIncluidos');
        const saveBtn = document.getElementById('saveAgentChangesBtn');

        const newVars = {
          NombreEtiqueta: (titleText.textContent||'').trim(),
          tipo: '',
          Contexto: (ctxInput.value||'').trim(),
          Objetivo: (objInput.value||'').trim(),
          Contenido: (contInput.value||'').trim(),
          DocumentosNoIncluidos: (noInclInput.value||'').trim()
        };

        if(!newVars.NombreEtiqueta){
          alert('El nombre del agente es obligatorio.');
          AGENTS_STATE.isSaving = false;
          const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
          if(btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = false; }
          return;
        }

        const newXml = buildEtiquetaXml(newVars);
        const response = await fetch('/api/get-user-data');
        const userData = await response.json();
        const etiquetas = userData.etiquetas_personalizadas || {};

        const oldKey = AGENTS_STATE.currentAgentKey;
        const newKey = newVars.NombreEtiqueta;
        if(oldKey !== newKey){ delete etiquetas[oldKey]; }
        etiquetas[newKey] = newXml;



        const updateResponse = await fetch('/api/update-user-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ etiquetas_personalizadas: etiquetas })
        });
        if(!updateResponse.ok) throw new Error('HTTP '+updateResponse.status);

        AGENTS_STATE.isDirty = false;
        // Mantener isEditing = true para que los campos sigan editables
        // AGENTS_STATE.isEditing = false;
        AGENTS_STATE.currentAgentKey = newKey;
        AGENTS_STATE.originalXml = newXml;
        AGENTS_STATE.originalVars = newVars;

        await loadExistingAgents();

        // NO bloquear campos despu√©s de guardar, mantener editables
        // const setDisabled = (disabled)=>{
        //   [ctxInput, objInput, contInput, noInclInput].forEach(el=>{ el.disabled = disabled; if(el.tagName==='TEXTAREA') el.readOnly = disabled; });
        // };
        // setDisabled(true);
        const titleSpan = document.getElementById('agentTitleText'); if (titleSpan) { titleSpan.textContent = newVars.NombreEtiqueta; }

        const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
        if (btn){
          btn.innerHTML = '<i class="fas fa-check"></i>';
        }
        // Mostrar toast 1s despu√©s
        if (!closeAfterSave) {
          // Solo mostrar toast si NO viene del modal de confirmaci√≥n
          setTimeout(()=>{
            showAgentsToast('Agente actualizado correctamente', 'success');
            // Revertir bot√≥n a Guardar tras ocultar toast (2s)
            setTimeout(()=>{
              if (btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = true; }
              // Mantener estado de edici√≥n activo tras guardar
              AGENTS_STATE.isEditing = true;
              AGENTS_STATE.isDirty = false;
            }, 2000);
          }, 1000);
        } else {
          // Para el modal de confirmaci√≥n, solo mantener estado activo
          AGENTS_STATE.isEditing = true;
          AGENTS_STATE.isDirty = false;
        }

        // No cerrar el modal autom√°ticamente
        AGENTS_STATE.isSaving = false;
      }catch(err){
        console.error('Error al guardar el agente:', err);
        const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
        if(btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = false; }
        // Mostrar toast 1s despu√©s
        setTimeout(()=>{
          showAgentsToast('Problema actualizando el agente, pruebe de nuevo por favor', 'error');
          // No deshabilitamos el bot√≥n en error
        }, 1000);
        AGENTS_STATE.isSaving = false;
      }
    }

    function showGeneratedAgent(agentData){
      if(agentData && agentData.etiqueta_personalizada){
        setTimeout(()=> loadExistingAgents(), 100);
        setTimeout(()=>{
          const configMenu = document.querySelector('.config-menu');
          if(configMenu) configMenu.scrollIntoView({behavior:'smooth', block:'start'});
        }, 200);
      }
    }
    // Expose agents functions globally
    window.openAgentDetail = openAgentDetail;
    window.saveAgentChanges = saveAgentChanges;
    window.attemptCloseAgentModal = attemptCloseAgentModal;
    window.closeAgentOverlay = closeAgentOverlay;

    function openNewAgentModal(){
      const overlay = document.getElementById('agentDetailOverlay');
      const title = document.getElementById('agentModalTitle');
      const titleText = document.getElementById('agentTitleText');
      const editNameBtn = document.getElementById('editAgentNameBtn');
      const ctxInput = document.getElementById('agentContexto');
      const objInput = document.getElementById('agentObjetivo');
      const contInput = document.getElementById('agentContenido');
      const noInclInput = document.getElementById('agentNoIncluidos');
      const saveBtn = document.getElementById('saveAgentChangesBtn');
      const closeBtn = document.getElementById('closeAgentModal');

      // Set placeholders based on Protecci√≥n de Datos example
      titleText.textContent = 'Protecci√≥n de Datos';
      ctxInput.value = '';
      ctxInput.placeholder = 'Ejemplo: Es una empresa del sector sanitario que presta servicios m√©dicos y asistenciales.';
      objInput.value = '';
      objInput.placeholder = 'Ejemplo: Detectar novedades normativas relevantes en protecci√≥n de datos e IA';
      contInput.value = '';
      contInput.placeholder = `Ejemplo:  Se debe etiquetar el <DOCUMENTO> si cumple al menos uno de los siguientes supuestos:
a) Impone nuevas obligaciones, prohibiciones o medidas que obliguen a empresas a adaptar su operativa o sistemas.
b) Establece sanciones econ√≥micas o decisiones judiciales en materia de protecci√≥n de datos.
c) Es una ley general u org√°nica relevante para la etiqueta
d) Establece novedades normativas en materia de datos sanitarios.
e) Establece una recomendaci√≥n o gu√≠a de mejores pr√°cticas relevantes para protecci√≥n de datos o aplicaci√≥n de la IA.`;
      noInclInput.value = '';
      noInclInput.placeholder = `Ejemplo: EL <DOCUMENTO> No DEBE SER ETIQUETADO por esta etiqueta SI CUMPLE ALGUNO DE LOS SIGUIENTES SUPUESTOS:
Lista exhaustiva (no ampliar):
a) Nombramientos o ceses individuales de Delegados de Protecci√≥n de Datos (DPO).
b) Convenios o resoluciones no sancionadoras que afectan a particulares concretos, empresas concretas o interadministrativos sin efectos jur√≠dicos generales
c) Subvenciones sin impacto en la regulaci√≥n del tratamiento de datos.
d) Documentos de otra materia cuya "inclusi√≥n" derive solo de menciones tangenciales al RGPD/LOPDGDD.`;

      // Enable all inputs for creation
      [ctxInput, objInput, contInput, noInclInput].forEach(el=>{
        el.disabled = false;
        if(el.tagName === 'TEXTAREA') el.readOnly = false;
      });
      saveBtn.disabled = false;

      // Set state for new agent creation
      AGENTS_STATE.currentAgentKey = null; // null indicates new agent
      AGENTS_STATE.originalXml = '';
      AGENTS_STATE.originalVars = null;
      AGENTS_STATE.isDirty = false;
      AGENTS_STATE.isEditing = true;

      const markDirty = ()=>{
        AGENTS_STATE.isDirty = true;
        saveBtn.disabled = false;
      };
      [ctxInput, objInput, contInput, noInclInput].forEach(el=>{ el.oninput = markDirty; });

      // Edici√≥n de nombre en el t√≠tulo
      if (editNameBtn){
        editNameBtn.onclick = ()=>{
          const spanNow = document.getElementById('agentTitleText');
          const current = (spanNow?.textContent) || '';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = current;
          input.className = 'product-input';
          input.style.height = '32px';
          input.style.fontSize = '16px';
          input.style.padding = '6px 10px';
          input.style.marginLeft = '0';
          (spanNow || titleText).replaceWith(input);
          input.focus();
          const commit = ()=>{
            const trimmed = (input.value || '').trim();
            const newSpan = document.createElement('span');
            newSpan.id = 'agentTitleText';
            newSpan.textContent = trimmed || current;
            input.replaceWith(newSpan);
            if ((trimmed || current) !== current) {
              AGENTS_STATE.isDirty = true;
              const saveBtn = document.getElementById('saveAgentChangesBtn');
              if (saveBtn) saveBtn.disabled = false;
            }
          };
          input.addEventListener('blur', commit);
          input.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter'){ e.preventDefault(); input.blur(); }
            if(e.key === 'Escape'){ input.value = current; input.blur(); }
          });
        };
      }

      saveBtn.onclick = ()=> {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="button-spinner"></div> Guardando...';
        saveNewAgent(saveBtn);
      };
      closeBtn.onclick = ()=> attemptCloseAgentModal();

      overlay.style.display = 'flex';
    }

    async function saveNewAgent(triggerBtn){
      try{
        if (AGENTS_STATE.isSaving) return;
        AGENTS_STATE.isSaving = true;
        const titleText = document.getElementById('agentTitleText');
        const ctxInput = document.getElementById('agentContexto');
        const objInput = document.getElementById('agentObjetivo');
        const contInput = document.getElementById('agentContenido');
        const noInclInput = document.getElementById('agentNoIncluidos');

        const newVars = {
          NombreEtiqueta: (titleText.textContent||'').trim(),
          tipo: '',
          Contexto: (ctxInput.value||'').trim(),
          Objetivo: (objInput.value||'').trim(),
          Contenido: (contInput.value||'').trim(),
          DocumentosNoIncluidos: (noInclInput.value||'').trim()
        };

        if(!newVars.NombreEtiqueta){
          alert('El nombre del agente es obligatorio.');
          AGENTS_STATE.isSaving = false;
          const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
          if(btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = false; }
          return;
        }

        const newXml = buildEtiquetaXml(newVars);
        const response = await fetch('/api/get-user-data');
        const userData = await response.json();
        const etiquetas = userData.etiquetas_personalizadas || {};

        const newKey = newVars.NombreEtiqueta;
        etiquetas[newKey] = newXml;

        const updateResponse = await fetch('/api/update-user-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ etiquetas_personalizadas: etiquetas })
        });
        if(!updateResponse.ok) throw new Error('HTTP '+updateResponse.status);

        AGENTS_STATE.isDirty = false;
        AGENTS_STATE.currentAgentKey = newKey;
        AGENTS_STATE.originalXml = newXml;
        AGENTS_STATE.originalVars = newVars;

        await loadExistingAgents();

        const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
        if (btn){
          btn.innerHTML = '<i class="fas fa-check"></i>';
        }
        setTimeout(()=>{
          showAgentsToast('Agente creado correctamente', 'success');
          setTimeout(()=>{
            if (btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = true; }
            closeAgentOverlay(); // Cerrar modal tras crear
          }, 2000);
        }, 1000);

        AGENTS_STATE.isSaving = false;
      }catch(err){
        console.error('Error al crear el agente:', err);
        const btn = triggerBtn || document.getElementById('saveAgentChangesBtn');
        if(btn){ btn.innerHTML = '<i class="fas fa-save"></i> Guardar'; btn.disabled = false; }
        setTimeout(()=>{
          showAgentsToast('Problema creando el agente, pruebe de nuevo por favor', 'error');
        }, 1000);
        AGENTS_STATE.isSaving = false;
      }
    }

    // Expose new agent creation functions globally
    window.openNewAgentModal = openNewAgentModal;
    window.saveNewAgent = saveNewAgent;
  })();
  </script>
  

</body>
</html>
