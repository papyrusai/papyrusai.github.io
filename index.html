<!DOCTYPE html>
<html>
<head>
  <title>Papyrus App</title>
  <link rel="icon" href="assets/papyrus_logo.png" type="image/png"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700&display=swap">
  <link rel="stylesheet" type="text/css" href="styles/login.css" />
  <link rel="stylesheet" type="text/css" href="styles/menu_index.css" />
  <style>
    /* Prevent zoom on input focus */
    input[type="text"],
    input[type="email"],
    input[type="url"],
    input[type="search"],
    input[type="password"],
    textarea,
    select {
      font-size: 16px !important; /* Minimum font size to prevent zoom on iOS */
    }
  </style>
</head>
<body>
  <nav class="navbar login">
    <div class="logo">
      <a href="https://www.papyrus-ai.com/" target="_blank">
        <img src="assets/papyrus_logo.png" alt="Papyrus Logo">
      </a>
    </div>
    <button class="hamburger login" onclick="toggleMenu()">☰</button> 
    <ul class="menu index">
      <li><a href="https://papyrus-ai.com/">WEB</a></li>
      <li><a href="https://app.papyrus-ai.com/profile">PANEL DE CONTROL</a></li>
      <li><a href="http://app.papyrus-ai.com/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
      <li><a href="https://papyrus-ai.com/pages/contact-1">AYUDA</a></li>
    </ul>
  </nav>

  <section class="login-form">
    <div class="container">
      <div class="login-section">
        <div class="logo">
          <a href="https://www.papyrus-ai.com/" target="_blank">
            <img class="login-image" src="assets/papyrus_app.png" alt="Papyrus Logo">
          </a>
        </div>
        <h1 id="form-title">Inicia Sesión</h1>

        <!-- Google Login -->
        <a id="google-login-btn" class="google-login" href="/auth/google" onclick="showLoading()">
          <div id="google-login">
            <img src="assets/google_trans-removebg-preview.png" alt="Google Logo">
            <span>Continuar con Google</span>
          </div>
          <span id="loading-icon" style="display: none;">
            <div class="loader-google"></div>
          </span>
        </a>

        <!-- Login Form -->
        <div id="login-form">
          <div class="divider">
            <span>O con email y contraseña</span>
          </div>
          <form id="loginForm">
            <input type="email" name="email" placeholder="Email" required>
            <input type="password" name="password" placeholder="Contraseña" required>
            <button type="submit" id="loginSubmitBtn">Iniciar Sesión</button>
          </form>          
          <div id="loginError" class="error-message"></div>
          <p>¿No tienes cuenta? <span class="toggle-link" onclick="toggleForm()">Regístrate</span></p>
        </div>
        
        <!-- Registration Form -->
        <div id="register-form" class="hidden">
          <div class="divider">
            <span>Regístrate con email y contraseña</span>
          </div>
          <form id="registrationForm">
            <input type="email" name="email" placeholder="Email" required>
            <input type="password" id="regPassword" name="password" placeholder="Contraseña" required>
            <input type="password" id="regConfirm" name="confirmPassword" placeholder="Confirmar Contraseña" required>
            <button type="submit" id="registerSubmitBtn">Registrarse</button>
          </form>
          
          <div id="registrationError" class="error-message"></div>
          <p>¿Ya tienes cuenta? <span class="toggle-link" onclick="toggleForm()">Inicia Sesión</span></p>
        </div>
      </div>

      <div class="info-section">
        <h2>Recibe acceso gratuito a Alertas Normativas</h2>
        <p>Filtra de manera automática todo el contenido normativo con nuestra IA</p>
        <p>Recibe alertas, resúmenes y gráficos <strong>personalizados</strong>.</p>
      </div>
    </div>
  </section>

  <script>
    // Toggle between login and registration forms
    function toggleForm() {
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const formTitle = document.getElementById('form-title');
      
      if (loginForm.classList.contains('hidden')) {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        formTitle.textContent = "Inicia Sesión";
      } else {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
        formTitle.textContent = "Regístrate";
      }
      
      // Clear error messages when toggling
      document.getElementById('loginError').textContent = "";
      document.getElementById('registrationError').textContent = "";
    }

    // Client-side validation for registration form
    function validateRegistration() {
      const password = document.getElementById('regPassword').value;
      const confirm = document.getElementById('regConfirm').value;
      const errorDiv = document.getElementById('registrationError');
      
      // Reset error message
      errorDiv.textContent = "";
      
      // Check that both passwords match
      if (password !== confirm) {
        errorDiv.textContent = "Las contraseñas no coinciden.";
        return false;
      }
      
      // Check length (more than 6 characters)
      if (password.length < 7) {
        errorDiv.textContent = "La contraseña debe tener al menos 7 caracteres.";
        return false;
      }
      
      // Check for at least one special character
      const specialCharRegex = /[!@#$%^&*(),.?":{}|<>]/;
      if (!specialCharRegex.test(password)) {
        errorDiv.textContent = "La contraseña debe contener al menos un carácter especial.";
        return false;
      }
      
      return true;
    }

    // Global variable to prevent multiple submissions
    let isSubmitting = false;
    
    // Handle registration form submission via AJAX
    async function handleRegistrationSubmit(event) {
      event.preventDefault();
      
      // Prevent multiple submissions
      if (isSubmitting) return false;
      isSubmitting = true;
      
      const errorDiv = document.getElementById('registrationError');
      errorDiv.textContent = "";
      
      if (!validateRegistration()) {
        isSubmitting = false;
        return false;
      }

      const form = document.getElementById('registrationForm');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => data[key] = value);
      
      // Show loader in the registration button
      const registerSubmitBtn = document.getElementById('registerSubmitBtn');
      const originalText = registerSubmitBtn.innerHTML;
      registerSubmitBtn.disabled = true;
      registerSubmitBtn.innerHTML = '<div class="loader"></div>';
      
      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          const errorResponse = await response.json();
          errorDiv.textContent = errorResponse.error || "Error en el registro. Inténtalo de nuevo.";
          registerSubmitBtn.disabled = false;
          registerSubmitBtn.innerHTML = originalText;
          isSubmitting = false;
          return false;
        } else {
          const result = await response.json();
          window.location.href = result.redirectUrl;
        }
      } catch (err) {
        errorDiv.textContent = "Error en el registro. Inténtalo de nuevo.";
        console.error(err);
        registerSubmitBtn.disabled = false;
        registerSubmitBtn.innerHTML = originalText;
        isSubmitting = false;
      }
      
      return false;
    }

    // Handle login form submission via AJAX
    async function handleLoginSubmit(event) {
      event.preventDefault();
      
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = "";
      
      const form = document.getElementById('loginForm');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => data[key] = value);

      // Show loader in the button
      const loginSubmitBtn = document.getElementById('loginSubmitBtn');
      const originalText = loginSubmitBtn.innerHTML;
      loginSubmitBtn.disabled = true;
      loginSubmitBtn.innerHTML = '<div class="loader"></div>';

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          const result = await response.json();
          window.location.href = result.redirectUrl;
        } else {
          const errorData = await response.json();
          errorDiv.textContent = errorData.error || "No existe un usuario con ese correo, por favor regístrate";
          loginSubmitBtn.disabled = false;
          loginSubmitBtn.innerHTML = originalText;
        }
      } catch (err) {
        errorDiv.textContent = "Error en el inicio de sesión. Inténtalo de nuevo.";
        console.error(err);
        loginSubmitBtn.disabled = false;
        loginSubmitBtn.innerHTML = originalText;
      }
      
      return false;
    }

    // Attach event listeners to the forms
    document.getElementById('registrationForm').addEventListener('submit', handleRegistrationSubmit);
    document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);

    // Functions for Google login and loading indicator
    function resetLoginButton() {
      const googleLoginText = document.getElementById('google-login');
      const loadingIcon = document.getElementById('loading-icon');
      const loginButton = document.getElementById('google-login-btn');

      if (googleLoginText) {
        googleLoginText.style.display = '';
      }
      
      if (loadingIcon) {
        loadingIcon.style.display = 'none';
      }
      
      if (loginButton) {
        loginButton.style.pointerEvents = 'auto';
      }
    }

    function showLoading() {
      const googleLoginText = document.getElementById('google-login');
      const loadingIcon = document.getElementById('loading-icon');
      
      if (googleLoginText) {
        googleLoginText.style.display = 'none';
      }
      
      if (loadingIcon) {
        loadingIcon.style.display = 'inline-block';
      }
      
      const loginButton = document.getElementById('google-login-btn');
      if (loginButton) {
        loginButton.style.pointerEvents = 'none';
      }
    }

    // Reset button state when page is shown
    window.addEventListener('pageshow', () => {
      resetLoginButton();
    });

    // Toggle menu for mobile view
    function toggleMenu() {
      const menu = document.querySelector('.menu');
      menu.classList.toggle('active');
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.menu');
      const hamburger = document.querySelector('.hamburger');
      
      if (menu && hamburger && !menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.classList.remove('active');
      }
    });
  </script>
</body>
</html>
