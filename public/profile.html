<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="icon" href="assets/papyrus_logo.png" type="image/png"> 

  <!-- Font Awesome + Chart.js + Basic CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>

  <!-- Your existing CSS files -->
  <link rel="stylesheet" type="text/css" href="styles/styles.css" />
  <link rel="stylesheet" type="text/css" href="styles/menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
  <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
  <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
  <link rel="stylesheet" type="text/css" href="styles/mobile.css" />

  <style>
    /* Loader overlay styling */
    #pageLoaderOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .page-loader {
      width: 50px; height: 50px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Dropdown styling for multi-check logic */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropbtn {
      cursor: pointer;
      padding: 8px 12px;
      display: inline-flex;
      align-items: center;
      background-color: #83a300;  /* background color for consistency */
      border-radius: 4px;
      color: #fff;
      border: none; /* remove default border */
    }
    .dropbtn i {
      margin-left: 6px;
    }

    /* The actual dropdown menus */
    #myDropdown,
    #ramaDropdown,
    #boletinDropdown,
    #rangoDropdown {
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      display: none; /* hidden by default */
    }
    #myDropdown.show,
    #ramaDropdown.show,
    #boletinDropdown.show,
    #rangoDropdown.show {
      display: block;
    }

    /* Items inside the dropdown */
    #myDropdown label,
    #ramaDropdown label,
    #boletinDropdown label,
    #rangoDropdown label {
      display: block;
      padding: 4px 2px;
      margin: 0;
      cursor: pointer;
      font-size: 0.85em;
      border-bottom: 1px solid #ddd;
    }
    #myDropdown label:last-child,
    #ramaDropdown label:last-child,
    #boletinDropdown label:last-child,
    #rangoDropdown label:last-child {
      border-bottom: none;
    }
    #myDropdown input[type="checkbox"],
    #ramaDropdown input[type="checkbox"],
    #boletinDropdown input[type="checkbox"],
    #rangoDropdown input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #83a300;
      margin-right: 6px;
    }

    /* Sub-ramas container */
    #subRamasCheckboxContainer {
      margin: 10px 0;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 6px;
      display: none; 
      max-height: 200px;
      overflow-y: auto;
    }
    #subRamasCheckboxContainer label {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
      font-size: 0.85em;
    }
    #subRamasCheckboxContainer input[type="checkbox"] {
      width: 16px;
      height: 16px;
      transform: scale(0.9);
      accent-color: #83a300;
      margin-right: 6px;
    }

    /* Basic layout styling */
    .analytics-label { margin-top: 20px; font-weight: bold; }
    .detalle-cuenta { display: flex; gap: 50px; margin-bottom: 20px; }
    .etiquetas-label { font-weight: bold; }
    .filter-item { margin-bottom: 10px; }
    .filter-section { margin-bottom: 10px; }
    .collectionDocs { margin-top: 10px; }
    .menu.active { display: block; }
  </style>
</head>
<body>
  <!-- Loader overlay -->
  <div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">
      <a href="https://papyrus-ai.com/" target="_blank">
        <img src="assets/papyrus_app.png" alt="Papyrus Logo">
      </a>
    </div>
    <button class="hamburger" onclick="toggleMenu()">☰</button>
    <ul class="menu">
      <li><a href="https://papyrus-ai.com/">WEB</a></li>
      <li><a href="/profile">PANEL DE CONTROL</a></li>
      <li><a href="http://app.papyrus-ai.com/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
      <li><a href="https://papyrus-ai.com/pages/contact-1">AYUDA</a></li>
    </ul>
  </nav>

  <h1>Hola {{name}}</h1>

  <div id="data-container">
    <!-- 1) Show user-subscribed Industries / Ramas in .etiquetas-values -->
    <div class="detalle-cuenta">
      <div>
        <div class="etiquetas-label">Sectores Económicos Suscritos</div>
        <div class="etiquetas-values" id="etiquetasContainer"></div>
      </div>
      <div>
        <div class="etiquetas-label">Ramas Jurídicas Suscritas</div>
        <div class="etiquetas-values" id="ramasContainer"></div>
      </div>
    </div>

    <a href="#" id="editIndustriesLink" class="change-subscription">Editar Suscripción</a>
    <div class="analytics-label busqueda">Búsqueda Avanzada</div>

    <!-- JSON data for industries, ramas, subramas, etc. -->
    <script id="industryTags" type="application/json">{{industry_tags_json}}</script>
    <script id="ramaJuridicas" type="application/json">{{rama_juridicas_json}}</script>
    <script id="userSubRamaMap" type="application/json">
      {
        "Derecho Civil": ["genérico","familia","sucesiones"],
        "Derecho Administrativo": ["genérico","urbanismo","contratación pública"]
      }
    </script>

    <!-- Filter Section -->
    <div id="Filtrar">
      <!-- Sector Económico multi-check -->
      <div class="filter-item">
        <div class="etiquetas-label">Sector Económico</div>
        <div class="dropdown">
          <button class="dropbtn" id="btnSectorEconomico" onclick="toggleIndustryDropdown()">
            <span id="selectedIndustry">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="myDropdown" class="dropdown-content">
            <!-- Will be populated on DOMContentLoaded -->
          </div>
        </div>
      </div>

      <!-- Rama Jurídica multi-check + sub-ramas -->
      <div class="filter-item">
        <div class="etiquetas-label">Rama Jurídica</div>
        <div class="dropdown" style="margin-bottom: 10px;">
          <button class="dropbtn" id="btnRamaJuridica" onclick="toggleRamaDropdown()">
            <span id="selectedRama">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="ramaDropdown" class="dropdown-content">
            <!-- Will be populated on DOMContentLoaded -->
          </div>
        </div>
        <!-- sub-ramas container if a single rama is chosen -->
        <div id="subRamasCheckboxContainer"></div>
      </div>

      <!-- Boletín Oficial multi-check -->
      <div class="filter-item">
        <div class="etiquetas-label">Boletín Oficial</div>
        <div class="dropdown">
          <button class="dropbtn" id="btnBoletin" onclick="toggleBoletinDropdown()">
            <span id="selectedBoletines">Todas</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="boletinDropdown" class="dropdown-content">
            <!-- Populated with "Todos" + bulletins on DOMContentLoaded -->
          </div>
        </div>
      </div>

      <!-- RANGO (Multi-Select) -->
      <div class="filter-item">
        <div class="etiquetas-label">Rango</div>
        <div class="dropdown" style="margin-bottom: 10px;">
          <button class="dropbtn" id="btnRango" onclick="toggleRangoDropdown()">
            <span id="selectedRango">Todos</span>
            <i class="fa fa-caret-down"></i>
          </button>
          <div id="rangoDropdown" class="dropdown-content">
            <label>
              <input type="checkbox" value="Todos" id="chkAllRango" checked onclick="toggleAllRango()">
              Todos
            </label>
            <label><input type="checkbox" value="Leyes" checked onclick="updateSelectedRango()">Leyes</label>
            <label><input type="checkbox" value="Reglamentos" checked onclick="updateSelectedRango()">Reglamentos</label>
            <label><input type="checkbox" value="Decisiones interpretativas y Reguladores" checked onclick="updateSelectedRango()">Decisiones interpretativas y Reguladores</label>
            <label><input type="checkbox" value="Jurisprudencia" checked onclick="updateSelectedRango()">Jurisprudencia</label>
            <label><input type="checkbox" value="Ayudas,subvenciones y premios" checked onclick="updateSelectedRango()">Ayudas,subvenciones y premios</label>
            <label><input type="checkbox" value="Otras" checked onclick="updateSelectedRango()">Otras</label>
          </div>
        </div>
      </div>

      <!-- Date filters -->
      <div class="filter-item">
        <div class="etiquetas-label">Fecha de publicación</div>
        <div class="date-filter">
          <label for="startDate">Desde:</label>
          <input type="date" id="startDate" name="startDate" />
          <label for="endDate">Hasta:</label>
          <input type="date" id="endDate" name="endDate" />
        </div>
      </div>
    </div>

    <div style="text-align: right;">
      <button id="buscarBtn" onclick="handleBuscar()">Buscar</button>
    </div>

    <div class="analytics-label">Estadísticas de la búsqueda</div>
    <div id="loading-icon-chart" style="display: none;">
      <div class="loader"></div>
    </div>
    <div id="chartContainer">
      <canvas id="documentsChart"></canvas>
    </div>

    <div class="analytics-label">Documentos</div>
    <div id="loading-icon" style="display: none;">
      <div class="loader"></div>
    </div>
    <div class="collectionDocs">{{boeDocuments}}</div>
  </div>

  <div class="logout-container">
    <a href="/logout">Logout</a>
  </div>

  <!-- Additional JSON data for the chart and plan, etc. -->
  <script id="monthsData" type="application/json">{{months_json}}</script>
  <script id="countsData" type="application/json">{{counts_json}}</script>
  <script id="userPlan" type="application/json">{{subscription_plan}}</script>
  <script id="startDateInput" type="application/json">{{start_date}}</script>
  <script id="endDateInput" type="application/json">{{end_date}}</script>

  <script>
    // -------------- NAV / HAMBURGER --------------
    function toggleMenu() {
      const menu = document.querySelector('.menu');
      menu.classList.toggle('active');
    }
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.menu');
      const hamburger = document.querySelector('.hamburger');
      if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    // -------------- LOADER / CHART ON LOAD --------------
    document.addEventListener("DOMContentLoaded", () => {
      // Hide the loader overlay
      const loaderOverlay = document.getElementById("pageLoaderOverlay");
      if (loaderOverlay) loaderOverlay.style.display = "none";

      // Fill default date from server
      const startDateInput = JSON.parse(document.getElementById("startDateInput").textContent || '"2024-01-01T00:00:00.000Z"');
      const formattedDate = new Date(startDateInput).toISOString().split('T')[0];
      const startDate = document.getElementById("startDate");
      if (formattedDate && startDate) {
        startDate.value = formattedDate;
      }

      // Chart on first load if monthsData / countsData exist
      const monthsData = JSON.parse(document.getElementById('monthsData').textContent || '[]');
      const countsData = JSON.parse(document.getElementById('countsData').textContent || '[]');
      if (monthsData.length && countsData.length) {
        loadChart(monthsData, countsData);
      }
    });

    // -------------- EDIT SUBSCRIPTION LINK --------------
    document.getElementById('editIndustriesLink').addEventListener('click', function(e){
      e.preventDefault();
      window.location.href = '/suscripcion.html';
    });

    // -------------- Plan logic => disabling bulletins if plan1 --------------
    let userPlan;
    document.addEventListener("DOMContentLoaded", () => {
      userPlan = JSON.parse(document.getElementById("userPlan").textContent || '"plan1"');
    });

    // -------------- LOAD USER DATA --------------
    let userIndustries = [];
    let userRamas = [];
    let userSubRamaMap = {};
    const allBulletins = ["BOE","BOCM","BOA","BOJA","BOPV","DOUE"];

    (function initUserData(){
      // parse user industries
      const industryTagScript = document.getElementById('industryTags');
      if (industryTagScript) {
        userIndustries = JSON.parse(industryTagScript.textContent) || [];
      }
      // parse user Ramas
      const ramaScript = document.getElementById('ramaJuridicas');
      if (ramaScript) {
        userRamas = JSON.parse(ramaScript.textContent) || [];
      }
      // parse userSubRamaMap
      const subRamaScript = document.getElementById('userSubRamaMap');
      if (subRamaScript) {
        userSubRamaMap = JSON.parse(subRamaScript.textContent) || {};
      }

      // Show user data in #etiquetasContainer / #ramasContainer
      const etcContainer = document.getElementById('etiquetasContainer');
      if (etcContainer) {
        if (userIndustries.length > 0) {
          etcContainer.innerHTML = userIndustries.map(i => `<span>${i}</span>`).join('');
        } else {
          etcContainer.innerHTML = `<span>No hay sectores suscritos</span>`;
        }
      }
      const ramaContainer = document.getElementById('ramasContainer');
      if (ramaContainer) {
        if (userRamas.length > 0) {
          ramaContainer.innerHTML = userRamas.map(r => `<span>${r}</span>`).join('');
        } else {
          ramaContainer.innerHTML = `<span>No hay ramas suscritas</span>`;
        }
      }
    })();

    // -------------- Sector Económico --------------
    function populateIndustryDropdown() {
      const container = document.getElementById('myDropdown');
      container.innerHTML = '';

      const lblTodos = document.createElement('label');
      lblTodos.innerHTML = `<input type="checkbox" id="chkAllIndustry" value="Todos" checked> Todos`;
      container.appendChild(lblTodos);

      userIndustries.forEach(ind => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${ind}" checked> ${ind}`;
        container.appendChild(lbl);
      });

      const chkAll = lblTodos.querySelector('#chkAllIndustry');
      chkAll.addEventListener('change', () => {
        const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
        if (chkAll.checked) {
          others.forEach(o => o.checked = true);
        } else {
          others.forEach(o => o.checked = false);
        }
        updateIndustryLabel();
      });
      const otherBoxes = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
      otherBoxes.forEach(b => {
        b.addEventListener('change', () => {
          const allChecked = [...otherBoxes].every(x => x.checked);
          chkAll.checked = allChecked;
          updateIndustryLabel();
        });
      });

      document.getElementById('selectedIndustry').textContent = 'Todas';
    }
    function toggleIndustryDropdown() {
      document.getElementById('myDropdown').classList.toggle('show');
    }
    function updateIndustryLabel() {
      const container = document.getElementById('myDropdown');
      const chkAll = container.querySelector('#chkAllIndustry');
      const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
      const labelSpan = document.getElementById('selectedIndustry');

      if (chkAll.checked) {
        labelSpan.textContent = 'Todas';
        return;
      }
      let checkedCount = 0;
      let singleVal = '';
      others.forEach(b => {
        if (b.checked) {
          checkedCount++;
          singleVal = b.value;
        }
      });
      if (checkedCount === 0) {
        labelSpan.textContent = '-';
      } else if (checkedCount === 1) {
        labelSpan.textContent = singleVal;
      } else if (checkedCount === others.length) {
        labelSpan.textContent = 'Todas';
        chkAll.checked = true;
      } else {
        labelSpan.textContent = checkedCount + ' seleccionados';
      }
    }

    // -------------- Rama Jurídica --------------
    function populateRamaDropdown() {
      const container = document.getElementById('ramaDropdown');
      container.innerHTML = '';

      const lblTodos = document.createElement('label');
      lblTodos.innerHTML = `<input type="checkbox" id="chkAllRamas" value="Todos" checked> Todos`;
      container.appendChild(lblTodos);

      userRamas.forEach(r => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${r}" checked> ${r}`;
        container.appendChild(lbl);
      });

      const chkAllRamas = lblTodos.querySelector('#chkAllRamas');
      chkAllRamas.addEventListener('change', () => {
        const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
        if (chkAllRamas.checked) {
          others.forEach(o => o.checked = true);
        } else {
          others.forEach(o => o.checked = false);
        }
        updateRamaLabel();
      });
      const otherRamas = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
      otherRamas.forEach(b => {
        b.addEventListener('change', () => {
          const allChecked = [...otherRamas].every(x => x.checked);
          chkAllRamas.checked = allChecked;
          updateRamaLabel();
        });
      });

      document.getElementById('selectedRama').textContent = 'Todas';
      document.getElementById('subRamasCheckboxContainer').style.display = 'none';
    }
    function toggleRamaDropdown() {
      document.getElementById('ramaDropdown').classList.toggle('show');
    }
    function updateRamaLabel() {
      const container = document.getElementById('ramaDropdown');
      const chkAllRamas = container.querySelector('#chkAllRamas');
      const otherRamas = container.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
      const labelSpan = document.getElementById('selectedRama');
      const subRamasContainer = document.getElementById('subRamasCheckboxContainer');

      if (chkAllRamas.checked) {
        labelSpan.textContent = 'Todas';
        subRamasContainer.style.display = 'none';
        return;
      }
      let checkedCount = 0;
      let singleVal = '';
      otherRamas.forEach(b => {
        if (b.checked) {
          checkedCount++;
          singleVal = b.value;
        }
      });
      if (checkedCount === 0) {
        labelSpan.textContent = '-';
        subRamasContainer.style.display = 'none';
      } else if (checkedCount === 1) {
        labelSpan.textContent = singleVal;
        fillSubRamas(singleVal);
      } else if (checkedCount === otherRamas.length) {
        labelSpan.textContent = 'Todas';
        chkAllRamas.checked = true;
        subRamasContainer.style.display = 'none';
      } else {
        labelSpan.textContent = checkedCount + ' seleccionados';
        subRamasContainer.style.display = 'none';
      }
    }
    function fillSubRamas(ramaName) {
      const subRamasContainer = document.getElementById('subRamasCheckboxContainer');
      subRamasContainer.innerHTML = '';
      if (!userSubRamaMap[ramaName] || !userSubRamaMap[ramaName].length) {
        subRamasContainer.style.display = 'none';
        return;
      }
      subRamasContainer.style.display = 'block';
      userSubRamaMap[ramaName].forEach(sub => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${sub}" checked> ${sub}`;
        subRamasContainer.appendChild(lbl);
      });
    }

    // -------------- BOLETines => multi-check --------------
    function populateBoletinDropdown() {
      const container = document.getElementById('boletinDropdown');
      container.innerHTML = '';

      const lblTodos = document.createElement('label');
      lblTodos.innerHTML = `<input type="checkbox" id="chkAllBoletines" value="Todos" checked> Todos`;
      container.appendChild(lblTodos);

      allBulletins.forEach(bol => {
        const lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${bol}" checked> ${bol}`;
        container.appendChild(lbl);
      });

      // plan1 => disable everything except BOE
      if (userPlan === 'plan1') {
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (cb.value !== 'Todos' && cb.value !== 'BOE') {
            cb.disabled = true;
            cb.parentElement.style.opacity = '0.5';
          }
        });
      }

      const chkAllBol = lblTodos.querySelector('#chkAllBoletines');
      chkAllBol.addEventListener('change', () => {
        const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
        if (chkAllBol.checked) {
          others.forEach(o => { if (!o.disabled) o.checked = true; });
        } else {
          others.forEach(o => { if (!o.disabled) o.checked = false; });
        }
        updateBoletinLabel();
      });
      const otherBol = container.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
      otherBol.forEach(box => {
        box.addEventListener('change', () => {
          const allChecked = [...otherBol].filter(x=>!x.disabled).every(b => b.checked);
          chkAllBol.checked = allChecked;
          updateBoletinLabel();
        });
      });

      document.getElementById('selectedBoletines').textContent = 'Todas';
    }
    function toggleBoletinDropdown() {
      document.getElementById('boletinDropdown').classList.toggle('show');
    }
    function updateBoletinLabel() {
      const container = document.getElementById('boletinDropdown');
      const chkAll = container.querySelector('#chkAllBoletines');
      const others = container.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
      const labelSpan = document.getElementById('selectedBoletines');

      if (chkAll.checked) {
        labelSpan.textContent = 'Todas';
        return;
      }
      let checkedCount = 0;
      let singleValue = '';
      others.forEach(b => {
        if (b.checked && !b.disabled) {
          checkedCount++;
          singleValue = b.value;
        }
      });
      if (checkedCount === 0) {
        labelSpan.textContent = '-';
      } else if (checkedCount === 1) {
        labelSpan.textContent = singleValue;
      } else if (checkedCount + container.querySelectorAll('input[disabled]').length === allBulletins.length) {
        labelSpan.textContent = 'Todas';
        chkAll.checked = true;
      } else {
        labelSpan.textContent = checkedCount + ' seleccionados';
      }
    }

    // -------------- RANGO => multi-check --------------
    function toggleRangoDropdown() {
      document.getElementById('rangoDropdown').classList.toggle('show');
    }
    function toggleAllRango() {
      const chkAll = document.getElementById('chkAllRango');
      const checkboxes = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      if (chkAll.checked) {
        checkboxes.forEach(cb => cb.checked = true);
      } else {
        checkboxes.forEach(cb => cb.checked = false);
      }
      updateSelectedRango();
    }
    function updateSelectedRango() {
      const chkAllRango = document.getElementById('chkAllRango');
      const otherBoxes = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      const rangoSpan = document.getElementById('selectedRango');

      let selectedCount = 0;
      let singleVal = '';
      otherBoxes.forEach(cb => {
        if (cb.checked) {
          selectedCount++;
          singleVal = cb.value;
        }
      });

      if (selectedCount === otherBoxes.length) {
        chkAllRango.checked = true;
      } else {
        chkAllRango.checked = false;
      }

      if (selectedCount === 0) {
        rangoSpan.textContent = 'Ninguno';
      } else if (selectedCount === otherBoxes.length) {
        rangoSpan.textContent = 'Todos';
      } else if (selectedCount === 1) {
        rangoSpan.textContent = singleVal;
      } else {
        rangoSpan.textContent = selectedCount + ' seleccionados';
      }
    }

    // -------------- CLICK OUTSIDE => HIDE DROPDOWNS --------------
    document.addEventListener('click', function(e) {
      // Industry
      const isIndustryButton = e.target.closest('#btnSectorEconomico');
      const isIndustryDropdown = e.target.closest('#myDropdown');
      if (!isIndustryButton && !isIndustryDropdown) {
        document.getElementById('myDropdown').classList.remove('show');
      }

      // Rama
      const isRamaButton = e.target.closest('#btnRamaJuridica');
      const isRamaDropdown = e.target.closest('#ramaDropdown');
      if (!isRamaButton && !isRamaDropdown) {
        document.getElementById('ramaDropdown').classList.remove('show');
      }

      // Boletines
      const isBoletinButton = e.target.closest('#btnBoletin');
      const isBoletinDropdown = e.target.closest('#boletinDropdown');
      if (!isBoletinButton && !isBoletinDropdown) {
        document.getElementById('boletinDropdown').classList.remove('show');
      }

      // Rango
      const isRangoButton = e.target.closest('#btnRango');
      const isRangoDropdown = e.target.closest('#rangoDropdown');
      if (!isRangoButton && !isRangoDropdown) {
        document.getElementById('rangoDropdown').classList.remove('show');
      }
    });

    // -------------- handleBuscar => front-end filter by doc-rango, doc-seccion, etc. --------------
    async function handleBuscar() {
      // 1) Gather bulletins from the new dropdown
      const containerBol = document.getElementById('boletinDropdown');
      const chkAllBol = containerBol.querySelector('#chkAllBoletines');
      const othersBol = containerBol.querySelectorAll('input[type="checkbox"]:not(#chkAllBoletines)');
      let selectedBulletins = [];
      if (!chkAllBol.checked) {
        const checkedBols = [];
        othersBol.forEach(cb => {
          if (cb.checked && !cb.disabled) checkedBols.push(cb.value);
        });
        if (checkedBols.length > 0) {
          selectedBulletins = checkedBols;
        }
      } else {
        // "Todos" => if plan1 => only BOE is truly available if the others are disabled
        if (userPlan === 'plan1') {
          selectedBulletins = ["BOE"];
        } else {
          selectedBulletins = allBulletins.slice();
        }
      }

      // 2) Gather selected Industry
      const containerInd = document.getElementById('myDropdown');
      const chkAllIndustry = containerInd.querySelector('#chkAllIndustry');
      const otherInds = containerInd.querySelectorAll('input[type="checkbox"]:not(#chkAllIndustry)');
      let selectedIndustries = [];
      if (!chkAllIndustry.checked) {
        const checkedInds = [];
        otherInds.forEach(cb => {
          if (cb.checked) checkedInds.push(cb.value);
        });
        if (checkedInds.length > 0) {
          selectedIndustries = checkedInds;
        }
      }

      // 3) Gather selected Ramas
      const containerRama = document.getElementById('ramaDropdown');
      const chkAllRamas = containerRama.querySelector('#chkAllRamas');
      const otherRamas = containerRama.querySelectorAll('input[type="checkbox"]:not(#chkAllRamas)');
      let selectedRamas = [];
      if (!chkAllRamas.checked) {
        const checkedRamas = [];
        otherRamas.forEach(cb => {
          if (cb.checked) checkedRamas.push(cb.value);
        });
        if (checkedRamas.length > 0) {
          selectedRamas = checkedRamas;
        }
      }
      let selectedSubRamas = [];
      if (!chkAllRamas.checked && selectedRamas.length === 1) {
        const subBoxes = document.querySelectorAll('#subRamasCheckboxContainer input[type="checkbox"]');
        subBoxes.forEach(sb => {
          if (sb.checked) selectedSubRamas.push(sb.value);
        });
      }

      // 4) Gather selected Rango
      const chkAllRango = document.getElementById('chkAllRango');
      const rangoBoxes = document.querySelectorAll('#rangoDropdown input[type="checkbox"]:not(#chkAllRango)');
      let selectedRangos = [];
      if (!chkAllRango.checked) {
        rangoBoxes.forEach(cb => {
          if (cb.checked) selectedRangos.push(cb.value);
        });
      }

      // 5) Filter the displayed documents in .collectionDocs
      const docs = document.querySelectorAll('.collectionDocs .data-item');
      docs.forEach(doc => {
        // If we built .doc-rango or .doc-seccion or .etiquetas-values
        const boletinName = doc.querySelector('.collectionName') 
              ? doc.querySelector('.collectionName').innerText 
              : (doc.getAttribute('data-collection') || '');
        const etiquetasText = doc.querySelector('.etiquetas-values') 
              ? doc.querySelector('.etiquetas-values').innerText 
              : '';
        const ramaText = doc.querySelector('.rama-juridica-values')
              ? doc.querySelector('.rama-juridica-values').innerText
              : '';
        const subRamasText = doc.querySelector('.sub-rama-juridica-values')
              ? doc.querySelector('.sub-rama-juridica-values').innerText
              : '';
        const rangoText = doc.querySelector('.doc-rango')
              ? doc.querySelector('.doc-rango').innerText
              : '';

        // 5A) Boletin check
        // if user selected partial bulletins => doc must be in that set
        let matchBoletin = true;
        if (selectedBulletins.length > 0) {
          // we require doc's collectionName is in selectedBulletins
          // but the doc might store it in an attribute or hidden field
          // e.g. doc has data-collection
          const docCollection = doc.getAttribute('data-collectionName') 
                || doc.getAttribute('data-collection') 
                || boletinName; // fallback
          matchBoletin = selectedBulletins.includes(docCollection);
        }

        // 5B) Industry check
        let matchIndustria = true;
        if (selectedIndustries.length > 0) {
          // doc must contain any of the selectedIndustries in its .etiquetas-values
          matchIndustria = selectedIndustries.some(ind => etiquetasText.includes(ind));
        }

        // 5C) Ramas check
        let matchRama = true;
        if (selectedRamas.length > 0) {
          // doc must contain at least 1 selected rama
          matchRama = selectedRamas.some(r => ramaText.includes(r));
        }
        // subRamas => if single
        // omitted for brevity, you'd parse subRamasText. But let's skip

        // 5D) Rango check
        let matchRango = true;
        if (selectedRangos.length > 0) {
          matchRango = selectedRangos.some(r => rangoText.includes(r));
        }

        if (matchBoletin && matchIndustria && matchRama && matchRango) {
          doc.style.display = '';
        } else {
          doc.style.display = 'none';
        }
      });
    }

    // -------------- CHART LOAD --------------
    let myChart;
    function loadChart(months, counts) {
      const ctx = document.getElementById('documentsChart').getContext('2d');
      if (myChart) {
        myChart.destroy();
      }
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Documentos',
            data: counts,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // -------------- ON PAGE LOAD => fill dropdowns --------------
    document.addEventListener('DOMContentLoaded', () => {
      populateIndustryDropdown();
      populateRamaDropdown();
      populateBoletinDropdown();
      // Also default the Rango checks
      updateSelectedRango();
    });
  </script>
</body>
</html>
