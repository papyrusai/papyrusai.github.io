<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suscripción - Papyrus</title>
  <link rel="icon" href="assets\papyrus_logo.png" type="image/png"> 
  <link rel="stylesheet" href="styles/menu.css">
  <link rel="stylesheet" href="styles/onboarding.css">
  <style>
    /* Additional styles specific for paso4 */
 /* Step 3 Plans Container */

/* A small floating message to warn about plan1 limitations */
.limited-plan-warning {
    position: fixed;            /* or absolute if you prefer to anchor inside .form-container */
    top: 10px;                  /* place near top (or center, your choice) */
    left: 50%;
    transform: translateX(-50%);  /* center horizontally */
    background-color: #ac1717;    /* a warning color, e.g., yellowish */
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 14px;
    box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.2);
    z-index: 9999;             /* on top of other stuff */
    display: none;             /* hidden by default, show via JS */
  }
  
  /* The close (X) button inside the banner */
  .limited-plan-warning .close-btn {
    position: absolute;
    top: 4px;
    right: 6px;
    cursor: pointer;
    color: #092534;
    background: #ffffff99;
    border-radius: 50%;
    padding: 3px 3px;
    font-size: 12px;
    font-weight: bold;
  }
  
.choose-plan-heading {
    text-align: center;
    font-size: clamp(18px, 2.5vw, 24px);
    margin-top: clamp(20px, 5vh, 50px);
    font-weight: bold;
}
.plans-container {
  display: flex;
  justify-content: space-between;
  gap: clamp(5px, 1vw, 10px);
  margin-top: clamp(20px, 3vh, 50px);
}

.plan-box {
  position: relative;
  flex: 1;
  border-radius: 6px;
  padding: clamp(8px, 1.5vh, 15px);
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
  text-align: center;
  border: 1px solid #092534;
}

.plan-box h3 {
  font-size: clamp(12px, 1.5vw, 16px);
  font-weight: normal;
  color: #092534bd;
}

.plan-box h2 {
  font-size: clamp(16px, 2.5vw, 20px);
  margin: clamp(3px, 0.8vh, 8px) 0;
  font-weight: bold;
}

.plan-box p {
  font-size: clamp(10px, 1.2vw, 12px);
  color: #666;
  margin-bottom: clamp(8px, 1.5vh, 15px);
}

.plan-box ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.plan-box ul li {
  font-size: clamp(10px, 1.2vw, 12px);
  margin-bottom: clamp(3px, 0.8vh, 8px);
  padding-bottom: clamp(3px, 0.8vh, 8px);
  border-bottom: 1px solid #ccccccd9;
}

    .btn-siguiente {
      background-color: var(--primary-color);
      color: white;
      width: 140px;
      padding: 12px 0;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
    
    }

/*banners*/

  /* Common style for all plan badges */
  .plan-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    color: #092534;
    padding: 2px 5px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 12px; /* smaller text */
    z-index: 9999;
  }
  
  /* If you want different colors for each banner: */
  .free-two-months {
    background-color: #83a300; /* or #ffcc00, up to you */
    color: #fbf7ef;
  }
  .free{
    top:-20px;
    right: 10px;
  }
  
  .coming-soon {
    background-color: #092534; /* for example pink, or any color */
    color: #fff;               /* white text for contrast */
  }
  
  /* (Optional) If plan3 is disabled, you can gray it out entirely: */
  .plan-box[data-disabled="true"] {
    opacity: 0.6;       /* visually indicate it's not available */
    cursor: default;    /* no pointer hand */
  }
  
  /* Possibly highlight the banner if the user tries to click Plan 3 */
  
  /*.plan-badge.highlighted {
    animation: pulse 0.8s ease 0s 2 alternate;
  } */
  
  @keyframes pulse {
    0% { transform: scale(1.0); }
    100% { transform: scale(1.2); }
  }
  
/* Plan Features List */
.plan-box ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.plan-box ul li {
    font-size: clamp(12px, 1.5vw, 14px);
    margin-bottom: clamp(5px, 1vh, 10px);
    padding-bottom: clamp(5px, 1vh, 10px);
    border-bottom: 1px solid #ccccccd9;
}

.plan-box ul li:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.step-navigation {
  margin-top: 3%;
  display: flex;
  justify-content: center; /* This centers the button horizontally */
  width: 100%;
}

.btn-siguiente {
  background-color: var(--primary-color);
  color: white;
  width: 140px;
  padding: 12px 0;
  font-size: 16px;
  border-radius: 6px;
  cursor: pointer;
  border: none;
  /* Removed any margin that might affect centering */
}

/* Plan Buttons */
.plan-button {
    margin-top: clamp(5px, 1vh, 10px);
    padding: clamp(5px, 1vh, 10px) clamp(10px, 2vw, 20px);
    border: none;
    border-radius: 5px;
    font-size: clamp(12px, 1.5vw, 14px);
    cursor: pointer;
    background-color: #83a300;
    color: #fff;
    transition: background-color 0.3s ease;
}

.plan-box {
    cursor: pointer;
    transition: background-color 0.3s ease, border 0.3s ease;
}

.plan-box:hover {
    background-color: #e6f7e6;
}


.plan-box.selected {
    border: 2px solid #83a300;
    Box-shadow: 0px 0px 2px #83a300;
} 

    .choose-plan-heading {
      margin: 20px 0;
      font-size: 1.2em;
      font-weight: bold;
      text-align: center;
    }
    /* Progress bar adjustments for three steps */
    .progress-container {
      margin-bottom: 30px;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .step {
      flex: 1;
      text-align: center;
      font-weight: bold;
      padding: 10px;
    }
    .step.active {
      color: var(--primary-color);
    }
    .progress-bar {
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    /* For three steps, assume the current step fills 100% when active */
    .progress-fill {
      height: 100%;
      width: 100%;
      background-color: var(--primary-color);
      border-radius: 4px;
    }

  </style>
</head>
<body>
  
  <nav class="navbar">
    <div class="logo">
        <a href="https://www.papyrus-ai.com/" target="_blank">
          <img src="assets/papyrus_app.png" alt="Papyrus Logo">
        </a>
      </div>
   <button class="hamburger" onclick="toggleMenu()">☰</button> 
   <ul class="menu">
    <li><a href="https://papyrus-ai.com/">WEB</a></li>
    <li><a href="https://app.papyrus-ai.com/profile">PANEL DE CONTROL</a></li> <!--cambiar-->
    <li><a href="http://app.papyrus-ai.com/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
    <li><a href="https://papyrus-ai.com/pages/contact-1">AYUDA</a></li>
  </ul>
  </nav>

  <div class="container">
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="step">1. Usuario</div>
        <div class="step">2. Personalización</div>
        <div class="step active">3. Plan</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 100%;"></div>
      </div>
    </div>

    <div class="formulario">
      <h1>Tipo de Suscripción</h1>
      <p class="subheading">Seleccione el paquete que más se adapte a sus necesidades</p>
      <div class="choose-plan-heading">Elige tu plan</div>
      
      <div class="plans-container">
        <!-- Plan 1 -->
        <div class="plan-box" data-value="plan1">
          <h3>Básico</h3>
          <h2>Gratuito</h2>
          <p>Al mes</p>
          <ul>
            <li>Resumen diario general del BOE</li>
            <li>-</li>
            <li>-</li>
          </ul>
        </div>
        <!-- Plan 2 -->
        <div class="plan-box" data-value="plan2">
          <!-- <div class="plan-badge free-two-months">1 mes gratuito, sin tarjeta</div> -->
          <h3>Estándar</h3>
          <h2>30€</h2>
          <p>Al mes por fuente oficial</p>
          <ul>
            <li>Descuento por cada fuente extra</li>
            <li>Alertas normativas personalizadas</li>
            <li>Análisis de impacto normativo</li>
          </ul>
        </div>
        <!-- Plan 3 -->
        <div class="plan-box" data-value="plan3" data-disabled="true">
          <div class="plan-badge coming-soon">Próximamente</div>
          <h3>Enterprise</h3>
          <h2>Contact sales</h2>
          <p>Al mes</p>
          <ul>
            <li>Todo el paqueta Estándar</li>
            <li>Cobertura legal completa</li>
            <li>Integración personalizada</li>
          </ul>
        </div>
        <div class="plan-box" data-value="plan4">
           <!-- <div class="plan-badge free-two-months">1 mes gratuito, sin tarjeta</div> -->
          <h3 style="color:#83a300; font-weight: bolder;">Prueba</h3>
          <h2>Gratuito</h2>
          <p>Un mes</p>
          <ul>
            <li>Acceso completo a la plataforma de manera temporal</li>
            
            <li>Sin tarjetas, sin compromisos</li>

          </ul>
      </div>
      </div>
      <div class="step-navigation">
        <button id="nextBtn" class="btn-siguiente">Finalizar</button>
      </div>
      
      <!-- Hidden input to store the selected plan -->
      <input type="hidden" id="selectedPlan" name="selectedPlan" value="">
    </div>
  </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
  // Global variable to control plan2 free status
  let plan2isfree = true;
  
  // Set up plan selection functionality
  const planBoxes = document.querySelectorAll('.plan-box');
  const selectedPlanInput = document.getElementById('selectedPlan');
  
  // Add click handlers to each plan box
  planBoxes.forEach(function(box) {
    box.addEventListener('click', function() {
      // Skip if plan is disabled
      if (box.getAttribute('data-disabled') === 'true') {
        return;
      }
      
      // Remove selected class from all plans
      planBoxes.forEach(function(plan) {
        plan.classList.remove('selected');
      });
      
      // Add selected class to clicked plan
      box.classList.add('selected');
      
      // Store the selected plan value
      selectedPlanInput.value = box.getAttribute('data-value');
      console.log('Selected plan:', selectedPlanInput.value);
    });
  });
  
  // Select plan4 by default
  const plan4Box = Array.from(planBoxes).find(box => box.getAttribute('data-value') === 'plan4');
  if (plan4Box && !plan4Box.getAttribute('data-disabled')) {
    plan4Box.click();
  }
  
  // CRITICAL: Get userData from the original source in sessionStorage
  const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
  console.log('User data from step 1:', userData);
  
  // Get data from step 3
  const industryTags = JSON.parse(sessionStorage.getItem('industry_tags') || '[]');
  const ramaJuridicas = JSON.parse(sessionStorage.getItem('rama_juridicas') || '[]');
  const subRamaMap = JSON.parse(sessionStorage.getItem('sub_rama_map') || '{}');
  const rangos = JSON.parse(sessionStorage.getItem('rangos') || '[]');
  const coberturaLegal = JSON.parse(sessionStorage.getItem('cobertura_legal') || '{}');
  // CRITICAL: Properly parse the feedback object with correct structure
  let feedback;
      try {
        feedback = JSON.parse(sessionStorage.getItem('feedback') || '{}');
        // Ensure feedback has all required fields
        feedback = {
          industrias: feedback.industrias || '',
          ramas: feedback.ramas || '',
          fuentes_reguladores: feedback.fuentes_reguladores || '',
          rangos: feedback.rangos || ''
        };
        console.log('Parsed feedback:', feedback);
      } catch (error) {
        console.error('Error parsing feedback:', error);
        feedback = {
          industrias: '',
          ramas: '',
          fuentes_reguladores: '',
          rangos: ''
        };
      }
  
  // Add a single event handler for the submit button
  const submitButton = document.getElementById('nextBtn');
  submitButton.addEventListener('click', async function(e) {
    e.preventDefault();
    
    // Get selected plan value
    const planType = selectedPlanInput.value;
    if (!planType) {
      alert('Por favor, selecciona un plan');
      return;
    }
    
    // Show loading state
   // Show loading state - replace text with loader and disable button
   const originalButtonText = this.textContent.trim();
      this.innerHTML = '<div class="loader"></div><span>Procesando...</span>';
      this.classList.add('loading');
      this.disabled = true;
    // Create a complete payload with ALL user data
    const payload = {
      plan: planType,
      industry_tags: industryTags,
      rama_juridicas: ramaJuridicas,
      sub_rama_map: subRamaMap,
      rangos,
      cobertura_legal: {
        "fuentes-gobierno":  coberturaLegal["fuentes-gobierno"] || [], // || userData.fuentes || ,
        "fuentes-reguladores": coberturaLegal["fuentes-reguladores"] || [] // || userData.reguladores, || 
      },
      feedback,
      // CRITICAL: Get user profile data directly from userData object
      name: userData.nombre || '',
      web: userData.webEmpresa || '',
      linkedin: userData.linkedin || '',
      perfil_profesional: Array.isArray(userData.perfil) ? userData.perfil.join(',') : '',
      company_name: userData.webEmpresa || '',
      profile_type: userData.otro_perfil || (Array.isArray(userData.perfil) ? userData.perfil[0] : ''),
      especializacion: userData.especializacion,
      otro_perfil: userData.otro_perfil

    };
    
    console.log('Sending complete payload to server:', payload);
    
    try {
      // Determine endpoint based on plan type
      let endpoint = '/save-free-plan';
      
      // For paid plans that aren't free trial
      if (planType === 'plan3' || (planType === 'plan2' && !plan2isfree)) {
        endpoint = '/create-checkout-session';
      }
      
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      if (!resp.ok) throw new Error(`Failed to save plan data: ${resp.status}`);
      
      const result = await resp.json();
      
      if (endpoint === '/create-checkout-session') {
        const { sessionId } = result;
        const stripe = Stripe('pk_live_51QOlLCEpe9srfTKE4ymTYWhMSWs7qDvRQvmnzgoh0FmOWQ9cYTlOawWNiWQReOQeDx7Uslw7cbj9ClBGFas8heQq00wKegaiJg');
        await stripe.redirectToCheckout({ sessionId });
      } else if (result.redirectUrl) {
        window.location.href = result.redirectUrl;
      }
    } catch (error) {
      console.error('Error saving data:', error);
      // Restore button state on error
      this.innerHTML = originalButtonText;
        this.classList.remove('loading');
        this.disabled = false;
      alert('Hubo un error al guardar los datos. Por favor, inténtelo de nuevo.');
    }
  });
});

</script>

</html>
