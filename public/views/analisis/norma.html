<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <title>Profile</title>
    <link rel="icon" href="/assets/reversa_logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="/styles/styles.css" />
    <link rel="stylesheet" type="text/css" href="/styles/menu.css" />
    <link rel="stylesheet" type="text/css" href="/styles/toggle.css" />
    <link rel="stylesheet" type="text/css" href="/styles/dropdown.css" />
    <link rel="stylesheet" type="text/css" href="/styles/radio_menu.css" />
    <link rel="stylesheet" type="text/css" href="/styles/mobile.css" />
    <link rel="stylesheet" type="text/css" href="/styles/sidebar_styles.css" />
    <link rel="stylesheet" type="text/css" href="/styles/profile.css" />
    <style>

      :root {
        --primary-color: #04db8d;
        --secondary-color: #455862;
        --border-color: #e0e0e0;
        --text-color: #0b2431;
        --placeholder-color: #999;
        --active-color: #04db8d;
        --error-color: #d32f2f;
        --background-color: #ffffff;

        /*tab background color: #f8f8f8*/
      }
        #analysisResult {
            margin-top: 20px;
            padding: 20px 30px;
            border: 1px solid #ccc;
            border-radius: 20px;
            text-align: left;
            display: none;
            background-color: #ffffff;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            position: relative; /* To anchor export menu inside the box */
        }
        
        #analysisResult.show {
            opacity: 1;
        }
        
        #analysisResult.error-state {
            border: none;
            background-color: transparent;
            padding: 0;
        }

        body {
          font-family: 'Satoshi', sans-serif;
          margin: 0;
          padding: 0;
          min-height: 100vh;
        }

        #loader {
            display: none; /* Hidden by default */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .analisis-impacto {
            background: transparent;
            color: var(--text-color);
            padding: 8px 16px;
            border: 1px solid #999;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 2%;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .analisis-impacto .icon {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .analisis-impacto:hover {
            background-color: var(--text-color);
            border: none;
            color: white;
           /* transform: translateY(-1px);*/
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .analisis-impacto:hover .icon {
            color: white;
        }
        
        /* Styling for active analysis buttons */
        .analisis-impacto.active {
            background-color: var(--text-color);
            color: white;
            border: 1px solid var(--text-color);
        }
        
        .analisis-impacto.active .icon {
            color: white;
        }

        /* Skeleton Loader Styles */
        .skeleton-loader {
            background: linear-gradient(90deg, 
                rgba(11, 36, 49, 0.1) 25%, 
                rgba(4, 219, 141, 0.2) 50%, 
                rgba(11, 36, 49, 0.1) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            display: inline-block;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Hide skeleton when content is loaded */
        .skeleton-hidden {
            display: none !important;
        }

          .container-norma {
            max-width: 1100px; 
            margin: 40px auto; 
            padding: 30px;     
            border-radius: 12px; 
            text-align: center;
          }
          /* Style the input field */
          .user-prompt {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: 'Heebo', sans-serif;
            text-align: left;
            resize: vertical; /* This enables vertical resizing */
            overflow: auto;
            min-height: 100px;
            /* height: auto;
            white-space: pre-wrap; /* Allows line breaks within the text area */
            word-break: break-word;/*Break on new word, not letter*/
             spellcheck: false; /* Disable spellcheck */
             padding-right: 45px; /* Add space for the button */
        }


        /* Add focus style */
        .user-prompt:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 5px rgba(131, 163, 0, 0.5);
        }

        /* Style the container for the input and button */
        .input-button-container {
          display: flex;
          flex-direction: column;
          align-items: center; /* Aligns items to the start (left) */
          width: 100%;
          margin-bottom: 20px;
          position: relative;
        }
        
        /* Wrapper for textarea to contain the button */
        .textarea-wrapper {
          position: relative;
          width: 100%;
        }
        .input-button-container > * {
            margin-bottom: 10px; /* Adds spacing between elements */
        }
        
        /* Style for the custom prompt submit button */
        #sendCustomPrompt {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background-color: var(--text-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 15;
        }
        
        #sendCustomPrompt:hover {
            background-color: #03c57f;
        }
        
        /* When textarea is focused, ensure the button is visible */
        .user-prompt:focus + #sendCustomPrompt {
            opacity: 1;
        }
        
        /* Table styling for checklist */
        #analysisResult table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        #analysisResult th, #analysisResult td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }
        
        #analysisResult th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        
        #analysisResult tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /*feedback*/

                #feedbackSection {
          margin-top: 20px;
          border: 1px solid #ccc;
          border-radius: 20px;
          overflow: hidden;
        }

        #feedbackToggle {
          display: flex;
          justify-content: space-between;
          padding: 10px 15px;
          background-color: #ffffff;
          cursor: pointer;
        }

        #feedbackContent {
          padding: 15px;
        }

        #feedbackText {
          width: 95%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 20px;
          margin-bottom: 10px;
          resize: vertical;
          min-height: 80px;
        }

        #sendFeedbackBtn {
          margin-top: 10px;
        }

        .feedback-success {
          color: var(--primary-color);
          margin-top: 10px;
          font-weight: bold;
        }

        /* Dropdown para selección de agentes */
        .analysis-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .dropdown-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            text-align: left;
        }

        .etiquetas-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .etiqueta-btn {
            background: #f2f2f2;
            border: 1px solid #dcdcdc;
            color: #455862;
            padding: 8px 14px;
            border-radius: 14px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .etiqueta-btn:hover {
            background: #e6e6e6;
        }

        .etiqueta-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* Modern radio list for agentes */
        .etiqueta-radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .etiqueta-radio-item:hover {
            background: #f9fafb;
            border-color: #d6d6d6;
        }
        .radio-control {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #c7c7c7;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s ease, background 0.2s ease;
            flex-shrink: 0;
        }
        .radio-control .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: transparent;
            transition: background 0.2s ease;
        }
        .etiqueta-radio-item.selected .radio-control {
            border-color: var(--primary-color);
            background: #eafff4;
        }
        .etiqueta-radio-item.selected .radio-control .dot {
            background: var(--primary-color);
        }
        .etiqueta-radio-label {
            font-size: 14px;
            color: var(--text-color);
        }

        .start-analysis-btn {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .start-analysis-btn:hover {
            background: var(--text-color);
            color: white;
        }

        .start-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Hidden class for original etiquetas selector */
        #etiquetasSelectorContainer {
            display: none;
        }

        /* ---------- STATUS WORKFLOW ---------- */
        #analysisStatus {
            margin-top: 15px;
            display: none;
            font-size: 15px;
            color: var(--text-color);
            font-weight: 500;
            align-items: center;
            gap: 8px;
            justify-content: flex-start; /* left align */
            position: relative;
            width: 100%;
        }

        #analysisStatus .spinner {
            font-size: 16px;
            animation: spin 2s linear infinite;
        }

        /* shimmer effect - PRECISE TEXT ONLY */
        .shimmer-text {
            position: relative;
            display: inline-block;
            color: var(--text-color);
            overflow: hidden; /* This ensures shimmer doesn't go beyond text */
        }

        .shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: -50px; /* Start from left edge */
            width: 50px; /* Fixed width shimmer bar */
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
            animation: shimmer-slide 3s infinite;
        }

        @keyframes shimmer-slide {
          0% { 
            left: -50px; 
          }
          100% { 
            left: 100%; 
          }
        }

        /* slide-in subtle animation */
        .slide {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(-8px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* Analysis result - no animation for better performance */
        .analysis-render {
            /* No animation - show results immediately */
        }

        /* Status completed - simplified for better performance */
        .status-completed {
            /* No complex animation - just hide immediately */
            opacity: 0;
        }



        /* ---------- HTML source banner ---------- */
        .html-source-banner {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .html-source-banner a {
            color: #04db8d;
            text-decoration: underline;
            font-weight: 500;
        }

        .html-source-banner a:hover {
            color: #03c57f;
        }

        /* ---------- No analysis available banner ---------- */
        .no-analysis-banner {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            font-size: 14px;
            margin-top: 16px;
        }

        /* ---------- Export Menu ---------- */
        .export-menu-container {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 50;
        }

        .export-menu-btn {
            background: #0b2431; /* Reversa dark blue */
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(4, 219, 141, 0.2);
        }

        .export-menu-btn:hover {
            background: #1a3a4a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 36, 49, 0.25);
        }

        .export-menu-btn i {
            font-size: 16px;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 8px 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            min-width: 200px;
            animation: dropdownSlide 0.3s ease-out;
            z-index: 1000;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .export-option:hover {
            background: #f8f9fa;
            color: var(--primary-color);
        }

        .export-option i {
            width: 18px;
            text-align: center;
            font-size: 16px;
        }

        .export-option:first-child {
            border-radius: 12px 12px 0 0;
        }

        .export-option:last-child {
            border-radius: 0 0 12px 12px;
        }

        /* ---------- Analysis Settings Dropdown ---------- */
        .analysis-settings-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 2%;
            /* Removed top margin to align with other buttons */
            margin-top: 0;
        }

        .analysis-settings-btn {
            background: transparent;
            color: var(--text-color);
            padding: 8px 16px;
            border: 1px solid #999;
            border-radius: 16px;
            cursor: pointer;
            /* Removed top margin to align with other buttons */
            margin-top: 2%;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 36px;
        }

        .analysis-settings-btn:hover {
            background-color: var(--text-color);
            color: white;
            border-color: var(--text-color);
        }

        .analysis-settings-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            animation: dropdownSlide 0.3s ease-out;
        }

        .analysis-settings-dropdown.show {
            display: block;
        }

        .settings-dropdown-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            text-align: left;
        }

        .settings-item {
            margin-bottom: 12px;
        }

        .settings-item label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 4px;
            text-align: left;
        }

        .settings-select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 14px;
            background-color: #ffffff;
            color: var(--text-color);
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 3px rgba(4, 219, 141, 0.3);
        }

        /* ---------- Breadcrumb inside main content ---------- */
        .breadcrumb-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0 10px 0;
            color: #0b2431;
        }
        .breadcrumb-back {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: 1px solid #e0e0e0;
            border-radius: 50%;
            color: #0b2431;
            text-decoration: none;
            cursor: pointer;
            transition: all .2s ease;
        }
        .breadcrumb-back:hover { box-shadow: 0 2px 8px rgba(11,36,49,.12); transform: translateY(-1px); }
        .breadcrumb-text { font-weight: 600; }

        /* ---------- Loader overlay (ensure no white flash) ---------- */
        #pageLoaderOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        /* Fallback spinner for page overlay */
        .page-loader {
            border: 5px solid rgba(11,36,49,.12);
            border-top: 5px solid #0b2431;
            border-radius: 50%;
            width: 44px; height: 44px;
            animation: spin 1s linear infinite;
        }

        /* ---------- Skeleton loaders ---------- */
        @keyframes skeleton-pulse { 0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5} }
        .skeleton { background: rgba(11,36,49,0.18); border-radius: 6px; animation: skeleton-pulse 1.5s ease-in-out infinite; }
        .skeleton-line { height: 14px; width: 100%; }
        .skeleton-text { height: 20px; }

    </style>
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "r7ltvtr85q");
  </script>
</head>
<body>

     <!-- Loader overlay -->
<div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>
  <script>
    // Fallback para ocultar el overlay aunque otros scripts fallen
    (function(){
      function hideOverlay(){
        var ov = document.getElementById('pageLoaderOverlay');
        if (ov) ov.style.display = 'none';
      }
      // Timeout duro: 12s
      setTimeout(function(){ if (window.__normaLoaded__ !== true) hideOverlay(); }, 12000);
      // Al estar el DOM interactivo, asegurar ocultado si no se ha marcado cargado
      if (document.readyState === 'interactive' || document.readyState === 'complete') {
        setTimeout(function(){ if (window.__normaLoaded__ !== true) hideOverlay(); }, 2000);
      } else {
        document.addEventListener('readystatechange', function(){
          if (document.readyState === 'interactive') {
            setTimeout(function(){ if (window.__normaLoaded__ !== true) hideOverlay(); }, 2000);
          }
        });
      }
    })();
  </script>

    <div class="container-norma">
      <div class="breadcrumb-row">
        <a id="backToAgentes" class="breadcrumb-back" title="Volver a Agentes" href="/profile#agentes">
          <i class="fa fa-chevron-left"></i>
        </a>
        <div class="breadcrumb-text">Agentes / Análisis</div>
      </div>

      <h2>
        <span id="normaShortName" style="display: none;"></span>
        <div id="normaShortNameSkeleton" class="skeleton-loader" style="height: 32px; width: 60%; margin: 0 auto; border-radius: 8px;"></div>
      </h2>
      <div id="normaExtraDetails" style="font-size: large; color: #757575; margin-top: 4px; margin-bottom: 15px; line-height: 1.4; display: none;"></div>
      <div id="normaExtraDetailsSkeleton" class="skeleton-loader" style="height: 20px; width: 40%; margin: 4px auto 15px auto; border-radius: 6px;"></div>

    <div id="normaDetails">
        <!-- This will be populated with data from MongoDB -->
        <h2>  </h2>
           <!-- <label for="userPrompt">Custom Prompt:</label> --> </div>
             <div class="input-button-container">

<div class="textarea-wrapper">
<textarea class="user-prompt" id="userPrompt" name="userPrompt" placeholder="Escribe aquí para analizar la norma..." spellcheck="false"></textarea>
<button id="sendCustomPrompt" title="Enviar consulta personalizada">↑</button>
</div>
<div class="buttons-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; position: relative;">
    <button id="analyzeButton" class="analisis-impacto">
        <i class="fas fa-file-alt icon"></i>
        <span>Realizar resumen</span>
    </button>
    <button id="checklistButton" class="analisis-impacto">
        <span class="icon">☐</span>
        <span>Cuadro de obligaciones</span>
    </button>
    <button id="risksButton" class="analisis-impacto">
        <span class="icon">⚠</span>
        <span>Riesgos y oportunidades</span>
    </button>
    
    <!-- Settings dropdown for analysis -->
  <!--  <div class="analysis-settings-container"> -->
        <button id="analysisSettingsBtn" class="analysis-settings-btn" title="Ajustes de análisis">
            <i class="fa fa-cog"></i>
        </button>
        <div id="analysisSettingsDropdown" class="analysis-settings-dropdown">
            <div class="settings-dropdown-title">Ajustes de análisis</div>
            <div class="settings-item">
                <label for="analysis-idioma-select">Idioma:</label>
                <select id="analysis-idioma-select" class="settings-select">
                    <option value="español">Español</option>
                    <option value="inglés">Inglés</option>
                </select>
            </div>
        </div>
    <!-- </div> -->
    
    <!-- Dropdown para selección de agentes -->
    <div id="analysisDropdown" class="analysis-dropdown">
        <div class="dropdown-title">Selecciona un agente</div>
        <div id="etiquetasList" class="etiquetas-list">
            <!-- Las etiquetas se llenarán dinámicamente -->
        </div>
        <button id="startAnalysisBtn" class="start-analysis-btn" disabled>Empezar análisis</button>
    </div>
</div>

</div>

    <!-- Status workflow indicator -->
    <div id="analysisStatus"><i class="fa fa-spinner spinner"></i> <span class="shimmer-text"></span></div>
    <div id="analysisResult"></div>

<!-- Sección de Feedback -->
<div id="feedbackSection" style="display: none;">
  <div id="feedbackToggle">
    <span style="font-weight: 700;">Feedback</span>
    <i class="fa fa-chevron-down"></i>
  </div>
  <div id="feedbackContent" style="display: none;">
    <textarea id="feedbackText" placeholder="Indícanos tu opinión para que podamos seguir mejorando"></textarea>
    <button id="sendFeedbackBtn" class="analisis-impacto">Enviar feedback</button>
  </div>
</div>

        </div> <!-- .container-norma -->
      </div> <!-- #main-content -->
    </div> <!-- .profile-container -->

<script>
    // Helper function to clean analysis output
	function cleanAnalysisOutput(htmlContent) {
		if (!htmlContent) return '';
		
		// Remove JSON wrapper artifacts
		let cleaned = htmlContent;
		
		// Remove leading/trailing JSON structure
		cleaned = cleaned.replace(/^\s*\{\s*"html_response"\s*:\s*"/i, '');
		cleaned = cleaned.replace(/"\s*\}\s*$/i, '');
		
		// Remove escaped quotes
		cleaned = cleaned.replace(/\\"/g, '"');
		
		// Remove escaped newlines
		cleaned = cleaned.replace(/\\n/g, '\n');
		
		// Remove excessive whitespace and newlines
		cleaned = cleaned.replace(/(\n\s*){3,}/g, '\n\n');
		cleaned = cleaned.replace(/\n\s*\n\s*\n/g, '\n\n');
		
		// Remove standalone whitespace lines
		cleaned = cleaned.replace(/\n\s+\n/g, '\n');
		
		// Trim leading and trailing whitespace
		cleaned = cleaned.trim();
		
		return cleaned;
	}

	// Export functionality
	function addExportMenu() {
		const analysisResultDiv = document.getElementById('analysisResult');
		if (!analysisResultDiv || !analysisResultDiv.innerHTML) return;
		
		// Check if export menu already exists
		if (document.querySelector('.export-menu-container')) return;
		
		const exportMenu = document.createElement('div');
		exportMenu.className = 'export-menu-container';
		exportMenu.innerHTML = `
			<button class="export-menu-btn" id="exportMenuBtn" title="Opciones de exportación">
				<span>Exportar</span>
				<i class="fa fa-download"></i>
			</button>
			<div class="export-dropdown" id="exportDropdown">
				<div class="export-option" data-action="copy">
					<i class="fa fa-copy"></i>
					<span>Copiar</span>
				</div>
				<div class="export-option" data-action="pdf">
					<i class="fa fa-file-pdf-o"></i>
					<span>Exportar a PDF</span>
				</div>
				<div class="export-option" data-action="word">
					<i class="fa fa-file-word-o"></i>
					<span>Exportar a Word</span>
				</div>
			</div>
		`;
		
		analysisResultDiv.appendChild(exportMenu);
		
		// Add event listeners
		const exportMenuBtn = document.getElementById('exportMenuBtn');
		const exportDropdown = document.getElementById('exportDropdown');
		
		// Click to toggle dropdown
		exportMenuBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			exportDropdown.classList.toggle('show');
		});
		
		// Show dropdown on hover
		exportMenu.addEventListener('mouseenter', () => {
			exportDropdown.classList.add('show');
		});
		
		// Hide dropdown when mouse leaves the container
		exportMenu.addEventListener('mouseleave', () => {
			exportDropdown.classList.remove('show');
		});
		
		// Handle export options
		document.querySelectorAll('.export-option').forEach(option => {
			option.addEventListener('click', (e) => {
				e.stopPropagation();
				const action = option.dataset.action;
				exportDropdown.classList.remove('show');
				handleExport(action);
			});
		});
		
		// Close dropdown when clicking outside
		document.addEventListener('click', (e) => {
			if (!exportMenu.contains(e.target)) {
				exportDropdown.classList.remove('show');
			}
		});
	}
	
	function handleExport(action) {
		const analysisContent = document.getElementById('analysisResult');
		const documentTitle = document.getElementById('normaShortName').textContent || 'Análisis';
		
		// Get document source link
		const extraDetailsDiv = document.getElementById('normaExtraDetails');
		let sourceLink = '';
		if (extraDetailsDiv) {
			const linkElement = extraDetailsDiv.querySelector('a');
			if (linkElement) {
				sourceLink = linkElement.href;
			}
		}
		
		switch(action) {
			case 'copy':
				copyToClipboard(analysisContent);
				break;
			case 'word':
				exportToWord(analysisContent, documentTitle, sourceLink);
				break;
			case 'pdf':
				exportToPDF(analysisContent, documentTitle, sourceLink);
				break;
		}
	}
	
	function copyToClipboard(element) {
		// Get text content without export menu
		const clone = element.cloneNode(true);
		const exportMenu = clone.querySelector('.export-menu-container');
		if (exportMenu) exportMenu.remove();
		
		const text = clone.innerText;
		
		if (navigator.clipboard) {
			navigator.clipboard.writeText(text).then(() => {
				showNotification('Contenido copiado al portapapeles');
			}).catch(err => {
				console.error('Error al copiar:', err);
				showNotification('Error al copiar el contenido', 'error');
			});
		} else {
			// Fallback for older browsers
			const textarea = document.createElement('textarea');
			textarea.value = text;
			textarea.style.position = 'fixed';
			textarea.style.opacity = '0';
			document.body.appendChild(textarea);
			textarea.select();
			document.execCommand('copy');
			document.body.removeChild(textarea);
			showNotification('Contenido copiado al portapapeles');
		}
	}
	
	function exportToWord(element, title, sourceLink = '') {
		// Clone and remove export menu
		const clone = element.cloneNode(true);
		const exportMenu = clone.querySelector('.export-menu-container');
		if (exportMenu) exportMenu.remove();
		
		const htmlContent = clone.innerHTML;
		const sourceSection = sourceLink ? `
			<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
				<h3 style="color: #34495e; margin-bottom: 10px;">Fuente:</h3>
				<p style="margin: 0;"><a href="${sourceLink}" style="color: #04db8d; text-decoration: none;">${sourceLink}</a></p>
			</div>
		` : '';
		
		const html = `
			<!DOCTYPE html>
			<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word">
			<head>
				<meta charset="utf-8">
				<title>${title}</title>
				<style>
					body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
					h1 { color: #2c3e50; border-bottom: 2px solid #04db8d; padding-bottom: 10px; }
					h2 { color: #2c3e50; margin-top: 20px; }
					h3 { color: #34495e; margin-top: 15px; }
					table { border-collapse: collapse; width: 100%; margin: 15px 0; }
					th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
					th { background-color: #f2f2f2; }
					tr:nth-child(even) { background-color: #f9f9f9; }
				</style>
			</head>
			<body>
				<h1>${title}</h1>
				<p style="color: #7f8c8d; font-size: 12px; margin-bottom: 20px;">Generado el ${new Date().toLocaleDateString('es-ES')}</p>
				${htmlContent}
				${sourceSection}
			</body>
			</html>
		`;
		
		const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
		const url = URL.createObjectURL(blob);
		const link = document.createElement('a');
		link.href = url;
		link.download = `${title}_${new Date().toISOString().slice(0,10)}.doc`;
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
		URL.revokeObjectURL(url);
		
		showNotification('Documento Word generado correctamente');
	}
	
	async function ensureHtml2PdfLoaded() {
		if (window.html2pdf) return true;
		return new Promise((resolve, reject) => {
			const s = document.createElement('script');
			s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
			s.onload = () => resolve(true);
			s.onerror = () => reject(new Error('No se pudo cargar html2pdf'));
			document.head.appendChild(s);
		});
	}

	async function exportToPDF(element, title, sourceLink = '') {
		try {
			await ensureHtml2PdfLoaded();
		} catch (e) { console.error(e); return; }

		// Clone and clean
		const clone = element.cloneNode(true);
		const exportMenu = clone.querySelector('.export-menu-container');
		if (exportMenu) exportMenu.remove();
		if (sourceLink) {
			const src = document.createElement('div');
			src.style.marginTop = '30px';
			src.style.paddingTop = '20px';
			src.style.borderTop = '1px solid #ddd';
			src.innerHTML = `<h3 style="color:#34495e;margin-bottom:10px;">Fuente:</h3><p style="margin:0; word-break:break-all;">${sourceLink}</p>`;
			clone.appendChild(src);
		}

		const opt = {
			margin: 10,
			filename: `${title || 'Analisis'}_${new Date().toISOString().slice(0,10)}.pdf`,
			image: { type: 'jpeg', quality: 0.95 },
			html2canvas: { scale: 2, useCORS: true },
			jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
		};
		// Use html2pdf to directly download
		window.html2pdf().set(opt).from(clone).save();
	}
	
	function showNotification(message, type = 'success') {
		const notification = document.createElement('div');
		notification.style.cssText = `
			position: fixed;
			top: 20px;
			right: 20px;
			background: ${type === 'success' ? '#04db8d' : '#ff4444'};
			color: white;
			padding: 12px 20px;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			z-index: 10000;
			animation: slideIn 0.3s ease-out;
		`;
		notification.textContent = message;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			notification.style.animation = 'slideOut 0.3s ease-out';
			setTimeout(() => {
				document.body.removeChild(notification);
			}, 300);
		}, 3000);
	}

    // Función global para inicializar desde profile.html
    window.initializeNormaAnalysis = async function() {
        console.log('[initializeNormaAnalysis] Starting initialization from profile.html');
        await initializeNormaAnalysisInternal();
    };

    async function initializeNormaAnalysisInternal() {
		const shortNameSpan = document.getElementById('normaShortName');
		const analyzeButton = document.getElementById('analyzeButton');
		const checklistButton = document.getElementById('checklistButton');
		const risksButton = document.getElementById('risksButton');
		const sendCustomPromptButton = document.getElementById('sendCustomPrompt');
		const analysisResultDiv = document.getElementById('analysisResult');
		const loaderDiv = document.getElementById('loader');
		const pageLoaderOverlay = document.getElementById('pageLoaderOverlay'); // Select the overlay
		const userPromptInput = document.getElementById('userPrompt');
		const analysisStatusDiv = document.getElementById('analysisStatus');
		const statusTextSpan = analysisStatusDiv.querySelector('.shimmer-text');
		const analysisDropdown = document.getElementById('analysisDropdown');
		const etiquetasList = document.getElementById('etiquetasList');
		const startAnalysisBtn = document.getElementById('startAnalysisBtn');
		const analysisSettingsBtn = document.getElementById('analysisSettingsBtn');
		const analysisSettingsDropdown = document.getElementById('analysisSettingsDropdown');
		const analysisIdiomaSelect = document.getElementById('analysis-idioma-select');
		let statusTimeouts = [];
		let currentAnalysisType = null;
		let activeAnalysisButton = null;

		// ===== Prompts loader =====
		let PROMPTS = {};
		function parsePrompts(mdText) {
			const text = mdText || '';
			const trimmed = text.trimStart();
			// Try YAML front matter first
			if (trimmed.startsWith('---')) {
				const endIdx = trimmed.indexOf('\n---');
				if (endIdx !== -1) {
					const yamlBlock = trimmed.substring(3, endIdx + 1); // exclude starting '---' and include trailing newline
					const lines = yamlBlock.split('\n');
					const result = {};
					let currentKey = null;
					let collectingBlock = false;
					let buffer = [];
					for (let i = 0; i < lines.length; i++) {
						const line = lines[i];
						const keyMatch = line.match(/^([A-Z_]+):\s*(\|)?\s*$/);
						if (keyMatch) {
							// flush previous
							if (currentKey) {
								result[currentKey] = buffer.join('\n').replace(/\s+$/, '');
							}
							currentKey = keyMatch[1].trim();
							collectingBlock = !!keyMatch[2];
							buffer = [];
						} else if (currentKey) {
							if (collectingBlock) {
								// part of block scalar: expect indentation
								const contentLine = line.replace(/^\s{2}/, '');
								buffer.push(contentLine);
							} else if (line.trim().length === 0) {
								// allow empty line between simple scalars (unused here)
								continue;
							} else {
								// treat as single-line value
								result[currentKey] = line.trim();
								currentKey = null;
								buffer = [];
							}
						}
					}
					if (currentKey) {
						result[currentKey] = buffer.join('\n').replace(/\s+$/, '');
					}
					// If YAML parsed into non-empty object, return it
					if (Object.keys(result).length > 0) return result;
				}
			}
			// Fallback: parse by markdown sections ## NAME
			const sections = {};
			let currentKey = null;
			let buffer = [];
			for (const line of text.split('\n')) {
				if (line.startsWith('## ')) {
					if (currentKey) sections[currentKey] = buffer.join('\n').trim();
					currentKey = line.substring(3).trim().toUpperCase();
					buffer = [];
				} else {
					buffer.push(line);
				}
			}
			if (currentKey) sections[currentKey] = buffer.join('\n').trim();
			return sections;
		}
		async function loadPromptsFromServer() {
			try {
				const res = await fetch('/prompts/analisis_normativo.md', { cache: 'no-store' });
				if (!res.ok) throw new Error('No se pudieron cargar los prompts');
				const md = await res.text();
				PROMPTS = parsePrompts(md);
			} catch (e) {
				console.error('Error cargando prompts:', e);
			}
		}
		function renderTemplate(key, replacements) {
			let tpl = (PROMPTS[key] || '').slice();
			if (!tpl) {
				throw new Error('Plantilla no disponible: ' + key);
			}
			for (const [k, v] of Object.entries(replacements || {})) {
				const token = new RegExp('\\{\\{'+k+'\\}\\}', 'g');
				tpl = tpl.replace(token, v || '');
			}
			return tpl;
		}

		// Cargar prompts en paralelo para no bloquear la carga de detalles
		const promptsPromise = loadPromptsFromServer();
		async function ensurePromptsLoaded(){
			try { await promptsPromise; } catch(e){ console.error('No se pudieron cargar los prompts', e); }
		}
		// ===== End prompts loader =====

		// Get the document ID from the URL (you can change this if you pass it differently)
		const urlParams = new URLSearchParams(window.location.search);
		const documentId = urlParams.get('documentId');
		const collectionName = urlParams.get('collectionName'); // Get the collection from URL

		// Early validation of required params to avoid hanging loader
		if (!documentId || !collectionName) {
			console.error('Missing required parameters for norma.html', { documentId, collectionName });
			try { window.__normaLoaded__ = true; } catch(_) {}
			if (pageLoaderOverlay) pageLoaderOverlay.style.display = 'none';
			analysisResultDiv.innerHTML = `
				<div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 8px; border-left: 4px solid #c62828; margin: 20px 0;">
					<h4 style="margin: 0 0 10px 0; color: #c62828;">Error: Parámetros faltantes</h4>
					<p>No se han encontrado los parámetros necesarios para cargar el documento. Vuelve al panel e inténtalo de nuevo.</p>
				</div>
			`;
			return;
		}

		// Global variables to store document data
		let documentUrlPdf = null;
		let documentUrlHtml = null;
		let documentContenido = null;

		// Analysis settings management
		function loadAnalysisSettings() {
			const savedIdioma = localStorage.getItem('analysis_idioma') || 'español';
			if (analysisIdiomaSelect) {
				analysisIdiomaSelect.value = savedIdioma;
			}
		}

		function saveAnalysisSettings() {
			if (analysisIdiomaSelect) {
				localStorage.setItem('analysis_idioma', analysisIdiomaSelect.value);
			}
		}

		function getSelectedAnalysisLanguage() {
			return analysisIdiomaSelect ? analysisIdiomaSelect.value : 'español';
		}

		function toggleAnalysisSettingsDropdown() {
			// Hide analysis dropdown if it's open
			hideAnalysisDropdown();
			analysisSettingsDropdown.classList.toggle('show');
		}

		function hideAnalysisSettingsDropdown() {
			analysisSettingsDropdown.classList.remove('show');
		}

		// Función para mostrar la sección de feedback
		function showFeedbackSection() {
			const feedbackSection = document.getElementById('feedbackSection');
			feedbackSection.style.display = 'block';
		}

		// Add event listener for custom prompt button
		sendCustomPromptButton.addEventListener('click', async () => {
			await handleCustomPrompt();
		});

		// Also allow pressing Enter in the textarea to submit
		userPromptInput.addEventListener('keydown', async (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				await handleCustomPrompt();
			}
		});

		// Function to handle custom prompt submissions
		async function handleCustomPrompt() {
			const userInput = userPromptInput.value.trim();
			if (!userInput) {
				alert('Por favor, escribe una consulta antes de enviar.');
				return;
			}
			await ensurePromptsLoaded();
			// Obtener idioma seleccionado
			const idiomaSeleccionado = getSelectedAnalysisLanguage();
			const bloqueIdioma = `\n**IDIOMA DE RESPUESTA:**\n<idioma>Aunque las instrucciones del prompt son en español, es muy importante que formules toda tu respuesta en ${idiomaSeleccionado}</idioma>\n`;
			const customSuffix = renderTemplate('CUSTOM_SUFFIX', { BLOQUE_IDIOMA: bloqueIdioma });
			const customPrompt = `${userInput}\n\n${customSuffix}`;
			performCustomAnalysis(customPrompt, sendCustomPromptButton);
		}

		// Function to build user prompt based on analysis type
		function buildUserPrompt(promptType) {
			// Obtener contexto de etiqueta seleccionada, si existe
			const etiquetaContext = window.getSelectedEtiquetaContext ? window.getSelectedEtiquetaContext() : null;
			let contextoEtiquetaTexto = '';
			if (etiquetaContext) {
				const { name, data } = etiquetaContext;
				let definicion = '';
				let nivelImpacto = '';
				if (typeof data === 'string') {
					definicion = data;
				} else if (data && typeof data === 'object') {
					definicion = data.explicacion || data.definicion || '';
					nivelImpacto = data.nivel_impacto || '';
				}
				const definicionGlobal = window.getDefinicionEtiqueta ? window.getDefinicionEtiqueta(name) : '';
				if (!definicion || definicion.trim() === '') {
					definicion = definicionGlobal;
				}
				contextoEtiquetaTexto = `\n=== CONTEXTO ESPECÍFICO DEL USUARIO – ETIQUETA SELECCIONADA ===\nEtiqueta: "${name}"\nDefinición global: ${definicionGlobal || 'No especificada'}\nDescripción / explicación específica: ${definicion || 'No especificada'}\nGrado de impacto en este documento: ${nivelImpacto || 'No especificado'}\n`;
			}
			// Obtener perfil regulatorio del usuario
			const perfilRegulatorio = window.getPerfilRegulatorio ? window.getPerfilRegulatorio() : '';
			let contextoPerfilTexto = '';
			if (perfilRegulatorio && perfilRegulatorio.trim() !== '') {
				contextoPerfilTexto = `\n=== CONTEXTO – PERFIL REGULATORIO DE LA EMPRESA ===\n${perfilRegulatorio}\n`;
			}
			// Obtener idioma seleccionado
			const idiomaSeleccionado = getSelectedAnalysisLanguage();
			const bloqueIdioma = `\n**IDIOMA DE RESPUESTA:**\n<idioma>Aunque las instrucciones del prompt son en español, es muy importante que formules toda tu respuesta en ${idiomaSeleccionado}</idioma>\n`;
			// Unir ambos contextos (perfil + etiqueta + idioma)
			const bloqueContexto = `${contextoPerfilTexto}${contextoEtiquetaTexto}${bloqueIdioma}\n`;

			if (promptType === 'checklist') {
				return renderTemplate('CHECKLIST', { BLOQUE_CONTEXTO: bloqueContexto });
			} else if (promptType === 'risks') {
				return renderTemplate('RISKS', { BLOQUE_CONTEXTO: bloqueContexto });
			} else if (promptType === 'summary') {
				const etiquetaContext = window.getSelectedEtiquetaContext ? window.getSelectedEtiquetaContext() : null;
				const tieneEtiqueta = !!etiquetaContext;
				const tituloImpacto = tieneEtiqueta ? `Impacto en ${etiquetaContext.name}` : 'Aspectos clave y puntos importantes';
				return renderTemplate('SUMMARY', { BLOQUE_CONTEXTO: bloqueContexto, TITULO_IMPACTO: tituloImpacto });
			}
		}

		// ===== Analysis logic =====
		function performCustomAnalysis(customPrompt, buttonElement) {
			analysisResultDiv.textContent = '';
			analysisResultDiv.classList.remove('show');
			analysisResultDiv.classList.remove('error-state');
			analysisResultDiv.style.display = 'none';
			setAnalysisButtonsState(true);
			const originalButtonText = buttonElement.innerHTML;
			buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
			document.querySelectorAll('.analisis-impacto').forEach(btn => { btn.classList.remove('active'); });
			if (typeof startStatusWorkflow === 'function') startStatusWorkflow('custom');
			const requestBody = { documentId: documentId, userPrompt: customPrompt, collectionName: collectionName };
			if (documentContenido) { requestBody.htmlContent = documentContenido; }
			fetch('/api/analyze-norma', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json', 'Accept': 'text/html; charset=utf-8' },
				body: JSON.stringify(requestBody)
			})
			.then(response => {
				const contentType = response.headers.get('content-type');
				if (!response.ok) {
					if (contentType && contentType.includes('application/json')) {
						return response.json().then(errorData => { throw new Error(JSON.stringify(errorData)); });
					} else {
						return response.text().then(errorText => { try { const jsonData = JSON.parse(errorText); throw new Error(JSON.stringify(jsonData)); } catch (e) { throw new Error(errorText); } });
					}
				}
				if (contentType && contentType.includes('text/html')) { return response.text(); }
				else if (contentType && contentType.includes('application/json')) { return response.json().then(jsonData => jsonData.html_response ? jsonData.html_response : JSON.stringify(jsonData)); }
				else if (contentType && contentType.includes('text/plain')) { return response.text(); }
				return response.text();
			})
			.then(data => {
				let htmlContent = data;
				if (typeof data === 'string') {
					try { const jsonData = JSON.parse(data); if (jsonData.html_response) { htmlContent = jsonData.html_response; } }
					catch (e) {
						htmlContent = data.replace(/^```html\s*|\s*```|^<!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<!DOCTYPE html>/g, '');
						if (!htmlContent.includes('<') && htmlContent.trim().length > 0) { htmlContent = `<p>${htmlContent}</p>`; }
					}
				} else if (typeof data === 'object' && data.html_response) { htmlContent = data.html_response; }
				// Clean the HTML content
				htmlContent = cleanAnalysisOutput(htmlContent);
				if (typeof completeStatusWorkflow === 'function') {
					completeStatusWorkflow(() => {
						buttonElement.innerHTML = originalButtonText;
						setAnalysisButtonsState(false);
						analysisResultDiv.innerHTML = htmlContent;
						analysisResultDiv.style.display = 'block';
						analysisResultDiv.classList.remove('show');
						analysisResultDiv.classList.remove('error-state');
						setTimeout(() => {
							analysisResultDiv.classList.add('show');
							addExportMenu();
							if (typeof showFeedbackSection === 'function') showFeedbackSection();
						}, 100);
					});
				} else {
					buttonElement.innerHTML = originalButtonText;
					setAnalysisButtonsState(false);
					analysisResultDiv.innerHTML = htmlContent;
					analysisResultDiv.style.display = 'block';
					analysisResultDiv.classList.remove('show');
					analysisResultDiv.classList.remove('error-state');
					setTimeout(() => {
						analysisResultDiv.classList.add('show');
						addExportMenu();
						if (typeof showFeedbackSection === 'function') showFeedbackSection();
					}, 100);
				}
			})
			.catch(error => {
				console.error('Error analyzing norma:', error);
				let errorType = 'GENERIC_ERROR';
				let errorMessage = 'Error: Ocurrió un error inesperado al procesar la respuesta del análisis. Prueba de nuevo por favor';
				let statusMessage = 'Error en el análisis';
				try { const errorData = JSON.parse(error.message); errorType = errorData.error; errorMessage = errorData.message; if (errorData.details) { console.log('Error details:', errorData.details); } }
				catch (e) { console.error('Error parsing error response:', e); const errorText = error.message || error.toString(); if (errorText.includes('PDF_ACCESS_ERROR') || errorText.includes('PDF access')) { errorType = 'PDF_ACCESS_ERROR'; errorMessage = 'Error al acceder al documento, análisis no disponible.'; } else if (errorText.includes('timeout') || errorText.includes('TIMEOUT') || errorText.includes('ETIMEOUT')) { errorType = 'TIMEOUT_ERROR'; errorMessage = 'La consulta tardó demasiado tiempo. Por favor, inténtalo de nuevo.'; } else if (errorText.includes('DATABASE_TIMEOUT')) { errorType = 'DATABASE_TIMEOUT'; errorMessage = 'Error: La consulta tardó demasiado tiempo. Por favor, inténtalo de nuevo.'; } else if (errorText.includes('network') || errorText.includes('connection')) { errorType = 'NETWORK_ERROR'; errorMessage = 'Error de conexión. Por favor, verifica tu conexión a internet e inténtalo de nuevo.'; } else if (errorText.includes('Internal Server Error') || errorText.includes('500')) { errorType = 'SERVER_ERROR'; errorMessage = 'Error interno del servidor. Por favor, inténtalo de nuevo.'; } else if (errorText.length > 0 && errorText.length < 200) { errorMessage = errorText; } }
				if (errorType === 'PDF_ACCESS_ERROR') { statusMessage = 'Error accediendo al documento'; }
				else if (errorType === 'TIMEOUT_ERROR') { statusMessage = 'Tiempo de espera agotado'; }
				else if (errorType === 'DATABASE_TIMEOUT') { statusMessage = 'Tiempo de espera agotado'; }
				else if (errorType === 'NETWORK_ERROR') { statusMessage = 'Error de conexión'; }
				else if (errorType === 'SERVER_ERROR') { statusMessage = 'Error del servidor'; }
				else { statusMessage = 'Error procesando análisis'; }
				completeStatusWorkflowWithErrorAndCallback(statusMessage, () => {
					buttonElement.innerHTML = originalButtonText;
					setAnalysisButtonsState(false);
					let errorStyle = '';
					if (errorType === 'PDF_ACCESS_ERROR') { errorStyle = `
						background-color: #ffebee;
						border: 2px solid #c62828;
						color: #c62828;
						padding: 15px;
						border-radius: 8px;
						margin: 10px 0;
						font-weight: 500;
					`; } else { errorStyle = `
						background-color: #ffebee;
						border: 2px solid #c62828;
						color: #f57f17;
						padding: 15px;
						border-radius: 8px;
						margin: 10px 0;
						font-weight: 500;
					`; }
					const errorDiv = document.createElement('div');
					errorDiv.style.cssText = errorStyle;
					errorDiv.textContent = errorMessage;
					analysisResultDiv.innerHTML = '';
					analysisResultDiv.appendChild(errorDiv);
					analysisResultDiv.style.display = 'block';
					analysisResultDiv.classList.remove('show');
					analysisResultDiv.classList.add('error-state');
					setTimeout(() => { analysisResultDiv.classList.add('show'); }, 250);
				});
			});
		}

		function setAnalysisButtonsState(disabled) {
			const buttons = [analyzeButton, checklistButton, risksButton, sendCustomPromptButton];
			buttons.forEach(btn => { btn.disabled = disabled; if (disabled) { btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; } else { btn.style.opacity = '1'; btn.style.cursor = 'pointer'; } });
		}

		function showAnalysisDropdown(analysisType, buttonElement) {
			hideAnalysisSettingsDropdown();
			currentAnalysisType = analysisType;
			activeAnalysisButton = buttonElement;
			document.querySelectorAll('.analisis-impacto').forEach(btn => { btn.classList.remove('active'); });
			buttonElement.classList.add('active');
			const buttonRect = buttonElement.getBoundingClientRect();
			const containerRect = buttonElement.parentElement.getBoundingClientRect();
			const leftOffset = buttonRect.left - containerRect.left;
			analysisDropdown.style.left = `${leftOffset}px`;
			const etiquetasData = window.getEtiquetasData ? window.getEtiquetasData() : {};
			etiquetasList.innerHTML = '';
			const keys = Object.keys(etiquetasData || {});
			if (keys.length === 1) {
				// Autoselección: si solo hay un agente, lo seleccionamos y disparamos el análisis sin dropdown
				const only = keys[0];
				if (window.setSelectedEtiqueta) { window.setSelectedEtiqueta(only, etiquetasData[only]); }
				analysisDropdown.style.display = 'none';
				performAnalysis(analysisType, buttonElement);
				return;
			}
			if (keys.length > 1) {
				// Render como lista de radios (solo puede haber uno seleccionado)
				keys.forEach(etiqueta => {
					const item = document.createElement('div');
					item.className = 'etiqueta-radio-item';
					const radio = document.createElement('div');
					radio.className = 'radio-control';
					const dot = document.createElement('div');
					dot.className = 'dot';
					radio.appendChild(dot);
					const label = document.createElement('div');
					label.className = 'etiqueta-radio-label';
					label.textContent = etiqueta;
					item.appendChild(radio);
					item.appendChild(label);
					item.addEventListener('click', () => {
						etiquetasList.querySelectorAll('.etiqueta-radio-item').forEach(el => el.classList.remove('selected'));
						item.classList.add('selected');
						if (window.setSelectedEtiqueta) { window.setSelectedEtiqueta(etiqueta, etiquetasData[etiqueta]); }
						if (startAnalysisBtn) { startAnalysisBtn.disabled = false; }
					});
					etiquetasList.appendChild(item);
				});
				startAnalysisBtn.disabled = true;
			} else {
				const noEtiquetasMsg = document.createElement('div');
				noEtiquetasMsg.style.color = '#999';
				noEtiquetasMsg.style.fontStyle = 'italic';
				noEtiquetasMsg.textContent = 'No hay agentes disponibles para este documento';
				etiquetasList.appendChild(noEtiquetasMsg);
			}
			startAnalysisBtn.textContent = 'Empezar análisis';
			analysisDropdown.style.display = 'block';
		}

		function hideAnalysisDropdown() {
			analysisDropdown.style.display = 'none';
			analysisDropdown.style.left = '0';
			document.querySelectorAll('.analisis-impacto').forEach(btn => { btn.classList.remove('active'); });
			currentAnalysisType = null;
			activeAnalysisButton = null;
		}

		async function performWebscrapingAnalysis(promptType, buttonElement, htmlUrl) {
			try {
				const webscrapingResponse = await fetch('/api/webscrape', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: htmlUrl }) });
				if (!webscrapingResponse.ok) throw new Error('Error during webscraping');
				const webscrapingData = await webscrapingResponse.json();
				const htmlContent = webscrapingData.text;
				return performAnalysisWithContent(promptType, buttonElement, htmlContent, htmlUrl);
			} catch (error) { console.error('Error during webscraping:', error); throw error; }
		}

		function performAnalysisWithContent(promptType, buttonElement, directContent = null, sourceUrl = null) {
			return ensurePromptsLoaded().then(() => new Promise((resolve, reject) => {
				const requestBody = { documentId: documentId, userPrompt: buildUserPrompt(promptType), collectionName: collectionName };
				if (directContent) { requestBody.htmlContent = directContent; }
				fetch('/api/analyze-norma', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'text/html; charset=utf-8' }, body: JSON.stringify(requestBody) })
				.then(response => {
					const contentType = response.headers.get('content-type');
					if (!response.ok) {
						if (contentType && contentType.includes('application/json')) { return response.json().then(errorData => { throw new Error(JSON.stringify(errorData)); }); }
						else { return response.text().then(errorText => { try { const jsonData = JSON.parse(errorText); throw new Error(JSON.stringify(jsonData)); } catch (e) { throw new Error(errorText); } }); }
					}
					if (contentType && contentType.includes('text/html')) { return response.text(); }
					else if (contentType && contentType.includes('application/json')) { return response.json().then(jsonData => jsonData.html_response ? jsonData.html_response : JSON.stringify(jsonData)); }
					else if (contentType && contentType.includes('text/plain')) { return response.text(); }
					return response.text();
				})
				.then(data => {
					let htmlResult = data;
					if (typeof data === 'string') {
						try { const jsonData = JSON.parse(data); if (jsonData.html_response) { htmlResult = jsonData.html_response; } }
						catch (e) {
							htmlResult = data.replace(/^```html\s*|\s*```|^<!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<!DOCTYPE html>/g, '');
							if (!htmlResult.includes('<') && htmlResult.trim().length > 0) { htmlResult = `<p>${htmlResult}</p>`; }
						}
					} else if (typeof data === 'object' && data.html_response) { htmlResult = data.html_response; }
					// Clean the HTML result
					htmlResult = cleanAnalysisOutput(htmlResult);
					let finalHtml = htmlResult;
					if (directContent && sourceUrl) { const banner = `<div class=\"html-source-banner\">Documento PDF no identificado para este documento, análisis basado en el texto publicado en la <a href=\"${sourceUrl}\" target=\"_blank\">fuente</a></div>`; finalHtml = banner + htmlResult; }
					resolve(finalHtml);
				})
				.catch(error => {
					let errorType = 'GENERIC_ERROR';
					let errorMessage = 'Error analizando la norma. Por favor, inténtalo de nuevo.';
					try { const errorData = JSON.parse(error.message); errorType = errorData.error; errorMessage = errorData.message; if (errorData.details) { console.log('Error details:', errorData.details); } }
					catch (e) { console.error('Error parsing error response:', e); const errorText = error.message || error.toString(); if (errorText.includes('PDF_ACCESS_ERROR') || errorText.includes('PDF access')) { errorType = 'PDF_ACCESS_ERROR'; errorMessage = 'Error al acceder al documento, análisis no disponible.'; } else if (errorText.includes('timeout') || errorText.includes('TIMEOUT') || errorText.includes('ETIMEOUT')) { errorType = 'TIMEOUT_ERROR'; errorMessage = 'La consulta tardó demasiado tiempo. Por favor, inténtalo de nuevo.'; } else if (errorText.includes('DATABASE_TIMEOUT')) { errorType = 'DATABASE_TIMEOUT'; errorMessage = 'Error: La consulta tardó demasiado tiempo. Por favor, inténtalo de nuevo.'; } else if (errorText.includes('network') || errorText.includes('connection')) { errorType = 'NETWORK_ERROR'; errorMessage = 'Error de conexión. Por favor, verifica tu conexión a internet e inténtalo de nuevo.'; } else if (errorText.includes('Internal Server Error') || errorText.includes('500')) { errorType = 'SERVER_ERROR'; errorMessage = 'Error interno del servidor. Por favor, inténtalo de nuevo.'; } else if (errorText.length > 0 && errorText.length < 200) { errorMessage = errorText; } }
						const errorObj = new Error(errorMessage); errorObj.errorType = errorType; reject(errorObj);
					});
				}));
		}

		function performAnalysis(promptType, buttonElement) {
			if (!buttonElement || typeof buttonElement.innerHTML === 'undefined') { console.error('Error: buttonElement is null or invalid in performAnalysis'); alert('Error: Elemento de botón no válido. Por favor, inténtalo de nuevo.'); return; }
			analysisResultDiv.textContent = '';
			analysisResultDiv.classList.remove('show');
			analysisResultDiv.classList.remove('error-state');
			analysisResultDiv.style.display = 'none';
			setAnalysisButtonsState(true);
			if (typeof startStatusWorkflow === 'function') startStatusWorkflow(promptType);
			const originalButtonText = buttonElement.innerHTML;
			buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analizando...';
			document.querySelectorAll('.analisis-impacto').forEach(btn => { btn.classList.remove('active'); });
			buttonElement.classList.add('active');
			let analysisPromise;
			if (documentContenido) {
				analysisPromise = performAnalysisWithContent(promptType, buttonElement, documentContenido);
			} else if (documentUrlPdf) {
				analysisPromise = performAnalysisWithContent(promptType, buttonElement);
			} else if (documentUrlHtml) {
				analysisPromise = performWebscrapingAnalysis(promptType, buttonElement, documentUrlHtml);
			} else {
				console.error('No content sources available for analysis');
				setAnalysisButtonsState(false);
				buttonElement.innerHTML = originalButtonText;
				buttonElement.classList.remove('active');
				clearStatusWorkflow();
				alert('No hay fuentes disponibles para el análisis de este documento.');
				return;
			}
			analysisPromise.then(htmlContent => {
				if (typeof completeStatusWorkflow === 'function') {
					completeStatusWorkflow(() => {
						buttonElement.innerHTML = originalButtonText;
						buttonElement.style.backgroundColor = '';
						setAnalysisButtonsState(false);
						analysisResultDiv.innerHTML = htmlContent;
						analysisResultDiv.style.display = 'block';
						analysisResultDiv.classList.remove('show');
						analysisResultDiv.classList.remove('error-state');
						setTimeout(() => { 
						analysisResultDiv.classList.add('show'); 
						addExportMenu();
						if (typeof showFeedbackSection === 'function') showFeedbackSection(); 
					}, 100);
					});
				} else {
					buttonElement.innerHTML = originalButtonText;
					buttonElement.style.backgroundColor = '';
					setAnalysisButtonsState(false);
					analysisResultDiv.innerHTML = htmlContent;
					analysisResultDiv.style.display = 'block';
					analysisResultDiv.classList.remove('show');
					analysisResultDiv.classList.remove('error-state');
					setTimeout(() => { 
						analysisResultDiv.classList.add('show'); 
						addExportMenu();
						if (typeof showFeedbackSection === 'function') showFeedbackSection(); 
					}, 100);
				}
			}).catch(error => {
				console.error('Error analyzing norma:', error);
				let errorType = 'GENERIC_ERROR';
				let errorMessage = 'Error: Ocurrió un error inesperado al procesar la respuesta del análisis. Prueba de nuevo por favor';
				let statusMessage = 'Error en el análisis';
				try { const errorData = JSON.parse(error.message); errorType = errorData.error; errorMessage = errorData.message; }
				catch (e) { console.error('Error parsing error response:', e); }
				if (errorType === 'PDF_ACCESS_ERROR') { statusMessage = 'Error accediendo al documento'; } else { statusMessage = 'Error procesando análisis'; }
				completeStatusWorkflowWithErrorAndCallback(statusMessage, () => {
					buttonElement.innerHTML = originalButtonText;
					buttonElement.classList.remove('active');
					setAnalysisButtonsState(false);
					let errorStyle = '';
					if (errorType === 'PDF_ACCESS_ERROR') { errorStyle = `
						background-color: #ffebee;
						border: 2px solid #c62828;
						color: #c62828;
						padding: 15px;
						border-radius: 8px;
						margin: 10px 0;
						font-weight: 500;
					`; } else { errorStyle = `
						background-color: #ffebee;
						border: 2px solid #c62828;
						color:#c62828;
						padding: 15px;
						border-radius: 8px;
						margin: 10px 0;
						font-weight: 500;
					`; }
					const errorDiv = document.createElement('div');
					errorDiv.style.cssText = errorStyle;
					errorDiv.textContent = errorMessage;
					analysisResultDiv.innerHTML = '';
					analysisResultDiv.appendChild(errorDiv);
					analysisResultDiv.style.display = 'block';
					analysisResultDiv.classList.remove('show');
					analysisResultDiv.classList.add('error-state');
					setTimeout(() => { analysisResultDiv.classList.add('show'); }, 250);
				});
			});
		}

		// ===== Event listeners =====
		// Mostrar skeleton loaders inicialmente
		const shortNameSkeleton = document.getElementById('normaShortNameSkeleton');
		const extraDetailsSkeleton = document.getElementById('normaExtraDetailsSkeleton');
		
		fetch(`/api/norma-details?documentId=${documentId}&collectionName=${collectionName}`)
			.then(response => response.json())
			.then(data => {
				// Ocultar skeleton y mostrar contenido real
				if (shortNameSkeleton) {
					shortNameSkeleton.classList.add('skeleton-hidden');
				}
				if (extraDetailsSkeleton) {
					extraDetailsSkeleton.classList.add('skeleton-hidden');
				}
				
				shortNameSpan.textContent = data.short_name;
				shortNameSpan.style.display = 'inline';
				
				// Ocultar loader de profile.html una vez que se cargan los datos básicos
				if (typeof window.hidePageLoaderOverlay === 'function') {
					console.log('[norma.html] Datos básicos cargados, ocultando loader de profile.html');
					window.hidePageLoaderOverlay();
				}
			// Update breadcrumb
			const breadcrumbDocName = document.getElementById('breadcrumbDocName');
			if (breadcrumbDocName) {
				breadcrumbDocName.textContent = data.short_name || 'Documento';
			}
				documentUrlPdf = data.url_pdf;
				documentUrlHtml = data.url_html;
				documentContenido = data.contenido;
				if (!documentContenido && !documentUrlPdf && !documentUrlHtml) {
					const impactButtons = [analyzeButton, checklistButton, risksButton];
					impactButtons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; });
					const banner = document.createElement('div');
					banner.className = 'no-analysis-banner';
					banner.textContent = 'Documento con análisis de impacto no disponible';
					const buttonsContainer = analyzeButton.parentElement;
					buttonsContainer.insertAdjacentElement('afterend', banner);
				}
				const extraDetailsDiv = document.getElementById('normaExtraDetails');
				if (extraDetailsDiv) {
					let detailsParts = [];
					if (data.collectionName) { detailsParts.push(data.collectionName); }
					if (data.rango_titulo) { detailsParts.push(data.rango_titulo); }
					if (data.url_pdf) { detailsParts.push(`<a href="${data.url_pdf}" target="_blank" style="color: #757575; text-decoration: underline;">Leer documento</a>`); }
					else if (data.url_html) { detailsParts.push(`<a href="${data.url_html}" target="_blank" style="color: #757575; text-decoration: underline;">Leer documento</a>`); }
					extraDetailsDiv.innerHTML = detailsParts.filter(part => part !== null && part !== undefined && part !== '').join(' | ');
					extraDetailsDiv.style.display = 'block';
					const perfilRegulatorioUser = data.perfil_regulatorio || '';
					const definicionesMap = data.user_etiquetas_definiciones || {};
					const isEnterprise = !!data.user_is_enterprise;
					const seleccionadas = Array.isArray(data.user_etiquetas_seleccionadas) ? data.user_etiquetas_seleccionadas : [];
					let etiquetasData = data.user_etiquetas_personalizadas || {};
					// Normalizar: si viene como array (legacy), convertir a objeto con definiciones
					if (Array.isArray(etiquetasData)) {
						const obj = {};
						etiquetasData.forEach((nombre) => { obj[nombre] = definicionesMap[nombre] || ''; });
						etiquetasData = obj;
					}
					// A partir de backend, etiquetasData ya viene filtrado a etiquetas que hacen match con el documento.
					// Si quieres reforzar selección local (opcional): intersectar con seleccionadas cuando existan
					if (isEnterprise && seleccionadas.length > 0) {
						const filtered = {};
						seleccionadas.forEach((nombre) => {
							if (Object.prototype.hasOwnProperty.call(etiquetasData, nombre)) {
								filtered[nombre] = etiquetasData[nombre];
							}
						});
						etiquetasData = filtered;
					}
					window.getPerfilRegulatorio = () => perfilRegulatorioUser;
					window.getDefinicionEtiqueta = (et) => definicionesMap[et] || '';
					let selectedEtiquetaName = null;
					let selectedEtiquetaData = null;
					window.getEtiquetasData = () => etiquetasData || {};
					window.setSelectedEtiqueta = (name, data) => { selectedEtiquetaName = name; selectedEtiquetaData = data; };
					window.getSelectedEtiquetaContext = () => { if (!selectedEtiquetaName) return null; return { name: selectedEtiquetaName, data: selectedEtiquetaData }; };
				}
				try { window.__normaLoaded__ = true; } catch(_) {}
				pageLoaderOverlay.style.display = 'none';
			})
			.catch(error => { console.error('Error fetching norma details:', error); analysisResultDiv.textContent = 'Error fetching norma details.'; try { window.__normaLoaded__ = true; } catch(_) {} pageLoaderOverlay.style.display = 'none'; });

		// Breadcrumb navigation
	const backToAgentesBtn = document.getElementById('backToAgentes');
	if (backToAgentesBtn) {
		backToAgentesBtn.addEventListener('click', (e) => {
			e.preventDefault();
			
			// Show loading state
			const originalContent = backToAgentesBtn.innerHTML;
			backToAgentesBtn.disabled = true;
			backToAgentesBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
			
			// Check if we're in profile.html context (SPA navigation)
			if (window.location.href.includes('/profile') && typeof window.loadTrackerContent === 'function') {
				console.log('[backToAgentes] Using SPA navigation to tracker');
				
				try {
					// Update URL without reload
					const newUrl = new URL(window.location.href);
					newUrl.searchParams.delete('view');
					newUrl.searchParams.delete('documentId');
					newUrl.searchParams.delete('collectionName');
					newUrl.hash = '';
					window.history.pushState({path: newUrl.href}, '', newUrl.href);
					
					// Hide all sections and show agentes
					document.querySelectorAll('.vision-section').forEach(section => {
						section.style.display = 'none';
						section.classList.remove('active');
					});
					
					const agentesSection = document.getElementById('content-agentes');
					if (agentesSection) {
						agentesSection.style.display = 'block';
						agentesSection.classList.add('active');
					}
					
					// Reset sidebar active states
					document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
					const agentesMenuItem = document.querySelector('.sidebar-item[data-target="content-agentes"]');
					if (agentesMenuItem) {
						agentesMenuItem.classList.add('active');
					}
					
					// Reset analysis state and force tracker reload
					window.analisisContentLoaded = false;
					window.analisisContentLoading = false;
					
					// Reset tracker state to force fresh load
					if (typeof window.trackerInitialized !== 'undefined') {
						window.trackerInitialized = false;
					}
					
					// Remove gradient background from main-content when leaving analysis
					const mainContent = document.getElementById('main-content');
					if (mainContent) {
						mainContent.style.background = 'white';
						mainContent.style.minHeight = '100vh';
					}
					
					// Clear the container and show loading state
					if (agentesSection) {
						agentesSection.innerHTML = `
							<div style="display: flex; justify-content: center; align-items: center; height: 60vh; flex-direction: column;">
								<div class="tracker-loader" style="width: 60px; height: 60px; border: 4px solid rgba(4, 219, 141, 0.3); border-top-color: #04db8d; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
								<div style="color: #455862; font-size: 16px; text-align: center;">
									<div style="font-weight: 600; margin-bottom: 8px;">Regresando a Agentes</div>
									<div style="font-size: 14px; opacity: 0.8;">Cargando tracker de documentos...</div>
								</div>
							</div>
							<style>
								@keyframes spin {
									0% { transform: rotate(0deg); }
									100% { transform: rotate(360deg); }
								}
							</style>
						`;
					}
					
					// Force reload tracker content
					const trackerContentLoaded = window.trackerContentLoaded || false;
					window.trackerContentLoaded = false;
					window.trackerContentLoading = false;
					
					// Load tracker content with force reload and callback to restore button
					window.loadTrackerContent(() => {
						// Restore button state after successful load
						backToAgentesBtn.disabled = false;
						backToAgentesBtn.innerHTML = originalContent;
					}, true); // forceReload = true
					
					// Safety timeout to restore button if something fails
					setTimeout(() => {
						if (backToAgentesBtn.disabled) {
							backToAgentesBtn.disabled = false;
							backToAgentesBtn.innerHTML = originalContent;
						}
					}, 5000);
					
				} catch (error) {
					console.error('[backToAgentes] Error in SPA navigation:', error);
					// Fallback to traditional navigation
					window.location.href = '/profile';
				}
			} else {
				// Fallback: traditional navigation
				console.log('[backToAgentes] Using traditional navigation');
				window.location.href = '/profile';
			}
		});
	}

	analyzeButton.addEventListener('click', () => { showAnalysisDropdown('summary', analyzeButton); });
		checklistButton.addEventListener('click', () => { showAnalysisDropdown('checklist', checklistButton); });
		risksButton.addEventListener('click', () => { showAnalysisDropdown('risks', risksButton); });
		startAnalysisBtn.addEventListener('click', () => { if (currentAnalysisType && activeAnalysisButton && activeAnalysisButton.innerHTML) { const analysisType = currentAnalysisType; const buttonElement = activeAnalysisButton; hideAnalysisDropdown(); performAnalysis(analysisType, buttonElement); } else { console.error('Error: activeAnalysisButton is null or invalid'); alert('Error: No se pudo identificar el botón de análisis. Por favor, inténtalo de nuevo.'); } });

		// ===== Status workflow and helpers remain as defined below =====

		// Configurar los listeners para el feedback
		function setupFeedbackListeners() {
			document.getElementById('feedbackToggle').addEventListener('click', function() {
				const feedbackContent = document.getElementById('feedbackContent');
				const chevron = this.querySelector('.fa');
				if (feedbackContent.style.display === 'none') {
					feedbackContent.style.display = 'block';
					chevron.classList.remove('fa-chevron-down');
					chevron.classList.add('fa-chevron-up');
				} else {
					feedbackContent.style.display = 'none';
					chevron.classList.remove('fa-chevron-up');
					chevron.classList.add('fa-chevron-down');
				}
			});
			document.getElementById('sendFeedbackBtn').addEventListener('click', function() {
				const feedbackText = document.getElementById('feedbackText').value.trim();
				if (!feedbackText) { alert('Por favor, introduce tu feedback antes de enviar.'); return; }
				this.disabled = true; this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';
				const urlParams = new URLSearchParams(window.location.search);
				const documentId = urlParams.get('documentId');
				const collectionName = urlParams.get('collectionName');
				const userPrompt = document.getElementById('userPrompt').value;
				const analysisResults = document.getElementById('analysisResult').innerHTML;
				const now = new Date();
				const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
				fetch('/api/feedback-analisis', {
					method: 'POST', headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ documentId, collectionName, userPrompt, analysisResults, fecha: dateStr, feedback: feedbackText, content_evaluated: 'analisis_impacto' })
				})
				.then(response => response.json())
				.then(data => {
					this.disabled = false; this.innerHTML = 'Enviar feedback';
					if (data.success) {
						const successMsg = document.createElement('div');
						successMsg.className = 'feedback-success';
						successMsg.textContent = '¡Gracias por tu feedback!';
						document.getElementById('feedbackContent').appendChild(successMsg);
						document.getElementById('feedbackText').value = '';
					} else { alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.'); }
				})
				.catch(error => { console.error('Error sending feedback:', error); this.disabled = false; this.innerHTML = 'Enviar feedback'; alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.'); });
			});
		}
		setupFeedbackListeners();

		// Add click outside to close dropdown
		document.addEventListener('click', function(event) {
			if (!analysisDropdown.contains(event.target) && !analyzeButton.contains(event.target) && !checklistButton.contains(event.target) && !risksButton.contains(event.target)) {
				hideAnalysisDropdown();
			}
			if (!analysisSettingsDropdown.contains(event.target) && !analysisSettingsBtn.contains(event.target)) {
				hideAnalysisSettingsDropdown();
			}
		});

		// Analysis settings event listeners
		if (analysisSettingsBtn) {
			analysisSettingsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleAnalysisSettingsDropdown(); });
		}
		if (analysisIdiomaSelect) {
			analysisIdiomaSelect.addEventListener('change', () => { saveAnalysisSettings(); });
		}
		loadAnalysisSettings();

		function startStatusWorkflow(analysisType = 'generic') {
			clearStatusWorkflow();
			console.log('[workflow] starting for type:', analysisType);
			analysisStatusDiv.style.display = 'flex';
			statusTextSpan.classList.remove('slide');
			void statusTextSpan.offsetWidth;
			statusTextSpan.textContent = 'Pensando…';
			let specificSteps = [];
			if (analysisType === 'summary') {
				specificSteps = [
					{ text: 'Resumiendo aspectos generales…', duration: 2500 },
					{ text: 'Analizando el objetivo de la norma…', duration: 2500 },
					{ text: 'Identificando sujetos afectados…', duration: 2500 },
					{ text: 'Recomendando próximos pasos…', duration: 2500 }
				];
			} else if (analysisType === 'checklist') {
				specificSteps = [
					{ text: 'Identificando cuadro de obligaciones…', duration: 2500 },
					{ text: 'Referenciando los artículos…', duration: 2500 },
					{ text: 'Analizando sanciones por incumplimiento…', duration: 2500 }
				];
			} else if (analysisType === 'risks') {
				specificSteps = [
					{ text: 'Identificando oportunidades…', duration: 2500 },
					{ text: 'Analizando riesgos…', duration: 2500 }
				];
			} else {
				specificSteps = [
					{ text: 'Procesando tu consulta…', duration: 2500 },
					{ text: 'Buscando información relevante…', duration: 2500 },
					{ text: 'Estructurando la respuesta…', duration: 2500 }
				];
			}
			const commonSteps = [
				{ text: 'Pensando…', duration: 3000 },
				{ text: 'Accediendo a la fuente oficial…', duration: 2000 },
				{ text: 'Analizando el documento…', duration: 3000 }
			];
			const steps = [ ...commonSteps, ...specificSteps, { text: 'Personalizando el análisis…', duration: null } ];
			let cumulative = 0;
			steps.forEach((step) => {
				const t = setTimeout(() => {
					console.log('[workflow] step', step.text);
					statusTextSpan.classList.remove('slide');
					void statusTextSpan.offsetWidth;
					statusTextSpan.textContent = step.text;
					statusTextSpan.classList.add('slide');
				}, cumulative);
				statusTimeouts.push(t);
				if (step.duration) cumulative += step.duration;
			});
		}

		function clearStatusWorkflow() {
			statusTimeouts.forEach(t => clearTimeout(t));
			statusTimeouts = [];
			console.log('[workflow] cleared');
			analysisStatusDiv.style.display = 'none';
		}

		function completeStatusWorkflowWithError() {
			statusTimeouts.forEach(t => clearTimeout(t));
			statusTimeouts = [];
			console.log('[workflow] completing with error - API error received');
			const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
			spinnerIcon.className = 'fa fa-exclamation-triangle';
			statusTextSpan.classList.remove('slide');
			void statusTextSpan.offsetWidth;
			statusTextSpan.textContent = 'Error en el análisis';
			statusTextSpan.classList.add('slide');
			setTimeout(() => {
				analysisStatusDiv.classList.add('status-completed');
				setTimeout(() => {
					analysisStatusDiv.style.display = 'none';
					analysisStatusDiv.classList.remove('status-completed');
					spinnerIcon.className = 'fa fa-spinner spinner';
				}, 800);
			}, 800);
		}

		function completeStatusWorkflowWithErrorAndCallback(errorMessage, callback) {
			statusTimeouts.forEach(t => clearTimeout(t));
			statusTimeouts = [];
			console.log('[workflow] completing with error - showing custom message');
			const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
			spinnerIcon.className = 'fa fa-exclamation-triangle';
			statusTextSpan.classList.remove('slide');
			void statusTextSpan.offsetWidth;
			statusTextSpan.textContent = errorMessage;
			statusTextSpan.classList.add('slide');
			setTimeout(() => {
				analysisStatusDiv.classList.add('status-completed');
				setTimeout(() => {
					analysisStatusDiv.style.display = 'none';
					analysisStatusDiv.classList.remove('status-completed');
					spinnerIcon.className = 'fa fa-spinner spinner';
					if (callback && typeof callback === 'function') { callback(); }
				}, 800);
			}, 1200);
		}

		function completeStatusWorkflow(onCompleteCallback) {
			statusTimeouts.forEach(t => clearTimeout(t));
			statusTimeouts = [];
			console.log('[workflow] completing with success - API response received');
			const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
			spinnerIcon.className = 'fa fa-check';
			statusTextSpan.classList.remove('slide');
			void statusTextSpan.offsetWidth;
			statusTextSpan.textContent = 'Análisis Finalizado';
			statusTextSpan.classList.add('slide');
			setTimeout(() => {
				analysisStatusDiv.classList.add('status-completed');
				setTimeout(() => {
					analysisStatusDiv.style.display = 'none';
					analysisStatusDiv.classList.remove('status-completed');
					spinnerIcon.className = 'fa fa-spinner spinner';
					if (onCompleteCallback && typeof onCompleteCallback === 'function') { onCompleteCallback(); }
				}, 800);
			}, 600);
		}
    }

    // Initialize when loaded directly (not from profile.html)
    document.addEventListener('DOMContentLoaded', async () => {
        if (!window.location.href.includes('/profile')) {
            await initializeNormaAnalysisInternal();
        }
    });
</script>
<style>
	@keyframes slideIn {
		0% { transform: translateX(100%); opacity: 0; }
		100% { transform: translateX(0); opacity: 1; }
	}
	@keyframes slideOut {
		0% { transform: translateX(0); opacity: 1; }
		100% { transform: translateX(100%); opacity: 0; }
	}
</style>
<script>
        function toggleMenu() {
            const menu = document.querySelector('.menu'); if (!menu) return;
            menu.classList.toggle('active');
        }
        // Close the menu if clicking outside of it (guard if elements don't exist)
        document.addEventListener('click', function(event) {
            const menu = document.querySelector('.menu');
            const hamburger = document.querySelector('.hamburger');
            if (!menu || !hamburger) return;
            if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
                menu.classList.remove('active');
            }
        });
</script>

</body>
</html>