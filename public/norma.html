<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Profile</title>
    <link rel="icon" href="assets\reversa_logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
    <link href="https://fonts.googleapis.com/css?family=Heebo&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="styles/styles.css" />
    <link rel="stylesheet" type="text/css" href="styles/menu.css" />
    <link rel="stylesheet" type="text/css" href="styles/toggle.css" />
    <link rel="stylesheet" type="text/css" href="styles/dropdown.css" />
    <link rel="stylesheet" type="text/css" href="styles/radio_menu.css" />
    <link rel="stylesheet" type="text/css" href="styles/mobile.css" />
    <style>

      :root {
        --primary-color: #04db8d;
        --secondary-color: #455862;
        --border-color: #e0e0e0;
        --text-color: #0b2431;
        --placeholder-color: #999;
        --active-color: #04db8d;
        --error-color: #d32f2f;
        --background-color: #ffffff;

        /*tab background color: #f8f8f8*/
      }
        #analysisResult {
            margin-top: 20px;
            padding: 20px 30px;
            border: 1px solid #ccc;
            border-radius: 20px;
            text-align: left;
            display: none;
            background-color: #ffffff;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        
        #analysisResult.show {
            opacity: 1;
        }
        
        #analysisResult.error-state {
            border: none;
            background-color: transparent;
            padding: 0;
        }

        body {
          font-family: 'Satoshi', sans-serif;
          background: radial-gradient(circle at 50% 0, rgba(4, 219, 141, 0.25) 0%, #ffffff 70%);
          margin: 0;
          padding: 0;
          min-height: 100vh;
        }

        #loader {
            display: none; /* Hidden by default */
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .analisis-impacto {
            background: transparent;
            color: var(--text-color);
            padding: 8px 16px;
            border: 1px solid #999;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 2%;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .analisis-impacto .icon {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .analisis-impacto:hover {
            background-color: var(--text-color);
            border: none;
            color: white;
           /* transform: translateY(-1px);*/
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .analisis-impacto:hover .icon {
            color: white;
        }
        
        /* Styling for active analysis buttons */
        .analisis-impacto.active {
            background-color: var(--text-color);
            color: white;
            border: 1px solid var(--text-color);
        }
        
        .analisis-impacto.active .icon {
            color: white;
        }
          .container-norma {
            max-width: 1100px; 
            margin: 40px auto; 
            padding: 30px;     
            border-radius: 12px; 
            text-align: center;
          }
          /* Style the input field */
          .user-prompt {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: 'Heebo', sans-serif;
            text-align: left;
            resize: vertical; /* This enables vertical resizing */
            overflow: auto;
            min-height: 100px;
            /* height: auto;
            white-space: pre-wrap; /* Allows line breaks within the text area */
            word-break: break-word;/*Break on new word, not letter*/
             spellcheck: false; /* Disable spellcheck */
             padding-right: 45px; /* Add space for the button */
        }


        /* Add focus style */
        .user-prompt:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 5px rgba(131, 163, 0, 0.5);
        }

        /* Style the container for the input and button */
        .input-button-container {
          display: flex;
          flex-direction: column;
          align-items: center; /* Aligns items to the start (left) */
          width: 100%;
          margin-bottom: 20px;
          position: relative;
        }
        
        /* Wrapper for textarea to contain the button */
        .textarea-wrapper {
          position: relative;
          width: 100%;
        }
        .input-button-container > * {
            margin-bottom: 10px; /* Adds spacing between elements */
        }
        
        /* Style for the custom prompt submit button */
        #sendCustomPrompt {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background-color: var(--text-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 15;
        }
        
        #sendCustomPrompt:hover {
            background-color: #03c57f;
        }
        
        /* When textarea is focused, ensure the button is visible */
        .user-prompt:focus + #sendCustomPrompt {
            opacity: 1;
        }
        
        /* Table styling for checklist */
        #analysisResult table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        #analysisResult th, #analysisResult td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }
        
        #analysisResult th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        
        #analysisResult tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /*feedback*/

                #feedbackSection {
          margin-top: 20px;
          border: 1px solid #ccc;
          border-radius: 20px;
          overflow: hidden;
        }

        #feedbackToggle {
          display: flex;
          justify-content: space-between;
          padding: 10px 15px;
          background-color: #ffffff;
          cursor: pointer;
        }

        #feedbackContent {
          padding: 15px;
        }

        #feedbackText {
          width: 95%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 20px;
          margin-bottom: 10px;
          resize: vertical;
          min-height: 80px;
        }

        #sendFeedbackBtn {
          margin-top: 10px;
        }

        .feedback-success {
          color: var(--primary-color);
          margin-top: 10px;
          font-weight: bold;
        }

        /* Dropdown para selección de agentes */
        .analysis-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            animation: dropdownSlide 0.3s ease-out;
        }

        @keyframes dropdownSlide {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .dropdown-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            text-align: left;
        }

        .etiquetas-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .etiqueta-btn {
            background: #f2f2f2;
            border: 1px solid #dcdcdc;
            color: #455862;
            padding: 8px 14px;
            border-radius: 14px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .etiqueta-btn:hover {
            background: #e6e6e6;
        }

        .etiqueta-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .start-analysis-btn {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .start-analysis-btn:hover {
            background: var(--text-color);
            color: white;
        }

        .start-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Hidden class for original etiquetas selector */
        #etiquetasSelectorContainer {
            display: none;
        }

        /* ---------- STATUS WORKFLOW ---------- */
        #analysisStatus {
            margin-top: 15px;
            display: none;
            font-size: 15px;
            color: var(--text-color);
            font-weight: 500;
            align-items: center;
            gap: 8px;
            justify-content: flex-start; /* left align */
            position: relative;
            width: 100%;
        }

        #analysisStatus .spinner {
            font-size: 16px;
            animation: spin 2s linear infinite;
        }

        /* shimmer effect - PRECISE TEXT ONLY */
        .shimmer-text {
            position: relative;
            display: inline-block;
            color: var(--text-color);
            overflow: hidden; /* This ensures shimmer doesn't go beyond text */
        }

        .shimmer-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: -50px; /* Start from left edge */
            width: 50px; /* Fixed width shimmer bar */
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
            animation: shimmer-slide 3s infinite;
        }

        @keyframes shimmer-slide {
          0% { 
            left: -50px; 
          }
          100% { 
            left: 100%; 
          }
        }

        /* slide-in subtle animation */
        .slide {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            0% { opacity: 0; transform: translateX(-8px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* Analysis result - no animation for better performance */
        .analysis-render {
            /* No animation - show results immediately */
        }

        /* Status completed - simplified for better performance */
        .status-completed {
            /* No complex animation - just hide immediately */
            opacity: 0;
        }

        /* ---------- BOCG banner ---------- */
        .bocg-banner {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #856404;
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            font-size: 14px;
            margin-top: 16px;
        }

        /* ---------- HTML source banner ---------- */
        .html-source-banner {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .html-source-banner a {
            color: #04db8d;
            text-decoration: underline;
            font-weight: 500;
        }

        .html-source-banner a:hover {
            color: #03c57f;
        }

        /* ---------- No analysis available banner ---------- */
        .no-analysis-banner {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 12px;
            padding: 12px 18px;
            text-align: center;
            font-size: 14px;
            margin-top: 16px;
        }

        /* ---------- Analysis Settings Dropdown ---------- */
        .analysis-settings-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 2%;
            /* Removed top margin to align with other buttons */
            margin-top: 0;
        }

        .analysis-settings-btn {
            background: transparent;
            color: var(--text-color);
            padding: 8px 16px;
            border: 1px solid #999;
            border-radius: 16px;
            cursor: pointer;
            /* Removed top margin to align with other buttons */
            margin-top: 2%;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 36px;
        }

        .analysis-settings-btn:hover {
            background-color: var(--text-color);
            color: white;
            border-color: var(--text-color);
        }

        .analysis-settings-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            animation: dropdownSlide 0.3s ease-out;
        }

        .analysis-settings-dropdown.show {
            display: block;
        }

        .settings-dropdown-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
            text-align: left;
        }

        .settings-item {
            margin-bottom: 12px;
        }

        .settings-item label {
            display: block;
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 4px;
            text-align: left;
        }

        .settings-select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 14px;
            background-color: #ffffff;
            color: var(--text-color);
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 3px rgba(4, 219, 141, 0.3);
        }

    </style>
    <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "r7ltvtr85q");
  </script>
</head>
<body>

     <!-- Loader overlay -->
<div id="pageLoaderOverlay">
    <div class="page-loader"></div>
  </div>

    <nav class="navbar">
      <div class="logo">
          <a href="https://reversa.ai/" target="_blank">
            <img src="assets/reversa_blue.png" alt="Reversa Logo">
          </a>
        </div>
      <button class="hamburger" onclick="toggleMenu()">☰</button> 
      
        <ul class="menu">
          <li><a href="https://reversa.ai/">WEB</a></li>
          <li><a href="https://app.reversa.ai/profile">PANEL DE CONTROL</a></li> <!--cambiar-->
          <li><a href="http://app.reversa.ai/suscripcion.html">EDITAR SUSCRIPCIÓN</a></li>
          <li><a href="https://reversa.ai/pages/contact-1">AYUDA</a></li>
        </ul>
    </nav>

    <div class="container-norma">
      <h2 > <span id="normaShortName"></span></h2>
      <div id="normaExtraDetails" style="font-size: large; color: #757575; margin-top: 4px; margin-bottom: 15px; line-height: 1.4;"></div>

    <div id="normaDetails">
        <!-- This will be populated with data from MongoDB -->
        <h2>  </h2>
           <!-- <label for="userPrompt">Custom Prompt:</label> --> </div>
             <div class="input-button-container">

<div class="textarea-wrapper">
<textarea class="user-prompt" id="userPrompt" name="userPrompt" placeholder="Escribe aquí para analizar la norma..." spellcheck="false"></textarea>
<button id="sendCustomPrompt" title="Enviar consulta personalizada">↑</button>
</div>
<div class="buttons-container" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; position: relative;">
    <button id="analyzeButton" class="analisis-impacto">
        <i class="fa fa-file-text-o icon"></i>
        <span>Realizar resumen</span>
    </button>
    <button id="checklistButton" class="analisis-impacto">
        <span class="icon">☐</span>
        <span>Cuadro de obligaciones</span>
    </button>
    <button id="risksButton" class="analisis-impacto">
        <span class="icon">⚠</span>
        <span>Riesgos y oportunidades</span>
    </button>
    
    <!-- Settings dropdown for analysis -->
  <!--  <div class="analysis-settings-container"> -->
        <button id="analysisSettingsBtn" class="analysis-settings-btn" title="Ajustes de análisis">
            <i class="fa fa-cog"></i>
        </button>
        <div id="analysisSettingsDropdown" class="analysis-settings-dropdown">
            <div class="settings-dropdown-title">Ajustes de análisis</div>
            <div class="settings-item">
                <label for="analysis-idioma-select">Idioma:</label>
                <select id="analysis-idioma-select" class="settings-select">
                    <option value="español">Español</option>
                    <option value="inglés">Inglés</option>
                </select>
            </div>
        </div>
    <!-- </div> -->
    
    <!-- Dropdown para selección de agentes -->
    <div id="analysisDropdown" class="analysis-dropdown">
        <div class="dropdown-title">Selecciona agentes</div>
        <div id="etiquetasList" class="etiquetas-list">
            <!-- Las etiquetas se llenarán dinámicamente -->
        </div>
        <button id="startAnalysisBtn" class="start-analysis-btn">Empezar análisis</button>
    </div>
</div>

</div>

    <!-- Status workflow indicator -->
    <div id="analysisStatus"><i class="fa fa-spinner spinner"></i> <span class="shimmer-text"></span></div>
    <div id="analysisResult"></div>

<!-- Sección de Feedback -->
<div id="feedbackSection" style="display: none;">
  <div id="feedbackToggle">
    <span style="font-weight: 700;">Feedback</span>
    <i class="fa fa-chevron-down"></i>
  </div>
  <div id="feedbackContent" style="display: none;">
    <textarea id="feedbackText" placeholder="Indícanos tu opinión para que podamos seguir mejorando"></textarea>
    <button id="sendFeedbackBtn" class="analisis-impacto">Enviar feedback</button>
  </div>
</div>

</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const shortNameSpan = document.getElementById('normaShortName');
        const analyzeButton = document.getElementById('analyzeButton');
        const checklistButton = document.getElementById('checklistButton');
        const risksButton = document.getElementById('risksButton');
        const sendCustomPromptButton = document.getElementById('sendCustomPrompt');
        const analysisResultDiv = document.getElementById('analysisResult');
        const loaderDiv = document.getElementById('loader');
        const pageLoaderOverlay = document.getElementById('pageLoaderOverlay'); // Select the overlay
        const userPromptInput = document.getElementById('userPrompt');
        const analysisStatusDiv = document.getElementById('analysisStatus');
        const statusTextSpan = analysisStatusDiv.querySelector('.shimmer-text');
        const analysisDropdown = document.getElementById('analysisDropdown');
        const etiquetasList = document.getElementById('etiquetasList');
        const startAnalysisBtn = document.getElementById('startAnalysisBtn');
        const analysisSettingsBtn = document.getElementById('analysisSettingsBtn');
        const analysisSettingsDropdown = document.getElementById('analysisSettingsDropdown');
        const analysisIdiomaSelect = document.getElementById('analysis-idioma-select');
        let statusTimeouts = [];
        let currentAnalysisType = null;
        let activeAnalysisButton = null;

        // Get the document ID from the URL (you can change this if you pass it differently)
        const urlParams = new URLSearchParams(window.location.search);
        const documentId = urlParams.get('documentId');
        const collectionName = urlParams.get('collectionName'); // Get the collection from URL

        // ----- Disable impact analysis for BOCG collections -----
        const bocgCollections = ['BOCG', 'BOCG_test'];
        if (bocgCollections.includes(collectionName)) {
            const impactButtons = [analyzeButton, checklistButton, risksButton];
            impactButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
            });

            // Create and insert informational banner
            const banner = document.createElement('div');
            banner.className = 'bocg-banner';
            banner.textContent = 'Análisis de impacto BOCG coming soon';

            // Insert banner just after the impact buttons container
            const buttonsContainer = analyzeButton.parentElement;
            buttonsContainer.insertAdjacentElement('afterend', banner);
        }

        // Global variables to store document URLs
        let documentUrlPdf = null;
        let documentUrlHtml = null;

        // Analysis settings management
        function loadAnalysisSettings() {
            const savedIdioma = localStorage.getItem('analysis_idioma') || 'español';
            if (analysisIdiomaSelect) {
                analysisIdiomaSelect.value = savedIdioma;
            }
        }

        function saveAnalysisSettings() {
            if (analysisIdiomaSelect) {
                localStorage.setItem('analysis_idioma', analysisIdiomaSelect.value);
            }
        }

        function getSelectedAnalysisLanguage() {
            return analysisIdiomaSelect ? analysisIdiomaSelect.value : 'español';
        }

        function toggleAnalysisSettingsDropdown() {
            // Hide analysis dropdown if it's open
            hideAnalysisDropdown();
            analysisSettingsDropdown.classList.toggle('show');
        }

        function hideAnalysisSettingsDropdown() {
            analysisSettingsDropdown.classList.remove('show');
        }

        // Función para mostrar la sección de feedback
        function showFeedbackSection() {
          const feedbackSection = document.getElementById('feedbackSection');
          feedbackSection.style.display = 'block';
        }

        // Add event listener for custom prompt button
        sendCustomPromptButton.addEventListener('click', () => {
            handleCustomPrompt();
        });

        // Also allow pressing Enter in the textarea to submit
        userPromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleCustomPrompt();
            }
        });

        // Function to handle custom prompt submissions
        function handleCustomPrompt() {
            const userInput = userPromptInput.value.trim();
            if (!userInput) {
                alert('Por favor, escribe una consulta antes de enviar.');
                return;
            }
            
            // Obtener idioma seleccionado
            const idiomaSeleccionado = getSelectedAnalysisLanguage();
            const bloqueIdioma = `\n**IDIOMA DE RESPUESTA:**\n<idioma>Aunque las instrucciones del prompt son en español, es muy importante que formules toda tu respuesta en ${idiomaSeleccionado}</idioma>\n`;
            
            const customPrompt = `${userInput}

${bloqueIdioma}

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML solo puede incluir <h2>, <p>, <ul>, <li>, <b>. Nada más.  
• Sin saltos de línea innecesarios ni Markdown.`;
            
            performCustomAnalysis(customPrompt, sendCustomPromptButton);
        }

        // Function for custom prompt analysis
        function performCustomAnalysis(customPrompt, buttonElement) {
            analysisResultDiv.textContent = ''; // Clear previous results
            analysisResultDiv.classList.remove('show'); // Reset transition class
            analysisResultDiv.classList.remove('error-state'); // Reset error styling
            analysisResultDiv.style.display = 'none'; // Hide initially
            
            // Disable all buttons during analysis
            setAnalysisButtonsState(true);
            
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i>'; // Show loading icon
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Start status workflow for custom analysis
            if (typeof startStatusWorkflow === 'function') startStatusWorkflow('custom');
            
            fetch('/api/analyze-norma', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/html; charset=utf-8'
                },
                body: JSON.stringify({ documentId: documentId, userPrompt: customPrompt, collectionName: collectionName })
            })
            .then(response => {
                // Check if response is JSON (error) or HTML (success)
                const contentType = response.headers.get('content-type');
                
                if (!response.ok) {
                    // If response is not ok, try to parse as JSON for error details
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(errorData => {
                            throw new Error(JSON.stringify(errorData));
                        });
                    } else {
                        return response.text().then(errorText => {
                            throw new Error(errorText);
                        });
                    }
                }
                
                // Success case - parse as text/html
                if (contentType && contentType.includes('charset=utf-8')) {
                    return response.text();
                }
                return response.arrayBuffer().then(buffer => {
                    const decoder = new TextDecoder('utf-8');
                    return decoder.decode(buffer);
                });
            })
            .then(data => {
                // Process the response
                const htmlContent = data.replace(/^```html\s*|\s*```|^<\!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<\!DOCTYPE html>/g, '');
                
                // Complete the status workflow
                if (typeof completeStatusWorkflow === 'function') completeStatusWorkflow();
                
                // Show results immediately without delays
                buttonElement.innerHTML = originalButtonText; // Restore original button text
                
                // Enable all buttons again
                setAnalysisButtonsState(false);
                
                // Show content with smooth transition
                analysisResultDiv.innerHTML = htmlContent;
                analysisResultDiv.style.display = 'block';
                analysisResultDiv.classList.remove('show'); // Ensure it starts hidden
                analysisResultDiv.classList.remove('error-state'); // Remove error styling for normal content
                
                // Small delay for smooth transition
                setTimeout(() => {
                    analysisResultDiv.classList.add('show');
                    if (typeof showFeedbackSection === 'function') showFeedbackSection();
                }, 250);
            })
            .catch(error => {
                console.error('Error analyzing norma:', error);
                
                // Parse error details if it's a JSON error
                let errorType = 'GENERIC_ERROR';
                let errorMessage = 'Error: Ocurrió un error inesperado al procesar la respuesta del análisis. Prueba de nuevo por favor';
                let statusMessage = 'Error en el análisis';
                
                try {
                    const errorData = JSON.parse(error.message);
                    errorType = errorData.error;
                    errorMessage = errorData.message;
                } catch (e) {
                    // If error message is not JSON, use the default error message
                    console.error('Error parsing error response:', e);
                }
                
                // Set specific status message based on error type
                if (errorType === 'PDF_ACCESS_ERROR') {
                    statusMessage = 'Error accediendo al documento';
                } else {
                    statusMessage = 'Error procesando análisis';
                }
                
                // Show error in status first, then in result div
                completeStatusWorkflowWithErrorAndCallback(statusMessage, () => {
                    // This callback executes after status is hidden
                    
                    // Restore button state
                    buttonElement.innerHTML = originalButtonText;
                    setAnalysisButtonsState(false);
                    
                    // Determine styling based on error type
                    let errorStyle = '';
                    if (errorType === 'PDF_ACCESS_ERROR') {
                        errorStyle = `
                            background-color: #ffebee;
                            border: 2px solid #c62828;
                            color: #c62828;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            font-weight: 500;
                        `;
                    } else {
                        errorStyle = `
                            background-color: #ffebee;
                            border: 2px solid #c62828;
                            color: #f57f17;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            font-weight: 500;
                        `;
                    }
                    
                    // Create and show error element with smooth transition
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = errorStyle;
                    errorDiv.textContent = errorMessage;
                    
                    analysisResultDiv.innerHTML = '';
                    analysisResultDiv.appendChild(errorDiv);
                    analysisResultDiv.style.display = 'block';
                    analysisResultDiv.classList.remove('show');
                    analysisResultDiv.classList.add('error-state'); // Add error styling to remove container border/background
                    
                    // Small delay for smooth transition
                    setTimeout(() => {
                        analysisResultDiv.classList.add('show');
                    }, 250);
                });
            });
        }

        // Function to disable/enable analysis buttons
        function setAnalysisButtonsState(disabled) {
            const buttons = [analyzeButton, checklistButton, risksButton, sendCustomPromptButton];
            buttons.forEach(btn => {
                btn.disabled = disabled;
                if (disabled) {
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        // Function to show analysis dropdown with agent selection
        function showAnalysisDropdown(analysisType, buttonElement) {
            // Hide settings dropdown if it's open
            hideAnalysisSettingsDropdown();
            
            currentAnalysisType = analysisType;
            activeAnalysisButton = buttonElement;
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set this button as active
            buttonElement.classList.add('active');
            
            // Position the dropdown relative to the pressed button
            const buttonRect = buttonElement.getBoundingClientRect();
            const containerRect = buttonElement.parentElement.getBoundingClientRect();
            const leftOffset = buttonRect.left - containerRect.left;
            analysisDropdown.style.left = `${leftOffset}px`;
            
            // Populate etiquetas list
            const etiquetasData = window.getEtiquetasData ? window.getEtiquetasData() : {};
            etiquetasList.innerHTML = '';
            
            if (etiquetasData && Object.keys(etiquetasData).length > 0) {
                Object.keys(etiquetasData).forEach(etiqueta => {
                    const btn = document.createElement('button');
                    btn.className = 'etiqueta-btn';
                    btn.textContent = etiqueta;
                                        btn.addEventListener('click', () => {
                        const isAlreadySelected = btn.classList.contains('selected');
                        
                        // Toggle selection
                        etiquetasList.querySelectorAll('.etiqueta-btn').forEach(b => b.classList.remove('selected'));
                        
                        const startBtn = document.getElementById('startAnalysisBtn');
                        const analysisTypeText = {
                            'summary': 'resumen',
                            'checklist': 'cuadro de obligaciones', 
                            'risks': 'riesgos y oportunidades'
                        };
                        
                        if (isAlreadySelected) {
                            // Deselect - reset to generic
                            if (window.setSelectedEtiqueta) {
                                window.setSelectedEtiqueta(null, null);
                            }
                            if (startBtn) {
                                startBtn.textContent = `Generar ${analysisTypeText[currentAnalysisType] || 'análisis'} genérico`;
                            }
                        } else {
                            // Select this etiqueta
                            btn.classList.add('selected');
                            
                            // Update global selection
                            if (window.setSelectedEtiqueta) {
                                window.setSelectedEtiqueta(etiqueta, etiquetasData[etiqueta]);
                            }
                            
                            // Update start button text to show personalized
                            if (startBtn) {
                                startBtn.textContent = `Generar ${analysisTypeText[currentAnalysisType] || 'análisis'} personalizado`;
                            }
                        }
                    });
                    etiquetasList.appendChild(btn);
                });
            } else {
                const noEtiquetasMsg = document.createElement('div');
                noEtiquetasMsg.style.color = '#999';
                noEtiquetasMsg.style.fontStyle = 'italic';
                noEtiquetasMsg.textContent = 'No hay agentes disponibles para este documento';
                etiquetasList.appendChild(noEtiquetasMsg);
            }
            
            // Reset start button text - initially shows "genérico"
            const analysisTypeText = {
                'summary': 'resumen',
                'checklist': 'cuadro de obligaciones', 
                'risks': 'riesgos y oportunidades'
            };
            startAnalysisBtn.textContent = `Generar ${analysisTypeText[analysisType] || 'análisis'} genérico`;
            
            // Show dropdown
            analysisDropdown.style.display = 'block';
        }

        // Function to hide analysis dropdown
        function hideAnalysisDropdown() {
            analysisDropdown.style.display = 'none';
            // Reset position
            analysisDropdown.style.left = '0';
            // Reset active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            currentAnalysisType = null;
            activeAnalysisButton = null;
        }

        // Function to handle webscraping and analysis
        async function performWebscrapingAnalysis(promptType, buttonElement, htmlUrl) {
            try {
                // First, perform webscraping
                const webscrapingResponse = await fetch('/api/webscrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: htmlUrl })
                });

                if (!webscrapingResponse.ok) {
                    throw new Error('Error during webscraping');
                }

                const webscrapingData = await webscrapingResponse.json();
                const htmlContent = webscrapingData.text;

                // Now perform analysis with the scraped content
                return performAnalysisWithContent(promptType, buttonElement, htmlContent, htmlUrl);
            } catch (error) {
                console.error('Error during webscraping:', error);
                throw error;
            }
        }

        // Function to perform analysis with content (either from PDF or HTML)
        function performAnalysisWithContent(promptType, buttonElement, htmlContent = null, sourceUrl = null) {
            return new Promise((resolve, reject) => {
                const requestBody = {
                    documentId: documentId,
                    userPrompt: buildUserPrompt(promptType),
                    collectionName: collectionName
                };

                // Add HTML content if provided
                if (htmlContent) {
                    requestBody.htmlContent = htmlContent;
                }

                fetch('/api/analyze-norma', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/html; charset=utf-8'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    // Check if response is JSON (error) or HTML (success)
                    const contentType = response.headers.get('content-type');
                    
                    if (!response.ok) {
                        // If response is not ok, try to parse as JSON for error details
                        if (contentType && contentType.includes('application/json')) {
                            return response.json().then(errorData => {
                                throw new Error(JSON.stringify(errorData));
                            });
                        } else {
                            return response.text().then(errorText => {
                                throw new Error(errorText);
                            });
                        }
                    }
                    
                    // Success case - parse as text/html
                    if (contentType && contentType.includes('charset=utf-8')) {
                        return response.text();
                    }
                    return response.arrayBuffer().then(buffer => {
                        const decoder = new TextDecoder('utf-8');
                        return decoder.decode(buffer);
                    });
                })
                .then(data => {
                    const htmlResult = data.replace(/^```html\s*|\s*```|^<\!DOCTYPE html>\s*<html>\s*<head>.*?<\/head>\s*<body>|<\/html>\s*<\/body>|<\/body>|<\/html>|<html>|<\/html>|<\!DOCTYPE html>/g, '');
                    
                    // Show banner if analysis was based on HTML source
                    let finalHtml = htmlResult;
                    if (htmlContent && sourceUrl) {
                        const banner = `<div class="html-source-banner">Documento PDF no identificado para este documento, análisis basado en el texto publicado en la <a href="${sourceUrl}" target="_blank">fuente</a></div>`;
                        finalHtml = banner + htmlResult;
                    }
                    
                    resolve(finalHtml);
                })
                .catch(error => {
                    // Parse error details if it's a JSON error
                    let errorType = 'GENERIC_ERROR';
                    let errorMessage = 'Error analizando la norma. Por favor, inténtalo de nuevo.';
                    
                    try {
                        const errorData = JSON.parse(error.message);
                        errorType = errorData.error;
                        errorMessage = errorData.message;
                    } catch (e) {
                        // If error message is not JSON, use the raw error message
                        console.error('Error parsing error response:', e);
                    }
                    
                    const errorObj = new Error(errorMessage);
                    errorObj.errorType = errorType;
                    reject(errorObj);
                });
            });
        }

        // Function to build user prompt based on analysis type
        function buildUserPrompt(promptType) {
            // Obtener contexto de etiqueta seleccionada, si existe
            const etiquetaContext = window.getSelectedEtiquetaContext ? window.getSelectedEtiquetaContext() : null;
            let contextoEtiquetaTexto = '';
            if (etiquetaContext) {
                const { name, data } = etiquetaContext;
                let definicion = '';
                let nivelImpacto = '';
                if (typeof data === 'string') {
                    definicion = data;
                } else if (data && typeof data === 'object') {
                    definicion = data.explicacion || data.definicion || '';
                    nivelImpacto = data.nivel_impacto || '';
                }
                const definicionGlobal = window.getDefinicionEtiqueta ? window.getDefinicionEtiqueta(name) : '';
                if (!definicion || definicion.trim() === '') {
                    definicion = definicionGlobal;
                }
                contextoEtiquetaTexto = `\n=== CONTEXTO ESPECÍFICO DEL USUARIO – ETIQUETA SELECCIONADA ===\nEtiqueta: "${name}"\nDefinición global: ${definicionGlobal || 'No especificada'}\nDescripción / explicación específica: ${definicion || 'No especificada'}\nGrado de impacto en este documento: ${nivelImpacto || 'No especificado'}\n`;
            }

            // Obtener perfil regulatorio del usuario
            const perfilRegulatorio = window.getPerfilRegulatorio ? window.getPerfilRegulatorio() : '';
            let contextoPerfilTexto = '';
            if (perfilRegulatorio && perfilRegulatorio.trim() !== '') {
                contextoPerfilTexto = `\n=== CONTEXTO – PERFIL REGULATORIO DE LA EMPRESA ===\n${perfilRegulatorio}\n`;
            }

            // Obtener idioma seleccionado
            const idiomaSeleccionado = getSelectedAnalysisLanguage();
            const bloqueIdioma = `\n**IDIOMA DE RESPUESTA:**\n<idioma>Aunque las instrucciones del prompt son en español, es muy importante que formules toda tu respuesta en ${idiomaSeleccionado}</idioma>\n`;

            // Unir ambos contextos (perfil + etiqueta + idioma) para inyectarlos antes del resto del prompt
            const bloqueContexto = `${contextoPerfilTexto}${contextoEtiquetaTexto}${bloqueIdioma}\n`;

            // Return the appropriate prompt based on type
            if (promptType === 'checklist') {
                return `Eres un abogado senior especializado en compliance. Utiliza el contexto proporcionado para adaptar tu análisis.

${bloqueContexto}

Lee el siguiente documento PDF y genera un checklist de obligaciones:

IMPORTANTE: Ten en cuenta la etiqueta personalizada seleccionada. Si el *perfil regulatorio* indica que la empresa es una **consultora** o un **despacho de abogados**, el checklist debe estar orientado a los **clientes** de la empresa que estén afectados por dicha etiqueta, no a la empresa directamente.

INSTRUCCIONES CRÍTICAS DE FORMATO DE SALIDA  
1. **OBLIGATORIO – JSON estricto:** responde SIEMPRE con un objeto JSON válido.  
2. **Esquema único:** el objeto JSON debe tener UNA SOLA clave llamada \`html_response\`, cuyo valor sea un string que contenga SOLO el fragmento HTML.  
3. **Sin saltos de línea innecesarios:** el string HTML irá en una sola línea continua (o con los mínimos saltos indispensables para la legibilidad).  
4. **Basado en el PDF:** no inventes información. Si algo no figura, indica cortésmente: \`<p>El documento no proporciona información específica sobre este tema.</p>\`.  
5. **Citas internas:** cita siempre el artículo o sección del PDF cuando fundamentes tu respuesta.  
6. **Extensión:** máximo aproximado de 300 palabras dentro del string HTML.    
7. **Resúmenes concisos:** cuando se pida un resumen, que sea ordenado y breve.  
8. **Sensibilidad e implicaciones:** evalúa el impacto usando solo la información disponible; sin sesgos ni especulaciones.  
9. **Sin opiniones personales:** cualquier dato no contenido en el documento deberá declararse "No disponible".

REQUERIMIENTOS DEL CONTENIDO HTML  
• Dentro de \`html_response\` usa ÚNICAMENTE estas etiquetas: \`<h2>\`, \`<p>\`, \`<table>\`, \`<tr>\`, \`<th>\`, \`<td>\` y \`<b>\` donde resulte necesario.  
• Estructura de salida:  
  * \`<h2>Checklist de Cumplimiento</h2>\`  
  * \`<p>Resumen ejecutivo</p>\` (máx. 100 palabras con nº total de obligaciones y fecha de entrada en vigor).  
  * \`<table>\` con cinco columnas en este orden:  
    1. Obligación / Acción a realizar (≤ 25 palabras)  
    2. Artículo o disposición que la impone  
    3. Departamento interno responsable (Compliance, RR.HH., IT, Dirección Financiera, etc.)  
    4. Plazo exacto o frecuencia (fecha fija, "30 días", "trimestral"…).  
    5. Sanción o consecuencia por incumplimiento (importe o referencia al art.).  
  * Máximo 10 filas; si algún dato no aparece, escribe "No especificado".  
• No utilices ninguna otra etiqueta HTML ni Markdown.

**RECUERDA:** Tu salida debe ser únicamente el objeto JSON como el del ejemplo anterior, sin nada antes ni después. El string HTML dentro de \`html_response\` no debe contener saltos de línea innecesarios, solo el HTML puro.`;
            } else if (promptType === 'risks') {
                return `Eres un socio de un despacho de abogados en España. Analiza la norma dentro de <PDF></PDF> y extrae riesgos, oportunidades para la empresa y servicios que el despacho puede ofrecer.

${bloqueContexto}

=== Indicaciones adicionales (contextualización por tipo de empresa) ===
• Si el *perfil regulatorio* indica que la empresa es una **empresa regulada** (por ejemplo, entidad financiera, aseguradora, eléctrica, etc.), genera **únicamente** los riesgos y oportunidades que afectan a **esa empresa**.  
  – Prioriza siempre la **etiqueta personalizada seleccionada**; si no se seleccionó ninguna, haz el análisis genérico sobre la norma.  
• Si el perfil indica que la empresa es un **despacho de abogados** o **consultora**, divide la respuesta en DOS grandes bloques diferenciados:  
  A) **Riesgos y oportunidades para clientes** (centrado en los clientes afectados por la etiqueta seleccionada; si no hay etiqueta, hazlo genérico) con sub-apartados 1. *Riesgos para clientes* y 2. *Oportunidades para clientes*.  
  B) **Riesgos y oportunidades para servicios profesionales** (oportunidades comerciales para la propia firma: captación de clientes, nuevos servicios, notificaciones proactivas, etc.).

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML solo puede incluir <h2>, <p>, <table>, <tr>, <th>, <td>, <b>. Nada más.  
• Sin saltos de línea innecesarios ni Markdown.  

=== Contenido HTML requerido (≤ 400 palabras) ===
<p>Introducción (≤ 60 palabras) situando la relevancia de la norma.</p>

<h2>1. Riesgos</h2>
<table>
<tr><th>Riesgo</th><th>Artículo</th><th>Probabilidad</th><th>Impacto</th><th>Mitigación</th></tr>
<!-- hasta 6 filas de riesgos -->
</table>

<!-- SOLO si hay oportunidades empresariales reales -->
<h2>[NÚMERO]. Oportunidades para empresas</h2>
<table>
<tr><th>Oportunidad Empresarial</th><th>Sector</th><th>Beneficio</th></tr>
<!-- hasta 4 filas de oportunidades empresariales -->
</table>

<!-- SOLO si hay oportunidades para servicios legales -->
<h2>[NÚMERO]. Oportunidades para servicios legales</h2>
<table>
<tr><th>Oportunidad de servicio legal</th><th>Etapa</th><th>Valor para el cliente</th></tr>
<!-- hasta 6 filas de servicios legales -->
</table>

<p><b>Conclusión:</b> Prioriza los 3 principales riesgos y las oportunidades más relevantes.</p>

=== Instrucciones específicas ===
• **Riesgos:** Siempre incluye la tabla de riesgos si existen en la norma (siempre será "1. Riesgos").
• **Numeración dinámica:** Los números de los títulos deben ajustarse según las tablas que realmente se muestren:
  - Si solo hay riesgos: solo "1. Riesgos"
  - Si hay riesgos + oportunidades empresariales: "1. Riesgos" y "2. Oportunidades para empresas"
  - Si hay riesgos + servicios legales: "1. Riesgos" y "2. Oportunidades para servicios legales"
  - Si hay las tres tablas: "1. Riesgos", "2. Oportunidades para empresas", "3. Oportunidades para servicios legales"
• **Oportunidades empresariales:** SOLO incluye esta tabla si la norma genera oportunidades reales para empresas (nuevos mercados, cambios regulatorios favorables, etc.). Si no hay oportunidades empresariales claras, omite completamente esta sección.
• **Oportunidades para servicios legales:** SOLO incluye esta tabla si la norma genera oportunidades de servicios para despachos de abogados (asesoramiento, implementación, compliance, litigios, etc.). Si no hay oportunidades para servicios legales, omite completamente esta sección.
• Si no hay ningún tipo de oportunidades, indica: <p>Esta norma no presenta oportunidades empresariales o de servicios legales evidentes.</p>
• Indica "No especificado" en las celdas donde el PDF carece de información necesaria.

=== Criterios analíticos ===
• Basado únicamente en el PDF; cita artículos concretos.  
• Estilo claro y preciso, sin opiniones personales ni especulación.
• Evalúa de forma realista si existen verdaderas oportunidades antes de incluir las tablas correspondientes.`;
            } else if (promptType === 'summary') {
                const tieneEtiqueta = !!etiquetaContext;
                const tituloImpacto = tieneEtiqueta ? `Impacto en ${etiquetaContext.name}` : 'Aspectos clave y puntos importantes';

                return `Eres un abogado experto. Analiza el documento PDF y genera un resumen claro y conciso.

${bloqueContexto}

=== Formato de salida ===
• Responde EXCLUSIVAMENTE con un objeto JSON que contenga la clave \`html_response\`.  
• El string HTML puede incluir <h2>, <p>, <ul>, <li>, <b>, <hr>. Nada más.  
• Usa <hr> (o dos saltos de línea) para separar visualmente secciones. No utilices Markdown.

=== Contenido HTML requerido (≤ 600 palabras) ===
<h2 style="font-size:1.3em; margin-bottom:12px;">Resumen de la Norma</h2>
<table style="width:100%; border-collapse:collapse; font-size:0.95em;">
  <tr style="background:#f8f8f8;">
    <th style="text-align:left; padding:6px 8px; color:#0b2431;">Concepto</th>
    <th style="text-align:left; padding:6px 8px; color:#455862;">Detalle</th>
  </tr>
  <tr><td style="padding:6px 8px;">Título completo</td><td style="padding:6px 8px;"></td></tr>
  <tr style="background:#fafafa;"><td style="padding:6px 8px;">Fecha de publicación</td><td style="padding:6px 8px;"></td></tr>
  <tr><td style="padding:6px 8px;">Entrada en vigor</td><td style="padding:6px 8px;"></td></tr>
  <tr style="background:#fafafa;"><td style="padding:6px 8px;">Ámbito de aplicación</td><td style="padding:6px 8px;"></td></tr>
</table>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Propósito principal de la norma</h3>
<p>Contenido de propósito principal de la norma</p>	
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Sujetos afectados</h3>
<p>Contenido de sujetos afectados</p>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h2 style="font-size:1.3em;">${tituloImpacto}</h2>
<h3>Implicaciones generales</h3>
<h3>Aspectos clave y puntos importantes a considerar.</h3>
<ul>
  <li style="margin:6px 0;">Principales disposiciones (máximo 5 puntos)</li>
</ul>
<hr style="border:none; border-top:1px solid #e0e0e0; margin:20px 0;" />
<h3>Próximos pasos recomendados</h3>

=== Criterios analíticos ===
• Basado únicamente en el PDF y el contexto proporcionado; cita artículos concretos.
• Estilo claro y preciso, sin opiniones personales ni especulación.`;
            }
        }

        // Function to handle all analysis requests
        function performAnalysis(promptType, buttonElement) {
            // Validate buttonElement
            if (!buttonElement || typeof buttonElement.innerHTML === 'undefined') {
                console.error('Error: buttonElement is null or invalid in performAnalysis');
                alert('Error: Elemento de botón no válido. Por favor, inténtalo de nuevo.');
                return;
            }
            
            analysisResultDiv.textContent = ''; // Clear previous results
            analysisResultDiv.classList.remove('show'); // Reset transition class
            analysisResultDiv.classList.remove('error-state'); // Reset error styling
            analysisResultDiv.style.display = 'none'; // Hide initially
            
            // Disable all buttons during analysis
            setAnalysisButtonsState(true);
            
            if (typeof startStatusWorkflow === 'function') startStatusWorkflow(promptType);
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Analizando...'; // Show loading icon
            
            // Reset any active button state
            document.querySelectorAll('.analisis-impacto').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set this button as active
            buttonElement.classList.add('active');

            // Determine analysis strategy based on available URLs
            let analysisPromise;
            
            if (documentUrlPdf) {
                // Scenario 3: PDF available - use normal workflow
                analysisPromise = performAnalysisWithContent(promptType, buttonElement);
            } else if (documentUrlHtml) {
                // Scenario 1: No PDF but HTML available - use webscraping
                analysisPromise = performWebscrapingAnalysis(promptType, buttonElement, documentUrlHtml);
            } else {
                // Scenario 2: Neither PDF nor HTML available - should not reach here as buttons should be disabled
                console.error('No PDF or HTML URL available for analysis');
                setAnalysisButtonsState(false);
                buttonElement.innerHTML = originalButtonText;
                buttonElement.classList.remove('active');
                clearStatusWorkflow();
                alert('No hay fuentes disponibles para el análisis de este documento.');
                return;
                         }

             // Handle the analysis promise
             analysisPromise
                                 .then(htmlContent => {
                    // Complete the status workflow
                    if (typeof completeStatusWorkflow === 'function') completeStatusWorkflow();
                    
                    // Show results immediately without delays
                    buttonElement.innerHTML = originalButtonText; // Restore original button text
                    buttonElement.style.backgroundColor = ''; // Remove inline style
                    
                    // Enable all buttons again
                    setAnalysisButtonsState(false);
                    
                    // Show content with smooth transition
                    analysisResultDiv.innerHTML = htmlContent;
                    analysisResultDiv.style.display = 'block';
                    analysisResultDiv.classList.remove('show'); // Ensure it starts hidden
                    analysisResultDiv.classList.remove('error-state'); // Remove error styling for normal content
                    
                    // Small delay for smooth transition
                    setTimeout(() => {
                        analysisResultDiv.classList.add('show');
                        if (typeof showFeedbackSection === 'function') showFeedbackSection();
                    }, 250);
                })
                .catch(error => {
                    console.error('Error analyzing norma:', error);
                    
                    // Parse error details if it's a JSON error
                    let errorType = 'GENERIC_ERROR';
                    let errorMessage = 'Error: Ocurrió un error inesperado al procesar la respuesta del análisis. Prueba de nuevo por favor';
                    let statusMessage = 'Error en el análisis';
                    
                    try {
                        const errorData = JSON.parse(error.message);
                        errorType = errorData.error;
                        errorMessage = errorData.message;
                    } catch (e) {
                        // If error message is not JSON, use the default error message
                        console.error('Error parsing error response:', e);
                    }
                    
                    // Set specific status message based on error type
                    if (errorType === 'PDF_ACCESS_ERROR') {
                        statusMessage = 'Error accediendo al documento';
                    } else {
                        statusMessage = 'Error procesando análisis';
                    }
                    
                    // Show error in status first, then in result div
                    completeStatusWorkflowWithErrorAndCallback(statusMessage, () => {
                        // This callback executes after status is hidden
                        
                        // Restore button state
                        buttonElement.innerHTML = originalButtonText;
                        buttonElement.classList.remove('active');
                        setAnalysisButtonsState(false);
                        
                        // Determine styling based on error type
                        let errorStyle = '';
                        if (errorType === 'PDF_ACCESS_ERROR') {
                            errorStyle = `
                                background-color: #ffebee;
                                border: 2px solid #c62828;
                                color: #c62828;
                                padding: 15px;
                                border-radius: 8px;
                                margin: 10px 0;
                                font-weight: 500;
                            `;
                        } else {
                            errorStyle = `
                                background-color: #ffebee;
                                border: 2px solid #c62828;
                                color:#c62828;
                                padding: 15px;
                                border-radius: 8px;
                                margin: 10px 0;
                                font-weight: 500;
                            `;
                        }
                        
                        // Create and show error element with smooth transition
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = errorStyle;
                        errorDiv.textContent = errorMessage;
                        
                        analysisResultDiv.innerHTML = '';
                        analysisResultDiv.appendChild(errorDiv);
                        analysisResultDiv.style.display = 'block';
                        analysisResultDiv.classList.remove('show');
                        analysisResultDiv.classList.add('error-state'); // Add error styling to remove container border/background
                        
                        // Small delay for smooth transition
                        setTimeout(() => {
                            analysisResultDiv.classList.add('show');
                        }, 250);
                    });
                });
        }

        // Fetch the document details (only the short_name for this example)
        fetch(`/api/norma-details?documentId=${documentId}&collectionName=${collectionName}`) // New endpoint in app.js
                .then(response => response.json())
                .then(data => {
                    shortNameSpan.textContent = data.short_name;
                    
                    // Store document URLs globally
                    documentUrlPdf = data.url_pdf;
                    documentUrlHtml = data.url_html;
                    
                    // Handle different scenarios based on available URLs
                    if (!documentUrlPdf && !documentUrlHtml) {
                        // Scenario 2: Neither PDF nor HTML available - disable analysis buttons and show banner
                        const impactButtons = [analyzeButton, checklistButton, risksButton];
                        impactButtons.forEach(btn => {
                            btn.disabled = true;
                            btn.style.opacity = '0.6';
                            btn.style.cursor = 'not-allowed';
                        });

                        // Create and insert no analysis available banner
                        const banner = document.createElement('div');
                        banner.className = 'no-analysis-banner';
                        banner.textContent = 'Documento con análisis de impacto no disponible';

                        // Insert banner just after the impact buttons container
                        const buttonsContainer = analyzeButton.parentElement;
                        buttonsContainer.insertAdjacentElement('afterend', banner);
                    }
                    
                     // Nuevo código para mostrar detalles adicionales
                    const extraDetailsDiv = document.getElementById('normaExtraDetails');
                    if (extraDetailsDiv) {
                        let detailsParts = [];

                        // data.collectionName ya lo estás recibiendo de la API
                        if (data.collectionName) {
                            detailsParts.push(data.collectionName);
                        }

                        if (data.rango_titulo) {
                            detailsParts.push(data.rango_titulo);
                        }

                        // Prioritize PDF URL, but show HTML URL if PDF is not available
                        if (data.url_pdf) {
                            detailsParts.push(`<a href="${data.url_pdf}" target="_blank" style="color: #757575; text-decoration: underline;">Leer documento</a>`);
                        } else if (data.url_html) {
                            detailsParts.push(`<a href="${data.url_html}" target="_blank" style="color: #757575; text-decoration: underline;">Leer documento</a>`);
                        }
                        
                        // Une las partes con ' | ', filtrando las que estén vacías o nulas
                        extraDetailsDiv.innerHTML = detailsParts.filter(part => part !== null && part !== undefined && part !== '').join(' | ');

                        /* =========  NUEVO: Selector de etiquetas personalizadas  ========= */
                        const etiquetasData = data.user_etiquetas_personalizadas;
                        const perfilRegulatorioUser = data.perfil_regulatorio || '';
                        // Mapa de definiciones de todas las etiquetas del usuario
                        const definicionesMap = data.user_etiquetas_definiciones || {};

                        // Expose profile getter globally
                        window.getPerfilRegulatorio = () => perfilRegulatorioUser;
                        window.getDefinicionEtiqueta = (et) => definicionesMap[et] || '';
                        
                        // Expose etiquetas data and selection functions globally
                        let selectedEtiquetaName = null;
                        let selectedEtiquetaData = null;
                        
                        window.getEtiquetasData = () => etiquetasData || {};
                        window.setSelectedEtiqueta = (name, data) => {
                            selectedEtiquetaName = name;
                            selectedEtiquetaData = data;
                        };
                        window.getSelectedEtiquetaContext = () => {
                            if (!selectedEtiquetaName) return null;
                            return { name: selectedEtiquetaName, data: selectedEtiquetaData };
                        };
                        /* ==================================================================== */
                    }
                    pageLoaderOverlay.style.display = 'none';
    // Fin del nuevo código
                })
                .catch(error => {
                    console.error('Error fetching norma details:', error);
                    analysisResultDiv.textContent = 'Error fetching norma details.'; // show error if there's a problem
                    pageLoaderOverlay.style.display = 'none';// Hide the overlay even if there's an error
                });

        // Add click handlers for each button - now show dropdown instead of direct analysis
        analyzeButton.addEventListener('click', () => {
            showAnalysisDropdown('summary', analyzeButton);
        });

        checklistButton.addEventListener('click', () => {
            showAnalysisDropdown('checklist', checklistButton);
        });

        risksButton.addEventListener('click', () => {
            showAnalysisDropdown('risks', risksButton);
        });

        // Add click handler for start analysis button
        startAnalysisBtn.addEventListener('click', () => {
            if (currentAnalysisType && activeAnalysisButton && activeAnalysisButton.innerHTML) {
                // Store references before hiding dropdown (which resets them)
                const analysisType = currentAnalysisType;
                const buttonElement = activeAnalysisButton;
                
                hideAnalysisDropdown();
                performAnalysis(analysisType, buttonElement);
            } else {
                console.error('Error: activeAnalysisButton is null or invalid');
                alert('Error: No se pudo identificar el botón de análisis. Por favor, inténtalo de nuevo.');
            }
        });
            

            // Configurar los listeners para el feedback
            function setupFeedbackListeners() {
              // Toggle para mostrar/ocultar el contenido de feedback
              document.getElementById('feedbackToggle').addEventListener('click', function() {
                const feedbackContent = document.getElementById('feedbackContent');
                const chevron = this.querySelector('.fa');
                
                if (feedbackContent.style.display === 'none') {
                  feedbackContent.style.display = 'block';
                  chevron.classList.remove('fa-chevron-down');
                  chevron.classList.add('fa-chevron-up');
                } else {
                  feedbackContent.style.display = 'none';
                  chevron.classList.remove('fa-chevron-up');
                  chevron.classList.add('fa-chevron-down');
                }
              });

              // Enviar feedback
              document.getElementById('sendFeedbackBtn').addEventListener('click', function() {
                const feedbackText = document.getElementById('feedbackText').value.trim();
                
                if (!feedbackText) {
                  alert('Por favor, introduce tu feedback antes de enviar.');
                  return;
                }
                
                this.disabled = true;
                this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';
                
                const urlParams = new URLSearchParams(window.location.search);
                const documentId = urlParams.get('documentId');
                const collectionName = urlParams.get('collectionName');
                const userPrompt = document.getElementById('userPrompt').value;
                const analysisResults = document.getElementById('analysisResult').innerHTML;
                
                // Obtener fecha actual en formato yyyy-mm-dd
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                fetch('/api/feedback-analisis', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    documentId: documentId,
                    collectionName: collectionName,
                    userPrompt: userPrompt,
                    analysisResults: analysisResults,
                    fecha: dateStr,
                    feedback: feedbackText,
                    content_evaluated: 'analisis_impacto'
                  })
                })
                .then(response => response.json())
                .then(data => {
                  this.disabled = false;
                  this.innerHTML = 'Enviar feedback';
                  
                  if (data.success) {
                    const successMsg = document.createElement('div');
                    successMsg.className = 'feedback-success';
                    successMsg.textContent = '¡Gracias por tu feedback!';
                    document.getElementById('feedbackContent').appendChild(successMsg);
                    
                    // Limpiar el textarea
                    document.getElementById('feedbackText').value = '';
                  
                  } else {
                    alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.');
                  }
                })
                .catch(error => {
                  console.error('Error sending feedback:', error);
                  this.disabled = false;
                  this.innerHTML = 'Enviar feedback';
                  alert('Error al enviar el feedback. Por favor, inténtalo de nuevo.');
                });
              });
            }
            // Inicializar los listeners
            setupFeedbackListeners();

            // Add click outside to close dropdown
            document.addEventListener('click', function(event) {
                if (!analysisDropdown.contains(event.target) && 
                    !analyzeButton.contains(event.target) && 
                    !checklistButton.contains(event.target) && 
                    !risksButton.contains(event.target)) {
                    hideAnalysisDropdown();
                }
                
                // Close analysis settings dropdown if clicking outside
                if (!analysisSettingsDropdown.contains(event.target) && 
                    !analysisSettingsBtn.contains(event.target)) {
                    hideAnalysisSettingsDropdown();
                }
            });

            // Analysis settings event listeners
            if (analysisSettingsBtn) {
                analysisSettingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleAnalysisSettingsDropdown();
                });
            }

            if (analysisIdiomaSelect) {
                analysisIdiomaSelect.addEventListener('change', () => {
                    saveAnalysisSettings();
                });
            }

            // Load analysis settings on page load
            loadAnalysisSettings();

        function startStatusWorkflow(analysisType = 'generic') {
            clearStatusWorkflow();
            console.log('[workflow] starting for type:', analysisType);
            analysisStatusDiv.style.display = 'flex';
            statusTextSpan.classList.remove('slide');
            void statusTextSpan.offsetWidth;
            statusTextSpan.textContent = 'Pensando…';
            
            // Define specific steps based on analysis type
            let specificSteps = [];
            
            if (analysisType === 'summary') {
                specificSteps = [
                    { text: 'Resumiendo aspectos generales…', duration: 2500 },
                    { text: 'Analizando el objetivo de la norma…', duration: 2500 },
                    { text: 'Identificando sujetos afectados…', duration: 2500 },
                    { text: 'Recomendando próximos pasos…', duration: 2500 }
                ];
            } else if (analysisType === 'checklist') {
                specificSteps = [
                    { text: 'Identificando cuadro de obligaciones…', duration: 2500 },
                    { text: 'Referenciando los artículos…', duration: 2500 },
                    { text: 'Analizando sanciones por incumplimiento…', duration: 2500 }
                ];
            } else if (analysisType === 'risks') {
                specificSteps = [
                    { text: 'Identificando oportunidades…', duration: 2500 },
                    { text: 'Analizando riesgos…', duration: 2500 }
                ];
                         } else {
                 // Generic fallback for custom prompts
                 specificSteps = [
                     { text: 'Procesando tu consulta…', duration: 2500 },
                     { text: 'Buscando información relevante…', duration: 2500 },
                     { text: 'Estructurando la respuesta…', duration: 2500 }
                 ];
             }
            
            // Common initial steps
            const commonSteps = [
                { text: 'Pensando…', duration: 3000 },
                { text: 'Accediendo a la fuente oficial…', duration: 2000 },
                { text: 'Analizando el documento…', duration: 3000 }
            ];
            
            // Combine common steps with specific steps
            const steps = [
                ...commonSteps,
                ...specificSteps,
                { text: 'Personalizando el análisis…', duration: null } // stays until done
            ];

            let cumulative = 0;
            steps.forEach((step, idx) => {
                const t = setTimeout(() => {
                    console.log('[workflow] step', step.text);
                    statusTextSpan.classList.remove('slide');
                    void statusTextSpan.offsetWidth;
                    statusTextSpan.textContent = step.text;
                    statusTextSpan.classList.add('slide');
                }, cumulative);
                statusTimeouts.push(t);
                if (step.duration) cumulative += step.duration;
            });
        }

        function clearStatusWorkflow() {
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] cleared');
            analysisStatusDiv.style.display = 'none';
        }

        function completeStatusWorkflowWithError() {
            // Cancel any pending timeouts
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] completing with error - API error received');
            
            // Show error status
            const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
            spinnerIcon.className = 'fa fa-exclamation-triangle'; // Change to error icon
            statusTextSpan.classList.remove('slide');
            void statusTextSpan.offsetWidth;
            statusTextSpan.textContent = 'Error en el análisis';
            statusTextSpan.classList.add('slide');
            
            // Animate out after showing error
            setTimeout(() => {
                analysisStatusDiv.classList.add('status-completed');
                setTimeout(() => {
                    analysisStatusDiv.style.display = 'none';
                    analysisStatusDiv.classList.remove('status-completed');
                    // Reset spinner for next time
                    spinnerIcon.className = 'fa fa-spinner spinner';
                }, 800); // Match animation duration
            }, 800); // Show error state a bit longer
        }

        function completeStatusWorkflowWithErrorAndCallback(errorMessage, callback) {
            // Cancel any pending timeouts
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] completing with error - showing custom message');
            
            // Show error status with custom message
            const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
            spinnerIcon.className = 'fa fa-exclamation-triangle'; // Change to error icon
            statusTextSpan.classList.remove('slide');
            void statusTextSpan.offsetWidth;
            statusTextSpan.textContent = errorMessage;
            statusTextSpan.classList.add('slide');
            
            // Animate out after showing error, then execute callback
            setTimeout(() => {
                analysisStatusDiv.classList.add('status-completed');
                setTimeout(() => {
                    analysisStatusDiv.style.display = 'none';
                    analysisStatusDiv.classList.remove('status-completed');
                    // Reset spinner for next time
                    spinnerIcon.className = 'fa fa-spinner spinner';
                    // Execute callback to show error in analysisResult
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }, 800); // Match animation duration
            }, 1200); // Show error state longer for user to read
        }

        function completeStatusWorkflow() {
            // Cancel any pending timeouts but don't hide yet
            statusTimeouts.forEach(t => clearTimeout(t));
            statusTimeouts = [];
            console.log('[workflow] completing with success - API response received');
            
            // Show completion status with tick immediately
            const spinnerIcon = analysisStatusDiv.querySelector('.spinner');
            spinnerIcon.className = 'fa fa-check'; // Change to tick
            statusTextSpan.classList.remove('slide');
            void statusTextSpan.offsetWidth;
            statusTextSpan.textContent = 'Análisis Finalizado';
            statusTextSpan.classList.add('slide');
            
            // Animate out after showing completion
            setTimeout(() => {
                analysisStatusDiv.classList.add('status-completed');
                setTimeout(() => {
                    analysisStatusDiv.style.display = 'none';
                    analysisStatusDiv.classList.remove('status-completed');
                    // Reset spinner for next time
                    spinnerIcon.className = 'fa fa-spinner spinner';
                }, 800); // Match animation duration
            }, 600); // Show completed state for 600ms
        }
    });
</script>
<script>
        function toggleMenu() {
            const menu = document.querySelector('.menu');
            menu.classList.toggle('active');
             }
             // Close the menu if clicking outside of it
    document.addEventListener('click', function(event) {
        const menu = document.querySelector('.menu');
        const hamburger = document.querySelector('.hamburger');
        
        if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
            menu.classList.remove('active');
        }
    });
</script>

</body>
</html>